<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <script src="/live2d-widget/live2d-widget-resource/jquery.min.js"></script>
  <link rel="stylesheet" href="/live2d-widget/live2d-widget-resource/font-awesome.min.css"/>
  <script src="/live2d-widget/autoload.js"></script>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />


















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="turn," />










<meta name="description" content="前言虽然已经用 coturn 来作为 webrtc 的转发服。 但是我们只做了一个最基本的静态key的加密校验而已。但是对于转发的流量和转发的时长，却没法统计。但是事实上，对于转发的流量和时长对于我们的业务来说是非常必要的。刚好 coturn 有提供了一个统计的redis配置，redis-statsdb，这个是就是 turnserver 会将一些统计的数据存到 redis 中。 然后我们去取就行了">
<meta name="keywords" content="turn">
<meta property="og:type" content="article">
<meta property="og:title" content="coturn 添加redis实现对转发流量和转发时长的统计">
<meta property="og:url" content="http://kebingzao.com/2018/11/15/turn-stat/index.html">
<meta property="og:site_name" content="Zach Ke&#39;s Notes">
<meta property="og:description" content="前言虽然已经用 coturn 来作为 webrtc 的转发服。 但是我们只做了一个最基本的静态key的加密校验而已。但是对于转发的流量和转发的时长，却没法统计。但是事实上，对于转发的流量和时长对于我们的业务来说是非常必要的。刚好 coturn 有提供了一个统计的redis配置，redis-statsdb，这个是就是 turnserver 会将一些统计的数据存到 redis 中。 然后我们去取就行了">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://kebingzao.com/2018/11/15/turn-stat/1.png">
<meta property="og:image" content="http://kebingzao.com/2018/11/15/turn-stat/2.png">
<meta property="og:image" content="http://kebingzao.com/2018/11/15/turn-stat/3.png">
<meta property="og:image" content="http://kebingzao.com/2018/11/15/turn-stat/4.png">
<meta property="og:image" content="http://kebingzao.com/2018/11/15/turn-stat/5.png">
<meta property="og:image" content="http://kebingzao.com/2018/11/15/turn-stat/6.png">
<meta property="og:image" content="http://kebingzao.com/2018/11/15/turn-stat/7.png">
<meta property="og:image" content="http://kebingzao.com/2018/11/15/turn-stat/8.png">
<meta property="og:image" content="http://kebingzao.com/2018/11/15/turn-stat/9.png">
<meta property="og:updated_time" content="2021-08-28T11:11:34.690Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="coturn 添加redis实现对转发流量和转发时长的统计">
<meta name="twitter:description" content="前言虽然已经用 coturn 来作为 webrtc 的转发服。 但是我们只做了一个最基本的静态key的加密校验而已。但是对于转发的流量和转发的时长，却没法统计。但是事实上，对于转发的流量和时长对于我们的业务来说是非常必要的。刚好 coturn 有提供了一个统计的redis配置，redis-statsdb，这个是就是 turnserver 会将一些统计的数据存到 redis 中。 然后我们去取就行了">
<meta name="twitter:image" content="http://kebingzao.com/2018/11/15/turn-stat/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'KGVI6VPIBI',
      apiKey: '41c2ccc830ca183768a6bf1e50a03f44',
      indexName: 'test_blog',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://kebingzao.com/2018/11/15/turn-stat/"/>





  <title>coturn 添加redis实现对转发流量和转发时长的统计 | Zach Ke's Notes</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <a href="https://github.com/kebingzao" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Zach Ke's Notes</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Quick notes</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kebingzao.com/2018/11/15/turn-stat/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zach Ke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zach Ke's Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">coturn 添加redis实现对转发流量和转发时长的统计</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-15T15:09:57+08:00">
                2018-11-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/webrtc相关/" itemprop="url" rel="index">
                    <span itemprop="name">webrtc相关</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/15/turn-stat/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/11/15/turn-stat/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/11/15/turn-stat/" class="leancloud_visitors" data-flag-title="coturn 添加redis实现对转发流量和转发时长的统计">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>虽然已经用 coturn 来作为 webrtc 的转发服。 但是我们只做了一个最基本的静态key的加密校验而已。但是对于转发的流量和转发的时长，却没法统计。<br>但是事实上，对于转发的流量和时长对于我们的业务来说是非常必要的。<br>刚好 coturn 有提供了一个统计的redis配置，<strong>redis-statsdb</strong>，这个是就是 turnserver 会将一些统计的数据存到 redis 中。 然后我们去取就行了。<br>所以要在配置文件里面加上这一个配置:<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-statsdb="ip=59.57.xx.xx dbname=13 port=6379 connect_timeout=30"</span><br></pre></td></tr></table></figure></p>
<a id="more"></a>
<p>具体文档：<br><blockquote><p>-O, –redis-statsdb    <connection-string>    Redis status and statistics database connection string, if used (default - empty, no Redis stats DB used). This database keeps allocations status information, and it can be also used for publishing and delivering traffic and allocation event notifications. The connection string has the same parameters as redis-userdb connection string.</connection-string></p>
<footer><strong>https://github.com/coturn/coturn/wiki/turnserver</strong></footer></blockquote><br>也就是这个参数是用来做状态统计的。 可以用来发布和传递流量， 还有断开和连接的webhook通知。通过这个统计的redis db，我们可以得到这一次转发的开始时间，结束时间，以及转发的流量。<br>大概的一个截图就是：<br><img src="/2018/11/15/turn-stat/1.png" alt="1"><br>这边还有更详细的说明： <a href="https://github.com/coturn/coturn/blob/master/turndb/schema.stats.redis" target="_blank" rel="noopener">schema.stats.redis</a><br>状态的key就是：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">turn/user/<span class="tag">&lt;<span class="name">username</span>&gt;</span>/allocation/<span class="tag">&lt;<span class="name">id</span>&gt;</span>/status</span><br></pre></td></tr></table></figure></p>
<p>举例：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">turn/realm/pano/user/1531994598:fe909a0a4cde20be0a7bb9fbfdc8d6dc_21_24_18154723/allocation/003000000000002028/status</span><br></pre></td></tr></table></figure></p>
<p>他的值有可能是 <strong>new lifetime=…</strong> 或者是 <strong>refreshed lifetime=…</strong><br><img src="/2018/11/15/turn-stat/2.png" alt="1"><br>一个用户名下可能有多个状态。<br>然后是订阅： </p>
<ul>
<li>通过订阅： <strong>turn/realm/*/user/*/allocation/*/status</strong>  这个主题，可以得到一些事件，比如 deleted 事件</li>
<li>通过订阅: <strong>turn/realm/*/user/*/allocation/*/traffic</strong>  这个主题，可以得到一些信息，比如流量， 当这个配置被删除的时候， 也可以得到通知。</li>
</ul>
<p>如果是订阅所有的配置，那么就是 <strong>turn/realm/*/user/*/allocation/*/total_traffic</strong><br>因为不能过期，所以redis 的配置文件，要配置这两个：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">timeout 0</span><br><span class="line">tcp-keepalive 60</span><br></pre></td></tr></table></figure></p>
<p>而且为了保证 redis 统计的准确性， 还得再装一个依赖 <code>hiredis-devel</code>:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install gcc gcc-c++ openssl-devel libevent2 libevent2-devel  hiredis-devel</span><br></pre></td></tr></table></figure></p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>假设我们已经在使用webrtc的应用上连接上turn server了，并且已经在转发了。那我们就可以看下这个redis跑的统计数据都是什么样的？<br>接下来先在redis 先sub一下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[13]&gt; psubscribe turn/realm/*</span><br><span class="line">Reading messages... (press Ctrl-C to quit)</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532417691:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/001000000000003326/status"</span><br><span class="line">4) "new lifetime=600"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532417569:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/001000000000003324/status"</span><br><span class="line">4) "new lifetime=600"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532417569:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/003000000000003700/status"</span><br><span class="line">4) "refreshed lifetime=0"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532417569:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/003000000000003700/status"</span><br><span class="line">4) "deleted"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532417569:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/003000000000003700/total_traffic"</span><br><span class="line">4) "rcvp=0, rcvb=0, sentp=0, sentb=0"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532417569:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/001000000000003324/traffic"</span><br><span class="line">4) "rcvp=1610, rcvb=1607159, sentp=438, sentb=22052"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532417569:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/001000000000003324/traffic"</span><br><span class="line">4) "rcvp=1385, rcvb=1404252, sentp=663, sentb=31187"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532417569:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/001000000000003324/traffic"</span><br><span class="line">4) "rcvp=1407, rcvb=1442093, sentp=641, sentb=30066"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532417569:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/001000000000003324/traffic"</span><br><span class="line">4) "rcvp=1383, rcvb=1408780, sentp=665, sentb=31146"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532417691:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/001000000000003326/status"</span><br><span class="line">4) "refreshed lifetime=0"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532417691:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/001000000000003326/status"</span><br><span class="line">4) "deleted"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532417691:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/001000000000003326/total_traffic"</span><br><span class="line">4) "rcvp=0, rcvb=0, sentp=0, sentb=0"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532417569:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/001000000000003324/status"</span><br><span class="line">4) "refreshed lifetime=0"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532417691:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/001000000000003327/status"</span><br><span class="line">4) "new lifetime=600"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532417691:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/003000000000003705/status"</span><br><span class="line">4) "new lifetime=600"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532417569:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/001000000000003324/status"</span><br><span class="line">4) "deleted"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532417569:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/001000000000003324/total_traffic"</span><br><span class="line">4) "rcvp=5785, rcvb=5862284, sentp=2407, sentb=114451"</span><br></pre></td></tr></table></figure></p>
<p>可以看到进行一次连接的话，会分配好几条临时会话。 从下图来看的话，可以看到有 4 条，其实这四条都属于同一个连接。<br><img src="/2018/11/15/turn-stat/3.png" alt="1"><br>接下来我们一条一条来分析：</p>
<ul>
<li>刚开始建立了一条 3326 的临时channel ， 生命周期是 600s，也就是 10分钟</li>
<li>然后又建立了一条 3324 的临时channel</li>
<li>接下来的三条分别是，刷新一条 3700 的临时channel ，lifetime 为0，说明是要删除，所以接下来就收到一条 delete 的状态，说明这个临时topic要删除，然后当删除的时候，就会将这一段时间的流量(total_traffic )也传上来。</li>
<li>接下来的4条，全部都是 3324 这一个topic的流量信息。包括收到的字节和发送的字节</li>
<li>接下来的三条是3326，分别是将lifetime 为0，然后delete，最后关于这条临时channel 的流量过来。</li>
<li>接下来的一条是 3324 这一条的lifetime 为 0， 然后是两条新的临时channel 的建立， 然后就是 3324 收到 delete 的状态，和总流量的通知。</li>
</ul>
<p>总结一下：</p>
<h3 id="1-一次的webrtc-的turnserver-转发，其实会分配了好几个临时的-channel。"><a href="#1-一次的webrtc-的turnserver-转发，其实会分配了好几个临时的-channel。" class="headerlink" title="1. 一次的webrtc 的turnserver 转发，其实会分配了好几个临时的 channel。"></a>1. 一次的webrtc 的turnserver 转发，其实会分配了好几个临时的 channel。</h3><h3 id="2-每个-channel-的生命周期和对应的状态"><a href="#2-每个-channel-的生命周期和对应的状态" class="headerlink" title="2. 每个 channel 的生命周期和对应的状态"></a>2. 每个 channel 的生命周期和对应的状态</h3><p>每个 channel 刚开始创建的时候，生命周期只有 600s， 这个可以在 配置文件设置：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Uncomment to set the lifetime for the channel.</span><br><span class="line"># Default value is 600 secs (10 minutes).</span><br><span class="line"># This value MUST not be changed for production purposes.</span><br><span class="line">#</span><br><span class="line">#channel-lifetime=600</span><br></pre></td></tr></table></figure></p>
<p>而且刚开始创建就会有状态通知，内容就是 <strong>new lifetime=600</strong>。<br>虽然每个channel的生命周期都是 600s， 但是并不意味着，600s 之后，这个channel就会被删除，其实不是的，这个是可以被续的，也就是如果这个 channel 被续了，那么就会有这个状态通知：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532403222:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/004000000000003897/status"</span><br><span class="line">4) "refreshed lifetime=600"</span><br></pre></td></tr></table></figure></p>
<p>这个说明被续了一个周期了。当然也有不续的，这时候也会有这个状态，不过这时候 lifetime 是 0:<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532415366:07a9939e437c9bca97f67b4b74de6a2f_21_24_22819787/allocation/004000000000003905/status"</span><br><span class="line">4) "refreshed lifetime=0"</span><br></pre></td></tr></table></figure></p>
<p>一旦 lifetime 为0， 就说明这个channel要被删除了。 这时候就会收到 delete 状态:<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532415366:07a9939e437c9bca97f67b4b74de6a2f_21_24_22819787/allocation/000000000000001816/status"</span><br><span class="line">4) "deleted"</span><br></pre></td></tr></table></figure></p>
<p>这时候就说明这条channel已经被删除了。<br>而且每一个channel 的最长生命周期是可以配置的，默认是 3600s:<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Uncomment if you want to set the maximum allocation</span><br><span class="line"># time before it has to be refreshed.</span><br><span class="line"># Default is 3600s.</span><br><span class="line">#</span><br><span class="line">#max-allocate-lifetime=3600</span><br></pre></td></tr></table></figure></p>
<p>所以一个完整的 channel 周期就是  <strong>创建-&gt; 续周期(一次以上) -&gt; 删除 (如果续的是 0)</strong><br>针对这个，我后面试了一下， 在一次长达 一个多小时的webrtc连接， 那个转发流量的channel， 续周期续了7次， 一次 600s， 总的是 7 * 600 = 4200， 比3600 还大了，但是也还没有断开,所以这个也有点奇怪？？？</p>
<h3 id="3-流量信息"><a href="#3-流量信息" class="headerlink" title="3. 流量信息"></a>3. 流量信息</h3><p>每一条channel 在生命周期之内，如果有进行流量转发的话，那么就会每隔一段时间就会有 traffic 这个状态过来，注意，如果是 stun 或者 local 这种不走转发的，那么是没有这个事件的：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532417569:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/001000000000003324/traffic"</span><br><span class="line">4) "rcvp=1383, rcvb=1408780, sentp=665, sentb=31146"</span><br></pre></td></tr></table></figure></p>
<p>而且每次的channel 的生命周期结束之后，也就是 delete 状态，也会收到这一条生命周期的所有的转发流量数据。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532417569:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/001000000000003324/total_traffic"</span><br><span class="line">4) "rcvp=5785, rcvb=5862284, sentp=2407, sentb=114451"</span><br></pre></td></tr></table></figure></p>
<p>跟 traffic 不一样， traffic 是真的是转发有流量，才会每隔一段时间抛一次，而 total_traffic 是必会有的，不管是穿透还是转发， 只不过如果是穿透的话，那就是都是 0，比如:<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532415366:07a9939e437c9bca97f67b4b74de6a2f_21_24_22819787/allocation/004000000000003905/total_traffic"</span><br><span class="line">4) "rcvp=0, rcvb=0, sentp=0, sentb=0"</span><br></pre></td></tr></table></figure></p>
<p>每一个 delete 状态，都会跟着一个 total_traffic 事件。 而里面的 这些参数，其实都是 traffic 的所有对应参数的总和。<br>这四个参数分别是：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rcvp： 收到的数据包</span><br><span class="line">rcvb:   收到的字节（byte）</span><br><span class="line">sentp： 发送的数据包</span><br><span class="line">sentb： 发送的字节（byte）</span><br></pre></td></tr></table></figure></p>
<p>所以我们如果要统计这一次转发的时长的话，那么就要记录这次连接的所有的channel。也就是如果这一次的转发，有5个channel，那么就第一个channel创建的时候，就是开始时间， 当所有的channel 都断开的时候，那么就是结束时间。 一定要所有的channel 都断开，才算转发结束，<br>而且中间还会有不断的新的channel被创建，这些新的channel也要加入到map里面去。然后每一个channel断开，就从map里面去掉， 一直到最后map为空的话，才算转发结束。算转发的总流量也是一样，每一个channel都会有一段流量。 当所有的channel都断开的时候，加起来就是总的转发流量。</p>
<h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><p>刚开始是这样子写的：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">"errors"</span></span><br><span class="line">   <span class="string">"fmt"</span></span><br><span class="line">   <span class="string">"github.com/garyburd/redigo/redis"</span></span><br><span class="line">   <span class="string">"iGong/util/log"</span></span><br><span class="line">   <span class="string">"strconv"</span></span><br><span class="line">   <span class="string">"strings"</span></span><br><span class="line">   <span class="string">"sync"</span></span><br><span class="line">   <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">type OnlineTimeBucket struct &#123;</span><br><span class="line">   Data   map[string]*OnlineTimeBucketSub</span><br><span class="line">   Locker *sync.Mutex</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func NewOnlineTimeBucket() *OnlineTimeBucket &#123;</span><br><span class="line">   <span class="keyword">return</span> &amp;OnlineTimeBucket&#123;</span><br><span class="line">      Data:   make(map[string]*OnlineTimeBucketSub),</span><br><span class="line">      Locker: &amp;sync.Mutex&#123;&#125;,</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type OnlineTimeBucketSub struct &#123;</span><br><span class="line">   Timer map[string]*OnlineTime</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type OnlineTime struct &#123;</span><br><span class="line">   Start        int64</span><br><span class="line">   End          int64</span><br><span class="line">   Delete       bool</span><br><span class="line">   TotalTraffIc bool</span><br><span class="line">   Rcvp         int</span><br><span class="line">   Rcvb         int</span><br><span class="line">   Sentp        int</span><br><span class="line">   Sentb        int</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> onlineTimeBucket *OnlineTimeBucket</span><br><span class="line"><span class="keyword">var</span> serverTime = time.Now().Unix()</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">turn/realm/pano/user/1531882310:7ed1019263ce5e09f3d40a1ca15ae992_21_24_18152992/allocation/000000000000000495/status new lifetime=600</span></span><br><span class="line"><span class="comment">turn/realm/pano/user/1531881513:7ed1019263ce5e09f3d40a1ca15ae992_21_24_18152992/allocation/001000000000000462/status refreshed lifetime=0</span></span><br><span class="line"><span class="comment">turn/realm/pano/user/1531882310:7ed1019263ce5e09f3d40a1ca15ae992_21_24_18152992/allocation/004000000000000899/status deleted</span></span><br><span class="line"><span class="comment">turn/realm/pano/user/1531881513:7ed1019263ce5e09f3d40a1ca15ae992_21_24_18152992/allocation/001000000000000462/total_traffic rcvp=18612, rcvb=894124, sentp=104268, sentb=114206669</span></span><br><span class="line"><span class="comment">turn/realm/pano/user/1531881926:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/004000000000000896/traffic rcvp=1847, rcvb=2052114, sentp=201, sentb=10652</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">func TurnServerStats() &#123;</span><br><span class="line">   conn, <span class="attr">err</span> := RedisTurn.GetConn()</span><br><span class="line">   sub := redis.PubSubConn&#123;<span class="attr">Conn</span>: conn&#125;</span><br><span class="line">   <span class="keyword">if</span> err != nil &#123;</span><br><span class="line">      log.Error(err)</span><br><span class="line">   &#125;</span><br><span class="line">   defer conn.Close()</span><br><span class="line">   onlineTimeBucket = NewOnlineTimeBucket()</span><br><span class="line">   sub.PSubscribe(<span class="string">"turn/realm/*"</span>)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> &#123;</span><br><span class="line">      <span class="keyword">switch</span> n := sub.Receive().(type) &#123;</span><br><span class="line">      <span class="comment">//case redis.Message:</span></span><br><span class="line">      <span class="comment">// fmt.Printf("Message: %s %s\n", n.Channel, n.Data)</span></span><br><span class="line">      <span class="keyword">case</span> redis.PMessage:</span><br><span class="line">         err = forwardStats(n)</span><br><span class="line">         <span class="keyword">if</span> err != nil &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">         &#125;</span><br><span class="line">         </span><br><span class="line">      <span class="keyword">case</span> error:</span><br><span class="line">         fmt.Printf(<span class="string">"error: %v\n"</span>, n)</span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func forwardStats(data redis.PMessage) (err error) &#123;</span><br><span class="line">   fmt.Printf(<span class="string">"PMessage: %s %s %s\n"</span>, data.Pattern, data.Channel, data.Data)</span><br><span class="line">   event, deviceId, channel, <span class="attr">err</span> := decodeChannel(data.Channel)</span><br><span class="line">   <span class="keyword">if</span> err != nil &#123;</span><br><span class="line">      log.Error(err)</span><br><span class="line">      <span class="keyword">return</span> err</span><br><span class="line">   &#125;</span><br><span class="line">   log.Info(event, deviceId)</span><br><span class="line">   <span class="keyword">switch</span> event &#123;</span><br><span class="line">   <span class="keyword">case</span> <span class="string">"status"</span>:</span><br><span class="line">      <span class="comment">//统计时长 和在线状态</span></span><br><span class="line">      onlineStatus := decodeDataWithStatus(data.Data)</span><br><span class="line">      log.Info(onlineStatus)</span><br><span class="line">      addOnlineTime(deviceId, channel, onlineStatus)</span><br><span class="line">   <span class="keyword">case</span> <span class="string">"total_traffic"</span>:</span><br><span class="line">      <span class="comment">//统计流量 这个事件过来说明转发已经结束 并且只有一个会话是有值的</span></span><br><span class="line">      trafficMap, <span class="attr">err</span> := decodeDataWithTraffic(data.Data)</span><br><span class="line">      <span class="keyword">if</span> err != nil &#123;</span><br><span class="line">         <span class="keyword">return</span> err</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//rcvp 接收到的包数量  rcvb 接收到的流量 sentp 发送的包数量 sentb 发送的包流量</span></span><br><span class="line">      log.Info(trafficMap)</span><br><span class="line">      addFlow(deviceId, channel, trafficMap)</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func decodeChannel(channel string) (event string, deviceId, channelId string, err error) &#123;</span><br><span class="line">   args := strings.Split(channel, <span class="string">"/"</span>)</span><br><span class="line">   <span class="keyword">if</span> len(args) != <span class="number">8</span> &#123;</span><br><span class="line">      err = errors.New(<span class="string">"channel fail ."</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   event = args[<span class="number">7</span>]</span><br><span class="line">   deviceId = strings.Split(args[<span class="number">4</span>], <span class="string">":"</span>)[<span class="number">1</span>]</span><br><span class="line">   channelId = args[<span class="number">6</span>]</span><br><span class="line">   <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func decodeDataWithStatus(data []byte) (onlineStatus int) &#123;</span><br><span class="line">   args := strings.Split(string(data), <span class="string">"="</span>)</span><br><span class="line">   <span class="keyword">switch</span> args[<span class="number">0</span>] &#123;</span><br><span class="line">   <span class="comment">//新建</span></span><br><span class="line">   <span class="keyword">case</span> <span class="string">"new lifetime"</span>:</span><br><span class="line">      onlineStatus = <span class="number">0</span></span><br><span class="line">      <span class="comment">//刷新</span></span><br><span class="line">   <span class="keyword">case</span> <span class="string">"refreshed lifetime"</span>:</span><br><span class="line">      onlineStatus = <span class="number">1</span></span><br><span class="line">      <span class="comment">//移除</span></span><br><span class="line">   <span class="keyword">case</span> <span class="string">"deleted"</span>:</span><br><span class="line">      onlineStatus = <span class="number">2</span></span><br><span class="line">   <span class="keyword">default</span>:</span><br><span class="line">      onlineStatus = <span class="number">1</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">func decodeDataWithTraffic(data []byte) (stats map[string]int, err error) &#123;</span><br><span class="line">   args := strings.Split(string(data), <span class="string">","</span>)</span><br><span class="line">   <span class="keyword">if</span> len(args) != <span class="number">4</span> &#123;</span><br><span class="line">      err = errors.New(<span class="string">"traffic data fail"</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   stats = make(map[string]int)</span><br><span class="line">   <span class="keyword">for</span> _, <span class="attr">v</span> := range args &#123;</span><br><span class="line">      statsInfo := strings.Split(v, <span class="string">"="</span>)</span><br><span class="line">      s, <span class="attr">_</span> := strconv.Atoi(statsInfo[<span class="number">1</span>])</span><br><span class="line">      stats[strings.TrimLeft(statsInfo[<span class="number">0</span>], <span class="string">" "</span>)] = s</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//记录转发时长</span></span><br><span class="line">func addOnlineTime(deviceId, channelId string, onlineStatus int) &#123;</span><br><span class="line">   <span class="keyword">if</span> onlineStatus == <span class="number">1</span> &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   onlineTimeBucket.Locker.Lock()</span><br><span class="line">   timer := time.Now().Unix()</span><br><span class="line">   <span class="keyword">if</span> _, <span class="attr">ok</span> := onlineTimeBucket.Data[deviceId]; !ok &#123;</span><br><span class="line">      j := <span class="keyword">new</span>(OnlineTimeBucketSub)</span><br><span class="line">      j.Timer = make(map[string]*OnlineTime)</span><br><span class="line">      onlineTimeBucket.Data[deviceId] = j</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">switch</span> onlineStatus &#123;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">      log.Info(<span class="string">"new life_time"</span>)</span><br><span class="line">      <span class="keyword">var</span> onlineModel = <span class="keyword">new</span>(OnlineTime)</span><br><span class="line">      onlineModel.Start = timer</span><br><span class="line">      onlineTimeBucket.Data[deviceId].Timer[channelId] = onlineModel</span><br><span class="line">   <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      log.Info(<span class="string">"delete life_time"</span>)</span><br><span class="line">      <span class="keyword">if</span> _, <span class="attr">ok</span> := onlineTimeBucket.Data[deviceId].Timer[channelId]; !ok &#123;</span><br><span class="line">         <span class="keyword">var</span> onlineModel = <span class="keyword">new</span>(OnlineTime)</span><br><span class="line">         onlineModel.Start = serverTime</span><br><span class="line">         onlineTimeBucket.Data[deviceId].Timer[channelId] = onlineModel</span><br><span class="line">      &#125;</span><br><span class="line">      onlineTimeBucket.Data[deviceId].Timer[channelId].End = timer</span><br><span class="line">      onlineTimeBucket.Data[deviceId].Timer[channelId].Delete = <span class="literal">true</span></span><br><span class="line">   &#125;</span><br><span class="line">   onlineTimeBucket.Locker.Unlock()</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//记录转发流量并入库</span></span><br><span class="line">func addFlow(deviceId, channelId string, trafficMap map[string]int) &#123;</span><br><span class="line">   onlineTimeBucket.Locker.Lock()</span><br><span class="line">   <span class="keyword">if</span> _, <span class="attr">ok</span> := onlineTimeBucket.Data[deviceId]; !ok &#123;</span><br><span class="line">      j := <span class="keyword">new</span>(OnlineTimeBucketSub)</span><br><span class="line">      j.Timer = make(map[string]*OnlineTime)</span><br><span class="line">      onlineTimeBucket.Data[deviceId] = j</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   onlineTimeBucket.Data[deviceId].Timer[channelId].Rcvb = trafficMap[<span class="string">"rcvb"</span>]</span><br><span class="line">   onlineTimeBucket.Data[deviceId].Timer[channelId].Rcvp = trafficMap[<span class="string">"rcvp"</span>]</span><br><span class="line">   onlineTimeBucket.Data[deviceId].Timer[channelId].Sentb = trafficMap[<span class="string">"sentb"</span>]</span><br><span class="line">   onlineTimeBucket.Data[deviceId].Timer[channelId].Sentp = trafficMap[<span class="string">"sentp"</span>]</span><br><span class="line">   onlineTimeBucket.Data[deviceId].Timer[channelId].TotalTraffIc = <span class="literal">true</span></span><br><span class="line">   <span class="keyword">var</span> isDelete = <span class="literal">true</span></span><br><span class="line">   <span class="keyword">for</span> _, <span class="attr">v</span> := range onlineTimeBucket.Data[deviceId].Timer &#123;</span><br><span class="line">      <span class="keyword">if</span> v.Delete == <span class="literal">false</span> || v.TotalTraffIc == <span class="literal">false</span> &#123;</span><br><span class="line">         isDelete = <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> isDelete &#123;</span><br><span class="line">      <span class="comment">//计算时间,,流量</span></span><br><span class="line">      <span class="keyword">var</span> rcvb, rcvp, sentb, sentp int</span><br><span class="line">      <span class="keyword">var</span> end int64</span><br><span class="line">      start := time.Now().Unix()</span><br><span class="line">      <span class="keyword">for</span> _, <span class="attr">v</span> := range onlineTimeBucket.Data[deviceId].Timer &#123;</span><br><span class="line">         rcvb += v.Rcvb</span><br><span class="line">         rcvp += v.Rcvp</span><br><span class="line">         sentp += v.Sentp</span><br><span class="line">         sentb += v.Sentb</span><br><span class="line">         <span class="keyword">if</span> start &gt; v.Start &#123;</span><br><span class="line">            start = v.Start</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> end &lt; v.End &#123;</span><br><span class="line">            end = v.End</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      accountInfo := strings.Split(deviceId, <span class="string">"_"</span>)</span><br><span class="line">      <span class="keyword">if</span> len(accountInfo) &lt; <span class="number">4</span> &#123;</span><br><span class="line">         log.Info(<span class="string">"deviceId len fail "</span>, deviceId)</span><br><span class="line">      &#125;</span><br><span class="line">      total_time := onlineTimeBucket.Data[deviceId].Timer[channelId].End - onlineTimeBucket.Data[deviceId].Timer[channelId].Start</span><br><span class="line">      err := InsertTurnServerLogs(accountInfo[<span class="number">3</span>], accountInfo[<span class="number">0</span>], accountInfo[<span class="number">1</span>], accountInfo[<span class="number">2</span>], start, end, total_time, rcvp, rcvb, sentp, sentb)</span><br><span class="line">      <span class="keyword">if</span> err != nil &#123;</span><br><span class="line">         log.Error(err)</span><br><span class="line">      &#125;</span><br><span class="line">      onlineTimeBucket.Data[deviceId].Timer = nil</span><br><span class="line">      <span class="keyword">delete</span>(onlineTimeBucket.Data, deviceId)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   onlineTimeBucket.Locker.Unlock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>按照上面的算法来做的话，当我在用web测试的时候，会出现一个情况：</p>
<p><font color="red">就是如果 coturn 的连接断开了。但是对于这个username， 他还是会保持一两条临时 channel</font><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532433896:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/000000000000001857/traffic"</span><br><span class="line">4) "rcvp=1466, rcvb=1325047, sentp=582, sentb=29696"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532433896:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/001000000000003357/status"</span><br><span class="line">4) "refreshed lifetime=0"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532433896:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/001000000000003357/status"</span><br><span class="line">4) "deleted"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532433896:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/001000000000003357/total_traffic"</span><br><span class="line">4) "rcvp=0, rcvb=0, sentp=0, sentb=0"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532433896:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/000000000000001857/status"</span><br><span class="line">4) "refreshed lifetime=0"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532433896:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/003000000000003734/status"</span><br><span class="line">4) "new lifetime=600"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532433896:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/001000000000003358/status"</span><br><span class="line">4) "new lifetime=600"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532433896:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/000000000000001857/status"</span><br><span class="line">4) "deleted"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532433896:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/000000000000001857/total_traffic"</span><br><span class="line">4) "rcvp=1466, rcvb=1325047, sentp=582, sentb=29696"</span><br></pre></td></tr></table></figure></p>
<p>明明我连接断开了，但是又重新连接了两条。而且这两条根本不会释放<br><img src="/2018/11/15/turn-stat/4.png" alt="1"><br>这个就会导致 isDelete 的条件没法成立，因为总有新的链接没有释放。<br>而且后面还发现，一次转发，虽然有好几条channel存在，但是真正转发流量的channel只有一条，而且过了一个多小时，还是没有断。所以原则上我们只要去判断这一条channel，就可以知道本次转发的时长和流量了。 其他的channel都不要管。但是如果是stun这种穿透的，因为没有转发流量，所以根本不知道那一条的channel，才是起作用的那一条？？？？ </p>
<p>后面发现这种情况其实是一个bug， 之所以浏览器刷新还保持两条turn channel 是因为浏览器在刷新的时候，其实没有明确的给手机端发送断开webrtc的信号。导致手机端其实还不知道webrtc断开了。所以手机端其实是对turnserver连接进行重连了， 这也是为啥会有新的两条channel 的问题。<br>我试了其他端，比如 ios 端，如果是断开的话，是不会有遗留turnserver 的channel 的，最后全部都会被清掉。因此对于web端，在刷新浏览器，或者是退出页面的时候，都要给手机的发送断开webrtc的信号，并且断开本地的webrtc连接。<br>所以web端的代码得改下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 关掉 webrtc</span></span><br><span class="line">stopWebRtcServer: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">    <span class="comment">// 给手机端发送一个webrtc 关闭的指令</span></span><br><span class="line">    self.mqttSocket.pub(</span><br><span class="line">            self.subCommonStr + <span class="string">'toTarget'</span>,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"method"</span>: <span class="string">"webrtc.stop"</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                useAes: <span class="literal">true</span>,</span><br><span class="line">            &#125;</span><br><span class="line">    ).done(<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"%c accept stop:"</span> + <span class="built_in">JSON</span>.stringify(data), <span class="string">"color:red"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 清空状态统计的定时</span></span><br><span class="line">    clearTimeout(self.rtcStateMap.timeId);</span><br><span class="line">    <span class="comment">// 关闭signal长连接</span></span><br><span class="line">    self.mqttSocket.close();</span><br><span class="line">    <span class="comment">// 关闭webrtc 连接</span></span><br><span class="line">    self.rtcSocket.close();</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>其中 rtcSocket 的 close 事件为：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">close: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 停止 video 传输</span></span><br><span class="line">    <span class="keyword">var</span> video = <span class="keyword">this</span>._pc.getRemoteStreams()[<span class="number">0</span>].getVideoTracks()[<span class="number">0</span>];</span><br><span class="line">    video.stop();</span><br><span class="line">    <span class="comment">// 关掉 pc 对象</span></span><br><span class="line">    <span class="keyword">this</span>._pc.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>先停止video传输，再释放掉 pc 对象。这时候本来 webrtc work 的时候，是这样的：<br><img src="/2018/11/15/turn-stat/5.png" alt="1"><br>看到的消息就是：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532677507:ac5fa606abf5ae9d02bd4206625b4911_21_24_18152992/allocation/001000000000004071/status"</span><br><span class="line">4) "new lifetime=600"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532677507:ac5fa606abf5ae9d02bd4206625b4911_21_24_18152992/allocation/004000000000004390/status"</span><br><span class="line">4) "new lifetime=600"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532677507:ac5fa606abf5ae9d02bd4206625b4911_21_24_18152992/allocation/000000000000002210/status"</span><br><span class="line">4) "new lifetime=600"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532677507:ac5fa606abf5ae9d02bd4206625b4911_21_24_18152992/allocation/004000000000004390/status"</span><br><span class="line">4) "refreshed lifetime=0"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532677507:ac5fa606abf5ae9d02bd4206625b4911_21_24_18152992/allocation/004000000000004390/status"</span><br><span class="line">4) "deleted"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532677507:ac5fa606abf5ae9d02bd4206625b4911_21_24_18152992/allocation/004000000000004390/total_traffic"</span><br><span class="line">4) "rcvp=0, rcvb=0, sentp=0, sentb=0"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532677507:ac5fa606abf5ae9d02bd4206625b4911_21_24_18152992/allocation/001000000000004071/traffic"</span><br><span class="line">4) "rcvp=1546, rcvb=1442311, sentp=502, sentb=24802"</span><br></pre></td></tr></table></figure></p>
<p>就是建了3条 channel ，然后删掉一条 390 ，保留两条， 后面分别是 210 和 071<br><img src="/2018/11/15/turn-stat/6.png" alt="1"><br>这时候我点击 停止webrtc 按钮，图片传输就会停止了。这时候webrtc 就断开了。<br><img src="/2018/11/15/turn-stat/7.png" alt="1"><br>这时候就收到了断开的消息了， 210 和 071 都断开了:<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532677507:ac5fa606abf5ae9d02bd4206625b4911_21_24_18152992/allocation/000000000000002210/status"</span><br><span class="line">4) "refreshed lifetime=0"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532677507:ac5fa606abf5ae9d02bd4206625b4911_21_24_18152992/allocation/001000000000004071/status"</span><br><span class="line">4) "refreshed lifetime=0"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532677507:ac5fa606abf5ae9d02bd4206625b4911_21_24_18152992/allocation/000000000000002210/status"</span><br><span class="line">4) "deleted"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532677507:ac5fa606abf5ae9d02bd4206625b4911_21_24_18152992/allocation/000000000000002210/total_traffic"</span><br><span class="line">4) "rcvp=0, rcvb=0, sentp=0, sentb=0"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532677507:ac5fa606abf5ae9d02bd4206625b4911_21_24_18152992/allocation/001000000000004071/status"</span><br><span class="line">4) "deleted"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "turn/realm/*"</span><br><span class="line">3) "turn/realm/pano/user/1532677507:ac5fa606abf5ae9d02bd4206625b4911_21_24_18152992/allocation/001000000000004071/total_traffic"</span><br><span class="line">4) "rcvp=4595, rcvb=4367095, sentp=1549, sentb=74756"</span><br></pre></td></tr></table></figure></p>
<p>这时候channel 就全部为空了。<br><img src="/2018/11/15/turn-stat/8.png" alt="1"><br>所以要这样才可以。 但是问题来了，刚才是我们手动点击 停止 webrtc 按钮的，当然流程是对的。<br>但是如果是直接刷新浏览器呢，那可是来不及处理的？？？？<br>事实上也是有这个问题，如果直接刷新浏览器，并且不作处理的时候，就会出现最早之前的那种情况，就是手机端认为还连着，所以 turnserver 又建了两条新的 channel 。<br>所以我后面加了这个事件 <strong>onbeforeunload</strong>：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这时候要设置一个unload事件，不然如果直接浏览器刷新的话，手机端是不知道webrtc不用了，他还会连接 turnserver， 导致turnserver 的session 一直在，后面没法算时间</span></span><br><span class="line"><span class="comment">// 设置unonload, 防止直接刷新浏览器的时候，没有传 webrtc.stop 指令</span></span><br><span class="line"><span class="built_in">window</span>.onbeforeunload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    self.stopWebRtcServer();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>每次用户刷新的时候，这时候就会弹出这个窗口，当用户点击 重新加载的时候， 这时候 stop 操作就已经处理完了。<br><img src="/2018/11/15/turn-stat/9.png" alt="1"><br>因此就成功关闭了，缺点就是用户每次刷新都会弹窗，并且要点击重新加载。</p>
<p>所以服务端来说的话，整个连接过程中创建的channel 都要做判断，只有当channel 全部断掉的时候， 才判断这个连接结束，这时候才要算时间。虽然每一次连接都有一条channel 在发送流量。所以如果 traffic 有值的话，那么就是这一条有流量统计。所以如果有收到有流量的 total_traffic 的事件 ，那么应该就是 relay 的连接断开了。这时候就可以计算时长并入库了。<br>所以修改后的代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">"errors"</span></span><br><span class="line">   <span class="string">"fmt"</span></span><br><span class="line">   <span class="string">"github.com/garyburd/redigo/redis"</span></span><br><span class="line">   <span class="string">"iGong/util/log"</span></span><br><span class="line">   <span class="string">"strconv"</span></span><br><span class="line">   <span class="string">"strings"</span></span><br><span class="line">   <span class="string">"sync"</span></span><br><span class="line">   <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">type OnlineTimeBucket struct &#123;</span><br><span class="line">   Data   map[string]*OnlineTimeBucketSub</span><br><span class="line">   Locker *sync.RWMutex</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func NewOnlineTimeBucket() *OnlineTimeBucket &#123;</span><br><span class="line">   <span class="keyword">return</span> &amp;OnlineTimeBucket&#123;</span><br><span class="line">      Data:   make(map[string]*OnlineTimeBucketSub),</span><br><span class="line">      Locker: &amp;sync.RWMutex&#123;&#125;,</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type OnlineTimeBucketSub struct &#123;</span><br><span class="line">   Timer map[string]*OnlineTime</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//map 存在线时间,结束时间-开始时间,,结束之后再存入表</span></span><br><span class="line"></span><br><span class="line">type OnlineTime struct &#123;</span><br><span class="line">   Start         int64</span><br><span class="line">   RefreshedFlow int64</span><br><span class="line">   End           int64</span><br><span class="line">   Delete        bool</span><br><span class="line">   TotalTraffIc  bool</span><br><span class="line">   Rcvp          int</span><br><span class="line">   Rcvb          int</span><br><span class="line">   Sentp         int</span><br><span class="line">   Sentb         int</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> onlineTimeBucket *OnlineTimeBucket</span><br><span class="line"><span class="keyword">var</span> serverTime = time.Now().Unix()</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">turn/realm/pano/user/1531882310:7ed1019263ce5e09f3d40a1ca15ae992_21_24_18152992/allocation/000000000000000495/status new lifetime=600</span></span><br><span class="line"><span class="comment">turn/realm/pano/user/1531881513:7ed1019263ce5e09f3d40a1ca15ae992_21_24_18152992/allocation/001000000000000462/status refreshed lifetime=0</span></span><br><span class="line"><span class="comment">turn/realm/pano/user/1531882310:7ed1019263ce5e09f3d40a1ca15ae992_21_24_18152992/allocation/004000000000000899/status deleted</span></span><br><span class="line"><span class="comment">turn/realm/pano/user/1531881513:7ed1019263ce5e09f3d40a1ca15ae992_21_24_18152992/allocation/001000000000000462/total_traffic rcvp=18612, rcvb=894124, sentp=104268, sentb=114206669</span></span><br><span class="line"><span class="comment">turn/realm/pano/user/1531881926:26e4cd38fa6fc39fa8fc40fb25fe558c_21_24_18152649/allocation/004000000000000896/traffic rcvp=1847, rcvb=2052114, sentp=201, sentb=10652</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">func TurnServerStats() &#123;</span><br><span class="line">   conn, <span class="attr">err</span> := RedisTurn.GetConn()</span><br><span class="line">   sub := redis.PubSubConn&#123;<span class="attr">Conn</span>: conn&#125;</span><br><span class="line">   <span class="keyword">if</span> err != nil &#123;</span><br><span class="line">      log.Error(err)</span><br><span class="line">   &#125;</span><br><span class="line">   defer conn.Close()</span><br><span class="line">   onlineTimeBucket = NewOnlineTimeBucket()</span><br><span class="line">   sub.PSubscribe(<span class="string">"turn/realm/*"</span>)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> &#123;</span><br><span class="line">      <span class="keyword">switch</span> n := sub.Receive().(type) &#123;</span><br><span class="line">      <span class="comment">//case redis.Message:</span></span><br><span class="line">      <span class="comment">// fmt.Printf("Message: %s %s\n", n.Channel, n.Data)</span></span><br><span class="line">      <span class="keyword">case</span> redis.PMessage:</span><br><span class="line">         err = forwardStats(n)</span><br><span class="line">         <span class="keyword">if</span> err != nil &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">         &#125;</span><br><span class="line">      <span class="keyword">case</span> error:</span><br><span class="line">         fmt.Printf(<span class="string">"error: %v\n"</span>, n)</span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func forwardStats(data redis.PMessage) (err error) &#123;</span><br><span class="line">   fmt.Printf(<span class="string">"PMessage: %s %s %s\n"</span>, data.Pattern, data.Channel, data.Data)</span><br><span class="line">   event, deviceId, channel, <span class="attr">err</span> := decodeChannel(data.Channel)</span><br><span class="line">   <span class="keyword">if</span> err != nil &#123;</span><br><span class="line">      log.Error(err)</span><br><span class="line">      <span class="keyword">return</span> err</span><br><span class="line">   &#125;</span><br><span class="line">   log.Info(event, deviceId)</span><br><span class="line">   <span class="keyword">switch</span> event &#123;</span><br><span class="line">   <span class="keyword">case</span> <span class="string">"status"</span>:</span><br><span class="line">      <span class="comment">//统计时长 和在线状态</span></span><br><span class="line">      onlineStatus := decodeDataWithStatus(data.Data)</span><br><span class="line">      log.Info(onlineStatus)</span><br><span class="line">      addOnlineTime(deviceId, channel, onlineStatus)</span><br><span class="line">   <span class="keyword">case</span> <span class="string">"traffic"</span>, <span class="string">"total_traffic"</span>:</span><br><span class="line">      <span class="comment">//统计流量 这个事件过来说明转发已经结束 并且只有一个会话是有值的</span></span><br><span class="line">      trafficMap, <span class="attr">err</span> := decodeDataWithTraffic(data.Data)</span><br><span class="line">      <span class="keyword">if</span> err != nil &#123;</span><br><span class="line">         <span class="keyword">return</span> err</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//rcvp 接收到的包数量  rcvb 接收到的流量 sentp 发送的包数量 sentb 发送的包流量</span></span><br><span class="line">      log.Info(trafficMap)</span><br><span class="line">      addFlow(deviceId, channel, trafficMap, event)</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func decodeChannel(channel string) (event string, deviceId, channelId string, err error) &#123;</span><br><span class="line">   args := strings.Split(channel, <span class="string">"/"</span>)</span><br><span class="line">   <span class="keyword">if</span> len(args) != <span class="number">8</span> &#123;</span><br><span class="line">      err = errors.New(<span class="string">"channel fail ."</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   event = args[<span class="number">7</span>]</span><br><span class="line">   deviceId = strings.Split(args[<span class="number">4</span>], <span class="string">":"</span>)[<span class="number">1</span>]</span><br><span class="line">   channelId = args[<span class="number">6</span>]</span><br><span class="line">   <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func decodeDataWithStatus(data []byte) (onlineStatus int) &#123;</span><br><span class="line">   args := strings.Split(string(data), <span class="string">"="</span>)</span><br><span class="line">   <span class="keyword">switch</span> args[<span class="number">0</span>] &#123;</span><br><span class="line">   <span class="comment">//新建</span></span><br><span class="line">   <span class="keyword">case</span> <span class="string">"new lifetime"</span>:</span><br><span class="line">      onlineStatus = <span class="number">0</span></span><br><span class="line">      <span class="comment">//刷新</span></span><br><span class="line">   <span class="keyword">case</span> <span class="string">"refreshed lifetime"</span>:</span><br><span class="line">      onlineStatus = <span class="number">1</span></span><br><span class="line">      <span class="comment">//移除</span></span><br><span class="line">   <span class="keyword">case</span> <span class="string">"deleted"</span>:</span><br><span class="line">      onlineStatus = <span class="number">2</span></span><br><span class="line">   <span class="keyword">default</span>:</span><br><span class="line">      onlineStatus = <span class="number">1</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">func decodeDataWithTraffic(data []byte) (stats map[string]int, err error) &#123;</span><br><span class="line">   args := strings.Split(string(data), <span class="string">","</span>)</span><br><span class="line">   <span class="keyword">if</span> len(args) != <span class="number">4</span> &#123;</span><br><span class="line">      err = errors.New(<span class="string">"traffic data fail"</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   stats = make(map[string]int)</span><br><span class="line">   <span class="keyword">for</span> _, <span class="attr">v</span> := range args &#123;</span><br><span class="line">      statsInfo := strings.Split(v, <span class="string">"="</span>)</span><br><span class="line">      s, <span class="attr">_</span> := strconv.Atoi(statsInfo[<span class="number">1</span>])</span><br><span class="line">      stats[strings.TrimLeft(statsInfo[<span class="number">0</span>], <span class="string">" "</span>)] = s</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//记录转发时长</span></span><br><span class="line">func addOnlineTime(deviceId, channelId string, onlineStatus int) &#123;</span><br><span class="line">   <span class="keyword">if</span> onlineStatus == <span class="number">1</span> &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   timer := time.Now().Unix()</span><br><span class="line">   <span class="keyword">if</span> _, <span class="attr">ok</span> := onlineTimeBucket.Data[deviceId]; !ok &#123;</span><br><span class="line">      j := <span class="keyword">new</span>(OnlineTimeBucketSub)</span><br><span class="line">      j.Timer = make(map[string]*OnlineTime)</span><br><span class="line">      onlineTimeBucket.Locker.Lock()</span><br><span class="line">      onlineTimeBucket.Data[deviceId] = j</span><br><span class="line">      onlineTimeBucket.Locker.Unlock()</span><br><span class="line">   &#125;</span><br><span class="line">   onlineTimeBucket.Locker.RLock()</span><br><span class="line">   <span class="keyword">switch</span> onlineStatus &#123;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">      log.Info(<span class="string">"new life_time"</span>)</span><br><span class="line">      <span class="keyword">var</span> onlineModel = <span class="keyword">new</span>(OnlineTime)</span><br><span class="line">      onlineModel.Start = timer</span><br><span class="line">      onlineTimeBucket.Data[deviceId].Timer[channelId] = onlineModel</span><br><span class="line">   <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      log.Info(<span class="string">"delete life_time"</span>)</span><br><span class="line">      <span class="keyword">if</span> _, <span class="attr">ok</span> := onlineTimeBucket.Data[deviceId].Timer[channelId]; !ok &#123;</span><br><span class="line">         <span class="keyword">var</span> onlineModel = <span class="keyword">new</span>(OnlineTime)</span><br><span class="line">         onlineModel.Start = serverTime</span><br><span class="line">         onlineTimeBucket.Data[deviceId].Timer[channelId] = onlineModel</span><br><span class="line">      &#125;</span><br><span class="line">      onlineTimeBucket.Data[deviceId].Timer[channelId].End = timer</span><br><span class="line">      onlineTimeBucket.Data[deviceId].Timer[channelId].Delete = <span class="literal">true</span></span><br><span class="line">   &#125;</span><br><span class="line">   onlineTimeBucket.Locker.RUnlock()</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//记录转发流量并入库</span></span><br><span class="line">func addFlow(deviceId, channelId string, trafficMap map[string]int, event string) &#123;</span><br><span class="line">   <span class="keyword">if</span> _, <span class="attr">ok</span> := onlineTimeBucket.Data[deviceId]; !ok &#123;</span><br><span class="line">      j := <span class="keyword">new</span>(OnlineTimeBucketSub)</span><br><span class="line">      j.Timer = make(map[string]*OnlineTime)</span><br><span class="line">      j.Timer[channelId].Start = time.Now().Unix()</span><br><span class="line">      onlineTimeBucket.Locker.Lock()</span><br><span class="line">      onlineTimeBucket.Data[deviceId] = j</span><br><span class="line">      onlineTimeBucket.Locker.Unlock()</span><br><span class="line"></span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">   onlineTimeBucket.Locker.RLock()</span><br><span class="line">   <span class="keyword">if</span> event == <span class="string">"total_traffic"</span> &#123;</span><br><span class="line">      onlineTimeBucket.Data[deviceId].Timer[channelId].Rcvb = trafficMap[<span class="string">"rcvb"</span>]</span><br><span class="line">      onlineTimeBucket.Data[deviceId].Timer[channelId].Rcvp = trafficMap[<span class="string">"rcvp"</span>]</span><br><span class="line">      onlineTimeBucket.Data[deviceId].Timer[channelId].Sentb = trafficMap[<span class="string">"sentb"</span>]</span><br><span class="line">      onlineTimeBucket.Data[deviceId].Timer[channelId].Sentp = trafficMap[<span class="string">"sentp"</span>]</span><br><span class="line">      onlineTimeBucket.Data[deviceId].Timer[channelId].TotalTraffIc = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">var</span> isDelete = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">if</span> trafficMap[<span class="string">"rcvb"</span>] == <span class="number">0</span> &#123;</span><br><span class="line">          <span class="comment">//当穿透的时候流量为0,并且不会保存回话,所以需要判断所有会话是否关闭  当转发的时候,流量会大于0 ,但是可能会保留回话,所以转发的时候只需要判断流量过来就可以结束</span></span><br><span class="line">          <span class="keyword">for</span> _, <span class="attr">v</span> := range onlineTimeBucket.Data[deviceId].Timer &#123;</span><br><span class="line">             <span class="keyword">if</span> v.Delete == <span class="literal">false</span> || v.TotalTraffIc == <span class="literal">false</span> &#123;</span><br><span class="line">                 isDelete = <span class="literal">false</span></span><br><span class="line">             &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> isDelete &#123;</span><br><span class="line">         onlineTimeBucket.Locker.RUnlock()</span><br><span class="line">         insertFlowLogs(deviceId)</span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      onlineTimeBucket.Data[deviceId].Timer[channelId].RefreshedFlow = time.Now().Unix()</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   onlineTimeBucket.Locker.RUnlock()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func insertFlowLogs(deviceId string) &#123;</span><br><span class="line">    log.Info(<span class="string">"start insertFlowLogs=&gt;"</span>,deviceId)</span><br><span class="line">   <span class="keyword">var</span> rcvb, rcvp, sentb, sentp int</span><br><span class="line">   <span class="keyword">var</span> end int64</span><br><span class="line">   start := time.Now().Unix()</span><br><span class="line">   <span class="keyword">for</span> _, <span class="attr">v</span> := range onlineTimeBucket.Data[deviceId].Timer &#123;</span><br><span class="line">      rcvb += v.Rcvb</span><br><span class="line">      rcvp += v.Rcvp</span><br><span class="line">      sentp += v.Sentp</span><br><span class="line">      sentb += v.Sentb</span><br><span class="line">      <span class="keyword">if</span> start &gt; v.Start &#123;</span><br><span class="line">         start = v.Start</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> end &lt; v.End &#123;</span><br><span class="line">         end = v.End</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   accountInfo := strings.Split(deviceId, <span class="string">"_"</span>)</span><br><span class="line">   <span class="keyword">if</span> len(accountInfo) &lt; <span class="number">4</span> &#123;</span><br><span class="line">      log.Info(<span class="string">"deviceId len fail "</span>, deviceId)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   err := InsertTurnServerLogs(accountInfo[<span class="number">3</span>], accountInfo[<span class="number">0</span>], accountInfo[<span class="number">1</span>], accountInfo[<span class="number">2</span>], start, end, end-start, rcvp, rcvb, sentp, sentb)</span><br><span class="line">   <span class="keyword">if</span> err != nil &#123;</span><br><span class="line">      log.Error(err)</span><br><span class="line">   &#125;</span><br><span class="line">   onlineTimeBucket.Locker.Lock()</span><br><span class="line">   onlineTimeBucket.Data[deviceId].Timer = nil</span><br><span class="line">   <span class="keyword">delete</span>(onlineTimeBucket.Data, deviceId)</span><br><span class="line">   onlineTimeBucket.Locker.Unlock()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//程序关闭时调用,,记录 使用时长</span></span><br><span class="line">func forceInsertTurnServerUseLogs() &#123;</span><br><span class="line">   onlineTimeBucket.Locker.Lock()</span><br><span class="line">   log.Info(<span class="string">"start forceInsertTurnServerUseLogs"</span>)</span><br><span class="line">   <span class="keyword">for</span> k, <span class="attr">v</span> := range onlineTimeBucket.Data &#123;</span><br><span class="line">      <span class="comment">//取其中一个的开始时间就可以</span></span><br><span class="line">      <span class="keyword">var</span> start = time.Now().Unix()</span><br><span class="line">      <span class="keyword">var</span> end = time.Now().Unix()</span><br><span class="line">      <span class="keyword">var</span> rcvb, rcvp, sentb, sentp int</span><br><span class="line">      <span class="keyword">for</span> _, <span class="attr">v</span> := range v.Timer &#123;</span><br><span class="line">         rcvb += v.Rcvb</span><br><span class="line">         rcvp += v.Rcvp</span><br><span class="line">         sentp += v.Sentp</span><br><span class="line">         sentb += v.Sentb</span><br><span class="line">         <span class="keyword">if</span> start &gt; v.Start &#123;</span><br><span class="line">            start = v.Start</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      useTime := end - start</span><br><span class="line">      accountInfo := strings.Split(k, <span class="string">"_"</span>)</span><br><span class="line">      <span class="keyword">if</span> len(accountInfo) &lt; <span class="number">4</span> &#123;</span><br><span class="line">         log.Info(<span class="string">"deviceId len fail "</span>, k)</span><br><span class="line">      &#125;</span><br><span class="line">      err := InsertTurnServerLogs(accountInfo[<span class="number">3</span>], accountInfo[<span class="number">0</span>], accountInfo[<span class="number">1</span>], accountInfo[<span class="number">2</span>], start, end, useTime, rcvp, rcvb, sentp, sentb)</span><br><span class="line">      <span class="keyword">if</span> err != nil &#123;</span><br><span class="line">         log.Error(err)</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   onlineTimeBucket.Locker.Unlock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果是穿透的话，因为没有流量，所以每次收到 total_traffic的时候，都要判断是不是所有的channel 都断开了。如果是的话，那么就是连接断开了。这时候就统计时长并且入统计。</p>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    Zach Ke
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://kebingzao.com/2018/11/15/turn-stat/" title="coturn 添加redis实现对转发流量和转发时长的统计">http://kebingzao.com/2018/11/15/turn-stat/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/turn/" rel="tag"># turn</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/11/15/turn-verify/" rel="next" title="webrtc 的 turn 服务器 coturn 的权限校验">
                <i class="fa fa-chevron-left"></i> webrtc 的 turn 服务器 coturn 的权限校验
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/11/19/vernemq-docker-cluster/" rel="prev" title="VerneMQ 使用docker进行集群部署">
                VerneMQ 使用docker进行集群部署 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="Zach Ke" />
            
              <p class="site-author-name" itemprop="name">Zach Ke</p>
              <p class="site-description motion-element" itemprop="description">做最咸的那一条</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">316</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">31</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">83</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/kebingzao" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分析"><span class="nav-number">2.</span> <span class="nav-text">分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-一次的webrtc-的turnserver-转发，其实会分配了好几个临时的-channel。"><span class="nav-number">2.1.</span> <span class="nav-text">1. 一次的webrtc 的turnserver 转发，其实会分配了好几个临时的 channel。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-每个-channel-的生命周期和对应的状态"><span class="nav-number">2.2.</span> <span class="nav-text">2. 每个 channel 的生命周期和对应的状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-流量信息"><span class="nav-number">2.3.</span> <span class="nav-text">3. 流量信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#代码实现"><span class="nav-number">3.</span> <span class="nav-text">代码实现</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zach Ke</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://zach-2.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://kebingzao.com/2018/11/15/turn-stat/';
          this.page.identifier = '2018/11/15/turn-stat/';
          this.page.title = 'coturn 添加redis实现对转发流量和转发时长的统计';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://zach-2.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  














  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.4"></script>



  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("HIV4XRdKJXB0eaFgtSjiVNaK-gzGzoHsz", "zN3v8grxW0Q8eXwNlEgXxWrF");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  



</body>
</html>
