<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <script src="/live2d-widget/live2d-widget-resource/jquery.min.js"></script>
  <link rel="stylesheet" href="/live2d-widget/live2d-widget-resource/font-awesome.min.css"/>
  <script src="/live2d-widget/autoload.js"></script>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />


















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="aws,qiniu,lambda," />










<meta name="description" content="前言去年有通过 aws 的 Lambda 服务来解决缩略图的问题： 项目使用 aws 的 lambda服务来生成s3的缩略图，不过那时候是国内七牛缩略图，国外 S3 缩略图各自的策略，他们的缩略图的 URL 是不一样的。因为我们会在用户上传图片的时候，判断这个用户的所在国家，如果是中国的话，就传到七牛那边去，否则就传到 S3。但是这边会有一个问题，就是如果我在国内传了一个图片，这时候是会传到七牛那">
<meta name="keywords" content="aws,qiniu,lambda">
<meta property="og:type" content="article">
<meta property="og:title" content="针对国内和国外的图片资源和缩略图做CDN优化">
<meta property="og:url" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/index.html">
<meta property="og:site_name" content="Zach Ke&#39;s Notes">
<meta property="og:description" content="前言去年有通过 aws 的 Lambda 服务来解决缩略图的问题： 项目使用 aws 的 lambda服务来生成s3的缩略图，不过那时候是国内七牛缩略图，国外 S3 缩略图各自的策略，他们的缩略图的 URL 是不一样的。因为我们会在用户上传图片的时候，判断这个用户的所在国家，如果是中国的话，就传到七牛那边去，否则就传到 S3。但是这边会有一个问题，就是如果我在国内传了一个图片，这时候是会传到七牛那">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/1.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/2.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/3.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/4.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/5.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/6.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/7.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/8.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/9.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/10.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/11.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/12.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/13.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/14.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/15.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/16.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/17.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/18.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/19.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/20.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/21.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/22.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/23.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/24.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/25.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/26.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/27.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/28.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/29.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/30.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/31.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/32.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/33.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/34.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/35.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/36.png">
<meta property="og:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/37.png">
<meta property="og:updated_time" content="2019-07-14T01:54:45.773Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="针对国内和国外的图片资源和缩略图做CDN优化">
<meta name="twitter:description" content="前言去年有通过 aws 的 Lambda 服务来解决缩略图的问题： 项目使用 aws 的 lambda服务来生成s3的缩略图，不过那时候是国内七牛缩略图，国外 S3 缩略图各自的策略，他们的缩略图的 URL 是不一样的。因为我们会在用户上传图片的时候，判断这个用户的所在国家，如果是中国的话，就传到七牛那边去，否则就传到 S3。但是这边会有一个问题，就是如果我在国内传了一个图片，这时候是会传到七牛那">
<meta name="twitter:image" content="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'KGVI6VPIBI',
      apiKey: '41c2ccc830ca183768a6bf1e50a03f44',
      indexName: 'test_blog',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/"/>





  <title>针对国内和国外的图片资源和缩略图做CDN优化 | Zach Ke's Notes</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <a href="https://github.com/kebingzao" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Zach Ke's Notes</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Quick notes</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zach Ke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zach Ke's Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">针对国内和国外的图片资源和缩略图做CDN优化</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-03T15:38:34+08:00">
                2019-06-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/aws-相关/" itemprop="url" rel="index">
                    <span itemprop="name">aws 相关</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/03/image-thumb-s3-qn/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/06/03/image-thumb-s3-qn/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/06/03/image-thumb-s3-qn/" class="leancloud_visitors" data-flag-title="针对国内和国外的图片资源和缩略图做CDN优化">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>去年有通过 aws 的 Lambda 服务来解决缩略图的问题： <a href="/2018/08/13/use-lambda-s3/" title="项目使用 aws 的 lambda服务来生成s3的缩略图">项目使用 aws 的 lambda服务来生成s3的缩略图</a>，不过那时候是国内七牛缩略图，国外 S3 缩略图各自的策略，他们的缩略图的 URL 是不一样的。因为我们会在用户上传图片的时候，判断这个用户的所在国家，如果是中国的话，就传到七牛那边去，否则就传到 S3。<br>但是这边会有一个问题，就是如果我在国内传了一个图片，这时候是会传到七牛那边去的，但是一旦我到国外去，访问这个图片的话，也是会访问七牛的图片（因为S3根本就没有上传，我们只上传到七牛，所以保存的也是七牛的路径），这时候线路就不会得到优化了。</p>
<h2 id="新的策略-图片CDN"><a href="#新的策略-图片CDN" class="headerlink" title="新的策略-图片CDN"></a>新的策略-图片CDN</h2><p>现在我们有另一个全球的项目，在这个项目里面，要求用户上传的所有的图片资源无论是七牛还是S3都要传一份，这个是因为考虑到用户的使用场景有可能会有跨国的问题，所以就是相当于我们对用户上传的资源做了一层 CDN ,如果用户在国内访问的话，就会去取七牛的图片，如果在国外访问的话，就会去取 cloudfront 的图片。</p>
<h2 id="图片CDN域名要一致"><a href="#图片CDN域名要一致" class="headerlink" title="图片CDN域名要一致"></a>图片CDN域名要一致</h2><p>如果要实现这种结果的话，那么无论是七牛还是S3,对外的域名肯定是同一个，比如 img.example.com, 只要用户访问 img.example.com/123.jpg ,那么这时候 DNS 解析如果是在中国的话，就会 CNAME 到七牛对应 bucket 的域名，然后获取对应路径的图片， 如果解析是国外的，那么就会 CNAME 到 cloudfront 对应的 S3 的 bucket， 然后去取对应路径的图片。<br><a id="more"></a><br>所以我们用了 AWS 的 <a href="https://aws.amazon.com/route53/" target="_blank" rel="noopener">router 53</a> 的服务，就可以实现这种针对不同地区的不同指向了。<br><blockquote><p>Amazon Route 53 是一种可用性高、可扩展性强的云域名系统 (DNS) Web 服务。<br>它的目的是为开发人员和企业提供一种非常可靠且经济高效的方式，把名称（如 <a href="http://www.example.com）转换为计算机用于互相连接的数字" target="_blank" rel="noopener">www.example.com）转换为计算机用于互相连接的数字</a> IP 地址（如 192.0.2.1），从而将最终用户路由到 Internet 应用程序。Amazon Route 53 也与 IPv6 完全兼容。</p>
<footer><strong>https://aws.amazon.com/cn/route53/?nc1=h_ls</strong></footer></blockquote><br>截图如下：<br><img src="/2019/06/03/image-thumb-s3-qn/1.png" alt="1"><br>可以看到，针对这个域名来说，如果地理位置是 CN 的话，那么会解析到七牛那边的 DNS 地址，否则就会解析到 S3 bucket 对应的 cloudfront。 接下来我们就以 img.example.com 这个域名来说。<br>对于七牛来说，其实就是建一个存放图片资源的 bucket，比如 img-example-com, 然后建立一个 CDN 加速域名，域名为 img.example.com，这样子 router 53 那边做 CNAME 解析的时候，就可以匹配上了，就可以到这个 bucket 来取数据了。<br><img src="/2019/06/03/image-thumb-s3-qn/2.png" alt="1"><br>对于 S3 来说，也是一样的处理方式，也是在 S3 上建一个存放图片资源的 bucket，比如 img-example-com，然后创建一个针对这个 S3 的 cloudfront 的 CDN, 然后把 CDN 的解析域名也指向 img.example.com， 这样子， router 53 也才可以匹配得上。<br><img src="/2019/06/03/image-thumb-s3-qn/3.png" alt="1"><br>这样子就可以了，接下来要实测一下。 我们分别往 S3 和 七牛的 bucket 上传一张相同的图片。 比如 img.example.com/123.jpg ， 然后查看是否可以访问成功。<br>因为是国内，所以默认是七牛的 CDN:<br><img src="/2019/06/03/image-thumb-s3-qn/4.png" alt="1"><br>可以看到访问成功了，这个 ip 就是七牛的某一个 CDN 的 ip：<br><img src="/2019/06/03/image-thumb-s3-qn/5.png" alt="1"><br>接下来测试 cloudfront 的情况，首先先得到这个 cloudfront 的 ip 地址，然后将 img.example.com 的 host 指向这个 ip：<br><img src="/2019/06/03/image-thumb-s3-qn/6.png" alt="1"><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">54.192.151.32 img.example.com</span><br></pre></td></tr></table></figure></p>
<p><img src="/2019/06/03/image-thumb-s3-qn/7.png" alt="1"><br>测试正常。</p>
<h2 id="缩略图域名问题"><a href="#缩略图域名问题" class="headerlink" title="缩略图域名问题"></a>缩略图域名问题</h2><p>我们已经将原图的 URL 做了一层针对不同地区的 CDN 了。但是缩略图呢？？ 我们知道无论是七牛还是S3，其实都有缩略图方案，七牛本身bucket就支持缩略图策略，S3 通过 Lambda 函数也可以实现缩略图： <a href="/2018/08/13/use-lambda-s3/" title="项目使用 aws 的 lambda服务来生成s3的缩略图">项目使用 aws 的 lambda服务来生成s3的缩略图</a>。<br>但是问题就出现在，无论是七牛的缩略图还是 S3 的缩略图，对外的路径肯定是要一样的，这个要跟原图一样，也是要有一层 CDN 的，七牛的还好，因为他的缩略图机制就是在原来的bucket上做的，但是我们之前做的 S3 通过 Lambda 函数生成缩略图是存放在另一个 bucket的。 这样就七牛和S3的缩略图的访问路径就不一样了，这样就违反了我们做 CDN 的初衷了。<br>假设我们要针对某一个功能上传的图片要做两层缩略图，一层是 10% 的缩放比，一层是 50% 的缩放比。 而且所有通过这个功能上传的图片的前缀都是一样的，比如都是 ams_store_image 这个前缀。</p>
<h3 id="七牛的缩略图"><a href="#七牛的缩略图" class="headerlink" title="七牛的缩略图"></a>七牛的缩略图</h3><p>七牛的缩略图在 <a href="/2018/08/13/use-lambda-s3/" title="项目使用 aws 的 lambda服务来生成s3的缩略图">项目使用 aws 的 lambda服务来生成s3的缩略图</a> 其实已经讲过了，就是在这个 bucket 上创建你想要的缩略图的样式。针对这两种缩略图，我们就建了两个。<br><img src="/2019/06/03/image-thumb-s3-qn/8.png" alt="1"><br>这边有预览图，我们用的是 原图按百分比缩放 的方式， 然后设置你要的缩放比例（一个是 10%, 一个是 50%）,选择的是不裁剪，不加水印，并且输出的格式跟原图一致。<br><img src="/2019/06/03/image-thumb-s3-qn/9.png" alt="1"><br><img src="/2019/06/03/image-thumb-s3-qn/10.png" alt="1"><br>然后选择默认的样式连接符是中划线。 这样就可以了，假设原图是 img.airdroid.com/123.jpg， 那么他的</p>
<ul>
<li>10% 的缩放图就是：img.airdroid.com/123.jpg-p10</li>
<li>50% 的缩略图就是：img.airdroid.com/123.jpg-p50</li>
</ul>
<p>这样子七牛创建的两种缩略图就搞定了。</p>
<h3 id="S3-的缩略图"><a href="#S3-的缩略图" class="headerlink" title="S3 的缩略图"></a>S3 的缩略图</h3><p>因为七牛的缩略图的 URL 是不能改变的，按照一定的既定规则，为了保证对外的缩略图 URL 要一致, 那么我们只能让 S3 生成的缩略图的 URL 要跟七牛的一样。<br>但是一般用 Lambda 生成缩略图，一般缩略图要放在另一个bucket，一般是 {bucket}resized 这种格式，所以我们后面生成缩略图就不能这样子了，而是要放到跟原来的bucket一样。<br>所以具体的逻辑应该是：</p>
<ol>
<li>上传文件 123.jpg 到 img-example-com bucket 触发 Lambda 事件，接下来判断这个图片的前缀和后缀是否符合我们要生成缩略图的图片，如果不存在，就跳过(事实上这一块不会在代码里面做，而是S3 触发器会帮我们做)。</li>
<li>如果符合，接下来判断 123.jpg-p10 (123.jpg-p50) 这个缩略图是否存在这个bucket，如果已经存在，说明缩略图已经有了，就跳过。</li>
<li>如果不存在，就将 123.jpg 原图下载到内存 buffer 里面，然后按照百分比进行裁剪(10% 和 50%)，重新命名为 123.jpg-p10 (123.jpg-p50)， 然后将缩略图传到源bucket里面。</li>
</ol>
<p>这样就完了，但是要注意几个细节：</p>
<ol>
<li>当我把缩略图上传到bucket的时候，一样会触发 Lambda 函数，不过因为后缀已经不符合我们的裁剪条件了，所以直接在第一步就跳过了。所以后缀的判断就很重要(S3 触发器设置)</li>
<li>前缀的判断也很重要，为了节省资源，我们只针对某些特定功能上传的图片进行裁剪，不需要对所有的上传的图片进行裁剪，所以这边要有前缀的判断，而这个前缀就需要上传的程序来指定，比如如果是通过某一个功能上传的图片，服务端全部都会在这个图片的 filename 那边加上 xxx-xxx 的前缀</li>
<li>虽然 Lambda 执行环境他有自己的临时硬盘空间，但是一旦使用了，用来存放下载的图片，裁剪完之后，一定要记得删掉。所以这次我们下载原图的时候，直接存放在内存里面就行了。后面就不用再去删掉了。</li>
</ol>
<h3 id="认识-Lambda"><a href="#认识-Lambda" class="headerlink" title="认识 Lambda"></a>认识 Lambda</h3><p>因为在去年自我上次使用 Lambda 生成缩略图之后， Lambda 这个功能也改了很多。所以我这边再重新介绍一下。具体关于 Lambda 的使用文档，可以看这边：<a href="https://docs.aws.amazon.com/zh_cn/lambda/latest/dg/welcome.html" target="_blank" rel="noopener">AWS Lambda</a><br>我这边就按照正式流程，稍微过一下(因为我是在实现了之后，再写 blog 复盘的，所以之前建的那些流程和图都没有截下来，我就简单模拟了一下流程)：</p>
<h4 id="创建一个函数"><a href="#创建一个函数" class="headerlink" title="创建一个函数"></a>创建一个函数</h4><p>进入 Lambda 后台，点击创建函数，填写函数名称，并选择运行的语言环境，这边有很多环境可以选，有 Python，nodejs， Go， Java 等等，主要看你熟悉什么语言。 我这边选择的是 Python 3.6 的运行环境。因为上次我创建的那一个 Lambda 函数的运行环境也是 Python 3.6。<br><img src="/2019/06/03/image-thumb-s3-qn/11.png" alt="1"><br>创建好了之后，界面的这样子的<br><img src="/2019/06/03/image-thumb-s3-qn/12.png" alt="1"><br>跟我去年建的不太一样的是，多了一个叫做 Layers 的东西，并且下面竟然可以直接在线编辑 Python 代码。<br><img src="/2019/06/03/image-thumb-s3-qn/13.png" alt="1"></p>
<h4 id="创建一个-layer-层"><a href="#创建一个-layer-层" class="headerlink" title="创建一个 layer 层"></a>创建一个 layer 层</h4><p>这次跟我去年创建的最大的差别就是多了一个叫做 layer 的层机制。那么这个 layer 是干啥用的。<br><blockquote><p>您可以将 Lambda 函数配置为以层的形式拉入其他代码和内容。层是包含库、自定义运行时或其他依赖项的 ZIP 存档。利用层，您可以在函数中使用库，而不必将库包含在部署程序包中。</p>
<footer><strong>https://docs.aws.amazon.com/zh_cn/lambda/latest/dg/configuration-layers.html</strong></footer></blockquote><br>说白了就是存放第三方库的地方，去年我在上传 Python 代码的时候， 真正可编辑的代码文件只有一个： <strong>CreateThumbnail.py</strong>, 其他的全部都是依赖的第三方库：<br><img src="/2019/06/03/image-thumb-s3-qn/14.png" alt="1"><br>那么这次我如果还想实现类似的功能，第三方库我就不需要再传了，而是直接创建一个包含这些第三方库的 Python layer 层就行了。<br>点击左边菜单栏的 层，然后点击右上角的创建层：<br><img src="/2019/06/03/image-thumb-s3-qn/15.png" alt="1"><br>填入相关信息，选择运行的环境为 Python 3.6，并且上传第三方 zip 包，他是有格式要求的，因为我们 Python 环境，所以最外层是 python 文件夹，里面才是各个第三方包：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python.zip</span><br><span class="line">│ python/PIL</span><br><span class="line">└ python/Pillow-5.3.0.dist-info</span><br></pre></td></tr></table></figure></p>
<p>具体可以看这个说明：<a href="https://docs.aws.amazon.com/zh_cn/lambda/latest/dg/configuration-layers.html" target="_blank" rel="noopener">在层中包括库依赖项</a><br>点击创建,这时候就多了 Python的 层。<br><img src="/2019/06/03/image-thumb-s3-qn/16.png" alt="1"><br><img src="/2019/06/03/image-thumb-s3-qn/17.png" alt="1"><br>可以看到多了一个叫做 python36PIL 的层。</p>
<h4 id="将层添加到函数"><a href="#将层添加到函数" class="headerlink" title="将层添加到函数"></a>将层添加到函数</h4><p>既然层创建好了，那么就添加到这个函数里面去：<br><img src="/2019/06/03/image-thumb-s3-qn/18.png" alt="1"><br>点击右上角的保存，这样就为这个函数添加了一个含有python 3.6 第三方包的层了。<br><img src="/2019/06/03/image-thumb-s3-qn/19.png" alt="1"></p>
<h4 id="直接在线编辑执行的那个文件"><a href="#直接在线编辑执行的那个文件" class="headerlink" title="直接在线编辑执行的那个文件"></a>直接在线编辑执行的那个文件</h4><p>既然已经有层来存放第三方库了，那么就只剩下一个入口文件了，而这个入口文件是可以直接写在这个在线编辑器的：<br><img src="/2019/06/03/image-thumb-s3-qn/20.png" alt="1"><br>当然上面是预设值。所以后面直接改成我们的执行代码就可以了，<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">from __future__ import print_function</span><br><span class="line">...</span><br><span class="line">from PIL import Image, ImageFile</span><br><span class="line">import PIL.Image</span><br><span class="line">ImageFile.LOAD_TRUNCATED_IMAGES = True</span><br><span class="line"></span><br><span class="line">def handler(event, context):</span><br><span class="line">    // do something</span><br></pre></td></tr></table></figure></p>
<p>但是这边一定要注意一个问题，因为第三方库已经放到 layer 里面了，所以我们如果要引用 layer 里面的包，比如 PIL, 这边要预设一个 python 的环境变量，从而让 Lambda 函数在执行的时候，可以在 layer 层里面找到对应的包。<br>具体文档可以看：</p>
<ul>
<li><a href="https://docs.aws.amazon.com/zh_cn/lambda/latest/dg/env_variables.html" target="_blank" rel="noopener">AWS Lambda 环境变量</a></li>
<li>关于python的执行环境变量的值，可以在这边找到：<a href="https://docs.aws.amazon.com/zh_cn/lambda/latest/dg/lambda-environment-variables.html" target="_blank" rel="noopener">适用于 Lambda 函数的环境变量</a></li>
</ul>
<p><img src="/2019/06/03/image-thumb-s3-qn/21.png" alt="1"><br>因为这个不是预设值，所以我是需要在这个函数里面手动添加的。<br><img src="/2019/06/03/image-thumb-s3-qn/22.png" alt="1"><br>这样编辑器里面的入口文件就可以正常引用 layer 层里面的第三方包了。</p>
<h4 id="添加-S3-bucket-的事件"><a href="#添加-S3-bucket-的事件" class="headerlink" title="添加 S3 bucket 的事件"></a>添加 S3 bucket 的事件</h4><p>接下来就是添加 S3 bucket 对应的触发器事件，这个跟我之前做的那个是一样的设置，只不过之前我还得跑到 S3 那边的 bucket 的配置项里面去设置，这次就直接在 Lambda 函数页面就可以配置了，很方便，不需要两地跑。<br>选择要应用的 bucket，并且选择要触发的事件，输入前缀和后缀。<br><img src="/2019/06/03/image-thumb-s3-qn/23.png" alt="1"></p>
<h4 id="设置-CloudWatch-Log-和-S3-的-ACL"><a href="#设置-CloudWatch-Log-和-S3-的-ACL" class="headerlink" title="设置 CloudWatch Log 和 S3 的 ACL"></a>设置 CloudWatch Log 和 S3 的 ACL</h4><p>这个跟之前一样，就不多说了。</p>
<h4 id="在线测试"><a href="#在线测试" class="headerlink" title="在线测试"></a>在线测试</h4><p>既然可以在线编辑入口文件逻辑，那么就可以在线进行测试了。因此我们可以自己配置一个测试事件，然后进行测试：<br><img src="/2019/06/03/image-thumb-s3-qn/24.png" alt="1"><br>创建一个简单的 test 事件。<br><img src="/2019/06/03/image-thumb-s3-qn/25.png" alt="1"><br>然后直接点击测试。就可以看到输出log了，下面的编辑器的 console 控制台也会对应输出 log：<br><img src="/2019/06/03/image-thumb-s3-qn/26.png" alt="1"><br><img src="/2019/06/03/image-thumb-s3-qn/27.png" alt="1"><br>这样子基本上一个完成的流程就演示完成了。接下来我们进入到具体的实作环境</p>
<h3 id="使用Lambda函数创建缩略图"><a href="#使用Lambda函数创建缩略图" class="headerlink" title="使用Lambda函数创建缩略图"></a>使用Lambda函数创建缩略图</h3><p>上面的操作逻辑，已经讲的很清楚了，要注意的细节也说的很清楚了。接下来就开始实作，我们这一次不选用 python 语言来写，而是选用 nodejs 来写，换一种口味。</p>
<h4 id="创建一个函数-1"><a href="#创建一个函数-1" class="headerlink" title="创建一个函数"></a>创建一个函数</h4><p>选择 node 环境为 8.1<br><img src="/2019/06/03/image-thumb-s3-qn/28.png" alt="1"></p>
<h4 id="添加层"><a href="#添加层" class="headerlink" title="添加层"></a>添加层</h4><p>添加一个层，主要是需要用到的第三方库：<br><img src="/2019/06/03/image-thumb-s3-qn/29.png" alt="1"><br>所涉及到的 package.json 如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "name": "index",</span><br><span class="line">  "version": "1.0.0",</span><br><span class="line">  "description": "",</span><br><span class="line">  "main": "index.js",</span><br><span class="line">  "dependencies": &#123;</span><br><span class="line">    "aws-sdk": "^2.462.0",</span><br><span class="line">    "async": "^3.0.0",</span><br><span class="line">    "gm": "^1.23.1",</span><br><span class="line">    "util": "^0.12.0"</span><br><span class="line">  &#125;,</span><br><span class="line">  "devDependencies": &#123;&#125;,</span><br><span class="line">  "scripts": &#123;</span><br><span class="line">    "test": "echo \"Error: no test specified\" &amp;&amp; exit 1"</span><br><span class="line">  &#125;,</span><br><span class="line">  "author": "",</span><br><span class="line">  "license": "ISC"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>简单的来说，就先本地创建一个项目，然后<strong>npm install</strong> 一下，然后再把 node_modules 目录外面再套上一层 nodejs 目录，最后打成 zip 包传上去就行了。</p>
<h4 id="写代码"><a href="#写代码" class="headerlink" title="写代码"></a>写代码</h4><p>直接在线上编辑器写代码，代码主要是参照这个官方实例，然后做些调整就行了：<a href="https://docs.aws.amazon.com/zh_cn/lambda/latest/dg/with-s3-example.html" target="_blank" rel="noopener">将 AWS Lambda 与 Amazon S3 结合使用</a><br><img src="/2019/06/03/image-thumb-s3-qn/30.png" alt="1"><br>具体代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</span><br><span class="line"><span class="keyword">var</span> AWS = <span class="built_in">require</span>(<span class="string">'aws-sdk'</span>);</span><br><span class="line"><span class="keyword">var</span> gm = <span class="built_in">require</span>(<span class="string">'gm'</span>)</span><br><span class="line">    .subClass(&#123; <span class="attr">imageMagick</span>: <span class="literal">true</span> &#125;); <span class="comment">// Enable ImageMagick integration.</span></span><br><span class="line"><span class="keyword">var</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> MAX_WIDTH  = <span class="number">100</span>;</span><br><span class="line"><span class="keyword">var</span> MAX_HEIGHT = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> s3 = <span class="keyword">new</span> AWS.S3();</span><br><span class="line"></span><br><span class="line">exports.handler = <span class="function"><span class="keyword">function</span>(<span class="params">event, context, callback</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Read options from the event.</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Reading options from event:\n"</span>, util.inspect(event, &#123;<span class="attr">depth</span>: <span class="number">5</span>&#125;));</span><br><span class="line">    <span class="keyword">var</span> srcBucket = event.Records[<span class="number">0</span>].s3.bucket.name;</span><br><span class="line">    <span class="comment">// Object key may have spaces or unicode non-ASCII characters.</span></span><br><span class="line">    <span class="keyword">var</span> srcKey    =  <span class="built_in">decodeURIComponent</span>(event.Records[<span class="number">0</span>].s3.object.key.replace(<span class="regexp">/\+/g</span>, <span class="string">" "</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Infer the image type.</span></span><br><span class="line">    <span class="keyword">var</span> typeMatch = srcKey.match(<span class="regexp">/\.([^.]*)$/</span>);</span><br><span class="line">    <span class="keyword">if</span> (!typeMatch) &#123;</span><br><span class="line">        callback(<span class="string">"Could not determine the image type."</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> imageType = typeMatch[<span class="number">1</span>].toLocaleLowerCase();</span><br><span class="line">    <span class="keyword">if</span> (imageType != <span class="string">"jpg"</span> &amp;&amp; imageType != <span class="string">"jpeg"</span> &amp;&amp;imageType != <span class="string">"png"</span> ) &#123;</span><br><span class="line">        callback(<span class="string">'Unsupported image type: $&#123;imageType&#125;'</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取环境变量</span></span><br><span class="line">    <span class="keyword">var</span> env = process.env;</span><br><span class="line">    <span class="keyword">typeof</span> env.SUFFIX_ARR === <span class="literal">undefined</span> ?  callback(<span class="string">"env variable error"</span>) : <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">var</span> suffixArr = <span class="built_in">JSON</span>.parse(env.SUFFIX_ARR);</span><br><span class="line">    <span class="keyword">var</span> separator = env.SEPARATOR;</span><br><span class="line"></span><br><span class="line">    suffixArr.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">v,i</span>)</span>&#123;</span><br><span class="line">        <span class="comment">//缩略图的key</span></span><br><span class="line">        <span class="keyword">var</span> keyWithSuffix = srcKey+separator+v;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//图片缩放的比例</span></span><br><span class="line">        <span class="keyword">var</span> ratio = v.split(<span class="string">"p"</span>)[<span class="number">1</span>];</span><br><span class="line">        ratio = <span class="built_in">parseInt</span>(ratio);</span><br><span class="line">        <span class="keyword">if</span> (ratio&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"ratio error "</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//转成百分比</span></span><br><span class="line">            ratio = ratio/<span class="number">100</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Download the image from S3, transform, and upload to a different S3 bucket.</span></span><br><span class="line">        <span class="keyword">async</span>.waterfall([</span><br><span class="line">                <span class="function"><span class="keyword">function</span> <span class="title">checkExit</span>(<span class="params">next</span>)</span>&#123;</span><br><span class="line">                    s3.getObject(&#123;</span><br><span class="line">                            Bucket: srcBucket,</span><br><span class="line">                            Key:keyWithSuffix</span><br><span class="line">                        &#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,data</span>) </span>&#123;</span><br><span class="line">                            <span class="keyword">if</span> (err)&#123;</span><br><span class="line">                                next();</span><br><span class="line">                            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                               next(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"img has exit"</span>)); </span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="function"><span class="keyword">function</span> <span class="title">download</span>(<span class="params">next</span>) </span>&#123;</span><br><span class="line">                    <span class="comment">// Download the image from S3 into a buffer.</span></span><br><span class="line">                    s3.getObject(&#123;</span><br><span class="line">                            Bucket: srcBucket,</span><br><span class="line">                            Key: srcKey</span><br><span class="line">                        &#125;,</span><br><span class="line">                        next);</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="function"><span class="keyword">function</span> <span class="title">transform</span>(<span class="params">response, next</span>) </span>&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">"transform"</span>);</span><br><span class="line">                   <span class="comment">// next(null, response.ContentType, response.Body);</span></span><br><span class="line">                    gm(response.Body).size(<span class="function"><span class="keyword">function</span>(<span class="params">err, size</span>) </span>&#123;</span><br><span class="line">                        <span class="comment">// Infer the scaling factor to avoid stretching the image unnaturally.</span></span><br><span class="line">                        <span class="built_in">console</span>.log(<span class="string">"gm debug"</span>);</span><br><span class="line">                        </span><br><span class="line">                        <span class="keyword">var</span> width  = ratio * size.width;</span><br><span class="line">                        <span class="keyword">var</span> height = ratio * size.height;</span><br><span class="line">                        <span class="built_in">console</span>.log(<span class="string">"resize"</span>);</span><br><span class="line">                        <span class="comment">// Transform the image buffer in memory.</span></span><br><span class="line">                        <span class="keyword">this</span>.resize(width, height)</span><br><span class="line">                            .toBuffer(imageType, <span class="function"><span class="keyword">function</span>(<span class="params">err, buffer</span>) </span>&#123;</span><br><span class="line">                                <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                                   <span class="built_in">console</span>.log(<span class="string">"resize fail"</span>)</span><br><span class="line">                                    next(err);</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                      <span class="built_in">console</span>.log(<span class="string">"resize success"</span>)</span><br><span class="line">                                    next(<span class="literal">null</span>, response.ContentType, buffer);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;);</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params">contentType, data, next</span>) </span>&#123;</span><br><span class="line">                    <span class="comment">// Stream the transformed image to a different S3 bucket.</span></span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">"upload to s3"</span>)</span><br><span class="line">                    s3.putObject(&#123;</span><br><span class="line">                            Bucket: srcBucket,</span><br><span class="line">                            Key: keyWithSuffix,</span><br><span class="line">                            Body: data,</span><br><span class="line">                            ContentType: contentType</span><br><span class="line">                        &#125;,</span><br><span class="line">                        next);</span><br><span class="line">                &#125;</span><br><span class="line">            ], <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                    <span class="built_in">console</span>.error(</span><br><span class="line">                        <span class="string">'Unable to resize '</span> + srcBucket + <span class="string">'/'</span> + srcKey +</span><br><span class="line">                        <span class="string">' and upload to '</span> + srcBucket + <span class="string">'/'</span> + keyWithSuffix +</span><br><span class="line">                        <span class="string">' due to an error: '</span> + err</span><br><span class="line">                    );</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(</span><br><span class="line">                        <span class="string">'Successfully resized '</span> + srcBucket + <span class="string">'/'</span> + srcKey +</span><br><span class="line">                        <span class="string">' and uploaded to '</span> + srcBucket + <span class="string">'/'</span> +keyWithSuffix</span><br><span class="line">                    );</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                callback(<span class="literal">null</span>, <span class="string">"message"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>逻辑就不多说了，就跟我上面分析的逻辑一样，不过要注意几个东西，尤其是环境变量，这边要设置几个环境变量：<br><img src="/2019/06/03/image-thumb-s3-qn/31.png" alt="1"><br>NODE_PATH 就不用多说了，因为要引用 layer 里面的库，那么就要设置 node path，这边主要讲另外两个，</p>
<ul>
<li>SEPARATOR 这个就是分隔符，因为要跟七牛的缩略图的格式一样，所以这边也要设置中划线的分隔符</li>
<li>SUFFIX_ARR 后缀数组，其实就是要生成的缩略图的比例，这个是一个数组，<strong>[“p10”,”p50”]</strong>，一样为了跟七牛的格式一致，所以后缀名也要一样，然后将缩放比例也隐藏在后缀名里面，其实就是后两位</li>
</ul>
<h4 id="接下来添加对应-S3-bucket的事件"><a href="#接下来添加对应-S3-bucket的事件" class="headerlink" title="接下来添加对应 S3 bucket的事件"></a>接下来添加对应 S3 bucket的事件</h4><p>针对 jpg， jpeg， png， 这三种图片格式，并且是有设置前缀的。<br><img src="/2019/06/03/image-thumb-s3-qn/32.png" alt="1"></p>
<h4 id="设置超时时间"><a href="#设置超时时间" class="headerlink" title="设置超时时间"></a>设置超时时间</h4><p>之前的时间是 3s，担心对于大图片有时候会超时，所以就设置成长一点，加了一分钟：<br><img src="/2019/06/03/image-thumb-s3-qn/33.png" alt="1"></p>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>全部配好了，接下来就是测试了，我们创建一个测试事件，因为我们是依赖 S3 的 put 事件，所以我们就创建了一个基于 Amazon S3 Put 的事件：<br><img src="/2019/06/03/image-thumb-s3-qn/34.png" alt="1"><br>然后要修改一下，找到这个 bucket 的某一张图片，填对对应的值：<br><img src="/2019/06/03/image-thumb-s3-qn/35.png" alt="1"><br>对应的数据要去 bucket 里面对应的资源去拿：<br><img src="/2019/06/03/image-thumb-s3-qn/36.png" alt="1"><br>接下来开始测试：点击测试，就会开始触发 S3 的 PUT，然后就会开始触发我们的函数，就会针对这个图片文件进行分析和处理：<br><img src="/2019/06/03/image-thumb-s3-qn/37.png" alt="1"><br>当然编辑器下面的console也会输出log，这两个 log 是一样的，所以我只贴一份， 而且因为这个文件之前就被我们测试过了，所以缩略图已经在bucket存在了，所以就会返回<strong>img has exist</strong>, 所以这个测试是对的。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过以上对 S3 Lambda 的处理，我们就可以将 S3 的缩略图处理的跟七牛的缩略图的路径一样，就跟原图一样， 从而实现缩略图的基于不同地区的 CDN 路由解析。从而大大的提高了访问速度。<br>不过要注意一点的是，S3 的 Lambda 函数处理毕竟是需要时间的，所以有时候，一上传之后，马上就访问缩略图，这时候这个缩略图路径是不存在的，会报错误，所以要等一会儿再请求才能请求的到。</p>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    Zach Ke
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://kebingzao.com/2019/06/03/image-thumb-s3-qn/" title="针对国内和国外的图片资源和缩略图做CDN优化">http://kebingzao.com/2019/06/03/image-thumb-s3-qn/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/aws/" rel="tag"># aws</a>
          
            <a href="/tags/qiniu/" rel="tag"># qiniu</a>
          
            <a href="/tags/lambda/" rel="tag"># lambda</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/05/31/site-build-use-cos/" rel="next" title="站点加载速度优化，国内采用腾讯云COS存放">
                <i class="fa fa-chevron-left"></i> 站点加载速度优化，国内采用腾讯云COS存放
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/06/05/aws-ses-sns/" rel="prev" title="AWS 的邮件发送服务 SES 订阅 SNS 来处理硬反弹邮件">
                AWS 的邮件发送服务 SES 订阅 SNS 来处理硬反弹邮件 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="Zach Ke" />
            
              <p class="site-author-name" itemprop="name">Zach Ke</p>
              <p class="site-description motion-element" itemprop="description">做最咸的那一条</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">291</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">28</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">72</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/kebingzao" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#新的策略-图片CDN"><span class="nav-number">2.</span> <span class="nav-text">新的策略-图片CDN</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#图片CDN域名要一致"><span class="nav-number">3.</span> <span class="nav-text">图片CDN域名要一致</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#缩略图域名问题"><span class="nav-number">4.</span> <span class="nav-text">缩略图域名问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#七牛的缩略图"><span class="nav-number">4.1.</span> <span class="nav-text">七牛的缩略图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#S3-的缩略图"><span class="nav-number">4.2.</span> <span class="nav-text">S3 的缩略图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#认识-Lambda"><span class="nav-number">4.3.</span> <span class="nav-text">认识 Lambda</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建一个函数"><span class="nav-number">4.3.1.</span> <span class="nav-text">创建一个函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建一个-layer-层"><span class="nav-number">4.3.2.</span> <span class="nav-text">创建一个 layer 层</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#将层添加到函数"><span class="nav-number">4.3.3.</span> <span class="nav-text">将层添加到函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#直接在线编辑执行的那个文件"><span class="nav-number">4.3.4.</span> <span class="nav-text">直接在线编辑执行的那个文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#添加-S3-bucket-的事件"><span class="nav-number">4.3.5.</span> <span class="nav-text">添加 S3 bucket 的事件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#设置-CloudWatch-Log-和-S3-的-ACL"><span class="nav-number">4.3.6.</span> <span class="nav-text">设置 CloudWatch Log 和 S3 的 ACL</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#在线测试"><span class="nav-number">4.3.7.</span> <span class="nav-text">在线测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用Lambda函数创建缩略图"><span class="nav-number">4.4.</span> <span class="nav-text">使用Lambda函数创建缩略图</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建一个函数-1"><span class="nav-number">4.4.1.</span> <span class="nav-text">创建一个函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#添加层"><span class="nav-number">4.4.2.</span> <span class="nav-text">添加层</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#写代码"><span class="nav-number">4.4.3.</span> <span class="nav-text">写代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#接下来添加对应-S3-bucket的事件"><span class="nav-number">4.4.4.</span> <span class="nav-text">接下来添加对应 S3 bucket的事件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#设置超时时间"><span class="nav-number">4.4.5.</span> <span class="nav-text">设置超时时间</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#测试"><span class="nav-number">4.4.6.</span> <span class="nav-text">测试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">5.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zach Ke</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://zach-2.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://kebingzao.com/2019/06/03/image-thumb-s3-qn/';
          this.page.identifier = '2019/06/03/image-thumb-s3-qn/';
          this.page.title = '针对国内和国外的图片资源和缩略图做CDN优化';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://zach-2.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  














  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.4"></script>



  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("HIV4XRdKJXB0eaFgtSjiVNaK-gzGzoHsz", "zN3v8grxW0Q8eXwNlEgXxWrF");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  



</body>
</html>
