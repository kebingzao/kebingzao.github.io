<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="js,浏览器插件,Chrome 插件,Firefox 插件,Safari 插件," />










<meta name="description" content="前言这个插件开发最难的地方就是消息通信的事件驱动模型。而事件驱动模型，在这个项目可以分为3部分：  前端页面调用背景页AirDroid对象的方法（比如调用登录方法） 前端页面监听一个事件（监听登录成功事件），背景页触发这个事件 背景页监听一个事件（监听登录成功事件），背景页和前端页面都触发这个事件  其中不同的浏览器有不同的实现方法，主要代码在前端的 base.js 和 背景页的 event.js">
<meta name="keywords" content="js,浏览器插件,Chrome 插件,Firefox 插件,Safari 插件">
<meta property="og:type" content="article">
<meta property="og:title" content="浏览器 extension 插件开发系列(10) -- 事件驱动模型">
<meta property="og:url" content="http://kebingzao.com/2019/11/25/browser-extension-10/index.html">
<meta property="og:site_name" content="Zach Ke&#39;s Notes">
<meta property="og:description" content="前言这个插件开发最难的地方就是消息通信的事件驱动模型。而事件驱动模型，在这个项目可以分为3部分：  前端页面调用背景页AirDroid对象的方法（比如调用登录方法） 前端页面监听一个事件（监听登录成功事件），背景页触发这个事件 背景页监听一个事件（监听登录成功事件），背景页和前端页面都触发这个事件  其中不同的浏览器有不同的实现方法，主要代码在前端的 base.js 和 背景页的 event.js">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2020-02-20T16:35:39.037Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="浏览器 extension 插件开发系列(10) -- 事件驱动模型">
<meta name="twitter:description" content="前言这个插件开发最难的地方就是消息通信的事件驱动模型。而事件驱动模型，在这个项目可以分为3部分：  前端页面调用背景页AirDroid对象的方法（比如调用登录方法） 前端页面监听一个事件（监听登录成功事件），背景页触发这个事件 背景页监听一个事件（监听登录成功事件），背景页和前端页面都触发这个事件  其中不同的浏览器有不同的实现方法，主要代码在前端的 base.js 和 背景页的 event.js">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'KGVI6VPIBI',
      apiKey: '41c2ccc830ca183768a6bf1e50a03f44',
      indexName: 'test_blog',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://kebingzao.com/2019/11/25/browser-extension-10/"/>





  <title>浏览器 extension 插件开发系列(10) -- 事件驱动模型 | Zach Ke's Notes</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Zach Ke's Notes</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Quick notes</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kebingzao.com/2019/11/25/browser-extension-10/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zach Ke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zach Ke's Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">浏览器 extension 插件开发系列(10) -- 事件驱动模型</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-25T13:28:10+08:00">
                2019-11-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/前端相关/" itemprop="url" rel="index">
                    <span itemprop="name">前端相关</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/前端相关/浏览器-extension-插件开发系列/" itemprop="url" rel="index">
                    <span itemprop="name">浏览器 extension 插件开发系列</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/25/browser-extension-10/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/11/25/browser-extension-10/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/11/25/browser-extension-10/" class="leancloud_visitors" data-flag-title="浏览器 extension 插件开发系列(10) -- 事件驱动模型">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这个插件开发最难的地方就是消息通信的事件驱动模型。而事件驱动模型，在这个项目可以分为3部分：</p>
<ol>
<li>前端页面调用背景页AirDroid对象的方法（比如调用登录方法）</li>
<li>前端页面监听一个事件（监听登录成功事件），背景页触发这个事件</li>
<li>背景页监听一个事件（监听登录成功事件），背景页和前端页面都触发这个事件</li>
</ol>
<p>其中不同的浏览器有不同的实现方法，主要代码在前端的 <code>base.js</code> 和 背景页的 <code>event.js</code>, 其中 <code>base.js</code> 在<a href="/2019/11/25/browser-extension-9/" title="浏览器 extension 插件开发系列(09) -- popup以及其他前端页面的启动">浏览器 extension 插件开发系列(09) -- popup以及其他前端页面的启动</a> 已经分析了一部分，接下来我们结合以上三种情况来分析 <code>event.js</code>。<br><a id="more"></a></p>
<h2 id="1-前端页面调用背景页AirDroid对象的方法"><a href="#1-前端页面调用背景页AirDroid对象的方法" class="headerlink" title="1.前端页面调用背景页AirDroid对象的方法"></a>1.前端页面调用背景页AirDroid对象的方法</h2><p>这个在 <a href="/2019/11/25/browser-extension-7/" title="浏览器 extension 插件开发系列(07) -- 获取各浏览器端的背景页">浏览器 extension 插件开发系列(07) -- 获取各浏览器端的背景页</a> 已经讲了一些了，我们这一节做更详细的分析。</p>
<h3 id="1-1-Chrome-浏览器"><a href="#1-1-Chrome-浏览器" class="headerlink" title="1.1 Chrome 浏览器"></a>1.1 Chrome 浏览器</h3><p>在<code>Chrome</code>中，可以直接通过<code>chrome.extension.getBackgroundPage()</code> 获取背景页的<code>window对象</code>。因此可以直接通过这个<code>window对象</code>来调用这个上下文环境的方法，比如调用登录方法:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bg = chrome.extension.getBackgroundPage();</span><br><span class="line">bg.Airdroid.Account.signIn(mail, pwd);</span><br></pre></td></tr></table></figure></p>
<h3 id="1-2-Safari-浏览器"><a href="#1-2-Safari-浏览器" class="headerlink" title="1.2 Safari 浏览器"></a>1.2 Safari 浏览器</h3><p>Safari 有两种情况:</p>
<ol>
<li><p>一种情况是<code>popup</code>页面，这个页面的处理方式跟<code>Chrome</code>的很像，就是可以直接获取后台的<code>window对象</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bg = safari.extension.globalPage.contentWindow;</span><br><span class="line">bg.Airdroid.Account.signIn(mail, pwd);</span><br></pre></td></tr></table></figure>
</li>
<li><p>另一种情况就是其他页面，比如<code>消息过来的回复页面（reply）</code>，这种不是<code>popup</code>页面的页面，是获取不到背景页的上下文环境。</p>
</li>
</ol>
<p>只能通过监听，触发的方式来传数据。 即如果我要在<code>reply页面</code>调用一个<code>背景页server对象</code>的<code>回复接口sendIMMsg</code>,那么我必须要去触发一个<code>sendIMMsg_event</code> 事件，并监听一个叫<code>sendIMMsg_event_done</code>的数据回调事件，然后背景页这边本来就有监听这个<code>sendIMMsg_event</code>的事件，当背景页监听事件被触发之后，执行完逻辑之后（即执行<code>sendIMMsg</code>这个方法），就会反过来触发<code>sendIMMsg_event_done</code>这个事件，从而在前端页面得到这个事件的回调。</p>
<p>也就是如果我要触发背景页的一个对象的方法，那么在前端页面要监听一个事件，并要触发另一个事件:<br>前端页面代码:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 监听成功和失败事件</span></span><br><span class="line">safari.self.addEventListener(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">   <span class="keyword">var</span> eventName = e.name;</span><br><span class="line">   <span class="keyword">if</span>(eventName == <span class="string">'sendIMMsg_event_done'</span>)&#123;</span><br><span class="line">       <span class="comment">// sendIMMsg 这个方法在后台执行成功的回调</span></span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span>(eventName == <span class="string">'sendIMMsg_event_fail'</span>)&#123;</span><br><span class="line">       <span class="comment">// sendIMMsg 这个方法在后台执行失败的回调</span></span><br><span class="line">   &#125;                    </span><br><span class="line">&#125;, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 触发这个事件</span></span><br><span class="line">safari.self.tab.dispatchMessage(<span class="string">'sendIMMsg_event'</span>,&#123;</span><br><span class="line">   arg: agruments</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>而背景页的代码如下:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 监听前端过来的事件</span></span><br><span class="line">safari.application.addEventListener(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">     <span class="keyword">if</span>(e.name == <span class="string">'sendIMMsg_event'</span>)&#123;</span><br><span class="line">         <span class="keyword">var</span> arg = e.message.arg;</span><br><span class="line">         <span class="comment">// 开始执行真正的sendIMMsg方法</span></span><br><span class="line">         Airdroid.Server.sendIMMsg.apply(<span class="literal">null</span>, arg).done(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">               <span class="comment">// 调用成功, 触发sendIMMsg_event_done方法，把结果带过去</span></span><br><span class="line">               e.target.page.dispatchMessage(<span class="string">'sendIMMsg_event_done'</span>,data);</span><br><span class="line">         &#125;).fail(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">              <span class="comment">// 调用失败, 触发sendIMMsg_event_fail方法，把结果带过去</span></span><br><span class="line">               e.target.page.dispatchMessage(<span class="string">'sendIMMsg_event_fail'</span>,data);</span><br><span class="line">         &#125;)</span><br><span class="line">     &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>大概就是这样，从而形成一个闭环。</p>
<ol>
<li>前端触发<code>sendIMMsg_event</code></li>
<li>背景页收到<code>sendIMMsg_event</code>事件，并执行真正的<code>sendIMMsg</code>方法, 并返回方法的done对象</li>
<li>再触发到前端页面所监听的<code>done</code>和<code>fail</code>方法，并把结果带过去。</li>
<li>前端页面触发这个 done 的方法，并且对背景页带过来的结果值进行处理</li>
</ol>
<p>通过这个可以看到，其实前端页面只是想调用一个背景页的方法而已，但是过程却变得非常复杂。如果想调用十个，甚至几十个，那不是代码要写死了。而且通过这个例子可以看到，要调用的背景页的方法都要返回<code>defer</code>对象，这样才会有回调结果。</p>
<p>接下来我们优化这个流程，思路如下：</p>
<p>因为前端页面有可能调用Airdroid变量内的任何一个方法。 所以首先刚开始的时候，就要把背景页的Airdroid对象传过去。而且因为我们是通过 <code>e.target.page.dispatchMessage( event , data);</code> 来传递数据的。这个data不能太复杂，有两个局限性，一个是<code>function</code>方法带不过来，另一个是太复杂的对象也是传不过来，有了这两个限制，因此对象里面的<code>function</code>根本没法传过去。</p>
<p>为了解决这个问题，我们又重新<code>fake</code>了一个<code>Airdroid对象</code>，并把里面的<code>function</code>全部去掉，但是有新增了<code>funListenerObjs</code>对象。里面就是把要去掉的<code>function</code>的名字弄成一个唯一值。并放到这个<code>map</code>里面。同时把这个唯一值作为<code>key</code>，<code>function</code>的方法体作为<code>value</code>，放到一个全局的<code>window.funObjectObj</code>对象里面。以便后面如果前端页面要调用这个方法的时候，可以从这个<code>全局map</code>里面得到这个唯一值的方法体并执行。</p>
<p>部分代码如下: <code>event.js</code>:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 存放方法的唯一值和对应的方法提</span></span><br><span class="line"><span class="built_in">window</span>.funObjectObj = [];</span><br><span class="line"><span class="comment">// 过滤出函数</span></span><br><span class="line">self.addHandleTriggerToFrontInSafari(Airdroid);</span><br><span class="line"><span class="comment">// 接下来把函数去掉，并传入一个复制体</span></span><br><span class="line"><span class="comment">// 首先把Airdroid克隆一份</span></span><br><span class="line"><span class="keyword">var</span> fakeAirdroid = $.extend(<span class="literal">true</span>,&#123;&#125;, Airdroid);</span><br><span class="line"><span class="keyword">var</span> removeFunction = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>)</span>&#123;</span><br><span class="line">    _.each(obj,<span class="function"><span class="keyword">function</span>(<span class="params">value,key</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(_.isFunction(value))&#123;</span><br><span class="line">            <span class="keyword">delete</span> obj[key];</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(_.isObject(value))&#123;</span><br><span class="line">            removeFunction(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;;</span><br><span class="line">removeFunction(fakeAirdroid);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"airdroid==&gt;"</span> + <span class="built_in">JSON</span>.stringify(fakeAirdroid));</span><br><span class="line"><span class="comment">// 这边要监听来自非popup页面的数据传递，比如 reply，option 这种单独的页面</span></span><br><span class="line">safari.application.addEventListener(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"函数调用过来了，名字为："</span> + e.name);</span><br><span class="line">    <span class="comment">// 针对这些页面的数据初始化，这些页面不像popup这种页面可以直接访问后台的全局数据，而是必须要将数据进行传递</span></span><br><span class="line">    <span class="keyword">if</span> (e.name == <span class="string">'page_init'</span>) &#123;</span><br><span class="line">        <span class="comment">// todo 这边不能直接把Airdroid这个变量传递过去，数据量会太大，</span></span><br><span class="line">        <span class="comment">// todo 因此只能像firefox那样，如果是函数就用字符串来替换, 而且这边还要转化成字符串，不然会出现对象复制不了的情况</span></span><br><span class="line">        e.target.page.dispatchMessage(<span class="string">'page_data'</span>, <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">            <span class="string">"Airdroid"</span>: fakeAirdroid</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// 接下来就是执行那些函数了</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">window</span>.funObjectObj[e.name])&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"开始执行传过来的函数"</span>);</span><br><span class="line">            <span class="keyword">var</span> result = e.message;</span><br><span class="line">            <span class="comment">// 真正的参数,而且是argument的形式</span></span><br><span class="line">            <span class="keyword">var</span> arg = result.arg;</span><br><span class="line">            <span class="comment">// 如果有回调，就触发调用 这边已经绑定了上下文环境了，所以这边直接为null即可</span></span><br><span class="line">            <span class="keyword">var</span> funResult = <span class="built_in">window</span>.funObjectObj[e.name].apply(<span class="literal">null</span>,arg);</span><br><span class="line">            <span class="comment">// 判断是否是Deferred对象</span></span><br><span class="line">            <span class="keyword">if</span>(_.isFunction(funResult.done))&#123;</span><br><span class="line">                funResult.done(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">                    result.done &amp;&amp; e.target.page.dispatchMessage(result.done,data);</span><br><span class="line">                &#125;).fail(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">                    result.fail &amp;&amp; e.target.page.dispatchMessage(result.fail,data);</span><br><span class="line">                &#125;).always(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">                    result.always &amp;&amp; e.target.page.dispatchMessage(result.always,data);</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">// 返回return的</span></span><br><span class="line">                result.done &amp;&amp; e.target.page.dispatchMessage(result.done,funResult);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure></p>
<p>然后过滤的这个方法如下： <code>addHandleTriggerToFrontInSafari</code>:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 跟非popover页面通信，比如reply页面的时候，兼容chrome和firefox，让其可以像popover那样，可以直接调用后台的函数(这里的后台函数必须要defer形式)</span></span><br><span class="line"><span class="comment">// todo 这边禁止一种用法，就是数组里面的项不能是函数，不然会有问题</span></span><br><span class="line">addHandleTriggerToFrontInSafari: <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">if</span>(Airdroid.Util.Browser.safari)&#123;</span><br><span class="line">        <span class="keyword">if</span>(_.isObject(obj))&#123;</span><br><span class="line">            _.each(obj,<span class="function"><span class="keyword">function</span>(<span class="params">value,key</span>)</span>&#123;</span><br><span class="line">                <span class="comment">// 如果是函数，就保留，并监听，设置一个唯一值</span></span><br><span class="line">                <span class="keyword">if</span>(_.isFunction(value))&#123;</span><br><span class="line">                    obj.funListenerObjs = obj.funListenerObjs || &#123;&#125;;</span><br><span class="line">                    <span class="keyword">var</span> uniqFunId = _.uniqueId(<span class="string">"fun_"</span>);</span><br><span class="line">                    <span class="comment">// 加入监听队列，并监听</span></span><br><span class="line">                    obj.funListenerObjs[key] = uniqFunId;</span><br><span class="line">                    <span class="comment">// 加入window对象，并绑定执行上下文</span></span><br><span class="line">                    <span class="built_in">window</span>.funObjectObj[uniqFunId] = value.bind(obj);</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(_.isObject(value))&#123;</span><br><span class="line">                    self.addHandleTriggerToFrontInSafari(value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>通过这个方式，就可以看到，如果本来 <code>Airdroid对象</code> 长这样：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Airdroid = &#123;</span><br><span class="line">     name: <span class="string">'xxx'</span>,</span><br><span class="line">     server: &#123;</span><br><span class="line">         baseUrl: <span class="string">'http://xxx.airdroid.com'</span>,</span><br><span class="line">         sendMsg: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="comment">// 发送消息</span></span><br><span class="line">         &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     account: &#123;</span><br><span class="line">         username: <span class="string">'kkk'</span>,</span><br><span class="line">         signIn: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">           <span class="comment">// 登录操作 </span></span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>那么经过上述 <code>addHandleTriggerToFrontInSafari</code> 和 <code>fake</code> 和 <code>removeFunction</code> 操作，就会变成:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">fakeAirdroid = &#123;</span><br><span class="line">     name: <span class="string">'xxx'</span>,</span><br><span class="line">     server: &#123;</span><br><span class="line">         baseUrl: <span class="string">'http://server.airdroid.com'</span>,</span><br><span class="line">         funListenerObjs: &#123;</span><br><span class="line">             sendMsg: <span class="string">'fun_1'</span></span><br><span class="line">         &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     account: &#123;</span><br><span class="line">         username: <span class="string">'kkk'</span>,</span><br><span class="line">          funListenerObjs: &#123;</span><br><span class="line">            signIn: <span class="string">'fun_2'</span></span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后全局的<code>funObjectObj</code>为:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.funObjectObj = &#123;</span><br><span class="line">     <span class="string">'fun_1'</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="comment">// 发送消息</span></span><br><span class="line">     &#125;,</span><br><span class="line">      <span class="string">'fun_2'</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="comment">// // 登录操作</span></span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>fakeAirdroid</code> 里面已经没有函数了，每一个有函数的对象底下都有一个叫<code>funListenerObjs</code>的对象，里面就是<code>{key,value} =&gt; {对应的函数名，对应函数名的唯一值}</code>, 而全局对象<code>window.funObjectObj</code>也会有这个结构 <code>{key, value} =&gt; {某一个函数的唯一值,  这个唯一值所对应函数的函数体}</code>。</p>
<p>那么这样做有什么好处呢？</p>
<p>第一个是，有了<code>fakeAirdroid对象</code>，那么就可以通过 <code>e.target.page.dispatchMessage( event , data);</code>  这种方式把<code>Airdroid对象</code>传到前端页面:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">e.target.page.dispatchMessage(<span class="string">'page_data'</span>, <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">      <span class="string">"Airdroid"</span>: fakeAirdroid</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure></p>
<p>这样子前端页面也有了<code>Airdroid对象</code>了。那么是不是也可以跟<code>Chrome</code>一样，直接在通过这个<code>Airdroid对象</code>调用背景页的方法呢？ 显然是不行的。因为这个<code>Airdroid对象</code>其实跟<code>背景页的Airdroid对象</code>不是同一个，是一个<code>fake</code> 的对象，而且还差很多，因为它没有任何的<code>function</code>方法。</p>
<p>那么要怎么做到让这个<code>Airdroid对象</code>跟在<code>Chrome</code>浏览器一样，可以直接用 <code>Airdroid.acccount.signIn</code> 直接调用背景页的登录方法呢？ 这个秘诀其实就是在前端页面的js，<code>base.js</code> 中的<code>setUpBackground</code>方法中处理的:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">init: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>, args = <span class="built_in">arguments</span>;</span><br><span class="line">    $(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 这时候要根据浏览器来获取背景对象</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">window</span>.chrome) &#123;</span><br><span class="line">            <span class="comment">// chrome</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">window</span>.safari) &#123;</span><br><span class="line">            <span class="comment">// 如果是 popup这种 popover页面，那么可以直接访问后台的全局变量</span></span><br><span class="line">            <span class="keyword">if</span> (safari.extension.globalPage) &#123;</span><br><span class="line">                <span class="keyword">var</span> gp = safari.extension.globalPage.contentWindow;</span><br><span class="line">                self.setUpBackgroundPage(gp);</span><br><span class="line">                self.inited(args);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 其他的，像 reply 这种新建的窗体，就只能用数据传输的方式</span></span><br><span class="line">                safari.self.addEventListener(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">var</span> eventName = e.name;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">"消息过来了，名字为："</span> + eventName);</span><br><span class="line">                    <span class="keyword">if</span> (eventName == <span class="string">'page_data'</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> proxy = safari.self.tab;</span><br><span class="line">                        e.message = _.isString(e.message) ? <span class="built_in">JSON</span>.parse(e.message) : e.message;</span><br><span class="line">                        self.setUpBackgroundPage(e.message, proxy.dispatchMessage);</span><br><span class="line">                        self.inited(args);</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        <span class="keyword">if</span>(self.funCbObj[eventName])&#123;</span><br><span class="line">                            self.funCbObj[eventName](e.message);</span><br><span class="line">                            <span class="keyword">delete</span> self.funCbObj[eventName];</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="literal">false</span>);</span><br><span class="line">                safari.self.tab.dispatchMessage(<span class="string">'page_init'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// firefox</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置背景对象</span></span><br><span class="line">setUpBackgroundPage: <span class="function"><span class="keyword">function</span>(<span class="params">data, dispatcher</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">this</span>.Airdroid = data.Airdroid;</span><br><span class="line">    <span class="built_in">window</span>.Airdroid = <span class="keyword">this</span>.Airdroid;</span><br><span class="line">    <span class="comment">// 事件对象</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">window</span>.chrome)&#123;</span><br><span class="line">        <span class="comment">// chrome</span></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">window</span>.safari)&#123;</span><br><span class="line">        <span class="keyword">this</span>.eventObj = data;</span><br><span class="line">        <span class="keyword">if</span>(dispatcher)&#123;</span><br><span class="line">            <span class="comment">// 说明是非popover页面</span></span><br><span class="line">            <span class="comment">// 同时要绑定对应的事件触发器</span></span><br><span class="line">            <span class="keyword">var</span> addSafariTriggerHandle = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(obj.funListenerObjs)&#123;</span><br><span class="line">                    _.each(obj.funListenerObjs,<span class="function"><span class="keyword">function</span>(<span class="params">funId,name</span>)</span>&#123;</span><br><span class="line">                        <span class="comment">// 重新定义函数</span></span><br><span class="line">                        obj[name] = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                            <span class="built_in">console</span>.log(<span class="string">"调用函数，函数名为%s, id为 %s"</span>, name, funId);</span><br><span class="line">                            <span class="keyword">var</span> defer = $.Deferred();</span><br><span class="line">                            <span class="comment">// 加入回调队列</span></span><br><span class="line">                            <span class="keyword">var</span> deferDoneId = _.uniqueId(<span class="string">"defer_done_"</span> + name + <span class="string">"_"</span>);</span><br><span class="line">                            <span class="keyword">var</span> deferFailId = _.uniqueId(<span class="string">"defer_fail_"</span> + name + <span class="string">"_"</span>);</span><br><span class="line">                            self.funCbObj[deferDoneId] = <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">                                self.log(deferDoneId);</span><br><span class="line">                                defer.resolve(data);</span><br><span class="line">                            &#125;;</span><br><span class="line">                            self.funCbObj[deferFailId] = <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">                                self.log(deferDoneId);</span><br><span class="line">                                defer.resolve(data);</span><br><span class="line">                            &#125;;</span><br><span class="line">                            <span class="built_in">console</span>.log(<span class="string">"参数为＝＝》"</span> + <span class="built_in">JSON</span>.stringify(<span class="built_in">Array</span>.prototype.slice.apply(<span class="built_in">arguments</span>)))</span><br><span class="line">                            <span class="comment">// 触发函数</span></span><br><span class="line">                            safari.self.tab.dispatchMessage(funId,&#123;</span><br><span class="line">                                arg: <span class="built_in">Array</span>.prototype.slice.apply(<span class="built_in">arguments</span>),</span><br><span class="line">                                done: deferDoneId,</span><br><span class="line">                                fail: deferFailId</span><br><span class="line">                            &#125;);</span><br><span class="line">                            <span class="keyword">return</span> defer;</span><br><span class="line">                        &#125;;</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;</span><br><span class="line">                _.each(obj,<span class="function"><span class="keyword">function</span>(<span class="params">value,key</span>)</span>&#123;</span><br><span class="line">                    <span class="keyword">if</span>(_.isObject(value))&#123;</span><br><span class="line">                        addSafariTriggerHandle(value);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;;</span><br><span class="line">            addSafariTriggerHandle(<span class="keyword">this</span>.Airdroid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// firefox</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.util= <span class="keyword">this</span>.Airdroid.Util;</span><br><span class="line">    <span class="keyword">this</span>.server = <span class="keyword">this</span>.Airdroid.Server;</span><br><span class="line">    <span class="keyword">this</span>.account = <span class="keyword">this</span>.Airdroid.Account;</span><br><span class="line">    <span class="keyword">this</span>.EventType = <span class="keyword">this</span>.Airdroid.Event.TYPE;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>从上述代码可以看到，在前端页面的<code>document.ready</code> 事件中。会去触发 <code>safari.self.tab.dispatchMessage(&#39;page_init&#39;);</code> 这个事件，让背景页把<code>Airdroid对象</code>传过来, 这时候背景页的监听就会把<code>fakeAirdroid</code>传到前端，然后前端再调用<code>setUpBackgroundPage</code>进行设置.</p>
<p>判断一个页面是否是<code>Safari</code>的<code>非popup页面</code>，就看有没有 <code>safari.extension.globalPage</code> 这个对象。 所以背景页 <code>event.js</code> 的代码如下:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">safari.application.addEventListener(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"函数调用过来了，名字为："</span> + e.name);</span><br><span class="line">    <span class="comment">// 针对这些页面的数据初始化，这些页面不像popup这种页面可以直接访问后台的全局数据，而是必须要将数据进行传递</span></span><br><span class="line">    <span class="keyword">if</span> (e.name == <span class="string">'page_init'</span>) &#123;</span><br><span class="line">        <span class="comment">// todo 这边不能直接把Airdroid这个变量传递过去，数据量会太大，</span></span><br><span class="line">        <span class="comment">// todo 因此只能像firefox那样，如果是函数就用字符串来替换, 而且这边还要转化成字符串，不然会出现对象复制不了的情况</span></span><br><span class="line">        e.target.page.dispatchMessage(<span class="string">'page_data'</span>, <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">            <span class="string">"Airdroid"</span>: fakeAirdroid</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">       <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>而前端页面 <code>base.js</code> 对应的代码片段为:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 其他的，像 reply 这种新建的窗体，就只能用数据传输的方式</span></span><br><span class="line">safari.self.addEventListener(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> eventName = e.name;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"消息过来了，名字为："</span> + eventName);</span><br><span class="line">    <span class="keyword">if</span> (eventName == <span class="string">'page_data'</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> proxy = safari.self.tab;</span><br><span class="line">        e.message = _.isString(e.message) ? <span class="built_in">JSON</span>.parse(e.message) : e.message;</span><br><span class="line">        self.setUpBackgroundPage(e.message, proxy.dispatchMessage);</span><br><span class="line">        self.inited(args);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure></p>
<p>所以这时<code>setUpBackgroundPage</code> 这个方法的<code>data</code>参数，其实就是<code>fakeAirdroid对象</code>，它里面是没有函数的，只有一个<code>funListenerObjs</code>对象。<br>所以我们要在这个对象做文章，因为这个对象的每一条记录都是对应这个对象所在对象的一个函数。 那么就很简单了，我们只要把他还原成函数就行了。 所以对应的代码片段就是:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 说明是非popover页面</span></span><br><span class="line"><span class="comment">// 同时要绑定对应的事件触发器</span></span><br><span class="line"><span class="keyword">var</span> addSafariTriggerHandle = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(obj.funListenerObjs)&#123;</span><br><span class="line">        _.each(obj.funListenerObjs,<span class="function"><span class="keyword">function</span>(<span class="params">funId,name</span>)</span>&#123;</span><br><span class="line">            <span class="comment">// 重新定义函数</span></span><br><span class="line">            obj[name] = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"调用函数，函数名为%s, id为 %s"</span>, name, funId);</span><br><span class="line">                <span class="keyword">var</span> defer = $.Deferred();</span><br><span class="line">                <span class="comment">// 加入回调队列</span></span><br><span class="line">                <span class="keyword">var</span> deferDoneId = _.uniqueId(<span class="string">"defer_done_"</span> + name + <span class="string">"_"</span>);</span><br><span class="line">                <span class="keyword">var</span> deferFailId = _.uniqueId(<span class="string">"defer_fail_"</span> + name + <span class="string">"_"</span>);</span><br><span class="line">                self.funCbObj[deferDoneId] = <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">                    self.log(deferDoneId);</span><br><span class="line">                    defer.resolve(data);</span><br><span class="line">                &#125;;</span><br><span class="line">                self.funCbObj[deferFailId] = <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">                    self.log(deferDoneId);</span><br><span class="line">                    defer.resolve(data);</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"参数为＝＝》"</span> + <span class="built_in">JSON</span>.stringify(<span class="built_in">Array</span>.prototype.slice.apply(<span class="built_in">arguments</span>)))</span><br><span class="line">                <span class="comment">// 触发函数</span></span><br><span class="line">                safari.self.tab.dispatchMessage(funId,&#123;</span><br><span class="line">                    arg: <span class="built_in">Array</span>.prototype.slice.apply(<span class="built_in">arguments</span>),</span><br><span class="line">                    done: deferDoneId,</span><br><span class="line">                    fail: deferFailId</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">return</span> defer;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    _.each(obj,<span class="function"><span class="keyword">function</span>(<span class="params">value,key</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(_.isObject(value))&#123;</span><br><span class="line">            addSafariTriggerHandle(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;;</span><br><span class="line">addSafariTriggerHandle(<span class="keyword">this</span>.Airdroid);</span><br></pre></td></tr></table></figure></p>
<p>上述代码说明我们会去遍历<code>fakeAirdroid对象</code>下的每一个<code>funListenerObjs</code>对象，然后把它还原成函数，但是请注意，这个函数名虽然跟背景页的那个函数名一样，<br>但是函数体可是不一样的，我们在函数体里面定义了两个<code>defer</code>回调，一个是<code>done</code>，一个是<code>fail</code>，并且把他们对应的<code>id</code>保存在一个变量<code>funCbObj</code>中。</p>
<p>最后这个函数返回也是一个<code>defer</code>对象。 所以经过这一步之后，<code>fakeAirdroid</code>会变成什么情况呢？<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">fakeAirdroid = &#123;</span><br><span class="line">     name: <span class="string">'xxx'</span>,</span><br><span class="line">     server: &#123;</span><br><span class="line">         baseUrl: <span class="string">'http://xxx.airdroid.com'</span>,</span><br><span class="line">         funListenerObjs: &#123;</span><br><span class="line">             sendMsg: <span class="string">'fun_1'</span></span><br><span class="line">         &#125;,</span><br><span class="line">         sendMsg: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">             <span class="built_in">console</span>.log(<span class="string">"调用函数，函数名为%s, id为 %s"</span>, name, funId);</span><br><span class="line">             <span class="keyword">var</span> defer = $.Deferred();</span><br><span class="line">              <span class="comment">// 加入回调队列</span></span><br><span class="line">             <span class="keyword">var</span> deferDoneId = _.uniqueId(<span class="string">"defer_done_sendMsg_"</span>);</span><br><span class="line">             <span class="keyword">var</span> deferFailId = _.uniqueId(<span class="string">"defer_fail_sendMsg_"</span>);</span><br><span class="line">             self.funCbObj[deferDoneId] = <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">                   self.log(deferDoneId);</span><br><span class="line">                   defer.resolve(data);</span><br><span class="line">             &#125;;</span><br><span class="line">             self.funCbObj[deferFailId] = <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">                   self.log(deferDoneId);</span><br><span class="line">                   defer.resolve(data);</span><br><span class="line">             &#125;;</span><br><span class="line">             <span class="built_in">console</span>.log(<span class="string">"参数为＝＝》"</span> + <span class="built_in">JSON</span>.stringify(<span class="built_in">Array</span>.prototype.slice.apply(<span class="built_in">arguments</span>)))</span><br><span class="line">              <span class="comment">// 触发函数</span></span><br><span class="line">             safari.self.tab.dispatchMessage(<span class="string">'fun_1'</span>,&#123;</span><br><span class="line">                   arg: <span class="built_in">Array</span>.prototype.slice.apply(<span class="built_in">arguments</span>),</span><br><span class="line">                   done: deferDoneId,</span><br><span class="line">                   fail: deferFailId</span><br><span class="line">              &#125;);</span><br><span class="line">              <span class="keyword">return</span> defer;</span><br><span class="line"></span><br><span class="line">         &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     account: &#123;</span><br><span class="line">         username: <span class="string">'kkk'</span>,</span><br><span class="line">          funListenerObjs: &#123;</span><br><span class="line">            signIn: <span class="string">'fun_2'</span></span><br><span class="line">         &#125;,</span><br><span class="line">        signIn: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">             <span class="built_in">console</span>.log(<span class="string">"调用函数，函数名为%s, id为 %s"</span>, name, funId);</span><br><span class="line">             <span class="keyword">var</span> defer = $.Deferred();</span><br><span class="line">              <span class="comment">// 加入回调队列</span></span><br><span class="line">             <span class="keyword">var</span> deferDoneId = _.uniqueId(<span class="string">"defer_done_signIn_"</span>);</span><br><span class="line">             <span class="keyword">var</span> deferFailId = _.uniqueId(<span class="string">"defer_fail_signIn_"</span>);</span><br><span class="line">             self.funCbObj[deferDoneId] = <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">                   self.log(deferDoneId);</span><br><span class="line">                   defer.resolve(data);</span><br><span class="line">             &#125;;</span><br><span class="line">             self.funCbObj[deferFailId] = <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">                   self.log(deferDoneId);</span><br><span class="line">                   defer.resolve(data);</span><br><span class="line">             &#125;;</span><br><span class="line">             <span class="built_in">console</span>.log(<span class="string">"参数为＝＝》"</span> + <span class="built_in">JSON</span>.stringify(<span class="built_in">Array</span>.prototype.slice.apply(<span class="built_in">arguments</span>)))</span><br><span class="line">              <span class="comment">// 触发函数</span></span><br><span class="line">             safari.self.tab.dispatchMessage(<span class="string">'fun_2'</span>,&#123;</span><br><span class="line">                   arg: <span class="built_in">Array</span>.prototype.slice.apply(<span class="built_in">arguments</span>),</span><br><span class="line">                   done: deferDoneId,</span><br><span class="line">                   fail: deferFailId</span><br><span class="line">              &#125;);</span><br><span class="line">              <span class="keyword">return</span> defer;</span><br><span class="line"></span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>发现多了两个方法，一个是<code>server</code>下的<code>sendMsg</code>方法，一个是<code>account</code>的<code>signIn</code>方法。现在我们跟在<code>Chrome</code>一样调用登录方法<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Airdroid.account.signIn().done(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="comment">// 登录成功</span></span><br><span class="line">&#125;).fail(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="comment">// 登录失败</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>方法开始执行，首先就到方法体内，然后在变量<code>funCbObj</code>里面加入两个方法，一个是<code>done</code>方法，一个是<code>fail</code>方法，同时这两个方法的key值都是唯一值（每一次方法触发都会生成两个唯一值）。然后触发消息 <code>func_2</code>, 并把<code>arg</code>参数，<code>done</code>对应的方法<code>id</code>，<code>fail</code>对应的方法<code>id</code>带过去。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">safari.self.tab.dispatchMessage(<span class="string">'fun_2'</span>,&#123;</span><br><span class="line">   arg: <span class="built_in">Array</span>.prototype.slice.apply(<span class="built_in">arguments</span>),</span><br><span class="line">   done: deferDoneId,</span><br><span class="line">   fail: deferFailId</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>接下来就到了背景页的逻辑处理了:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">safari.application.addEventListener(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"函数调用过来了，名字为："</span> + e.name);</span><br><span class="line">  <span class="comment">// 针对这些页面的数据初始化，这些页面不像popup这种页面可以直接访问后台的全局数据，而是必须要将数据进行传递</span></span><br><span class="line">  <span class="keyword">if</span> (e.name == <span class="string">'page_init'</span>) &#123;</span><br><span class="line">      <span class="comment">// init</span></span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="comment">// 接下来就是执行那些函数了</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">window</span>.funObjectObj[e.name])&#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">"开始执行传过来的函数"</span>);</span><br><span class="line">          <span class="keyword">var</span> result = e.message;</span><br><span class="line">          <span class="comment">// 真正的参数,而且是argument的形式</span></span><br><span class="line">          <span class="keyword">var</span> arg = result.arg;</span><br><span class="line">          <span class="comment">// 如果有回调，就触发调用 这边已经绑定了上下文环境了，所以这边直接为null即可</span></span><br><span class="line">          <span class="keyword">var</span> funResult = <span class="built_in">window</span>.funObjectObj[e.name].apply(<span class="literal">null</span>,arg);</span><br><span class="line">          <span class="comment">// 判断是否是Deferred对象</span></span><br><span class="line">          <span class="keyword">if</span>(_.isFunction(funResult.done))&#123;</span><br><span class="line">              funResult.done(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">                  result.done &amp;&amp; e.target.page.dispatchMessage(result.done,data);</span><br><span class="line">              &#125;).fail(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">                  result.fail &amp;&amp; e.target.page.dispatchMessage(result.fail,data);</span><br><span class="line">              &#125;).always(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">                  result.always &amp;&amp; e.target.page.dispatchMessage(result.always,data);</span><br><span class="line">              &#125;)</span><br><span class="line">          &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">              <span class="comment">// 返回return的</span></span><br><span class="line">              result.done &amp;&amp; e.target.page.dispatchMessage(result.done,funResult);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure></p>
<p>可以看到，在背景页的消息处理中，如果这个消息名字不是 <code>page_init</code>, 那么统一从<code>全局对象funObjectObj</code>来取。而本例子，<code>e.name</code> 就是 <code>fun_2</code>, <code>funObjectObj</code> 的值为:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.funObjectObj = &#123;</span><br><span class="line"> <span class="string">'fun_1'</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 发送消息</span></span><br><span class="line"> &#125;,</span><br><span class="line">  <span class="string">'fun_2'</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// // 登录操作</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>刚好有这个方法，所以就执行函数体（经过上述一连串的处理，最后这个函数体就是<code>signIn</code>方法的函数），最后判断是否返回<code>defer</code>对象。如果有的话，就触发  <code>e.target.page.dispatchMessage(result.done,data);</code> 和 <code>e.target.page.dispatchMessage(result.fail,data);</code> 然后把返回值带过去，因为<code>doneId</code> 和 <code>failId</code> 都传过来了，所以可以正常返回到前端页面。</p>
<p>这时候前端页面就触发了:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">safari.self.addEventListener(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> eventName = e.name;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"消息过来了，名字为："</span> + eventName);</span><br><span class="line">    <span class="keyword">if</span> (eventName == <span class="string">'page_data'</span>) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(self.funCbObj[eventName])&#123;</span><br><span class="line">            self.funCbObj[eventName](e.message);</span><br><span class="line">            <span class="keyword">delete</span> self.funCbObj[eventName];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure></p>
<p>因为<code>eventName</code>就是上述<code>doneId</code> 或者 <code>failId</code>，所以直接在<code>funCbOjb</code>进行触发，并把参数传过去。因此每一次触发这个方法，<code>doneId</code>和<code>failId</code>都是一次性的唯一值，所以可以在<code>funCbObj</code>执行完函数之后，直接删除掉。所以这时候就触发 <code>doneId</code> 或者 <code>failId</code> 函数，然后返回<code>defer</code>到:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Airdroid.account.signIn().done(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line"><span class="comment">// 登录成功 doneId defer 返回的data就会到这里</span></span><br><span class="line">&#125;).fail(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="comment">// 登录失败 failId defer 返回的data就会到这里</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>这样子整个流程就完成了。这个结果跟在<code>Chrome</code>浏览器调用的接口是一样的。以上就是<code>Safari</code>下，非<code>popup</code>页面调用背景页<code>Airdroid对象</code>方法的情况。</p>
<h3 id="1-3-Firefox-浏览器"><a href="#1-3-Firefox-浏览器" class="headerlink" title="1.3 Firefox 浏览器"></a>1.3 Firefox 浏览器</h3><p><code>Firefox</code>的情况跟 <code>Safari</code>的 非<code>popup</code>页面非常像。也是不能直接获取背景页的上下文环境。而是都是通过监听和触发的方式来执行的。不过跟<code>Safari</code>不一样的是，<code>Firefox</code>的监听和触发不是 <code>safari.self.addEventListener(&#39;message&#39;, function(e) {})</code> 和 <code>safari.self.tab.dispatchMessage(&#39;page_init&#39;,{});</code> 而是 <code>self.port.on(&#39;page_data&#39;, function(data) {})</code> 监听 和 <code>self.port.emit(&#39;page_init&#39;,{})</code>触发。如果是一次性的监听就是 <code>self.port.once(&#39;page_data&#39;, function(data) {})</code></p>
<p>跟<code>Safari</code> 非<code>popup</code>页面一样，还是先从背景页获取<code>fakeAirdroid</code>。先触发 <code>page_init</code> 事件，然后监听<code>page_data</code> 事件获取<code>fakeAirdroid对象</code>。所以部分 <code>base.js</code> 代码如下:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//todo 这边为了兼容Firefox extension 下的前后台调用，所有在前台调用后台的函数，都必须是用defer方式来调用的</span></span><br><span class="line"><span class="keyword">var</span> fireFoxEvent =  (self &amp;&amp; self.port) || &#123;&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">init: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>, args = <span class="built_in">arguments</span>;</span><br><span class="line">    $(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 这时候要根据浏览器来获取背景对象</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">window</span>.chrome) &#123;</span><br><span class="line">            <span class="comment">// chrome</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">window</span>.safari) &#123;</span><br><span class="line">            <span class="comment">// safari</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 这个是要传过来的事件。所有的事件都可以自己定</span></span><br><span class="line">            fireFoxEvent.on(<span class="string">'page_data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">                <span class="comment">// 传过来 AirDroid对象</span></span><br><span class="line">                self.setUpBackgroundPage(data.detail);</span><br><span class="line">                <span class="comment">// 接下来绑定可以传递到前台的触发事件</span></span><br><span class="line">                _.each(_.values(self.EventType),<span class="function"><span class="keyword">function</span>(<span class="params">item</span>)</span>&#123;</span><br><span class="line">                    fireFoxEvent.emit(<span class="string">"page_register_handle"</span>,&#123;<span class="attr">name</span>:item&#125;);</span><br><span class="line">                &#125;);</span><br><span class="line">                self.inited(args);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// 触发页面初始化事件，让后台传递AirDroid数据过来</span></span><br><span class="line">            fireFoxEvent.emit(<span class="string">'page_init'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>在背景页的代码片段就是 <code>events.js</code>:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fireFoxEvent = (self &amp;&amp; self.port) || &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化</span></span><br><span class="line">init: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">window</span>.chrome) &#123;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">window</span>.safari) &#123;</span><br><span class="line">        <span class="comment">// safari</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 这时候要注册可以双向通行的事件</span></span><br><span class="line">        <span class="comment">// todo 这边如果已经在 background.js 中已经注册的事件了，就不要重复绑定了,不然前台会触发两次</span></span><br><span class="line">        <span class="keyword">var</span> isListener = [self.TYPE.signed_in, self.TYPE.signed_out];</span><br><span class="line">        _.each(self.TYPE,<span class="function"><span class="keyword">function</span>(<span class="params">value,key</span>)</span>&#123;</span><br><span class="line">            self.dispatchEvent(self.FireFoxEvent.registerHandle, value);</span><br><span class="line">            <span class="comment">// 同时绑定所有监听的默认事件</span></span><br><span class="line">            (isListener.indexOf(value) == <span class="number">-1</span>) &amp;&amp; Airdroid.Event.addEventListener(value, $.noop);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 接下来开始添加AirDroid的function，让function转化为字符串，让前台去转化监听</span></span><br><span class="line">        self.addHandleTriggerToFrontInFirefox(Airdroid);</span><br><span class="line">        self.addEventListener(self.FireFoxEvent.page_init, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            self.dispatchEvent(self.FireFoxEvent.page_data, &#123;</span><br><span class="line">                <span class="string">"Airdroid"</span>: Airdroid</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">addEventListener: <span class="function"><span class="keyword">function</span>(<span class="params">eventName, listener, isOnce</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">window</span>.chrome || <span class="built_in">window</span>.safari)&#123;</span><br><span class="line">      <span class="keyword">this</span>.eventListeners.push(&#123; <span class="string">'eventName'</span>: eventName, <span class="string">'listener'</span>: listener &#125;);</span><br><span class="line">      <span class="built_in">window</span>.addEventListener(eventName, listener, <span class="literal">false</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// firefox</span></span><br><span class="line">      <span class="comment">// 这边还要把这个事件回调到前台去</span></span><br><span class="line">      <span class="keyword">var</span> cb = <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">          listener(data);</span><br><span class="line">          <span class="comment">// 还要回调到前台去，这边注意一个问题，如果有很多个前台的话，不知道会不会发生事件覆盖</span></span><br><span class="line">          (_.values(self.TYPE).indexOf(eventName) &gt; <span class="number">-1</span>) &amp;&amp; fireFoxEvent.emit(eventName + <span class="string">"_front"</span>, data);</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">if</span>(isOnce)&#123;</span><br><span class="line">          fireFoxEvent.once(eventName,cb);</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          fireFoxEvent.on(eventName,cb);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">// 触发事件</span></span><br><span class="line">dispatchEvent: <span class="function"><span class="keyword">function</span>(<span class="params">eventName, details</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">window</span>.chrome || <span class="built_in">window</span>.safari) &#123;</span><br><span class="line">        <span class="built_in">window</span>.dispatchEvent(<span class="keyword">new</span> CustomEvent(eventName, &#123; <span class="string">'detail'</span>: details &#125;));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// firefox</span></span><br><span class="line">        <span class="comment">// todo 因为Firefox的特殊性，他不能再同一个js里面，同时绑定事件，并触发，而是都要经过main.js绕一圈</span></span><br><span class="line">        <span class="comment">// 有一种方法就是使用addEventListener，但是这个又不能传到前台去</span></span><br><span class="line">        <span class="comment">// 这时候要判断该事件是哪一种事件，是双向的，还是单向的， 即属于FireFoxEvent里面的，还是TYPE 里面的</span></span><br><span class="line">        <span class="keyword">if</span>(_.values(<span class="keyword">this</span>.TYPE).indexOf(eventName) &gt; <span class="number">-1</span>)&#123;</span><br><span class="line">            <span class="comment">// 这时候要到外面绕一圈回来</span></span><br><span class="line">            fireFoxEvent.emit(eventName + <span class="string">"_firefox"</span>, &#123; <span class="string">'detail'</span>: details &#125;);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            fireFoxEvent.emit(eventName, &#123; <span class="string">'detail'</span>: details &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">// firefox 下监听页面初始化事件, 然后传数据过去</span></span><br><span class="line"><span class="comment">// 注意， Firefox 这边很变态，他这边不是传的整个 AirDroid，</span></span><br><span class="line"><span class="comment">// 而是 AirDroid 里面的 可以json格式化的字符串</span></span><br><span class="line"><span class="comment">// (也就是说，要注意两点，一点是不是对象传递，另一点就是function是传不过去的)</span></span><br><span class="line"><span class="comment">// https://developer.mozilla.org/en-US/Add-ons/SDK/Guides/Content_Scripts/using_port</span></span><br><span class="line"><span class="comment">// 接下来给所有对象的方法，统一加上 on和emit事件</span></span><br><span class="line"><span class="comment">// todo 注意，这种方法，对new 的对象是不行的，比如 File Device，在前台如果这样做会出错, 如果在初始化的时候，也要执行这个操作（如果这个对象需要在前台页面操作，比如 File，Device）</span></span><br><span class="line"><span class="comment">// 在特定浏览器中添加(目前就Firefox中用到)</span></span><br><span class="line"><span class="comment">// todo 这边禁止一种用法，就是数组里面的项不能是函数，不然会有问题</span></span><br><span class="line">addHandleTriggerToFrontInFirefox: <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">if</span>(Airdroid.Util.Browser.firefox)&#123;</span><br><span class="line">        <span class="keyword">if</span>(_.isObject(obj))&#123;</span><br><span class="line">            _.each(obj,<span class="function"><span class="keyword">function</span>(<span class="params">value,key</span>)</span>&#123;</span><br><span class="line">                <span class="comment">// 如果是函数，就保留，并监听，设置一个唯一值</span></span><br><span class="line">                <span class="keyword">if</span>(_.isFunction(value))&#123;</span><br><span class="line">                    obj.funListenerObjs = obj.funListenerObjs || &#123;&#125;;</span><br><span class="line">                    <span class="keyword">var</span> uniqFunId = _.uniqueId(<span class="string">"fun_"</span>);</span><br><span class="line">                    <span class="comment">// 加入监听队列，并监听</span></span><br><span class="line">                    obj.funListenerObjs[key] = uniqFunId;</span><br><span class="line">                    self.addEventListener(uniqFunId,<span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">                        <span class="comment">// 这边接收参数</span></span><br><span class="line">                        <span class="comment">// 传过来的实际参数</span></span><br><span class="line">                        <span class="keyword">var</span> result = event;</span><br><span class="line">                        <span class="comment">// 真正的参数,而且是argument的形式</span></span><br><span class="line">                        <span class="keyword">var</span> arg = result.arg;</span><br><span class="line">                        <span class="comment">// 如果有回调，就触发调用</span></span><br><span class="line">                        <span class="keyword">var</span> funResult = value.apply(obj,arg);</span><br><span class="line">                        <span class="comment">// 判断是否是Deferred对象</span></span><br><span class="line">                        <span class="keyword">if</span>(_.isFunction(funResult.done))&#123;</span><br><span class="line">                            funResult.done(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">                                result.done &amp;&amp; self.dispatchEvent(result.done,data);</span><br><span class="line">                            &#125;).fail(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">                                        result.fail &amp;&amp; self.dispatchEvent(result.fail,data);</span><br><span class="line">                                    &#125;).always(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">                                        result.always &amp;&amp; self.dispatchEvent(result.always,data);</span><br><span class="line">                                    &#125;)</span><br><span class="line">                        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                            <span class="comment">// 返回return的</span></span><br><span class="line">                            result.done &amp;&amp; self.dispatchEvent(result.done,funResult);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(_.isObject(value))&#123;</span><br><span class="line">                    self.addHandleTriggerToFrontInFirefox(value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从上面的代码来看，<code>Firefox</code>在这一块的处理上还是跟<code>Safari</code>的非<code>popup</code>页面的处理上，还是相差很多的。 先 <code>init</code> 方法:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> isListener = [self.TYPE.signed_in, self.TYPE.signed_out];</span><br><span class="line">_.each(self.TYPE,<span class="function"><span class="keyword">function</span>(<span class="params">value,key</span>)</span>&#123;</span><br><span class="line">    self.dispatchEvent(self.FireFoxEvent.registerHandle, value);</span><br><span class="line">    <span class="comment">// 同时绑定所有监听的默认事件</span></span><br><span class="line">    (isListener.indexOf(value) == <span class="number">-1</span>) &amp;&amp; Airdroid.Event.addEventListener(value, $.noop);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>这部分的逻辑是<code>Firefox</code>注册双向通道的逻辑。这个后面会讲到。这边就看下面这个逻辑就行了，即<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 接下来开始添加AirDroid的function，让function转化为字符串，让前台去转化监听</span></span><br><span class="line">self.addHandleTriggerToFrontInFirefox(Airdroid);</span><br><span class="line">self.addEventListener(self.FireFoxEvent.page_init, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    self.dispatchEvent(self.FireFoxEvent.page_data, &#123;</span><br><span class="line">        <span class="string">"Airdroid"</span>: Airdroid</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>可以看到会把<code>Airdroid这个变量</code>，通过<code>addHandleTriggerToFrontInFirefox</code>这个函数再转化一次。这个逻辑跟<code>Safari</code> 非<code>popup</code>页面的处理逻辑有点像，也是转化<code>Airdroid</code>里面的函数，这边有几个点要注意:</p>
<ol>
<li>他这边不是传的整个 <code>AirDroid</code>，而是 <code>AirDroid</code> 里面的可以json格式化的字符串(也就是说，要注意两点，一点是不是对象传递，另一点就是<code>function</code>是传不过去的), 具体可以看: <a href="https://developer.mozilla.org/en-US/Add-ons/SDK/Guides/Content_Scripts/using_port" target="_blank" rel="noopener">using port</a></li>
<li>给所有对象的方法，统一加上 <code>on</code>和<code>emit</code>事件。注意，这种方法，对<code>new</code> 的对象是不行的，比如 <code>File Device</code>，在前台如果这样做会出错, 如果在初始化的时候，也要执行这个操作（如果这个对象需要在前台页面操作，比如 <code>File，Device</code>）</li>
<li>这边禁止一种用法，就是数组里面的项不能是函数，不然会有问题</li>
<li><code>Firefox</code>是在转化函数的时候，就对函数的<code>uniqFunId</code>进行监听。而不是像<code>Safari</code>非<code>popup</code>页面那样要先放一个全局的<code>funObjectObj</code>对象，然后在统一的<code>safari.application.addEventListener(&#39;message&#39;, function(e) {})</code> 进行处理。</li>
</ol>
<p>接下来就是对<code>page_init</code> 事件进行监听并回应，把<code>Airdroid</code>对象传过去:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">self.addEventListener(self.FireFoxEvent.page_init, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    self.dispatchEvent(self.FireFoxEvent.page_data, &#123;</span><br><span class="line">        <span class="string">"Airdroid"</span>: Airdroid</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>这个就涉及到<code>Firefox</code>一个最恶心的地方。就是<code>背景页的port</code>和<code>前端页面的port</code>不是同一个东西。 什么意思呢， 也就是说如果在前端页面触发一个事件 <code>self.port.emit(&quot;init&#39;);</code>, 然后背景页监听这个事件 <code>self.port.on(&quot;init&quot;);</code>, 其实你会发现，其实并没有卵用，反过来也是一样，也是没用的。其原因就是 这两个<code>self</code>变量不是同一个东西，这两个<code>port</code>也不是同一个东西。 也就说，一个是前端页面的上下文环境，一个是背景页的上下文环境。所以搭不上关系。</p>
<p>那么这个项目是怎么让他们搭得上关系的呢？其中奥秘就是在 <code>main.js</code> 中。在<code>Firefox</code>中，无论是背景页，还是<code>popup</code>页面都是在<code>main.js</code>中初始化的。 我们先看一下 <code>lib/main.js</code> 中的代码:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> self = <span class="built_in">require</span>(<span class="string">'sdk/self'</span>);</span><br><span class="line"><span class="keyword">var</span> ss = <span class="built_in">require</span>(<span class="string">'sdk/simple-storage'</span>);</span><br><span class="line"><span class="keyword">var</span> windows = <span class="built_in">require</span>(<span class="string">'sdk/windows'</span>);</span><br><span class="line"><span class="keyword">var</span> tabs = <span class="built_in">require</span>(<span class="string">'sdk/tabs'</span>);</span><br><span class="line"><span class="keyword">var</span> Panel = <span class="built_in">require</span>(<span class="string">'sdk/panel'</span>).Panel;</span><br><span class="line"><span class="keyword">var</span> contextMenu = <span class="built_in">require</span>(<span class="string">'sdk/context-menu'</span>);</span><br><span class="line"><span class="keyword">var</span> prefs = <span class="built_in">require</span>(<span class="string">'sdk/simple-prefs'</span>).prefs;</span><br><span class="line"><span class="keyword">var</span> Request = <span class="built_in">require</span>(<span class="string">'sdk/request'</span>).Request;</span><br><span class="line"><span class="keyword">var</span> clipboard = <span class="built_in">require</span>(<span class="string">"sdk/clipboard"</span>);</span><br><span class="line"><span class="keyword">var</span> timers = <span class="built_in">require</span>(<span class="string">'sdk/timers'</span>);</span><br><span class="line"><span class="keyword">var</span> system = <span class="built_in">require</span>(<span class="string">"sdk/system"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> compatToolbarButton = <span class="built_in">require</span>(<span class="string">'./toolbar-button'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> &#123;Cc, Ci&#125; = <span class="built_in">require</span>(<span class="string">'chrome'</span>);</span><br><span class="line"><span class="keyword">var</span> ioSvc = Cc[<span class="string">'@mozilla.org/network/io-service;1'</span>].getService(Ci.nsIIOService);</span><br><span class="line"><span class="keyword">var</span> cookieSvc = Cc[<span class="string">'@mozilla.org/cookieService;1'</span>].getService(Ci.nsICookieService);</span><br><span class="line"><span class="keyword">var</span> cookieMgr = Cc[<span class="string">'@mozilla.org/cookiemanager;1'</span>].getService(Ci.nsICookieManager);</span><br><span class="line"><span class="keyword">var</span> mediator = Cc[<span class="string">'@mozilla.org/appshell/window-mediator;1'</span>].getService(Ci.nsIWindowMediator);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> trim = <span class="function"><span class="keyword">function</span>(<span class="params">str</span>) </span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> str.replace(<span class="regexp">/^\s+|\s+$/g</span>, <span class="string">''</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> firefoxVersion = system.version.match(<span class="regexp">/(\d+)/</span>)[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">var</span> widget;</span><br><span class="line"><span class="comment">// 显示菜单栏图标</span></span><br><span class="line"><span class="keyword">var</span> setUpToolbarButton = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> icon = &#123;</span><br><span class="line">        <span class="string">'16'</span>: self.data.url(<span class="string">'images/icon_16.png'</span>),</span><br><span class="line">        <span class="string">'32'</span>: self.data.url(<span class="string">'images/icon_32.png'</span>)</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (firefoxVersion &gt;= <span class="number">30</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!widget) &#123;</span><br><span class="line">            widget = <span class="built_in">require</span>(<span class="string">'sdk/ui/button/toggle'</span>).ToggleButton(&#123;</span><br><span class="line">                id: <span class="string">'airdroid-widget'</span>,</span><br><span class="line">                label: <span class="string">'AirDroid'</span>,</span><br><span class="line">                icon: icon,</span><br><span class="line">                onChange: <span class="function"><span class="keyword">function</span>(<span class="params">state</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (state.checked) &#123;</span><br><span class="line">                        <span class="keyword">var</span> panel = onToolbarButtonClicked(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                            widget.state(<span class="string">'window'</span>, &#123; <span class="attr">checked</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">                            panel.destroy();</span><br><span class="line">                        &#125;);</span><br><span class="line">                        panel.show(&#123;</span><br><span class="line">                            position: widget</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            widget.icon = icon;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> </span><br><span class="line">    <span class="keyword">if</span> (firefoxVersion == <span class="number">29</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!widget) &#123;</span><br><span class="line">            widget = <span class="built_in">require</span>(<span class="string">'sdk/widget'</span>).Widget(&#123;</span><br><span class="line">                id: <span class="string">'airdroid-widget'</span>,</span><br><span class="line">                label: <span class="string">'AirDroid'</span>,</span><br><span class="line">                contentURL: icon[<span class="string">'16'</span>],</span><br><span class="line">                onClick: <span class="function"><span class="keyword">function</span>(<span class="params">view</span>) </span>&#123;</span><br><span class="line">                    view.panel = onToolbarButtonClicked();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            widget.contentURL = icon[<span class="string">'16'</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Set up the toolbar buttons on existing windows</span></span><br><span class="line">        <span class="keyword">var</span> enumerator = mediator.getEnumerator(<span class="string">'navigator:browser'</span>);</span><br><span class="line">        <span class="keyword">while</span> (enumerator.hasMoreElements()) &#123;</span><br><span class="line">            compatToolbarButton.add(self, enumerator.getNext(), onToolbarButtonClicked, icon[<span class="string">'16'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set up the toolbar button on any new windows that get opened</span></span><br><span class="line">        windows.browserWindows.on(<span class="string">'open'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">window</span>) </span>&#123;</span><br><span class="line">            compatToolbarButton.add(self, mediator.getMostRecentWindow(<span class="string">'navigator:browser'</span>), onToolbarButtonClicked, icon[<span class="string">'16'</span>]);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> onToolbarButtonClicked = <span class="function"><span class="keyword">function</span>(<span class="params">onHide</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> options = &#123;</span><br><span class="line">        <span class="comment">//'width': 355,</span></span><br><span class="line">        <span class="comment">//'height': 315,</span></span><br><span class="line">        <span class="string">'contentURL'</span>: self.data.url(<span class="string">'popup.html'</span>),</span><br><span class="line">        <span class="string">'contentScriptFile'</span>: [</span><br><span class="line">            self.data.url(<span class="string">'js/lib/jquery/jquery.js'</span>),</span><br><span class="line">            self.data.url(<span class="string">'js/lib/jquery/jquery.toast.js'</span>),</span><br><span class="line">            self.data.url(<span class="string">'js/lib/jquery/jquery.clipboard.js'</span>),</span><br><span class="line">            self.data.url(<span class="string">'js/lib/underscore/underscore.js'</span>),</span><br><span class="line">            self.data.url(<span class="string">'js/util/tplHelper.js'</span>),</span><br><span class="line">            self.data.url(<span class="string">'js/model/device.js'</span>),</span><br><span class="line">            self.data.url(<span class="string">'js/web/base.js'</span>),</span><br><span class="line">            self.data.url(<span class="string">'js/web/popup.js'</span>),</span><br><span class="line">            self.data.url(<span class="string">'js/lib/bootstrap/js/bootstrap.js'</span>)</span><br><span class="line">        ]</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (onHide) &#123;</span><br><span class="line">        options.onHide = onHide;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> panel = Panel(options);</span><br><span class="line"></span><br><span class="line">    attachListeners(panel);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (firefoxVersion &gt;= <span class="number">29</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> panel;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        panel.show(mediator.getMostRecentWindow(<span class="string">'navigator:browser'</span>).document.getElementById(<span class="string">'airdroid'</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> attachListeners = <span class="function"><span class="keyword">function</span>(<span class="params">component</span>) </span>&#123;</span><br><span class="line">    component.port.on(<span class="string">'resize'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        data.width &amp;&amp; (component.width = data.width);</span><br><span class="line">        data.height &amp;&amp; (component.height = data.height);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    component.port.once(<span class="string">'page_init'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 这边的page对应的是后台的 self.port对象</span></span><br><span class="line">        <span class="comment">// component 对应的是前台的 self.port对象</span></span><br><span class="line">        <span class="comment">// 因此会有这么一个流程</span></span><br><span class="line">        <span class="comment">// 先触发 component的page_init(base.js里面) 再触发page里面的page_init 再触发page的page_data,最后再触发component的page_data</span></span><br><span class="line">        page.port.once(<span class="string">'page_data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">            component.port.emit(<span class="string">'page_data'</span>, data);</span><br><span class="line">        &#125;);</span><br><span class="line">        page.port.emit(<span class="string">'page_init'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 绑定那些可以从后台触发到前台的事件，比如signed_in</span></span><br><span class="line">    component.port.on(<span class="string">"page_register_handle"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> name = data.name;</span><br><span class="line">        <span class="comment">// 绑定对应页面的前台事件, 然后再对应到前台所绑定的函数</span></span><br><span class="line">        page.port.on(name + <span class="string">"_front"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">            component.port.emit(name,data);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化方法</span></span><br><span class="line">    component.port.on(<span class="string">'page_bind_handle'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> funId = result;</span><br><span class="line">        component.port.on(funId,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> deferDoneId = data.done;</span><br><span class="line">            <span class="keyword">var</span> deferFailId = data.fail;</span><br><span class="line">            <span class="keyword">var</span> deferAlwayId = data.always;</span><br><span class="line">            page.port.once(deferDoneId,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">                component.port.emit(deferDoneId,data);</span><br><span class="line">            &#125;);</span><br><span class="line">            page.port.once(deferFailId,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">                component.port.emit(deferFailId,data);</span><br><span class="line">            &#125;);</span><br><span class="line">            page.port.once(deferAlwayId,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">                component.port.emit(deferAlwayId,data);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// 触发函数</span></span><br><span class="line">            page.port.emit(funId,data);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    component.port.on(<span class="string">'open_tab'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">tabInfo</span>) </span>&#123;</span><br><span class="line">        openTab(tabInfo);</span><br><span class="line">        <span class="keyword">if</span> (component.hide) &#123;</span><br><span class="line">            component.hide();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化插件的常驻背景页</span></span><br><span class="line"><span class="keyword">var</span> page = <span class="built_in">require</span>(<span class="string">'sdk/page-worker'</span>).Page(&#123;</span><br><span class="line">    <span class="string">'contentURL'</span>: self.data.url(<span class="string">'page.html?version=1'</span>),</span><br><span class="line">    <span class="string">'contentScriptFile'</span>: [</span><br><span class="line">        self.data.url(<span class="string">'js/lib/underscore/underscore.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/lib/jquery/jquery.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/lib/md5/md5.js'</span>),</span><br><span class="line">        <span class="comment">// des lib</span></span><br><span class="line">        self.data.url(<span class="string">'js/lib/des/tripledes.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/lib/des/mode.ecb.js'</span>),</span><br><span class="line">        <span class="comment">// e2ee lib</span></span><br><span class="line">        self.data.url(<span class="string">'js/lib/e2ee/System.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/lib/e2ee/System.IO.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/lib/e2ee/System.Text.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/lib/e2ee/System.Convert.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/lib/e2ee/System.BitConverter.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/lib/e2ee/System.BigInt.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/lib/e2ee/System.Security.Cryptography.SHA1.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/lib/e2ee/System.Security.Cryptography.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/lib/e2ee/System.Security.Cryptography.RSA.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/lib/e2ee/System.Security.Cryptography.HMACSHA1.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/lib/e2ee/System.Security.Cryptography.RijndaelManaged.js'</span>),</span><br><span class="line">        <span class="comment">// util lib</span></span><br><span class="line">        self.data.url(<span class="string">'js/util/util.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/util/tabs.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/util/e2ee.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/util/des.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/util/localstorage.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/util/browser_os.js'</span>),</span><br><span class="line">        <span class="comment">// model lib</span></span><br><span class="line">        self.data.url(<span class="string">'js/model/account.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/model/file.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/model/device.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/model/contextmenus.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/model/notification.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/sys/cache.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/sys/events.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/sys/baseSocket.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/sys/subSocket.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/sys/pushManage.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/sys/notificationManage.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/sys/server.js'</span>),</span><br><span class="line">        self.data.url(<span class="string">'js/sys/background.js'</span>)</span><br><span class="line">    ]</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 注册可以双向通信的事件通道</span></span><br><span class="line">page.port.on(<span class="string">'registerHandle'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> handleName = event.detail;</span><br><span class="line">    <span class="comment">// 这边开始注册一个事件, 名字为 name 后面加上 firefox 字样, 主要是让后台来触发，再回传到后台去，相当于绕了一圈，这样子会比较麻烦，但是为了兼容其他浏览器和一致性，只能这样了</span></span><br><span class="line">    page.port.on(handleName + <span class="string">"_firefox"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 同时回传过去</span></span><br><span class="line">        page.port.emit(handleName, data);</span><br><span class="line">        <span class="comment">// 同时也回传到前台. 注意，这边不能直接在同一个main.js 里面触发，还是要先绕回去</span></span><br><span class="line">        <span class="comment">// page.port.emit(handleName + "_front", data);</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 新建一个新的窗口</span></span><br><span class="line"><span class="keyword">var</span> openWindow = <span class="function"><span class="keyword">function</span>(<span class="params">info</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'OPEN WINDOW'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> url = info.url;</span><br><span class="line">    <span class="keyword">if</span> (url.indexOf(<span class="string">'http'</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        url = self.data.url(url);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> size = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">if</span> (info.width &amp;&amp; info.height) &#123;</span><br><span class="line">        size = <span class="string">',width='</span> + info.width + <span class="string">',height='</span> + info.height;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> popup = <span class="built_in">require</span>(<span class="string">'sdk/window/utils'</span>).openDialog(&#123;</span><br><span class="line">        <span class="string">'features'</span>: <span class="built_in">Object</span>.keys(&#123;</span><br><span class="line">            <span class="string">'chrome'</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="string">'centerscreen'</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="string">'resizable'</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">'scrollbars'</span>: <span class="literal">true</span></span><br><span class="line">        &#125;).join() + size,</span><br><span class="line">        name: info.id</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    popup.addEventListener(<span class="string">'load'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        tabs.activeTab.url = url;</span><br><span class="line">    &#125;);</span><br><span class="line">    popup.addEventListener(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        page.port.emit(<span class="string">'new_window_close'</span>, info.id);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// http://stackoverflow.com/questions/22002010/addon-sdk-way-to-make-a-dialog</span></span><br><span class="line">page.port.on(<span class="string">'new_window_open'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    openWindow(data.detail);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> openTab = <span class="function"><span class="keyword">function</span>(<span class="params">tabInfo</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> url = tabInfo.url;</span><br><span class="line">    <span class="keyword">if</span> (url.indexOf(<span class="string">'http'</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        url = self.data.url(url);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tabs.open(&#123;</span><br><span class="line">        <span class="string">'url'</span>: url,</span><br><span class="line">        <span class="string">'onClose'</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            page.port.emit(<span class="string">'tab_closed'</span>, tabInfo.id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">page.port.on(<span class="string">'open_tab'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">tabInfo</span>) </span>&#123;</span><br><span class="line">    openTab(tabInfo);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">page.port.on(<span class="string">"get_active_tab"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    data = data.detail;</span><br><span class="line">    page.port.emit(data.uid, &#123;<span class="attr">detail</span>:&#123; <span class="string">'title'</span>: tabs.activeTab.title, <span class="string">'url'</span>: tabs.activeTab.url &#125;&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// cookie operate</span></span><br><span class="line"><span class="keyword">var</span> getCookie = <span class="function"><span class="keyword">function</span>(<span class="params">name, domain</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> cookieString = cookieSvc.getCookieString(ioSvc.newURI(domain, <span class="literal">null</span>, <span class="literal">null</span>), <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">if</span> (cookieString != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> cookies = cookieString.split(<span class="string">';'</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, cookiesLength = cookies.length; i &lt; cookiesLength; i++) &#123;</span><br><span class="line">            <span class="keyword">var</span> cookie = cookies[i];</span><br><span class="line">            <span class="keyword">if</span> (cookie.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> parts = cookie.split(<span class="string">'='</span>);</span><br><span class="line">                <span class="keyword">if</span> (trim(parts[<span class="number">0</span>]) == name) &#123;</span><br><span class="line">                    <span class="keyword">return</span> trim(parts[<span class="number">1</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">page.port.on(<span class="string">"get_cookie"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    data = data.detail;</span><br><span class="line">    <span class="keyword">var</span> str = getCookie(data.name, data.domain);</span><br><span class="line">    page.port.emit(data.uid, &#123;<span class="attr">detail</span>: str&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">page.port.on(<span class="string">"set_cookie"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    data = data.detail;</span><br><span class="line">    <span class="keyword">var</span> opt = data.opt;</span><br><span class="line">    cookieSvc.setCookieString(ioSvc.newURI(data.domain, <span class="literal">null</span>, <span class="literal">null</span>), <span class="literal">null</span>, opt.name + <span class="string">'='</span> + opt.value, <span class="literal">null</span>);</span><br><span class="line">    page.port.emit(data.uid, &#123;<span class="attr">detail</span>: cookieSvc.getCookieString(ioSvc.newURI(data.domain, <span class="literal">null</span>, <span class="literal">null</span>), <span class="literal">null</span>)&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">page.port.on(<span class="string">"remove_cookie"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    data = data.detail;</span><br><span class="line">    cookieMgr.remove(data.domain, data.name, <span class="string">'/'</span>, <span class="literal">false</span>);</span><br><span class="line">    page.port.emit(data.uid, &#123;&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">page.port.on(<span class="string">"request_get"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    data = data.detail;</span><br><span class="line">    Request(&#123;</span><br><span class="line">        <span class="string">'url'</span>: data.url,</span><br><span class="line">        <span class="string">'onComplete'</span>: <span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">            page.port.emit(data.uid, &#123;</span><br><span class="line">                json: response.json,</span><br><span class="line">                text: response.text,</span><br><span class="line">                status: response.status,</span><br><span class="line">                statusText: response.statusText</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).get();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//page.port.on("get_all_cookie", function(data)&#123;</span></span><br><span class="line"><span class="comment">//    data = data.detail;</span></span><br><span class="line"><span class="comment">//    var cookieString = cookieSvc.getCookieString(ioSvc.newURI(data.domain, null, null), null);</span></span><br><span class="line"><span class="comment">//    page.port.emit(data.uid, &#123;detail: cookieString&#125;);</span></span><br><span class="line"><span class="comment">//&#125;);</span></span><br><span class="line"><span class="comment">// 通知过来，显示桌面图标</span></span><br><span class="line">page.port.on(<span class="string">'show_notification'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> notification = data.detail;</span><br><span class="line">    <span class="keyword">if</span> (notification.iconUrl.lastIndexOf(<span class="string">''</span>, <span class="number">0</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        notification.iconUrl = self.data.url(notification.iconUrl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (notification.contextMessage) &#123;</span><br><span class="line">        notification.message = notification.contextMessage + <span class="string">'\n'</span> + notification.message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (prefs.dont_show_mirrors) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'Not showing notification, disabled in preferences'</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> notifications = <span class="built_in">require</span>(<span class="string">'sdk/notifications'</span>);</span><br><span class="line">    notifications.notify(&#123;</span><br><span class="line">        <span class="string">'title'</span>: notification.title,</span><br><span class="line">        <span class="string">'text'</span>: notification.message,</span><br><span class="line">        <span class="string">'iconURL'</span>: notification.iconUrl,</span><br><span class="line">        <span class="string">'onClick'</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 通知点击事件</span></span><br><span class="line">            page.port.emit(<span class="string">'notification_clicked'</span>, notification.key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通知条数改变，就在图标上面显示小红点</span></span><br><span class="line">page.port.on(<span class="string">'notifications_changed'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> notifications = data.detail;</span><br><span class="line">    <span class="keyword">if</span> (firefoxVersion &gt;= <span class="number">36</span> &amp;&amp; widget) &#123;</span><br><span class="line">        <span class="keyword">var</span> count = notifications.length;</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            widget.badge = count;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            widget.badge = <span class="string">''</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示桌面右键菜单</span></span><br><span class="line"><span class="keyword">var</span> menus = [];</span><br><span class="line">page.port.on(<span class="string">'update_context_menu'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> entries = data.detail;</span><br><span class="line">    menus.map(<span class="function"><span class="keyword">function</span>(<span class="params">menu</span>) </span>&#123;</span><br><span class="line">        menu.destroy();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    menu = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!entries || entries.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> pageMenu = contextMenu.Menu(&#123;</span><br><span class="line">        <span class="string">'label'</span>: <span class="string">'AirDroid'</span>,</span><br><span class="line">        <span class="string">'image'</span>: self.data.url(<span class="string">'images/icon_32.png'</span>),</span><br><span class="line">        <span class="string">'context'</span>: contextMenu.PageContext()</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> linkMenu = contextMenu.Menu(&#123;</span><br><span class="line">        <span class="string">'label'</span>: <span class="string">'AirDroid'</span>,</span><br><span class="line">        <span class="string">'image'</span>: self.data.url(<span class="string">'images/icon_32.png'</span>),</span><br><span class="line">        <span class="string">'context'</span>: contextMenu.SelectorContext(<span class="string">'a[href]'</span>)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> selectionMenu = contextMenu.Menu(&#123;</span><br><span class="line">        <span class="string">'label'</span>: <span class="string">'AirDroid'</span>,</span><br><span class="line">        <span class="string">'image'</span>: self.data.url(<span class="string">'images/icon_32.png'</span>),</span><br><span class="line">        <span class="string">'context'</span>: contextMenu.SelectionContext()</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    menus.push(pageMenu);</span><br><span class="line">    menus.push(linkMenu);</span><br><span class="line">    menus.push(selectionMenu);</span><br><span class="line"></span><br><span class="line">    entries.map(<span class="function"><span class="keyword">function</span>(<span class="params">entry</span>) </span>&#123;</span><br><span class="line">        pageMenu.addItem(contextMenu.Item(&#123;</span><br><span class="line">            <span class="string">'label'</span>: entry.label,</span><br><span class="line">            <span class="string">'image'</span>: entry.imageUrl,</span><br><span class="line">            <span class="string">'contentScript'</span>: <span class="string">'self.on("click", function(node, data) &#123;'</span> +</span><br><span class="line">                    <span class="string">'    self.postMessage(&#123; "title": document.title, "url": document.URL &#125;);'</span> +</span><br><span class="line">                    <span class="string">'&#125;);'</span>,</span><br><span class="line">            <span class="string">'onMessage'</span>: <span class="function"><span class="keyword">function</span>(<span class="params">message</span>) </span>&#123;</span><br><span class="line">                page.port.emit(<span class="string">'context_menu_item_clicked'</span>, &#123; <span class="string">'entry'</span>: entry, <span class="string">'message'</span>: message &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line"></span><br><span class="line">        linkMenu.addItem(contextMenu.Item(&#123;</span><br><span class="line">            <span class="string">'label'</span>: entry.label,</span><br><span class="line">            <span class="string">'image'</span>: entry.imageUrl,</span><br><span class="line">            <span class="string">'contentScript'</span>: <span class="string">'self.on("click", function(node, data) &#123;'</span> +</span><br><span class="line">                    <span class="string">'    self.postMessage(&#123; "title": node.textContent, "url": node.href &#125;);'</span> +</span><br><span class="line">                    <span class="string">'&#125;);'</span>,</span><br><span class="line">            <span class="string">'onMessage'</span>: <span class="function"><span class="keyword">function</span>(<span class="params">message</span>) </span>&#123;</span><br><span class="line">                page.port.emit(<span class="string">'context_menu_item_clicked'</span>, &#123; <span class="string">'entry'</span>: entry, <span class="string">'message'</span>: message &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line"></span><br><span class="line">        selectionMenu.addItem(contextMenu.Item(&#123;</span><br><span class="line">            <span class="string">'label'</span>: entry.label,</span><br><span class="line">            <span class="string">'image'</span>: entry.imageUrl,</span><br><span class="line">            <span class="string">'contentScript'</span>: <span class="string">'self.on("context", function (node) &#123;'</span> +</span><br><span class="line">                    <span class="string">'    return node.nodeName != "A";'</span> +</span><br><span class="line">                    <span class="string">'&#125;);'</span> +</span><br><span class="line">                    <span class="string">'self.on("click", function(node, data) &#123;'</span> +</span><br><span class="line">                    <span class="string">'    self.postMessage(&#123; "selection": window.getSelection().toString() &#125;);'</span> +</span><br><span class="line">                    <span class="string">'&#125;);'</span>,</span><br><span class="line">            <span class="string">'onMessage'</span>: <span class="function"><span class="keyword">function</span>(<span class="params">message</span>) </span>&#123;</span><br><span class="line">                page.port.emit(<span class="string">'context_menu_item_clicked'</span>, &#123; <span class="string">'entry'</span>: entry, <span class="string">'message'</span>: message &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 打开快速回复窗口</span></span><br><span class="line"><span class="comment">// http://stackoverflow.com/questions/22002010/addon-sdk-way-to-make-a-dialog</span></span><br><span class="line">page.port.on(<span class="string">'open_quickreply'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> info = data.detail;</span><br><span class="line">    <span class="keyword">var</span> url = info.url;</span><br><span class="line">    <span class="keyword">if</span> (url.indexOf(<span class="string">'http'</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        url = self.data.url(url);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> size = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">if</span> (info.width &amp;&amp; info.height) &#123;</span><br><span class="line">        size = <span class="string">',width='</span> + info.width + <span class="string">',height='</span> + info.height;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> popup = <span class="built_in">require</span>(<span class="string">'sdk/window/utils'</span>).openDialog(&#123;</span><br><span class="line">        <span class="string">'features'</span>: <span class="built_in">Object</span>.keys(&#123;</span><br><span class="line">            <span class="string">'chrome'</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="string">'centerscreen'</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="string">'resizable'</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">'scrollbars'</span>: <span class="literal">true</span></span><br><span class="line">        &#125;).join() + size,</span><br><span class="line">        name: info.notification.webuid</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    popup.addEventListener(<span class="string">'load'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        tabs.activeTab.on(<span class="string">'ready'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">tab</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> worker = tab.attach(&#123;</span><br><span class="line">                <span class="string">'contentScriptFile'</span>: [</span><br><span class="line">                    self.data.url(<span class="string">'js/lib/jquery/jquery.js'</span>),</span><br><span class="line">                    self.data.url(<span class="string">'js/lib/jquery/jquery.toast.js'</span>),</span><br><span class="line">                    self.data.url(<span class="string">'js/lib/underscore/underscore.js'</span>),</span><br><span class="line">                    self.data.url(<span class="string">'js/util/tplHelper.js'</span>),</span><br><span class="line">                    self.data.url(<span class="string">'js/web/base.js'</span>),</span><br><span class="line">                    self.data.url(<span class="string">'js/web/reply.js'</span>)</span><br><span class="line">                ]</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            attachListeners(worker);</span><br><span class="line">            <span class="comment">// 请求对应的数据</span></span><br><span class="line">            worker.port.on(<span class="string">'request_conversation_push'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                worker.port.emit(<span class="string">'conversation_push'</span>, info.notification);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            worker.port.on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">reply</span>) </span>&#123;</span><br><span class="line">                popup.close();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        tabs.activeTab.url = url;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">setUpToolbarButton();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Hello World"</span>);</span><br></pre></td></tr></table></figure></p>
<p>从上面代码可以看到。 在 <code>attachListeners</code> 方法中， <code>component</code>指的就是<code>popup</code>页面的上下文环境对象（即<code>self</code>），而<code>page</code>就是背景页的上下文环境对象:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">component.port.once(<span class="string">'page_init'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 这边的page对应的是后台的 self.port对象</span></span><br><span class="line">    <span class="comment">// component 对应的是前台的 self.port对象</span></span><br><span class="line">    <span class="comment">// 因此会有这么一个流程</span></span><br><span class="line">    <span class="comment">// 先触发 component的page_init(base.js里面) 再触发page里面的page_init 再触发page的page_data,最后再触发component的page_data</span></span><br><span class="line">    page.port.once(<span class="string">'page_data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">        component.port.emit(<span class="string">'page_data'</span>, data);</span><br><span class="line">    &#125;);</span><br><span class="line">    page.port.emit(<span class="string">'page_init'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>从这个代码可以看出。<code>component</code> 绑定了一个一次性事件 <code>page_init</code>. 当这个事件被触发之后，就在背景页那边绑定了一个一次性事件 <code>page_data</code>, 而这个监听的事件就是触发<code>component</code>的<code>page_data</code>事件。当绑定背景页的<code>page_data</code> 事件之后，接着就触发背景页的 <code>page_init</code> 事件。</p>
<p>看起来很复杂。 但主要遵守一点，就很容易理解。就是前端页面和后端页面不能直接通信，必须要通过<code>main.js</code>的这个中转站，以这个事件为例,我们要的结果就是： </p>
<ol>
<li>前端页面监听<code>page_data</code>事件，并触发<code>page_init</code> 到背景页 (<code>base.js</code>)</li>
<li>背景页收到前端触发的 <code>page_init</code> 事件，并把<code>Airdroid对象</code>通过 <code>page_data</code>事件发送到前端页面 (<code>event.js</code>)</li>
<li>前端收到背景页触发的<code>page_data</code>事件，并得到他传过来的<code>Airdroid对象</code>。</li>
</ol>
<p>但是真正的流程是这样的:</p>
<ol>
<li><p>前端页面监听<code>page_data</code>事件，并触发<code>page_init</code> 事件 (<code>base.js</code>)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个是要传过来的事件。所有的事件都可以自己定</span></span><br><span class="line">fireFoxEvent.on(<span class="string">'page_data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 传过来 AirDroid对象</span></span><br><span class="line">    self.setUpBackgroundPage(data.detail);</span><br><span class="line">    <span class="comment">// 接下来绑定可以传递到前台的触发事件</span></span><br><span class="line">    _.each(_.values(self.EventType),<span class="function"><span class="keyword">function</span>(<span class="params">item</span>)</span>&#123;</span><br><span class="line">        fireFoxEvent.emit(<span class="string">"page_register_handle"</span>,&#123;<span class="attr">name</span>:item&#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">    self.inited(args);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 触发页面初始化事件，让后台传递AirDroid数据过来</span></span><br><span class="line">fireFoxEvent.emit(<span class="string">'page_init'</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>中转页面(<code>main.js</code>) 收到这个前端页面的<code>page_init</code> 事件，并绑定背景页的 <code>page_data</code>事件，然后触发背景页的 <code>page_init</code> 事件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">component.port.once(<span class="string">'page_init'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 这边的page对应的是后台的 self.port对象</span></span><br><span class="line">    <span class="comment">// component 对应的是前台的 self.port对象</span></span><br><span class="line">    <span class="comment">// 因此会有这么一个流程</span></span><br><span class="line">    <span class="comment">// 先触发 component的page_init(base.js里面) 再触发page里面的page_init 再触发page的page_data,最后再触发component的page_data</span></span><br><span class="line">    page.port.once(<span class="string">'page_data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">        component.port.emit(<span class="string">'page_data'</span>, data);</span><br><span class="line">    &#125;);</span><br><span class="line">    page.port.emit(<span class="string">'page_init'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>背景页收到中转页面（<code>main.js</code>）的触发的<code>page_init</code> 事件，并触发背景页的<code>page_data</code>事件，然后<code>Airdroid对象</code>传过去。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">self.addEventListener(self.FireFoxEvent.page_init, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    self.dispatchEvent(self.FireFoxEvent.page_data, &#123;</span><br><span class="line">        <span class="string">"Airdroid"</span>: Airdroid</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>中转页面(<code>main.js</code>) 收到背景页的<code>page_data</code>事件（这个事件是在第二个步骤绑定的），然后触发前端页面的<code>page_data</code>事件，并把<code>data</code>页面传过去</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">page.port.once(<span class="string">'page_data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    component.port.emit(<span class="string">'page_data'</span>, data);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>前端页收到中转页面（<code>main.js</code>）的触发的<code>page_data</code> 事件，并得到它传过来的<code>data</code>数据（其实就是从背景页过来的<code>Airdroid对象</code>）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">fireFoxEvent.on(<span class="string">'page_data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 传过来 AirDroid对象</span></span><br><span class="line">    self.setUpBackgroundPage(data.detail);</span><br><span class="line">    <span class="comment">// 接下来绑定可以传递到前台的触发事件</span></span><br><span class="line">    _.each(_.values(self.EventType),<span class="function"><span class="keyword">function</span>(<span class="params">item</span>)</span>&#123;</span><br><span class="line">        fireFoxEvent.emit(<span class="string">"page_register_handle"</span>,&#123;<span class="attr">name</span>:item&#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">    self.inited(args);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>对比上面的流程，就会发现多了两个中转流程。而在<code>Firefox</code>下，前端页面和背景页的通信就是得这样。</p>
<p>终于费了好大的劲，把<code>Airdroid对象</code>从背景页传到前端页面来了。虽然这个<code>Airdroid对象</code>也是一个<code>fakeAirdroid对象</code>，因为没有函数和复杂对象（通过<code>addHandleTriggerToFrontInFirefox</code>方法），跟<code>Safari</code>的非<code>popup</code>页面情况差不多。那么接下来就是怎么在前端页面调用背景页的方法了。</p>
<p>方法原理跟<code>Safari</code>的非<code>popup</code>页面的方式差不多，也是把<code>Airdroid对象</code>下的<code>funListenerObjs</code>的方法<code>map</code>，重定义成函数。 <code>base.js</code>的代码片段如下:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置背景对象</span></span><br><span class="line">setUpBackgroundPage: <span class="function"><span class="keyword">function</span>(<span class="params">data, dispatcher</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">this</span>.Airdroid = data.Airdroid;</span><br><span class="line">    <span class="built_in">window</span>.Airdroid = <span class="keyword">this</span>.Airdroid;</span><br><span class="line">    <span class="comment">// 事件对象</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">window</span>.chrome)&#123;</span><br><span class="line">        <span class="comment">// chrome</span></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">window</span>.safari)&#123;</span><br><span class="line">        <span class="comment">// safari</span></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// firefox 事件触发器</span></span><br><span class="line">        <span class="keyword">this</span>.eventObj = fireFoxEvent;</span><br><span class="line">        <span class="comment">// 同时要绑定对应的事件触发器</span></span><br><span class="line">        <span class="keyword">var</span> addFireFoxTriggerHandle = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(obj.funListenerObjs)&#123;</span><br><span class="line">                _.each(obj.funListenerObjs,<span class="function"><span class="keyword">function</span>(<span class="params">funId,name</span>)</span>&#123;</span><br><span class="line">                    <span class="comment">// 重新定义函数</span></span><br><span class="line">                    <span class="comment">// 这时候，要把组件的监听对象，传到page页面去</span></span><br><span class="line">                    self.eventObj.emit(<span class="string">'page_bind_handle'</span>,funId);</span><br><span class="line">                    obj[name] = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                        <span class="keyword">var</span> defer = $.Deferred();</span><br><span class="line">                        <span class="keyword">var</span> deferDoneId = _.uniqueId(<span class="string">"defer_done_"</span> + name + <span class="string">"_"</span>);</span><br><span class="line">                        <span class="keyword">var</span> deferFailId = _.uniqueId(<span class="string">"defer_fail_"</span> + name + <span class="string">"_"</span>);</span><br><span class="line">                        <span class="keyword">var</span> deferAlwayId = _.uniqueId(<span class="string">"defer_alway_"</span> + name + <span class="string">"_"</span>);</span><br><span class="line">                        <span class="comment">// 一次性监听</span></span><br><span class="line">                        self.eventObj.once(deferDoneId,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">                            <span class="comment">//self.log(deferDoneId);</span></span><br><span class="line">                            defer.resolve(data.detail);</span><br><span class="line">                        &#125;);</span><br><span class="line">                        self.eventObj.once(deferFailId,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">                            <span class="comment">//self.log(deferFailId);</span></span><br><span class="line">                            defer.reject(data.detail);</span><br><span class="line">                        &#125;);</span><br><span class="line">                        self.eventObj.once(deferAlwayId,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">                            <span class="comment">//self.log(deferAlwayId);</span></span><br><span class="line">                            defer.reject(data.detail);</span><br><span class="line">                        &#125;);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 触发函数</span></span><br><span class="line">                        self.eventObj.emit(funId,&#123;</span><br><span class="line">                            arg: <span class="built_in">Array</span>.prototype.slice.apply(<span class="built_in">arguments</span>),</span><br><span class="line">                            done: deferDoneId,</span><br><span class="line">                            fail: deferFailId,</span><br><span class="line">                            always: deferAlwayId</span><br><span class="line">                        &#125;);</span><br><span class="line">                        <span class="keyword">return</span> defer;</span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">            _.each(obj,<span class="function"><span class="keyword">function</span>(<span class="params">value,key</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(_.isObject(value))&#123;</span><br><span class="line">                    addFireFoxTriggerHandle(value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        addFireFoxTriggerHandle(<span class="keyword">this</span>.Airdroid);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.util= <span class="keyword">this</span>.Airdroid.Util;</span><br><span class="line">    <span class="keyword">this</span>.server = <span class="keyword">this</span>.Airdroid.Server;</span><br><span class="line">    <span class="keyword">this</span>.account = <span class="keyword">this</span>.Airdroid.Account;</span><br><span class="line">    <span class="keyword">this</span>.EventType = <span class="keyword">this</span>.Airdroid.Event.TYPE;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>这边的<code>eventObj</code>事件对象就是 <code>self.port</code>. 你会发现大部分的逻辑都跟<code>Safari</code>的非<code>popup</code>页面差不多。都是重定义函数，并在函数体内，对<code>defer</code>返回值, 即 <code>done</code>，<code>fail</code>，<code>always</code>，进行了事件的一次性监听，最后再触发这个<code>funcId</code>。但是还是有几个细节不太一样：</p>
<ol>
<li><code>Firefox</code> 是直接在函数体里面进行<code>defer</code>返回值对象的绑定监听，不需要像<code>Safari</code>的非<code>popup</code>页面那样，还要借助一个<code>funCbObj</code>对象，然后统一在<code>addListener</code>那边进行处理。</li>
<li>而且这边还需要把这个函数的监听，转到中间页面(<code>main.js</code>), 即 <code>self.eventObj.emit(&#39;page_bind_handle&#39;,funId);</code></li>
</ol>
<p>通过之前的分析，你会发现如果<code>Firefox</code>只是像<code>Safari</code>非<code>popup</code>页面那样处理的话，无论是函数的<code>funId</code>，还是重定义函数体内的<code>defer</code>返回值的绑定监听。其实都无法生效。因为根本到达不了背景页。背景页也没法把<code>defer</code>返回值的<code>函数id</code>触发到前端页面。</p>
<p>也就是说 在 <code>base.js</code> 页面这样写:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">self.eventObj.emit(funId,&#123;</span><br><span class="line">  arg: <span class="built_in">Array</span>.prototype.slice.apply(<span class="built_in">arguments</span>),</span><br><span class="line">  done: deferDoneId,</span><br><span class="line">  fail: deferFailId,</span><br><span class="line">  always: deferAlwayId</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>这个根本到达不了背景页。而在背景页 <code>events.js</code> 这样写:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> funResult = value.apply(obj,arg);</span><br><span class="line"><span class="comment">// 判断是否是Deferred对象</span></span><br><span class="line"><span class="keyword">if</span>(_.isFunction(funResult.done))&#123;</span><br><span class="line">    funResult.done(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        result.done &amp;&amp; self.dispatchEvent(result.done,data);</span><br><span class="line">    &#125;).fail(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        result.fail &amp;&amp; self.dispatchEvent(result.fail,data);</span><br><span class="line">    &#125;).always(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        result.always &amp;&amp; self.dispatchEvent(result.always,data);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">// 返回return的</span></span><br><span class="line">    result.done &amp;&amp; self.dispatchEvent(result.done,funResult);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的<code>dispatchEevnt</code>其实就是 <code>self.port.emit(result.done, { &#39;detail&#39;:  data});</code>, 这种触发也到达不了前端页面。</p>
<p>因此全部都要借助中转页面（<code>main.js</code>）才行。但是那么多的函数，而且每个函数都会有三个<code>defer</code>的返回监听，那不是写到手软？ 但是不是硬编码，其中还是有技巧的。 这个技巧就是在<code>main.js</code>中，绑定一个 <code>page_bind_handle</code> 监听，内容就是:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化方法</span></span><br><span class="line">component.port.on(<span class="string">'page_bind_handle'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> funId = result;</span><br><span class="line">    component.port.on(funId,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> deferDoneId = data.done;</span><br><span class="line">        <span class="keyword">var</span> deferFailId = data.fail;</span><br><span class="line">        <span class="keyword">var</span> deferAlwayId = data.always;</span><br><span class="line">        page.port.once(deferDoneId,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">            component.port.emit(deferDoneId,data);</span><br><span class="line">        &#125;);</span><br><span class="line">        page.port.once(deferFailId,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">            component.port.emit(deferFailId,data);</span><br><span class="line">        &#125;);</span><br><span class="line">        page.port.once(deferAlwayId,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">            component.port.emit(deferAlwayId,data);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 触发函数</span></span><br><span class="line">        page.port.emit(funId,data);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>这个逻辑其实就是当前端页面触发 <code>page_bind_handle</code> 这个事件的话，会把一个函数的id名字传过来。然后前端页面再绑定<code>这个函数id</code>的监听，函数体就是，在背景页绑定<code>defer</code>的三个返回值<code>id</code>事件，然后触发的时候，再去触发前端页面对应的<code>defer</code>返回值<code>id</code>的监听。</p>
<p>看似不好理解，其实很巧妙。我们想要的结果是：当我们调用 <code>Airdroid.account.sign</code> 的时候, 发生以下步骤:</p>
<ol>
<li><p>在重新定义的<code>sign</code>方法中，绑定这个函数的<code>defer</code>三个返回值的一次性监听，然后触发这个函数所对应的函数<code>id</code>，并把<code>defer</code>是三个返回情况的<code>id</code>传过去</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">self.eventObj.emit(funId,&#123;</span><br><span class="line">    arg: <span class="built_in">Array</span>.prototype.slice.apply(<span class="built_in">arguments</span>),</span><br><span class="line">    done: deferDoneId,</span><br><span class="line">    fail: deferFailId,</span><br><span class="line">    always: deferAlwayId</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>背景页面在收到这个事件之后，执行这个函数的函数体，并将函数体返回的<code>defer</code>情况，进行事件再触发，让其返回到前端</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">self.addEventListener(uniqFunId,<span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 这边接收参数</span></span><br><span class="line">    <span class="comment">// 传过来的实际参数</span></span><br><span class="line">    <span class="keyword">var</span> result = event;</span><br><span class="line">    <span class="comment">// 真正的参数,而且是argument的形式</span></span><br><span class="line">    <span class="keyword">var</span> arg = result.arg;</span><br><span class="line">    <span class="comment">// 如果有回调，就触发调用</span></span><br><span class="line">    <span class="keyword">var</span> funResult = value.apply(obj,arg);</span><br><span class="line">    <span class="comment">// 判断是否是Deferred对象</span></span><br><span class="line">    <span class="keyword">if</span>(_.isFunction(funResult.done))&#123;</span><br><span class="line">        funResult.done(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">            result.done &amp;&amp; self.dispatchEvent(result.done,data);</span><br><span class="line">        &#125;).fail(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">            result.fail &amp;&amp; self.dispatchEvent(result.fail,data);</span><br><span class="line">        &#125;).always(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">            result.always &amp;&amp; self.dispatchEvent(result.always,data);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// 返回return的</span></span><br><span class="line">        result.done &amp;&amp; self.dispatchEvent(result.done,funResult);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>这里的<code>dispatchEevnt</code>其实就是 <code>self.port.emit(result.done, { &#39;detail&#39;:  data});</code>, 而<code>addEventListener</code> 其实就是 <code>self.port.on(uniqFunId,cb);</code> 只是为了兼容各个浏览器，所以进行了封装。</p>
<ol start="3">
<li>前端页面收到背景页那边执行函数之后的<code>defer</code>返回情况，再跟进返回的参数进行处理<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">self.eventObj.once(deferDoneId,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//self.log(deferDoneId);</span></span><br><span class="line">    defer.resolve(data.detail);</span><br><span class="line">&#125;);</span><br><span class="line">self.eventObj.once(deferFailId,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//self.log(deferFailId);</span></span><br><span class="line">    defer.reject(data.detail);</span><br><span class="line">&#125;);</span><br><span class="line">self.eventObj.once(deferAlwayId,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//self.log(deferAlwayId);</span></span><br><span class="line">    defer.reject(data.detail);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>但是真正的执行情况是：</p>
<ol>
<li>前端页面在<code>addFireFoxTriggerHandle</code>函数中进行函数遍历之后，就会先把每一个<code>funId</code>都在中转页面（<code>main.js</code>）进行注册监听， 然后再进行函数重定义<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">_.each(obj.funListenerObjs,<span class="function"><span class="keyword">function</span>(<span class="params">funId,name</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 重新定义函数</span></span><br><span class="line">    <span class="comment">// 这时候，要把组件的监听对象，传到page页面去</span></span><br><span class="line">    self.eventObj.emit(<span class="string">'page_bind_handle'</span>,funId);</span><br><span class="line">    obj[name] = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> defer = $.Deferred();</span><br><span class="line">        ......</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>这时候在 <code>main.js</code> 就会触发 <code>page_bind_handle</code> 这个事件, 并监听前端的 <code>funId</code> 的这个事件<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">component.port.on(<span class="string">'page_bind_handle'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> funId = result;</span><br><span class="line">    component.port.on(funId,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> deferDoneId = data.done;</span><br><span class="line">        <span class="keyword">var</span> deferFailId = data.fail;</span><br><span class="line">        <span class="keyword">var</span> deferAlwayId = data.always;</span><br><span class="line">        page.port.once(deferDoneId,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">            component.port.emit(deferDoneId,data);</span><br><span class="line">        &#125;);</span><br><span class="line">        page.port.once(deferFailId,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">            component.port.emit(deferFailId,data);</span><br><span class="line">        &#125;);</span><br><span class="line">        page.port.once(deferAlwayId,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">            component.port.emit(deferAlwayId,data);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 触发函数</span></span><br><span class="line">        page.port.emit(funId,data);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<ol start="2">
<li><p>接下来才是在前端触发这个监听的事件，当我们调用 <code>Airdroid.account.sign</code> 的时候, 在重新定义的<code>sign</code>方法中，绑定这个函数的<code>defer</code>三个返回值的一次性监听，然后触发这个函数所对应的函数<code>id</code>，并把<code>defer</code>是三个返回情况的<code>id</code>传过去</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">self.eventObj.emit(funId,&#123;</span><br><span class="line">  arg: <span class="built_in">Array</span>.prototype.slice.apply(<span class="built_in">arguments</span>),</span><br><span class="line">  done: deferDoneId,</span><br><span class="line">  fail: deferFailId,</span><br><span class="line">  always: deferAlwayId</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>在中转页面（<code>main.js</code>）触发这个监听，在函数体内背景页绑定<code>data</code>的三个<code>defer</code>情况的返回回调<code>id</code>，并触发<code>背景页的函数funId监听</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">component.port.on(funId,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> deferDoneId = data.done;</span><br><span class="line">    <span class="keyword">var</span> deferFailId = data.fail;</span><br><span class="line">    <span class="keyword">var</span> deferAlwayId = data.always;</span><br><span class="line">    page.port.once(deferDoneId,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        component.port.emit(deferDoneId,data);</span><br><span class="line">    &#125;);</span><br><span class="line">    page.port.once(deferFailId,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        component.port.emit(deferFailId,data);</span><br><span class="line">    &#125;);</span><br><span class="line">    page.port.once(deferAlwayId,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        component.port.emit(deferAlwayId,data);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 触发函数</span></span><br><span class="line">    page.port.emit(funId,data);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>在背景页收到中转页面（<code>main.js</code>）的这个函数id触发，并执行函数体，执行完之后，触发<code>defer</code>的三种情况之一的回调事件触发</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">self.addEventListener(uniqFunId,<span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">  <span class="comment">// 这边接收参数</span></span><br><span class="line">  <span class="comment">// 传过来的实际参数</span></span><br><span class="line">  <span class="keyword">var</span> result = event;</span><br><span class="line">  <span class="comment">// 真正的参数,而且是argument的形式</span></span><br><span class="line">  <span class="keyword">var</span> arg = result.arg;</span><br><span class="line">  <span class="comment">// 如果有回调，就触发调用</span></span><br><span class="line">  <span class="keyword">var</span> funResult = value.apply(obj,arg);</span><br><span class="line">  <span class="comment">// 判断是否是Deferred对象</span></span><br><span class="line">  <span class="keyword">if</span>(_.isFunction(funResult.done))&#123;</span><br><span class="line">      funResult.done(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">          result.done &amp;&amp; self.dispatchEvent(result.done,data);</span><br><span class="line">      &#125;).fail(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">          result.fail &amp;&amp; self.dispatchEvent(result.fail,data);</span><br><span class="line">      &#125;).always(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">          result.always &amp;&amp; self.dispatchEvent(result.always,data);</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="comment">// 返回return的</span></span><br><span class="line">      result.done &amp;&amp; self.dispatchEvent(result.done,funResult);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>在中转页面（<code>main.js</code>）收到背景页的<code>defer</code>的回调事件触发，并触发<code>前端页面</code>的对应相同<code>id</code>的回调事件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">page.port.once(deferDoneId,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    component.port.emit(deferDoneId,data);</span><br><span class="line">&#125;);</span><br><span class="line">page.port.once(deferFailId,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    component.port.emit(deferFailId,data);</span><br><span class="line">&#125;);</span><br><span class="line">page.port.once(deferAlwayId,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    component.port.emit(deferAlwayId,data);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>前端页面收到中转页面的<code>defer</code>情况的回调事件，并对参数进行处理</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">self.eventObj.once(deferDoneId,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">  <span class="comment">//self.log(deferDoneId);</span></span><br><span class="line">  defer.resolve(data.detail);</span><br><span class="line">&#125;);</span><br><span class="line">self.eventObj.once(deferFailId,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">  <span class="comment">//self.log(deferFailId);</span></span><br><span class="line">  defer.reject(data.detail);</span><br><span class="line">&#125;);</span><br><span class="line">self.eventObj.once(deferAlwayId,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">  <span class="comment">//self.log(deferAlwayId);</span></span><br><span class="line">  defer.reject(data.detail);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>这样流程就结束了。这样子<code>Firefox</code>也可以在前端页面调用<code>背景页Airdroid对象</code>的方法了。经过我们这样一兼容，无论是<code>Chrome</code>，<code>Safari</code>，还是<code>Firefox</code>，调用方式都是一样的。 都是<code>Chrome</code> 那种调用方式:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Airdroid.account.signIn(mail, pwd).done(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;).fail(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;).always(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>很明显这些方法都要是以<code>defer</code>的形式来返回的。其实如果是直接返回的话，那么也会调用<code>done</code>方法，但是前端还是得用<code>defer</code>的方式来写，这样才能保持一致。相对于<code>Chrome</code>和<code>Safari</code>的<code>popup</code>页面，<code>Safari</code>的非<code>popup</code>会复杂一点，而<code>Firefox</code>就更复杂了，还要再中转一次才行了。</p>
<h2 id="2-前端页面监听一个事件，背景页触发这个事件"><a href="#2-前端页面监听一个事件，背景页触发这个事件" class="headerlink" title="2.前端页面监听一个事件，背景页触发这个事件"></a>2.前端页面监听一个事件，背景页触发这个事件</h2><p>我们现在已经知道怎么从前端页面调用后台的对象以及里面的方法了。虽然各个浏览器的实现原理都不一样。但是总归是在写法上进行了统一。</p>
<p>但是仅仅这样子还是不够的，有时候需要在前端监听一些事件，以便应付背景页的特殊情况。比如在<code>popup</code>页面监听通知改变事件，监听push消息改变事件，登录，登出事件,这些都要背景页在状态变化的时候，要及时通知到前端页面才行。</p>
<p>所以 <code>popup.js</code> 的部分代码如下:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 监听一些全局的事件</span></span><br><span class="line">addListenerGlobalEvent: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">    <span class="comment">// 通知推送过来</span></span><br><span class="line">    self.addListener(self.EventType.notification_change, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// todo </span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    self.addListener(self.EventType.push_change, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// todo </span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    self.addListener(self.EventType.signed_in, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// todo </span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    self.addListener(self.EventType.signed_out, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 如果在其他地方登录，就重新刷新</span></span><br><span class="line">        <span class="comment">// todo </span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>在背景页的长连接通道如果有消息过来的话，这时候就会触发到前端页面，然后让前端页面直接调用背景页的方法获取数据，并进行渲染。</p>
<p>而 <code>addListener</code> 是在 <code>base.js</code> 进行封装的:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 事件处理</span></span><br><span class="line">addListener: <span class="function"><span class="keyword">function</span>(<span class="params">name, fun</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.eventObj)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">window</span>.chrome || <span class="built_in">window</span>.safari)&#123;</span><br><span class="line">            <span class="keyword">this</span>.eventObj.addEventListener(name, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">                _.isFunction(fun) &amp;&amp; fun(event.detail);</span><br><span class="line">            &#125;,<span class="literal">false</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// firefox</span></span><br><span class="line">            <span class="keyword">this</span>.eventObj.on(name, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">                _.isFunction(fun) &amp;&amp; fun(event.detail);</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>而背景页对应的触发代码为 <code>events.js</code>:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 触发事件</span></span><br><span class="line">dispatchEvent: <span class="function"><span class="keyword">function</span>(<span class="params">eventName, details</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">window</span>.chrome || <span class="built_in">window</span>.safari) &#123;</span><br><span class="line">        <span class="built_in">window</span>.dispatchEvent(<span class="keyword">new</span> CustomEvent(eventName, &#123; <span class="string">'detail'</span>: details &#125;));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// firefox</span></span><br><span class="line">        <span class="comment">// todo 因为Firefox的特殊性，他不能再同一个js里面，同时绑定事件，并触发，而是都要经过main.js绕一圈</span></span><br><span class="line">        <span class="comment">// 有一种方法就是使用addEventListener，但是这个又不能传到前台去</span></span><br><span class="line">        <span class="comment">// 这时候要判断该事件是哪一种事件，是双向的，还是单向的， 即属于FireFoxEvent里面的，还是TYPE 里面的</span></span><br><span class="line">        <span class="keyword">if</span>(_.values(<span class="keyword">this</span>.TYPE).indexOf(eventName) &gt; <span class="number">-1</span>)&#123;</span><br><span class="line">            <span class="comment">// 这时候要到外面绕一圈回来</span></span><br><span class="line">            fireFoxEvent.emit(eventName + <span class="string">"_firefox"</span>, &#123; <span class="string">'detail'</span>: details &#125;);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            fireFoxEvent.emit(eventName, &#123; <span class="string">'detail'</span>: details &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>还是老样子，根据不同浏览器来分析。</p>
<h3 id="2-1-Chrome-和-Safari"><a href="#2-1-Chrome-和-Safari" class="headerlink" title="2.1. Chrome 和 Safari"></a>2.1. Chrome 和 Safari</h3><p><code>Chrome</code> 和 <code>Safari</code> 在前端的监听方式都差不多, 在前端页面都是<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.eventObj.addEventListener(name, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">    _.isFunction(fun) &amp;&amp; fun(event.detail);</span><br><span class="line">&#125;,<span class="literal">false</span>);</span><br></pre></td></tr></table></figure></p>
<p>这里的<code>eventObj</code> 就是 <code>setUpBackgroundPage</code> 方法传过来的背景页的 <code>window</code> 对象。</p>
<p>注意： 对于<code>Safari</code> 非 <code>popup</code> 页面，这种绑定是不行的，因为他的<code>eventObj</code>对象其实是<code>fakeAirdroid</code>所在的对象，根本不是背景页的 <code>window</code>，根本通信不了背景页。之所以这么做，其实是因为我们只有在<code>popup</code>页面才会有监听的需求的，其他的前端页面暂时没有这个需求。</p>
<p>比如在 <code>reply</code> 页面(非 <code>popup</code>页面), 如果前端想要数据的话，就直接请求。比如当我打开<code>reply</code>进行回复的时候，就要有上一条的消息，这时候就会通过<code>addEventListener</code>的形式去获取, <code>replay.js</code> 部分代码如下:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> listener = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (e.name == <span class="string">'conversation_push'</span>) &#123;</span><br><span class="line">    self.render(<span class="built_in">JSON</span>.parse(e.message));</span><br><span class="line">    safari.self.removeEventListener(<span class="string">'message'</span>, listener, <span class="literal">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">safari.self.addEventListener(<span class="string">'message'</span>, listener, <span class="literal">false</span>);</span><br><span class="line">safari.self.tab.dispatchMessage(<span class="string">'request_conversation_push'</span>);</span><br></pre></td></tr></table></figure></p>
<p>而在背景页，就要处理这种情况，并把数据发过来, 比如背景页的 <code>notificationManage.js</code> 的部分代码如下:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> listener = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (e.name == <span class="string">'request_conversation_push'</span>) &#123;</span><br><span class="line">    <span class="comment">// 这边要去掉里面的数组</span></span><br><span class="line">    <span class="keyword">delete</span> obj.buttons;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"接受其他页面的数据请求==&gt;"</span> + <span class="built_in">JSON</span>.stringify(obj));</span><br><span class="line">    e.target.page.dispatchMessage(<span class="string">'conversation_push'</span>, <span class="built_in">JSON</span>.stringify(obj));</span><br><span class="line">    safari.application.removeEventListener(<span class="string">'message'</span>, listener, <span class="literal">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">safari.application.addEventListener(<span class="string">'message'</span>, listener, <span class="literal">false</span>);</span><br><span class="line"><span class="keyword">var</span> w = safari.application.openBrowserWindow();</span><br><span class="line">w.activeTab.url = safari.extension.baseURI + spec.url + <span class="string">'&amp;width='</span> + spec.width + <span class="string">'&amp;height='</span> + spec.height;</span><br></pre></td></tr></table></figure></p>
<p>这样就实现了<code>Safari</code> 非 <code>popup</code> 页面的数据请求机制。还是以事件驱动的方式来通信。</p>
<p>如果在<code>Chrome</code>或者<code>Safari</code> <code>popup</code> 页面进行监听的话，那么背景页的触发也是很简单。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.dispatchEvent(<span class="keyword">new</span> CustomEvent(eventName, &#123; <span class="string">'detail'</span>: details &#125;));</span><br></pre></td></tr></table></figure></p>
<p>这样子前端页面的监听就会被触发到。从而实现背景页的通知功能。</p>
<h3 id="2-2-Firefox"><a href="#2-2-Firefox" class="headerlink" title="2.2. Firefox"></a>2.2. Firefox</h3><p><code>Firefox</code> 会比较麻烦，因为还要过一次中转页面(<code>main.js</code>)。前端页面的逻辑也是比较简单的:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.eventObj.on(name, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">    _.isFunction(fun) &amp;&amp; fun(event.detail);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>其中<code>eventObj</code> 就是 <code>self.port</code>, 背景页触发也是比较简单<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// firefox</span></span><br><span class="line"><span class="comment">// todo 因为Firefox的特殊性，他不能再同一个js里面，同时绑定事件，并触发，而是都要经过main.js绕一圈</span></span><br><span class="line"><span class="comment">// 有一种方法就是使用addEventListener，但是这个又不能传到前台去</span></span><br><span class="line"><span class="comment">// 这时候要判断该事件是哪一种事件，是双向的，还是单向的， 即属于FireFoxEvent里面的，还是TYPE 里面的</span></span><br><span class="line"><span class="keyword">if</span>(_.values(<span class="keyword">this</span>.TYPE).indexOf(eventName) &gt; <span class="number">-1</span>)&#123;</span><br><span class="line">    <span class="comment">// 这时候要到外面绕一圈回来</span></span><br><span class="line">    fireFoxEvent.emit(eventName + <span class="string">"_firefox"</span>, &#123; <span class="string">'detail'</span>: details &#125;);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    fireFoxEvent.emit(eventName, &#123; <span class="string">'detail'</span>: details &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，这个背景页有两个<code>if</code>分支，其中第二个分支 <code>fireFoxEvent.emit(eventName, { &#39;detail&#39;: details });</code> 其实就是前端页面调用背景页方法用的方法， 所以要实现事件触发监听，其实是在第一个if分支上。</p>
<p>从代码里面可以看到，他会被判断这个事件是否有在<code>this.TYPE</code>数组里面。 如果存在的时候，会去触发一个 <code>fireFoxEvent.emit(eventName + &quot;_firefox&quot;, { &#39;detail&#39;: details });</code>, 为什么要这样处理呢？ 这个是因为要处理这个中转的问题。</p>
<p> 也就是说，如果前端页面监听了一个<code>notification_change</code>事件，要来监听通知的改变，那么等背景页触发这个通知改变的时候，怎么样才能把这个触发传到前端页面来呢？ 流程如下：</p>
<ol>
<li>背景页触发这个通知<br><code>events.js</code> 在初始化(<code>init</code> 函数)的时候，就会把<code>TYPE数组</code>的事件都注册监听<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> isListener = [self.TYPE.signed_in, self.TYPE.signed_out];</span><br><span class="line">_.each(self.TYPE,<span class="function"><span class="keyword">function</span>(<span class="params">value,key</span>)</span>&#123;</span><br><span class="line">    self.dispatchEvent(self.FireFoxEvent.registerHandle, value);</span><br><span class="line">    <span class="comment">// 同时绑定所有监听的默认事件</span></span><br><span class="line">    (isListener.indexOf(value) == <span class="number">-1</span>) &amp;&amp; Airdroid.Event.addEventListener(value, $.noop);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>当背景页触发事件的时候<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Airdroid.Event.dispatchEvent(Airdroid.Event.FireFoxEvent.notifications_changed, _.keys(self._notificationsObj));</span><br></pre></td></tr></table></figure></p>
<p>然后执行的时候，因为 <code>notifications_changed</code> 这个事件在 <code>this.TYPE</code> 里面，所以执行<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fireFoxEvent.emit(eventName + <span class="string">"_firefox"</span>, &#123; <span class="string">'detail'</span>: details &#125;);</span><br></pre></td></tr></table></figure></p>
<ol start="2">
<li><p>中转页面（<code>main.js</code>）收到这个触发(<code>notifications_changed_firefox</code>)，然后又把这个事件(<code>notifications_changed</code>)再回传回去（events初始化就已经绑定了）。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册可以双向通信的事件通道</span></span><br><span class="line">page.port.on(<span class="string">'registerHandle'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> handleName = event.detail;</span><br><span class="line">    <span class="comment">// 这边开始注册一个事件, 名字为 name 后面加上 firefox 字样, 主要是让后台来触发，再回传到后台去，相当于绕了一圈，这样子会比较麻烦，但是为了兼容其他浏览器和一致性，只能这样了</span></span><br><span class="line">    page.port.on(handleName + <span class="string">"_firefox"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 同时回传过去</span></span><br><span class="line">        page.port.emit(handleName, data);</span><br><span class="line">        <span class="comment">// 同时也回传到前台. 注意，这边不能直接在同一个main.js 里面触发，还是要先绕回去</span></span><br><span class="line">        <span class="comment">// page.port.emit(handleName + "_front", data);</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>背景页收到这个事件<code>notifications_changed</code>之后，触发执行之后，还要再回调到前端页面, 事件就是 <code>notifications_changed_front</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">addEventListener: <span class="function"><span class="keyword">function</span>(<span class="params">eventName, listener, isOnce</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">window</span>.chrome || <span class="built_in">window</span>.safari)&#123;</span><br><span class="line">      <span class="keyword">this</span>.eventListeners.push(&#123; <span class="string">'eventName'</span>: eventName, <span class="string">'listener'</span>: listener &#125;);</span><br><span class="line">      <span class="built_in">window</span>.addEventListener(eventName, listener, <span class="literal">false</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// firefox</span></span><br><span class="line">      <span class="comment">// 这边还要把这个事件回调到前台去</span></span><br><span class="line">      <span class="keyword">var</span> cb = <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">          listener(data);</span><br><span class="line">          <span class="comment">// 还要回调到前台去，这边注意一个问题，如果有很多个前台的话，不知道会不会发生事件覆盖</span></span><br><span class="line">          (_.values(self.TYPE).indexOf(eventName) &gt; <span class="number">-1</span>) &amp;&amp; fireFoxEvent.emit(eventName + <span class="string">"_front"</span>, data);</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">if</span>(isOnce)&#123;</span><br><span class="line">          fireFoxEvent.once(eventName,cb);</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          fireFoxEvent.on(eventName,cb);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>ps: 之所以绕了一圈重新回到 <code>notifications_changed</code> 回调事件，就是因为在 <code>Firefox</code>, 只要是事件触发，哪怕是都写在背景页后台中，都要到 <code>main.js</code> 绕一圈，不然没法触发。</p>
<ol start="4">
<li><p>中转页面（<code>main.js</code>）收到这个触发，然后触发前端页面的这个触发</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 绑定那些可以从后台触发到前台的事件，比如signed_in</span></span><br><span class="line">component.port.on(<span class="string">"page_register_handle"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> name = data.name;</span><br><span class="line">    <span class="comment">// 绑定对应页面的前台事件, 然后再对应到前台所绑定的函数</span></span><br><span class="line">    page.port.on(name + <span class="string">"_front"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        component.port.emit(name,data);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>前端页面收到中转页面（<code>main.js</code>）的这个事件触发</p>
</li>
</ol>
<p>所以整个流程，其实最重要的地方就是两个中转页面地方的处理：<br>一个是背景页面的<code>registerHandle</code>事件注册, 同时要把<code>TYPE</code>数组里面的除登入，登出之外的其他事件都注册（比如<code>push_change</code>，<code>notification_change</code>）,在 <code>events.js</code> 的代码片段就是:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这时候要注册可以双向通行的事件</span></span><br><span class="line"><span class="comment">// todo 这边如果已经在 background.js 中已经注册的事件了，就不要重复绑定了,不然前台会触发两次</span></span><br><span class="line"><span class="keyword">var</span> isListener = [self.TYPE.signed_in, self.TYPE.signed_out];</span><br><span class="line">_.each(self.TYPE,<span class="function"><span class="keyword">function</span>(<span class="params">value,key</span>)</span>&#123;</span><br><span class="line">    self.dispatchEvent(self.FireFoxEvent.registerHandle, value);</span><br><span class="line">    <span class="comment">// 同时绑定所有监听的默认事件</span></span><br><span class="line">    (isListener.indexOf(value) == <span class="number">-1</span>) &amp;&amp; Airdroid.Event.addEventListener(value, $.noop);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>背景页中转页面（<code>main.js</code>）的处理:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册可以双向通信的事件通道</span></span><br><span class="line">page.port.on(<span class="string">'registerHandle'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> handleName = event.detail;</span><br><span class="line">    <span class="comment">// 这边开始注册一个事件, 名字为 name 后面加上 firefox 字样, 主要是让后台来触发，再回传到后台去，相当于绕了一圈，这样子会比较麻烦，但是为了兼容其他浏览器和一致性，只能这样了</span></span><br><span class="line">    page.port.on(handleName + <span class="string">"_firefox"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 同时回传过去</span></span><br><span class="line">        page.port.emit(handleName, data);</span><br><span class="line">        <span class="comment">// 同时也回传到前台. 注意，这边不能直接在同一个main.js 里面触发，还是要先绕回去</span></span><br><span class="line">        <span class="comment">// page.port.emit(handleName + "_front", data);</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>第二个就是前端页面要去绑定这个<code>page_register_handle</code>事件, <code>base.js</code> 代码片段如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">fireFoxEvent.on(<span class="string">'page_data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 传过来 AirDroid对象</span></span><br><span class="line">    self.setUpBackgroundPage(data.detail);</span><br><span class="line">    <span class="comment">// 接下来绑定可以传递到前台的触发事件</span></span><br><span class="line">    _.each(_.values(self.EventType),<span class="function"><span class="keyword">function</span>(<span class="params">item</span>)</span>&#123;</span><br><span class="line">        fireFoxEvent.emit(<span class="string">"page_register_handle"</span>,&#123;<span class="attr">name</span>:item&#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">    self.inited(args);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 触发页面初始化事件，让后台传递AirDroid数据过来</span></span><br><span class="line">fireFoxEvent.emit(<span class="string">'page_init'</span>);</span><br></pre></td></tr></table></figure></p>
<p>对应的中转页面（main.js）的代码片段为:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 绑定那些可以从后台触发到前台的事件，比如signed_in</span></span><br><span class="line">component.port.on(<span class="string">"page_register_handle"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> name = data.name;</span><br><span class="line">    <span class="comment">// 绑定对应页面的前台事件, 然后再对应到前台所绑定的函数</span></span><br><span class="line">    page.port.on(name + <span class="string">"_front"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        component.port.emit(name,data);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>可以看到，当获取到背景页过来的<code>Airdroid对象</code>的时候，它对每一个<code>EventType</code>的项都触发了一次<code>page_register_handle</code>事件，让背景页监听触发的事件。<br>而<code>EventType</code>数组也是从<code>Airdroid</code>对象获取的，在<code>setUpBackgroundPage</code>中设置。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.EventType = <span class="keyword">this</span>.Airdroid.Event.TYPE;</span><br></pre></td></tr></table></figure></p>
<p>其实就是<code>events.js</code>里面的<code>TYPE</code><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">TYPE: &#123;</span><br><span class="line">    <span class="comment">// 登录事件</span></span><br><span class="line">    <span class="string">"signed_in"</span>: <span class="string">"signed_in"</span>,</span><br><span class="line">    <span class="comment">// 登出事件</span></span><br><span class="line">    <span class="string">"signed_out"</span>: <span class="string">"signed_out"</span>,</span><br><span class="line">    <span class="comment">// push事件改变事件</span></span><br><span class="line">    <span class="string">"push_change"</span>: <span class="string">"push_change"</span>,</span><br><span class="line">    <span class="comment">// 普通通知改变事件</span></span><br><span class="line">    <span class="string">"notification_change"</span>: <span class="string">"notification_change"</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>这里面就是所有能在前端页面进行监听的事件列表，也就是说，如果你要在前端页面进行一个新的事件监听，那么就要在这里面再添加一个新的事件。所以在前端页面这样执行完之后。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_.each(_.values(self.EventType),<span class="function"><span class="keyword">function</span>(<span class="params">item</span>)</span>&#123;</span><br><span class="line">    fireFoxEvent.emit(<span class="string">"page_register_handle"</span>,&#123;<span class="attr">name</span>:item&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>那么在中转页面（<code>main.js</code>）就多了四个监听了分别是:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">page.port.on(<span class="string">"signed_in_front"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    component.port.emit(<span class="string">'signed_in'</span>,data);</span><br><span class="line">&#125;)</span><br><span class="line">page.port.on(<span class="string">"signed_out_front"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    component.port.emit(<span class="string">'signed_out'</span>,data);</span><br><span class="line">&#125;)</span><br><span class="line">page.port.on(<span class="string">"push_change_front"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    component.port.emit(<span class="string">'push_change'</span>,data);</span><br><span class="line">&#125;)</span><br><span class="line">page.port.on(<span class="string">"notification_change_front"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    component.port.emit(<span class="string">'notification_change'</span>,data);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>所以当中转页面（<code>main.js</code>）把<code>notifications_changed</code> 重新触发到背景页的时候:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> cb = <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    listener(data);</span><br><span class="line">    <span class="comment">// 还要回调到前台去，这边注意一个问题，如果有很多个前台的话，不知道会不会发生事件覆盖</span></span><br><span class="line">    (_.values(self.TYPE).indexOf(eventName) &gt; <span class="number">-1</span>) &amp;&amp; fireFoxEvent.emit(eventName + <span class="string">"_front"</span>, data);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">if</span>(isOnce)&#123;</span><br><span class="line">    fireFoxEvent.once(eventName,cb);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    fireFoxEvent.on(eventName,cb);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>cb</code> 方法里面会去判断<code>notifications_changed</code>这个事件是否在<code>TYPE</code>里面，如果在里面，说明这个事件是可以传递到前端页面的。所以才要触发<code>notifications_changed_front</code>事件到中间页面（<code>main.js</code>），从而再从中间页面（<code>main.js</code>）才触发<code>notification_change</code>到前端页面去。</p>
<p>所以<code>Firefox</code>的前端页面监听背景页触发，就是这样子。</p>
<h2 id="3-背景页监听一个事件，背景页和前端页面都触发这个事件"><a href="#3-背景页监听一个事件，背景页和前端页面都触发这个事件" class="headerlink" title="3.背景页监听一个事件，背景页和前端页面都触发这个事件"></a>3.背景页监听一个事件，背景页和前端页面都触发这个事件</h2><p>前面两点已经讲述了怎么在前端页面调用背景页的<code>Airdroid对象方法</code>，以及在前端事件监听，由背景页触发这个事件。但是还有一种情况，我们还要在处理，就是如果在背景页触发某个事件，不仅前端页面有收到（如果前端页面有监听这个事件），背景页也会收到（如果背景页也有监听这个事件）。</p>
<p>举个例子，针对登录成功<code>signed_in</code>这个事件监听，不仅前端页面有监听，在背景页也有监听, 比如前端的 <code>popup.js</code> 的代码如下:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">self.addListener(self.EventType.signed_in, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 如果不是在前端登的，比如后台自动登录，那么要切换页面</span></span><br><span class="line">  self.log(<span class="string">"登录了=="</span>);</span><br><span class="line">  <span class="keyword">if</span>(!self._isSigning &amp;&amp; self._dom.signInPage.inputEmail.is(<span class="string">":visible"</span>))&#123;</span><br><span class="line">  self.afterSignIn();</span><br><span class="line">  self.signInEnableDom();</span><br><span class="line">&#125;&#125;);</span><br></pre></td></tr></table></figure></p>
<p>然后背景页也有监听，比如 <code>background.js</code> 的代码如下:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 监听登录事件</span></span><br><span class="line">Airdroid.Event.addEventListener(Airdroid.Event.TYPE.signed_in, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.info(<span class="string">"响应登陆事件"</span>);</span><br><span class="line">  Airdroid.Cache.setCacheType();</span><br><span class="line">  <span class="comment">// 登录之后，初始化右键菜单</span></span><br><span class="line">  Airdroid.Account.getDevicesObjList().done(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    Airdroid.ContextMenus.init(data);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>当<code>account</code>的<code>signIn</code>方法登录成功的时候。触发这个登录事件<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Airdroid.Event.dispatchEvent(Airdroid.Event.TYPE.signed_in);</span><br></pre></td></tr></table></figure></p>
<p>这时候就要上述两个监听，都要可以触发到。 其实前端监听其实就是第二点。所以第三点主要讲的是，怎么在背景页也可以触发到。</p>
<p>从第二点我们可以知道，所有可以监听的事件都在<code>events</code>的这个数组里面:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">TYPE: &#123;</span><br><span class="line">  <span class="comment">// 登录事件</span></span><br><span class="line">  <span class="string">"signed_in"</span>: <span class="string">"signed_in"</span>,</span><br><span class="line">  <span class="comment">// 登出事件</span></span><br><span class="line">  <span class="string">"signed_out"</span>: <span class="string">"signed_out"</span>,</span><br><span class="line">  <span class="comment">// push事件改变事件</span></span><br><span class="line">  <span class="string">"push_change"</span>: <span class="string">"push_change"</span>,</span><br><span class="line">  <span class="comment">// 普通通知改变事件</span></span><br><span class="line">  <span class="string">"notification_change"</span>: <span class="string">"notification_change"</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>按照惯例，我们还是按照不同的浏览器来分析</p>
<h3 id="3-1-Chrome-和-Safari"><a href="#3-1-Chrome-和-Safari" class="headerlink" title="3.1 Chrome 和 Safari"></a>3.1 Chrome 和 Safari</h3><p>都是背景页环境，直接<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.addEventListener(eventName, listener, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.dispatchEvent(<span class="keyword">new</span> CustomEvent(eventName, &#123; <span class="string">'detail'</span>: details &#125;));</span><br></pre></td></tr></table></figure></p>
<p>这样就可以了。</p>
<h3 id="3-2-Firefox"><a href="#3-2-Firefox" class="headerlink" title="3.2 Firefox"></a>3.2 Firefox</h3><p><code>Firefox</code> 其实就会比较麻烦，在第二点的时候，有讲过，当触发:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Airdroid.Event.dispatchEvent(Airdroid.Event.FireFoxEvent.notifications_changed, _.keys(self._notificationsObj));</span><br></pre></td></tr></table></figure></p>
<p>这个事件的时候,其实会触发<code>notifications_changed_firefox</code>, 然后逻辑跑到中间页面（<code>main.js</code>），在中间页面（<code>main.js</code>）触发<code>notifications_changed</code>事件，然后逻辑再跑回背景页。这时候就会触发背景页所监听的<code>notifications_changed</code>事件，这时候就执行了背景页所监听的事件，同时执行完之后，再接着触发前端页面的<code>notifications_changed</code>事件。<br>在 <code>events.js</code> 的 <code>addEventListener</code> 方法:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">addEventListener: <span class="function"><span class="keyword">function</span>(<span class="params">eventName, listener, isOnce</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">window</span>.chrome || <span class="built_in">window</span>.safari)&#123;</span><br><span class="line">        <span class="comment">// todo</span></span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// firefox</span></span><br><span class="line">        <span class="comment">// 这边还要把这个事件回调到前台去</span></span><br><span class="line">        <span class="keyword">var</span> cb = <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">            listener(data);</span><br><span class="line">            <span class="comment">// 还要回调到前台去，这边注意一个问题，如果有很多个前台的话，不知道会不会发生事件覆盖</span></span><br><span class="line">            (_.values(self.TYPE).indexOf(eventName) &gt; <span class="number">-1</span>) &amp;&amp; fireFoxEvent.emit(eventName + <span class="string">"_front"</span>, data);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span>(isOnce)&#123;</span><br><span class="line">            fireFoxEvent.once(eventName,cb);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            fireFoxEvent.on(eventName,cb);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>所以这时候也是有触发背景页的监听的。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过三个需求点，我们主要梳理了这三个浏览器的事件驱动模式，尤其是 <code>Firefox</code> 复杂了很多，而且我们抽象成统一的写法，这样子在做业务的时候，我们就不需要考虑不同浏览器的不同写法了，因为对外暴露的方法都是统一的，我们不需要在这个层面去考虑浏览器兼容性。</p>
<hr>
<p>系列文章:<br><a href="/2019/11/25/browser-extension-1/" title="浏览器 extension 插件开发系列(01) -- 前言和确认需求">浏览器 extension 插件开发系列(01) -- 前言和确认需求</a><br><a href="/2019/11/25/browser-extension-2/" title="浏览器 extension 插件开发系列(02) -- Chrome 插件的启动以及调试">浏览器 extension 插件开发系列(02) -- Chrome 插件的启动以及调试</a><br><a href="/2019/11/25/browser-extension-3/" title="浏览器 extension 插件开发系列(03) -- Firefox 插件的启动以及调试">浏览器 extension 插件开发系列(03) -- Firefox 插件的启动以及调试</a><br><a href="/2019/11/25/browser-extension-4/" title="浏览器 extension 插件开发系列(04) -- Safari 插件的添加以及调试">浏览器 extension 插件开发系列(04) -- Safari 插件的添加以及调试</a><br><a href="/2019/11/25/browser-extension-5/" title="浏览器 extension 插件开发系列(05) -- Safari 插件申请开发者证书">浏览器 extension 插件开发系列(05) -- Safari 插件申请开发者证书</a><br><a href="/2019/11/25/browser-extension-6/" title="浏览器 extension 插件开发系列(06) -- 各浏览器导航栏按钮的配置的点击出现的panel">浏览器 extension 插件开发系列(06) -- 各浏览器导航栏按钮的配置的点击出现的panel</a><br><a href="/2019/11/25/browser-extension-7/" title="浏览器 extension 插件开发系列(07) -- 获取各浏览器端的背景页">浏览器 extension 插件开发系列(07) -- 获取各浏览器端的背景页</a><br><a href="/2019/11/25/browser-extension-8/" title="浏览器 extension 插件开发系列(08) -- 背景页启动和登录持久化">浏览器 extension 插件开发系列(08) -- 背景页启动和登录持久化</a><br><a href="/2019/11/25/browser-extension-9/" title="浏览器 extension 插件开发系列(09) -- popup以及其他前端页面的启动">浏览器 extension 插件开发系列(09) -- popup以及其他前端页面的启动</a><br><a href="/2019/11/25/browser-extension-10/" title="浏览器 extension 插件开发系列(10) -- 事件驱动模型">浏览器 extension 插件开发系列(10) -- 事件驱动模型</a><br><a href="/2019/11/25/browser-extension-11/" title="浏览器 extension 插件开发系列(11) -- 登录模块(包括第三方登录和弹框)">浏览器 extension 插件开发系列(11) -- 登录模块(包括第三方登录和弹框)</a><br><a href="/2019/11/25/browser-extension-12/" title="浏览器 extension 插件开发系列(12) -- 实现右键菜单推送消息">浏览器 extension 插件开发系列(12) -- 实现右键菜单推送消息</a><br><a href="/2019/11/25/browser-extension-13/" title="浏览器 extension 插件开发系列(13) -- 实现消息过来出现桌面通知">浏览器 extension 插件开发系列(13) -- 实现消息过来出现桌面通知</a><br><a href="/2019/11/25/browser-extension-14/" title="浏览器 extension 插件开发系列(14) -- 点击reply出现回复小窗口">浏览器 extension 插件开发系列(14) -- 点击reply出现回复小窗口</a><br><a href="/2019/11/25/browser-extension-15/" title="浏览器 extension 插件开发系列(15) -- chrome多文件上传（拖拽上传或者点击上传）">浏览器 extension 插件开发系列(15) -- chrome多文件上传（拖拽上传或者点击上传）</a><br><a href="/2019/11/25/browser-extension-16/" title="浏览器 extension 插件开发系列(16) -- Firefox 遇到的问题">浏览器 extension 插件开发系列(16) -- Firefox 遇到的问题</a><br><a href="/2019/11/25/browser-extension-17/" title="浏览器 extension 插件开发系列(17) -- Safari 遇到的问题">浏览器 extension 插件开发系列(17) -- Safari 遇到的问题</a></p>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    Zach Ke
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://kebingzao.com/2019/11/25/browser-extension-10/" title="浏览器 extension 插件开发系列(10) -- 事件驱动模型">http://kebingzao.com/2019/11/25/browser-extension-10/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/js/" rel="tag"># js</a>
          
            <a href="/tags/浏览器插件/" rel="tag"># 浏览器插件</a>
          
            <a href="/tags/Chrome-插件/" rel="tag"># Chrome 插件</a>
          
            <a href="/tags/Firefox-插件/" rel="tag"># Firefox 插件</a>
          
            <a href="/tags/Safari-插件/" rel="tag"># Safari 插件</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/11/25/browser-extension-9/" rel="next" title="浏览器 extension 插件开发系列(09) -- popup以及其他前端页面的启动">
                <i class="fa fa-chevron-left"></i> 浏览器 extension 插件开发系列(09) -- popup以及其他前端页面的启动
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/11/25/browser-extension-11/" rel="prev" title="浏览器 extension 插件开发系列(11) -- 登录模块(包括第三方登录和弹框)">
                浏览器 extension 插件开发系列(11) -- 登录模块(包括第三方登录和弹框) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="Zach Ke" />
            
              <p class="site-author-name" itemprop="name">Zach Ke</p>
              <p class="site-description motion-element" itemprop="description">做最咸的那一条</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">202</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">25</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">48</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/kebingzao" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-前端页面调用背景页AirDroid对象的方法"><span class="nav-number">2.</span> <span class="nav-text">1.前端页面调用背景页AirDroid对象的方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-Chrome-浏览器"><span class="nav-number">2.1.</span> <span class="nav-text">1.1 Chrome 浏览器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-Safari-浏览器"><span class="nav-number">2.2.</span> <span class="nav-text">1.2 Safari 浏览器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-Firefox-浏览器"><span class="nav-number">2.3.</span> <span class="nav-text">1.3 Firefox 浏览器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-前端页面监听一个事件，背景页触发这个事件"><span class="nav-number">3.</span> <span class="nav-text">2.前端页面监听一个事件，背景页触发这个事件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-Chrome-和-Safari"><span class="nav-number">3.1.</span> <span class="nav-text">2.1. Chrome 和 Safari</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-Firefox"><span class="nav-number">3.2.</span> <span class="nav-text">2.2. Firefox</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-背景页监听一个事件，背景页和前端页面都触发这个事件"><span class="nav-number">4.</span> <span class="nav-text">3.背景页监听一个事件，背景页和前端页面都触发这个事件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-Chrome-和-Safari"><span class="nav-number">4.1.</span> <span class="nav-text">3.1 Chrome 和 Safari</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-Firefox"><span class="nav-number">4.2.</span> <span class="nav-text">3.2 Firefox</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">5.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zach Ke</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://zach-2.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://kebingzao.com/2019/11/25/browser-extension-10/';
          this.page.identifier = '2019/11/25/browser-extension-10/';
          this.page.title = '浏览器 extension 插件开发系列(10) -- 事件驱动模型';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://zach-2.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  














  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.4"></script>



  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("HIV4XRdKJXB0eaFgtSjiVNaK-gzGzoHsz", "zN3v8grxW0Q8eXwNlEgXxWrF");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
