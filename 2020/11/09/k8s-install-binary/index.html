<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <script src="/live2d-widget/live2d-widget-resource/jquery.min.js"></script>
  <link rel="stylesheet" href="/live2d-widget/live2d-widget-resource/font-awesome.min.css"/>
  <script src="/live2d-widget/autoload.js"></script>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />


















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="kubernetes," />










<meta name="description" content="前言前面经过 CentOS7 Minikube - Kubernetes 单机安装 和 CentOS7 手动安装 Kubeadm 集群环境 的实操，接下来为了更深刻的理解 kubernetes， 本节我们来用二进制包的方式来安装 kubernetes 集群环境。 事实上，现在 2020 年了，  kubeadm 已经可以用于 生产环境部署了。 但是毕竟是集成安装的， 很多细节我都不了解。 为了更好">
<meta name="keywords" content="kubernetes">
<meta property="og:type" content="article">
<meta property="og:title" content="CentOS7 使用二进制包安装 kubernetes 集群环境">
<meta property="og:url" content="http://kebingzao.com/2020/11/09/k8s-install-binary/index.html">
<meta property="og:site_name" content="Zach Ke&#39;s Notes">
<meta property="og:description" content="前言前面经过 CentOS7 Minikube - Kubernetes 单机安装 和 CentOS7 手动安装 Kubeadm 集群环境 的实操，接下来为了更深刻的理解 kubernetes， 本节我们来用二进制包的方式来安装 kubernetes 集群环境。 事实上，现在 2020 年了，  kubeadm 已经可以用于 生产环境部署了。 但是毕竟是集成安装的， 很多细节我都不了解。 为了更好">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://kebingzao.com/2020/11/09/k8s-install-binary/1.png">
<meta property="og:image" content="http://kebingzao.com/2020/11/09/k8s-install-binary/2.png">
<meta property="og:updated_time" content="2020-11-12T13:34:58.931Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CentOS7 使用二进制包安装 kubernetes 集群环境">
<meta name="twitter:description" content="前言前面经过 CentOS7 Minikube - Kubernetes 单机安装 和 CentOS7 手动安装 Kubeadm 集群环境 的实操，接下来为了更深刻的理解 kubernetes， 本节我们来用二进制包的方式来安装 kubernetes 集群环境。 事实上，现在 2020 年了，  kubeadm 已经可以用于 生产环境部署了。 但是毕竟是集成安装的， 很多细节我都不了解。 为了更好">
<meta name="twitter:image" content="http://kebingzao.com/2020/11/09/k8s-install-binary/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'KGVI6VPIBI',
      apiKey: '41c2ccc830ca183768a6bf1e50a03f44',
      indexName: 'test_blog',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://kebingzao.com/2020/11/09/k8s-install-binary/"/>





  <title>CentOS7 使用二进制包安装 kubernetes 集群环境 | Zach Ke's Notes</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <a href="https://github.com/kebingzao" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Zach Ke's Notes</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Quick notes</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kebingzao.com/2020/11/09/k8s-install-binary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zach Ke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zach Ke's Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">CentOS7 使用二进制包安装 kubernetes 集群环境</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-11-09T15:28:16+08:00">
                2020-11-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">kubernetes</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/11/09/k8s-install-binary/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/11/09/k8s-install-binary/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2020/11/09/k8s-install-binary/" class="leancloud_visitors" data-flag-title="CentOS7 使用二进制包安装 kubernetes 集群环境">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>前面经过 <a href="/2020/11/06/k8s-install-minikube/" title="CentOS7 Minikube - Kubernetes 单机安装">CentOS7 Minikube - Kubernetes 单机安装</a> 和 <a href="/2020/11/06/k8s-install-kubeadm/" title="CentOS7 手动安装 Kubeadm 集群环境">CentOS7 手动安装 Kubeadm 集群环境</a> 的实操，接下来为了更深刻的理解 kubernetes， 本节我们来用二进制包的方式来安装 kubernetes 集群环境。</p>
<p>事实上，现在 2020 年了，  kubeadm 已经可以用于 生产环境部署了。 但是毕竟是集成安装的， 很多细节我都不了解。 为了更好的学习 kubernetes，理解里面错综复杂的关系链， 用二进制包的方式来安装 kubernetes 肯定是要的， 本文主要是根据 <a href="https://github.com/caicloud/kube-ladder/blob/master/tutorials/lab3-manual-installtion.md" target="_blank" rel="noopener">Kubernetes The Hard Way</a> 这一篇文章的基础上，一步一步去实践安装的， 本身那一篇的篇幅就很长， 本文再扩展一下，再实践一下，那就更长了。 可以理解为实践篇。<br><a id="more"></a></p>
<h2 id="机器准备"><a href="#机器准备" class="headerlink" title="机器准备"></a>机器准备</h2><p>本次准备了三台机子， 一台 master， 两台 node (事实上安装完最后会发现 master 这一台只做控制，并没有加入到集群中，真正的集群只有那两台 node)</p>
<table>
<thead>
<tr>
<th>环境参数</th>
<th>值</th>
</tr>
</thead>
<tbody>
<tr>
<td>系统</td>
<td>CentOS 7</td>
</tr>
<tr>
<td>CPU</td>
<td>2 核</td>
</tr>
<tr>
<td>内存</td>
<td>4 G</td>
</tr>
<tr>
<td>能否科学上网</td>
<td>能 (腾讯云位于美西的机器)</td>
</tr>
<tr>
<td>三台直接可以用内网相互访问</td>
<td>能</td>
</tr>
</tbody>
</table>
<p>这三台的内网 ip:</p>
<ul>
<li>172.26.64.9    worker-master</li>
<li>172.26.64.2    worker-1</li>
<li>172.26.64.10   worker-2</li>
</ul>
<h2 id="每一台的环境都要先配置"><a href="#每一台的环境都要先配置" class="headerlink" title="每一台的环境都要先配置"></a>每一台的环境都要先配置</h2><h3 id="1-关闭防火墙-开放端口"><a href="#1-关闭防火墙-开放端口" class="headerlink" title="1. 关闭防火墙 / 开放端口"></a>1. 关闭防火墙 / 开放端口</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# systemctl stop firewalld</span><br><span class="line">[root@worker-master ~]# systemctl disable firewalld</span><br></pre></td></tr></table></figure>
<p>关闭防火墙主要是为了让端口开放，按照官方文档，这些端口都会用到，都不要限制的。</p>
<p><img src="/2020/11/09/k8s-install-binary/1.png" alt="1"></p>
<p>如果是云服务器的话，那么就要在安全组那边将这几台的端口都开放:</p>
<p><img src="/2020/11/09/k8s-install-binary/2.png" alt="1"></p>
<h3 id="2-禁用SELinux"><a href="#2-禁用SELinux" class="headerlink" title="2. 禁用SELinux"></a>2. 禁用SELinux</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# setenforce 0</span><br><span class="line">setenforce: SELinux is disabled</span><br><span class="line">[root@worker-master ~]# sed -i &apos;s/^SELINUX=enforcing$/SELINUX=permissive/&apos; /etc/selinux/config</span><br></pre></td></tr></table></figure>
<h3 id="3-关闭Swap"><a href="#3-关闭Swap" class="headerlink" title="3. 关闭Swap"></a>3. 关闭Swap</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# swapoff -a</span><br></pre></td></tr></table></figure>
<h3 id="4-CentOS-7-用户还需要执行："><a href="#4-CentOS-7-用户还需要执行：" class="headerlink" title="4. CentOS 7 用户还需要执行："></a>4. CentOS 7 用户还需要执行：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# cat &lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf</span><br><span class="line">&gt; net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">&gt; net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">&gt; EOF</span><br><span class="line">[root@worker-master ~]# sysctl --system</span><br></pre></td></tr></table></figure>
<h3 id="5-etc-hosts-文件增加"><a href="#5-etc-hosts-文件增加" class="headerlink" title="5. /etc/hosts 文件增加"></a>5. /etc/hosts 文件增加</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">172.26.64.2 worker-1</span><br><span class="line">172.26.64.10 worker-2</span><br><span class="line">172.26.64.9 worker-master</span><br></pre></td></tr></table></figure>
<font color="red"><b>除非另有说明, 以下所有操作都是在 master 上执行</b></font>

<h2 id="1-安装必要工具"><a href="#1-安装必要工具" class="headerlink" title="1. 安装必要工具"></a>1. 安装必要工具</h2><p>接下来在 master 上安装以下必要工具</p>
<ul>
<li><a href="https://github.com/cloudflare/cfssl" target="_blank" rel="noopener">cfssl</a></li>
<li><a href="https://github.com/cloudflare/cfssl" target="_blank" rel="noopener">cfssljson</a></li>
<li><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" target="_blank" rel="noopener">kubectl</a></li>
</ul>
<h3 id="1-1-安装-cfssl"><a href="#1-1-安装-cfssl" class="headerlink" title="1.1 安装 cfssl"></a>1.1 安装 cfssl</h3><p>cfssl 和 cfssljson 命令行工具用于提供 PKI Infrastructure 基础设施与生成 TLS 证书。</p>
<p>指令:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget --timestamping \</span><br><span class="line">  https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 \</span><br><span class="line">  https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><br><span class="line">chmod +x cfssl_linux-amd64 cfssljson_linux-amd64</span><br><span class="line">sudo mv cfssl_linux-amd64 /usr/local/bin/cfssl</span><br><span class="line">sudo mv cfssljson_linux-amd64 /usr/local/bin/cfssljson</span><br></pre></td></tr></table></figure></p>
<p>执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# wget --timestamping \</span><br><span class="line">&gt;   https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 \</span><br><span class="line">&gt;   https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><br><span class="line">...</span><br><span class="line">Downloaded: 2 files, 12M in 0.4s (32.3 MB/s)</span><br><span class="line">[root@worker-master ~]# chmod +x cfssl_linux-amd64 cfssljson_linux-amd64</span><br><span class="line">[root@worker-master ~]# sudo mv cfssl_linux-amd64 /usr/local/bin/cfssl</span><br><span class="line">[root@worker-master ~]# sudo mv cfssljson_linux-amd64 /usr/local/bin/cfssljson</span><br></pre></td></tr></table></figure></p>
<p>验证一下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# cfssl version</span><br><span class="line">Version: 1.2.0</span><br><span class="line">Revision: dev</span><br><span class="line">Runtime: go1.6</span><br></pre></td></tr></table></figure></p>
<h3 id="1-2-安装-kubectl"><a href="#1-2-安装-kubectl" class="headerlink" title="1.2 安装 kubectl"></a>1.2 安装 kubectl</h3><p>kubectl 命令行工具用来与 Kubernetes API Server 交互，可以在 Kubernetes 官方网站下载并安装 kubectl。</p>
<p>指令:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://storage.googleapis.com/kubernetes-release/release/v1.15.0/bin/linux/amd64/kubectl</span><br><span class="line">chmod +x kubectl</span><br><span class="line">sudo mv kubectl /usr/local/bin/</span><br></pre></td></tr></table></figure></p>
<p>执行:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# wget https://storage.googleapis.com/kubernetes-release/release/v1.15.0/bin/linux/amd64/kubectl</span><br><span class="line">...</span><br><span class="line">2020-10-29 16:43:25 (44.4 MB/s) - ‘kubectl’ saved [42985504/42985504]</span><br><span class="line"></span><br><span class="line">[root@worker-master ~]# chmod +x kubectl</span><br><span class="line">[root@worker-master ~]# sudo mv kubectl /usr/local/bin/</span><br><span class="line">[root@worker-master ~]# kubectl version --client</span><br><span class="line">Client Version: version.Info&#123;Major:&quot;1&quot;, Minor:&quot;15&quot;, GitVersion:&quot;v1.15.0&quot;, GitCommit:&quot;e8462b5b5dc2584fdcd18e6bcfe9f1e4d970a529&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2019-06-19T16:40:16Z&quot;, GoVersion:&quot;go1.12.5&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux/amd64&quot;&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="2-配置-CA-并创建-TLS-证书"><a href="#2-配置-CA-并创建-TLS-证书" class="headerlink" title="2. 配置 CA 并创建 TLS 证书"></a>2. 配置 CA 并创建 TLS 证书</h2><p>我们将使用 CloudFlare’s PKI 工具 cfssl 来配置 PKI Infrastructure，然后使用它去创建 Certificate Authority（CA），并为 etcd、kube-apiserver、kubelet 以及 kube-proxy 创建 TLS 证书。</p>
<h3 id="2-1-Certificate-Authority"><a href="#2-1-Certificate-Authority" class="headerlink" title="2.1 Certificate Authority"></a>2.1 Certificate Authority</h3><p>创建用于生成其他 TLS 证书的 Certificate Authority。</p>
<h4 id="2-1-1-新建-CA-配置文件"><a href="#2-1-1-新建-CA-配置文件" class="headerlink" title="2.1.1 新建 CA 配置文件"></a>2.1.1 新建 CA 配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# cat &gt; ca-config.json &lt;&lt;EOF</span><br><span class="line">&gt; &#123;</span><br><span class="line">&gt;   &quot;signing&quot;: &#123;</span><br><span class="line">&gt;     &quot;default&quot;: &#123;</span><br><span class="line">&gt;       &quot;expiry&quot;: &quot;8760h&quot;</span><br><span class="line">&gt;     &#125;,</span><br><span class="line">&gt;     &quot;profiles&quot;: &#123;</span><br><span class="line">&gt;       &quot;kubernetes&quot;: &#123;</span><br><span class="line">&gt;         &quot;usages&quot;: [&quot;signing&quot;, &quot;key encipherment&quot;, &quot;server auth&quot;, &quot;client auth&quot;],</span><br><span class="line">&gt;         &quot;expiry&quot;: &quot;8760h&quot;</span><br><span class="line">&gt;       &#125;</span><br><span class="line">&gt;     &#125;</span><br><span class="line">&gt;   &#125;</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; EOF</span><br></pre></td></tr></table></figure>
<h4 id="2-1-2-新建-CA-凭证签发请求文件"><a href="#2-1-2-新建-CA-凭证签发请求文件" class="headerlink" title="2.1.2 新建 CA 凭证签发请求文件"></a>2.1.2 新建 CA 凭证签发请求文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# cat &gt; ca-csr.json &lt;&lt;EOF</span><br><span class="line">&gt; &#123;</span><br><span class="line">&gt;   &quot;CN&quot;: &quot;Kubernetes&quot;,</span><br><span class="line">&gt;   &quot;key&quot;: &#123;</span><br><span class="line">&gt;     &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">&gt;     &quot;size&quot;: 2048</span><br><span class="line">&gt;   &#125;,</span><br><span class="line">&gt;   &quot;names&quot;: [</span><br><span class="line">&gt;     &#123;</span><br><span class="line">&gt;       &quot;C&quot;: &quot;China&quot;,</span><br><span class="line">&gt;       &quot;L&quot;: &quot;Shanghai&quot;,</span><br><span class="line">&gt;       &quot;O&quot;: &quot;Kubernetes&quot;,</span><br><span class="line">&gt;       &quot;OU&quot;: &quot;Shanghai&quot;,</span><br><span class="line">&gt;       &quot;ST&quot;: &quot;Shanghai&quot;</span><br><span class="line">&gt;     &#125;</span><br><span class="line">&gt;   ]</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; EOF</span><br></pre></td></tr></table></figure>
<h4 id="2-1-3-生成-CA-凭证和私钥"><a href="#2-1-3-生成-CA-凭证和私钥" class="headerlink" title="2.1.3 生成 CA 凭证和私钥"></a>2.1.3 生成 CA 凭证和私钥</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span><br><span class="line">2020/10/29 16:46:45 [INFO] generating a new CA key and certificate from CSR</span><br><span class="line">2020/10/29 16:46:45 [INFO] generate received request</span><br><span class="line">2020/10/29 16:46:45 [INFO] received CSR</span><br><span class="line">2020/10/29 16:46:45 [INFO] generating key: rsa-2048</span><br><span class="line">2020/10/29 16:46:45 [INFO] encoded CSR</span><br><span class="line">2020/10/29 16:46:45 [INFO] signed certificate with serial number 313288276491452486871986487059615120584428274805</span><br></pre></td></tr></table></figure>
<p>最后生成这两个文件:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ca-key.pem</span><br><span class="line">ca.pem</span><br></pre></td></tr></table></figure></p>
<h3 id="2-2-client-与-server-凭证"><a href="#2-2-client-与-server-凭证" class="headerlink" title="2.2 client 与 server 凭证"></a>2.2 client 与 server 凭证</h3><p>本节将创建用于 Kubernetes 组件的 client 与 server 凭证，以及一个用于 Kubernetes admin 用户的 client 凭证。</p>
<h4 id="2-2-1-Admin-客户端凭证"><a href="#2-2-1-Admin-客户端凭证" class="headerlink" title="2.2.1 Admin 客户端凭证"></a>2.2.1 Admin 客户端凭证</h4><p>创建 admin client 凭证签发请求文件:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# cat &gt; admin-csr.json &lt;&lt;EOF</span><br><span class="line">&gt; &#123;</span><br><span class="line">&gt;   &quot;CN&quot;: &quot;admin&quot;,</span><br><span class="line">&gt;   &quot;key&quot;: &#123;</span><br><span class="line">&gt;     &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">&gt;     &quot;size&quot;: 2048</span><br><span class="line">&gt;   &#125;,</span><br><span class="line">&gt;   &quot;names&quot;: [</span><br><span class="line">&gt;     &#123;</span><br><span class="line">&gt;       &quot;C&quot;: &quot;China&quot;,</span><br><span class="line">&gt;       &quot;L&quot;: &quot;Shanghai&quot;,</span><br><span class="line">&gt;       &quot;O&quot;: &quot;system:masters&quot;,</span><br><span class="line">&gt;       &quot;OU&quot;: &quot;Kubernetes&quot;,</span><br><span class="line">&gt;       &quot;ST&quot;: &quot;Shanghai&quot;</span><br><span class="line">&gt;     &#125;</span><br><span class="line">&gt;   ]</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; EOF</span><br></pre></td></tr></table></figure></p>
<p>创建 admin client 凭证和私钥:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# cfssl gencert \</span><br><span class="line">&gt;   -ca=ca.pem \</span><br><span class="line">&gt;   -ca-key=ca-key.pem \</span><br><span class="line">&gt;   -config=ca-config.json \</span><br><span class="line">&gt;   -profile=kubernetes \</span><br><span class="line">&gt;   admin-csr.json | cfssljson -bare admin</span><br><span class="line">...</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br></pre></td></tr></table></figure></p>
<p>结果将生成以下两个文件:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin-key.pem</span><br><span class="line">admin.pem</span><br></pre></td></tr></table></figure></p>
<h4 id="2-2-2-Kubelet-客户端凭证"><a href="#2-2-2-Kubelet-客户端凭证" class="headerlink" title="2.2.2 Kubelet 客户端凭证"></a>2.2.2 Kubelet 客户端凭证</h4><p>Kubernetes 使用 special-purpose authorization mode（被称作 Node Authorizer）授权来自 Kubelet 的 API 请求。</p>
<p>为了通过 Node Authorizer 的授权, Kubelet 必须使用一个署名为 system:node:<nodename> 的凭证来证明它属于 system:nodes 用户组。本节将会给每台 worker 节点创建符合 Node Authorizer 要求的凭证。</nodename></p>
<p>我们有两台 worker， 分别是 <code>worker-1</code> 和 <code>worker-2</code>。 接下来先为 <code>worker-1</code> 节点创建凭证和私钥 (依然是在 master 上操作)。</p>
<h5 id="2-2-2-1-为-worker-1-节点创建凭证和私钥"><a href="#2-2-2-1-为-worker-1-节点创建凭证和私钥" class="headerlink" title="2.2.2.1 为 worker-1 节点创建凭证和私钥"></a>2.2.2.1 为 worker-1 节点创建凭证和私钥</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># 名字就是 worker-1， 下面的 ip 就是 worker-1 的内网 ip</span><br><span class="line">[root@worker-master ~]# export WORKER1_HOSTNAME=worker-1</span><br><span class="line">[root@worker-master ~]# export WORKER1_IP=172.26.64.2</span><br><span class="line">[root@worker-master ~]# cat &gt; worker-1-csr.json &lt;&lt;EOF</span><br><span class="line">&gt; &#123;</span><br><span class="line">&gt;   &quot;CN&quot;: &quot;system:node:$&#123;WORKER1_HOSTNAME&#125;&quot;,</span><br><span class="line">&gt;   &quot;key&quot;: &#123;</span><br><span class="line">&gt;     &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">&gt;     &quot;size&quot;: 2048</span><br><span class="line">&gt;   &#125;,</span><br><span class="line">&gt;   &quot;names&quot;: [</span><br><span class="line">&gt;     &#123;</span><br><span class="line">&gt;       &quot;C&quot;: &quot;China&quot;,</span><br><span class="line">&gt;       &quot;L&quot;: &quot;Shanghai&quot;,</span><br><span class="line">&gt;       &quot;O&quot;: &quot;system:nodes&quot;,</span><br><span class="line">&gt;       &quot;OU&quot;: &quot;Kubernetes&quot;,</span><br><span class="line">&gt;       &quot;ST&quot;: &quot;Shanghai&quot;</span><br><span class="line">&gt;     &#125;</span><br><span class="line">&gt;   ]</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; EOF</span><br><span class="line">[root@worker-master ~]# cfssl gencert \</span><br><span class="line">&gt;   -ca=ca.pem \</span><br><span class="line">&gt;   -ca-key=ca-key.pem \</span><br><span class="line">&gt;   -config=ca-config.json \</span><br><span class="line">&gt;   -hostname=$&#123;WORKER1_HOSTNAME&#125;,$&#123;WORKER1_IP&#125; \</span><br><span class="line">&gt;   -profile=kubernetes \</span><br><span class="line">&gt;   worker-1-csr.json | cfssljson -bare worker-1</span><br><span class="line">...</span><br><span class="line">2020/10/29 16:53:36 [INFO] signed certificate with serial number 531259582571192075561426574394248110542500079355</span><br><span class="line">[root@worker-master ~]# ll | grep &apos;worker-1&apos;</span><br><span class="line">-rw-r--r-- 1 root root 1041 Oct 29 16:53 worker-1.csr</span><br><span class="line">-rw-r--r-- 1 root root  236 Oct 29 16:53 worker-1-csr.json</span><br><span class="line">-rw------- 1 root root 1679 Oct 29 16:53 worker-1-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1489 Oct 29 16:53 worker-1.pem</span><br></pre></td></tr></table></figure>
<p>主要是为了产生这两个文件:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">worker-1-key.pem</span><br><span class="line">worker-1.pem</span><br></pre></td></tr></table></figure></p>
<h5 id="2-2-2-2-为-worker-2-节点创建凭证和私钥"><a href="#2-2-2-2-为-worker-2-节点创建凭证和私钥" class="headerlink" title="2.2.2.2 为 worker-2 节点创建凭证和私钥"></a>2.2.2.2 为 worker-2 节点创建凭证和私钥</h5><p>同样的方式，为 worker-2 再处理一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@worker-master ~]# export WORKER2_HOSTNAME=worker-2</span><br><span class="line">[root@worker-master ~]# export WORKER2_IP=172.26.64.10</span><br><span class="line">[root@worker-master ~]# cat &gt; worker-2-csr.json &lt;&lt;EOF</span><br><span class="line">&gt; &#123;</span><br><span class="line">&gt;   &quot;CN&quot;: &quot;system:node:$&#123;WORKER2_HOSTNAME&#125;&quot;,</span><br><span class="line">&gt;   &quot;key&quot;: &#123;</span><br><span class="line">&gt;     &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">&gt;     &quot;size&quot;: 2048</span><br><span class="line">&gt;   &#125;,</span><br><span class="line">&gt;   &quot;names&quot;: [</span><br><span class="line">&gt;     &#123;</span><br><span class="line">&gt;       &quot;C&quot;: &quot;China&quot;,</span><br><span class="line">&gt;       &quot;L&quot;: &quot;Shanghai&quot;,</span><br><span class="line">&gt;       &quot;O&quot;: &quot;system:nodes&quot;,</span><br><span class="line">&gt;       &quot;OU&quot;: &quot;Kubernetes&quot;,</span><br><span class="line">&gt;       &quot;ST&quot;: &quot;Shanghai&quot;</span><br><span class="line">&gt;     &#125;</span><br><span class="line">&gt;   ]</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; EOF</span><br><span class="line">[root@worker-master ~]# cfssl gencert \</span><br><span class="line">&gt;   -ca=ca.pem \</span><br><span class="line">&gt;   -ca-key=ca-key.pem \</span><br><span class="line">&gt;   -config=ca-config.json \</span><br><span class="line">&gt;   -hostname=$&#123;WORKER2_HOSTNAME&#125;,$&#123;WORKER2_IP&#125; \</span><br><span class="line">&gt;   -profile=kubernetes \</span><br><span class="line">&gt;   worker-2-csr.json | cfssljson -bare worker-2</span><br><span class="line">...</span><br><span class="line">2020/10/29 16:56:21 [INFO] signed certificate with serial number 688958995550700561005532700973761497460653349926</span><br><span class="line">[root@worker-master ~]# ll | grep &apos;worker-2&apos;</span><br><span class="line">-rw-r--r-- 1 root root 1041 Oct 29 16:56 worker-2.csr</span><br><span class="line">-rw-r--r-- 1 root root  236 Oct 29 16:55 worker-2-csr.json</span><br><span class="line">-rw------- 1 root root 1679 Oct 29 16:56 worker-2-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1489 Oct 29 16:56 worker-2.pem</span><br></pre></td></tr></table></figure></p>
<p>主要是为了产生这两个文件:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">worker-2-key.pem</span><br><span class="line">worker-2.pem</span><br></pre></td></tr></table></figure></p>
<h4 id="2-2-3-Kube-controller-manager-客户端凭证"><a href="#2-2-3-Kube-controller-manager-客户端凭证" class="headerlink" title="2.2.3 Kube-controller-manager 客户端凭证"></a>2.2.3 Kube-controller-manager 客户端凭证</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# cat &gt; kube-controller-manager-csr.json &lt;&lt;EOF</span><br><span class="line">&gt; &#123;</span><br><span class="line">&gt;   &quot;CN&quot;: &quot;system:kube-controller-manager&quot;,</span><br><span class="line">&gt;   &quot;key&quot;: &#123;</span><br><span class="line">&gt;     &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">&gt;     &quot;size&quot;: 2048</span><br><span class="line">&gt;   &#125;,</span><br><span class="line">&gt;   &quot;names&quot;: [</span><br><span class="line">&gt;     &#123;</span><br><span class="line">&gt;       &quot;C&quot;: &quot;China&quot;,</span><br><span class="line">&gt;       &quot;L&quot;: &quot;Shanghai&quot;,</span><br><span class="line">&gt;       &quot;O&quot;: &quot;system:kube-controller-manager&quot;,</span><br><span class="line">&gt;       &quot;OU&quot;: &quot;Kubernetes&quot;,</span><br><span class="line">&gt;       &quot;ST&quot;: &quot;Shanghai&quot;</span><br><span class="line">&gt;     &#125;</span><br><span class="line">&gt;   ]</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; EOF</span><br><span class="line">[root@worker-master ~]# cfssl gencert \</span><br><span class="line">&gt;   -ca=ca.pem \</span><br><span class="line">&gt;   -ca-key=ca-key.pem \</span><br><span class="line">&gt;   -config=ca-config.json \</span><br><span class="line">&gt;   -profile=kubernetes \</span><br><span class="line">&gt;   kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager</span><br><span class="line">...</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br><span class="line">[root@worker-master ~]# ll | grep &apos;kube-controller-manager&apos;</span><br><span class="line">-rw-r--r-- 1 root root 1078 Oct 29 16:58 kube-controller-manager.csr</span><br><span class="line">-rw-r--r-- 1 root root  264 Oct 29 16:57 kube-controller-manager-csr.json</span><br><span class="line">-rw------- 1 root root 1675 Oct 29 16:58 kube-controller-manager-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1489 Oct 29 16:58 kube-controller-manager.pem</span><br></pre></td></tr></table></figure>
<p>结果将产生以下几个文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kube-controller-manager-key.pem</span><br><span class="line">kube-controller-manager.pem</span><br></pre></td></tr></table></figure></p>
<h4 id="2-2-4-Kube-proxy-客户端凭证"><a href="#2-2-4-Kube-proxy-客户端凭证" class="headerlink" title="2.2.4 Kube-proxy 客户端凭证"></a>2.2.4 Kube-proxy 客户端凭证</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# cat &gt; kube-proxy-csr.json &lt;&lt;EOF</span><br><span class="line">&gt; &#123;</span><br><span class="line">&gt;   &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">&gt;   &quot;key&quot;: &#123;</span><br><span class="line">&gt;     &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">&gt;     &quot;size&quot;: 2048</span><br><span class="line">&gt;   &#125;,</span><br><span class="line">&gt;   &quot;names&quot;: [</span><br><span class="line">&gt;     &#123;</span><br><span class="line">&gt;       &quot;C&quot;: &quot;China&quot;,</span><br><span class="line">&gt;       &quot;L&quot;: &quot;Shanghai&quot;,</span><br><span class="line">&gt;       &quot;O&quot;: &quot;system:node-proxier&quot;,</span><br><span class="line">&gt;       &quot;OU&quot;: &quot;Kubernetes&quot;,</span><br><span class="line">&gt;       &quot;ST&quot;: &quot;Shanghai&quot;</span><br><span class="line">&gt;     &#125;</span><br><span class="line">&gt;   ]</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; EOF</span><br><span class="line">[root@worker-master ~]# cfssl gencert \</span><br><span class="line">&gt;   -ca=ca.pem \</span><br><span class="line">&gt;   -ca-key=ca-key.pem \</span><br><span class="line">&gt;   -config=ca-config.json \</span><br><span class="line">&gt;   -profile=kubernetes \</span><br><span class="line">&gt;   kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br><span class="line">...</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br><span class="line">[root@worker-master ~]# ll | grep &apos;kube-proxy&apos;</span><br><span class="line">-rw-r--r-- 1 root root 1045 Oct 29 16:59 kube-proxy.csr</span><br><span class="line">-rw-r--r-- 1 root root  240 Oct 29 16:59 kube-proxy-csr.json</span><br><span class="line">-rw------- 1 root root 1675 Oct 29 16:59 kube-proxy-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1456 Oct 29 16:59 kube-proxy.pem</span><br></pre></td></tr></table></figure>
<p>结果将产生以下两个文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kube-proxy-key.pem</span><br><span class="line">kube-proxy.pem</span><br></pre></td></tr></table></figure></p>
<h4 id="2-2-5-kube-scheduler-证书"><a href="#2-2-5-kube-scheduler-证书" class="headerlink" title="2.2.5 kube-scheduler 证书"></a>2.2.5 kube-scheduler 证书</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# cat &gt; kube-scheduler-csr.json &lt;&lt;EOF</span><br><span class="line">&gt; &#123;</span><br><span class="line">&gt;   &quot;CN&quot;: &quot;system:kube-scheduler&quot;,</span><br><span class="line">&gt;   &quot;key&quot;: &#123;</span><br><span class="line">&gt;     &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">&gt;     &quot;size&quot;: 2048</span><br><span class="line">&gt;   &#125;,</span><br><span class="line">&gt;   &quot;names&quot;: [</span><br><span class="line">&gt;     &#123;</span><br><span class="line">&gt;       &quot;C&quot;: &quot;China&quot;,</span><br><span class="line">&gt;       &quot;L&quot;: &quot;Shanghai&quot;,</span><br><span class="line">&gt;       &quot;O&quot;: &quot;system:kube-scheduler&quot;,</span><br><span class="line">&gt;       &quot;OU&quot;: &quot;Kubernetes&quot;,</span><br><span class="line">&gt;       &quot;ST&quot;: &quot;Shanghai&quot;</span><br><span class="line">&gt;     &#125;</span><br><span class="line">&gt;   ]</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; EOF</span><br><span class="line">[root@worker-master ~]# cfssl gencert \</span><br><span class="line">&gt;   -ca=ca.pem \</span><br><span class="line">&gt;   -ca-key=ca-key.pem \</span><br><span class="line">&gt;   -config=ca-config.json \</span><br><span class="line">&gt;   -profile=kubernetes \</span><br><span class="line">&gt;   kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span><br><span class="line">...</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br><span class="line">[root@worker-master ~]# ll | grep kube-scheduler</span><br><span class="line">-rw-r--r-- 1 root root 1054 Oct 29 17:00 kube-scheduler.csr</span><br><span class="line">-rw-r--r-- 1 root root  246 Oct 29 17:00 kube-scheduler-csr.json</span><br><span class="line">-rw------- 1 root root 1679 Oct 29 17:00 kube-scheduler-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1464 Oct 29 17:00 kube-scheduler.pem</span><br></pre></td></tr></table></figure>
<p>结果将产生以下两个文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kube-scheduler-key.pem</span><br><span class="line">kube-scheduler.pem</span><br></pre></td></tr></table></figure></p>
<h4 id="2-2-6-Kubernetes-API-Server-证书"><a href="#2-2-6-Kubernetes-API-Server-证书" class="headerlink" title="2.2.6 Kubernetes API Server 证书"></a>2.2.6 Kubernetes API Server 证书</h4><p>为了保证客户端与 Kubernetes API 的认证，Kubernetes API Server 凭证中必需包含 master 的静态 IP 地址。</p>
<h5 id="2-2-6-1-创建-Kubernetes-API-Server-凭证签发请求文件"><a href="#2-2-6-1-创建-Kubernetes-API-Server-凭证签发请求文件" class="headerlink" title="2.2.6.1 创建 Kubernetes API Server 凭证签发请求文件"></a>2.2.6.1 创建 Kubernetes API Server 凭证签发请求文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# cat &gt; kubernetes-csr.json &lt;&lt;EOF</span><br><span class="line">&gt; &#123;</span><br><span class="line">&gt;   &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">&gt;   &quot;key&quot;: &#123;</span><br><span class="line">&gt;     &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">&gt;     &quot;size&quot;: 2048</span><br><span class="line">&gt;   &#125;,</span><br><span class="line">&gt;   &quot;names&quot;: [</span><br><span class="line">&gt;     &#123;</span><br><span class="line">&gt;       &quot;C&quot;: &quot;China&quot;,</span><br><span class="line">&gt;       &quot;L&quot;: &quot;Shanghai&quot;,</span><br><span class="line">&gt;       &quot;O&quot;: &quot;Kubernetes&quot;,</span><br><span class="line">&gt;       &quot;OU&quot;: &quot;Kubernetes&quot;,</span><br><span class="line">&gt;       &quot;ST&quot;: &quot;Shanghai&quot;</span><br><span class="line">&gt;     &#125;</span><br><span class="line">&gt;   ]</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; EOF</span><br></pre></td></tr></table></figure>
<h5 id="2-2-6-2-创建-Kubernetes-API-Server-凭证与私钥"><a href="#2-2-6-2-创建-Kubernetes-API-Server-凭证与私钥" class="headerlink" title="2.2.6.2 创建 Kubernetes API Server 凭证与私钥"></a>2.2.6.2 创建 Kubernetes API Server 凭证与私钥</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# export MASTER_IP=172.26.64.9</span><br><span class="line">[root@worker-master ~]# cfssl gencert \</span><br><span class="line">&gt;   -ca=ca.pem \</span><br><span class="line">&gt;   -ca-key=ca-key.pem \</span><br><span class="line">&gt;   -config=ca-config.json \</span><br><span class="line">&gt;   -hostname=10.250.0.1,$&#123;MASTER_IP&#125;,127.0.0.1,kubernetes.default \</span><br><span class="line">&gt;   -profile=kubernetes \</span><br><span class="line">&gt;   kubernetes-csr.json | cfssljson -bare kubernetes</span><br><span class="line">...</span><br><span class="line">2020/10/29 17:02:51 [INFO] signed certificate with serial number 499334605103379856047696211541729253687736350720</span><br><span class="line">[root@worker-master ~]# ll | grep kubernetes</span><br><span class="line">-rw-r--r-- 1 root root 1021 Oct 29 17:02 kubernetes.csr</span><br><span class="line">-rw-r--r-- 1 root root  224 Oct 29 17:01 kubernetes-csr.json</span><br><span class="line">-rw------- 1 root root 1675 Oct 29 17:02 kubernetes-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1501 Oct 29 17:02 kubernetes.pem</span><br></pre></td></tr></table></figure>
<p>结果产生以下两个文件:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubernetes-key.pem</span><br><span class="line">kubernetes.pem</span><br></pre></td></tr></table></figure></p>
<h4 id="2-2-7-Service-Account-证书"><a href="#2-2-7-Service-Account-证书" class="headerlink" title="2.2.7 Service Account 证书"></a>2.2.7 Service Account 证书</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# cat &gt; service-account-csr.json &lt;&lt;EOF</span><br><span class="line">&gt; &#123;</span><br><span class="line">&gt;   &quot;CN&quot;: &quot;service-accounts&quot;,</span><br><span class="line">&gt;   &quot;key&quot;: &#123;</span><br><span class="line">&gt;     &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">&gt;     &quot;size&quot;: 2048</span><br><span class="line">&gt;   &#125;,</span><br><span class="line">&gt;   &quot;names&quot;: [</span><br><span class="line">&gt;     &#123;</span><br><span class="line">&gt;       &quot;C&quot;: &quot;China&quot;,</span><br><span class="line">&gt;       &quot;L&quot;: &quot;Shanghai&quot;,</span><br><span class="line">&gt;       &quot;O&quot;: &quot;Kubernetes&quot;,</span><br><span class="line">&gt;       &quot;OU&quot;: &quot;Kubernetes&quot;,</span><br><span class="line">&gt;       &quot;ST&quot;: &quot;Shanghai&quot;</span><br><span class="line">&gt;     &#125;</span><br><span class="line">&gt;   ]</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; EOF</span><br><span class="line">[root@worker-master ~]# cfssl gencert \</span><br><span class="line">&gt;   -ca=ca.pem \</span><br><span class="line">&gt;   -ca-key=ca-key.pem \</span><br><span class="line">&gt;   -config=ca-config.json \</span><br><span class="line">&gt;   -profile=kubernetes \</span><br><span class="line">&gt;   service-account-csr.json | cfssljson -bare service-account</span><br><span class="line">...</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br><span class="line">[root@worker-master ~]# ll | grep service-account</span><br><span class="line">-rw-r--r-- 1 root root 1029 Oct 29 17:04 service-account.csr</span><br><span class="line">-rw-r--r-- 1 root root  230 Oct 29 17:03 service-account-csr.json</span><br><span class="line">-rw------- 1 root root 1679 Oct 29 17:04 service-account-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1440 Oct 29 17:04 service-account.pem</span><br></pre></td></tr></table></figure>
<p>结果将生成以下两个文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service-account-key.pem</span><br><span class="line">service-account.pem</span><br></pre></td></tr></table></figure></p>
<h3 id="2-3-分发客户端和服务器证书"><a href="#2-3-分发客户端和服务器证书" class="headerlink" title="2.3 分发客户端和服务器证书"></a>2.3 分发客户端和服务器证书</h3><p>接下来将客户端凭证以及私钥复制到每个 worker 节点上，因为我们有两个 worker 节点， 所以两个都要处理<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# scp -i /root/k8s  ca.pem worker-1-key.pem worker-1.pem root@172.26.64.2:~/</span><br><span class="line">ca.pem                                                                                                                                                                        100% 1395     4.3MB/s   00:00    </span><br><span class="line">worker-1-key.pem                                                                                                                                                              100% 1679     5.4MB/s   00:00    </span><br><span class="line">worker-1.pem                                                                                                                                                                  100% 1489     5.2MB/s   00:00</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# scp -i /root/k8s  ca.pem worker-2-key.pem worker-2.pem root@172.26.64.10:~/</span><br><span class="line">ca.pem                                                                                                                                                                        100% 1395     3.6MB/s   00:00    </span><br><span class="line">worker-2-key.pem                                                                                                                                                              100% 1679     4.3MB/s   00:00    </span><br><span class="line">worker-2.pem                                                                                                                                                                  100% 1489     4.7MB/s   00:00</span><br></pre></td></tr></table></figure>
<p>不过要注意一点， 要用内网地址， 因为我的云服务器，只有内网互通，不会走公网，不然还得开22 端口权限。</p>
<p>这样子这些对应的文件都放到 worker 节点了。</p>
<p>教程中还有一个细节就是要将服务器凭证以及私钥复制到每个控制节点上:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp ca.pem ca-key.pem kubernetes-key.pem kubernetes.pem \</span><br><span class="line">    service-account-key.pem service-account.pem master:~/</span><br></pre></td></tr></table></figure></p>
<p>不过我们本来就是在 master 上操作，所以这一步就不要处理了。</p>
<h2 id="3-配置和生成-Kubernetes-配置文件"><a href="#3-配置和生成-Kubernetes-配置文件" class="headerlink" title="3. 配置和生成 Kubernetes 配置文件"></a>3. 配置和生成 Kubernetes 配置文件</h2><p>本部分内容将会创建 kubeconfig 配置文件，它们是 Kubernetes 客户端与 API Server 认证与鉴权的保证。</p>
<p>本节将会创建用于 kube-proxy、kube-controller-manager、kube-scheduler 和 kubelet 的 kubeconfig 文件。</p>
<h3 id="3-1-kubelet-配置文件"><a href="#3-1-kubelet-配置文件" class="headerlink" title="3.1 kubelet 配置文件"></a>3.1 kubelet 配置文件</h3><p>为了确保 Node Authorizer 授权，Kubelet 配置文件中的客户端证书必需匹配 Node 名字。 所以要为每个 worker 节点创建 kubeconfig 配置，所以要一台一台来, 先为 worker-1 先来:</p>
<h4 id="3-1-1-worker-1"><a href="#3-1-1-worker-1" class="headerlink" title="3.1.1 worker-1"></a>3.1.1 worker-1</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# kubectl config set-cluster kubernetes-training \</span><br><span class="line">&gt;   --certificate-authority=ca.pem \</span><br><span class="line">&gt;   --embed-certs=true \</span><br><span class="line">&gt;   --server=https://$&#123;MASTER_IP&#125;:6443 \</span><br><span class="line">&gt;   --kubeconfig=worker-1.kubeconfig</span><br><span class="line">Cluster &quot;kubernetes-training&quot; set.</span><br><span class="line">[root@worker-master ~]# kubectl config set-credentials system:node:worker-1 \</span><br><span class="line">&gt;   --client-certificate=worker-1.pem \</span><br><span class="line">&gt;   --client-key=worker-1-key.pem \</span><br><span class="line">&gt;   --embed-certs=true \</span><br><span class="line">&gt;   --kubeconfig=worker-1.kubeconfig</span><br><span class="line">User &quot;system:node:worker-1&quot; set.</span><br><span class="line">[root@worker-master ~]# kubectl config set-context default \</span><br><span class="line">&gt;   --cluster=kubernetes-training \</span><br><span class="line">&gt;   --user=system:node:worker-1 \</span><br><span class="line">&gt;   --kubeconfig=worker-1.kubeconfig</span><br><span class="line">Context &quot;default&quot; created.</span><br><span class="line">[root@worker-master ~]# kubectl config use-context default --kubeconfig=worker-1.kubeconfig</span><br><span class="line">Switched to context &quot;default&quot;.</span><br><span class="line">[root@worker-master ~]# ll | grep kubeconfig</span><br><span class="line">-rw------- 1 root root 6473 Oct 29 17:45 worker-1.kubeconfig</span><br></pre></td></tr></table></figure>
<p>结果将会生成以下文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker-1.kubeconfig</span><br></pre></td></tr></table></figure></p>
<h4 id="3-1-1-worker-2"><a href="#3-1-1-worker-2" class="headerlink" title="3.1.1 worker-2"></a>3.1.1 worker-2</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# kubectl config set-cluster kubernetes-training \</span><br><span class="line">&gt;   --certificate-authority=ca.pem \</span><br><span class="line">&gt;   --embed-certs=true \</span><br><span class="line">&gt;   --server=https://$&#123;MASTER_IP&#125;:6443 \</span><br><span class="line">&gt;   --kubeconfig=worker-2.kubeconfig</span><br><span class="line">Cluster &quot;kubernetes-training&quot; set.</span><br><span class="line">[root@worker-master ~]# kubectl config set-credentials system:node:worker-2 \</span><br><span class="line">&gt;   --client-certificate=worker-2.pem \</span><br><span class="line">&gt;   --client-key=worker-2-key.pem \</span><br><span class="line">&gt;   --embed-certs=true \</span><br><span class="line">&gt;   --kubeconfig=worker-2.kubeconfig</span><br><span class="line">User &quot;system:node:worker-2&quot; set.</span><br><span class="line">[root@worker-master ~]# kubectl config set-context default \</span><br><span class="line">&gt;   --cluster=kubernetes-training \</span><br><span class="line">&gt;   --user=system:node:worker-2 \</span><br><span class="line">&gt;   --kubeconfig=worker-2.kubeconfig</span><br><span class="line">Context &quot;default&quot; created.</span><br><span class="line">[root@worker-master ~]# kubectl config use-context default --kubeconfig=worker-2.kubeconfig</span><br><span class="line">Switched to context &quot;default&quot;.</span><br><span class="line">[root@worker-master ~]# ll | grep kubeconfig</span><br><span class="line">-rw------- 1 root root 6365 Oct 29 17:49 admin.kubeconfig</span><br><span class="line">-rw------- 1 root root 6487 Oct 29 17:47 kube-controller-manager.kubeconfig</span><br><span class="line">-rw------- 1 root root 6419 Oct 29 17:46 kube-proxy.kubeconfig</span><br><span class="line">-rw------- 1 root root 6437 Oct 29 17:48 kube-scheduler.kubeconfig</span><br><span class="line">-rw------- 1 root root 6473 Oct 29 17:45 worker-1.kubeconfig</span><br><span class="line">-rw------- 1 root root 6473 Oct 29 17:55 worker-2.kubeconfig</span><br></pre></td></tr></table></figure>
<p>结果将会生成以下文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker-2.kubeconfig</span><br></pre></td></tr></table></figure></p>
<h3 id="3-2-kube-proxy-配置文件"><a href="#3-2-kube-proxy-配置文件" class="headerlink" title="3.2 kube-proxy 配置文件"></a>3.2 kube-proxy 配置文件</h3><p>为 kube-proxy 服务生成 kubeconfig 配置文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# kubectl config set-cluster kubernetes-training \</span><br><span class="line">&gt;   --certificate-authority=ca.pem \</span><br><span class="line">&gt;   --embed-certs=true \</span><br><span class="line">&gt;   --server=https://$&#123;MASTER_IP&#125;:6443 \</span><br><span class="line">&gt;   --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">Cluster &quot;kubernetes-training&quot; set.</span><br><span class="line">[root@worker-master ~]# kubectl config set-credentials system:kube-proxy \</span><br><span class="line">&gt;   --client-certificate=kube-proxy.pem \</span><br><span class="line">&gt;   --client-key=kube-proxy-key.pem \</span><br><span class="line">&gt;   --embed-certs=true \</span><br><span class="line">&gt;   --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">User &quot;system:kube-proxy&quot; set.</span><br><span class="line">[root@worker-master ~]# kubectl config set-context default \</span><br><span class="line">&gt;   --cluster=kubernetes-training \</span><br><span class="line">&gt;   --user=system:kube-proxy \</span><br><span class="line">&gt;   --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">Context &quot;default&quot; created.</span><br><span class="line">[root@worker-master ~]# kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">Switched to context &quot;default&quot;.</span><br></pre></td></tr></table></figure></p>
<h3 id="3-3-kube-controller-manager-配置文件"><a href="#3-3-kube-controller-manager-配置文件" class="headerlink" title="3.3 kube-controller-manager 配置文件"></a>3.3 kube-controller-manager 配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# kubectl config set-cluster kubernetes-training \</span><br><span class="line">&gt;   --certificate-authority=ca.pem \</span><br><span class="line">&gt;   --embed-certs=true \</span><br><span class="line">&gt;   --server=https://127.0.0.1:6443 \</span><br><span class="line">&gt;   --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line">Cluster &quot;kubernetes-training&quot; set.</span><br><span class="line">[root@worker-master ~]# kubectl config set-credentials system:kube-controller-manager \</span><br><span class="line">&gt;   --client-certificate=kube-controller-manager.pem \</span><br><span class="line">&gt;   --client-key=kube-controller-manager-key.pem \</span><br><span class="line">&gt;   --embed-certs=true \</span><br><span class="line">&gt;   --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line">User &quot;system:kube-controller-manager&quot; set.</span><br><span class="line">[root@worker-master ~]# kubectl config set-context default \</span><br><span class="line">&gt;   --cluster=kubernetes-training \</span><br><span class="line">&gt;   --user=system:kube-controller-manager \</span><br><span class="line">&gt;   --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line">Context &quot;default&quot; created.</span><br><span class="line">[root@worker-master ~]# kubectl config use-context default --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line">Switched to context &quot;default&quot;.</span><br></pre></td></tr></table></figure>
<h3 id="3-4-kube-scheduler-配置文件"><a href="#3-4-kube-scheduler-配置文件" class="headerlink" title="3.4 kube-scheduler 配置文件"></a>3.4 kube-scheduler 配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# kubectl config set-cluster kubernetes-training \</span><br><span class="line">&gt;   --certificate-authority=ca.pem \</span><br><span class="line">&gt;   --embed-certs=true \</span><br><span class="line">&gt;   --server=https://127.0.0.1:6443 \</span><br><span class="line">&gt;   --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line">Cluster &quot;kubernetes-training&quot; set.</span><br><span class="line">[root@worker-master ~]# kubectl config set-credentials system:kube-scheduler \</span><br><span class="line">&gt;   --client-certificate=kube-scheduler.pem \</span><br><span class="line">&gt;   --client-key=kube-scheduler-key.pem \</span><br><span class="line">&gt;   --embed-certs=true \</span><br><span class="line">&gt;   --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line">User &quot;system:kube-scheduler&quot; set.</span><br><span class="line">[root@worker-master ~]# kubectl config set-context default \</span><br><span class="line">&gt;   --cluster=kubernetes-training \</span><br><span class="line">&gt;   --user=system:kube-scheduler \</span><br><span class="line">&gt;   --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line">Context &quot;default&quot; created.</span><br><span class="line">[root@worker-master ~]# kubectl config use-context default --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line">Switched to context &quot;default&quot;.</span><br></pre></td></tr></table></figure>
<h3 id="3-5-Admin-配置文件"><a href="#3-5-Admin-配置文件" class="headerlink" title="3.5 Admin 配置文件"></a>3.5 Admin 配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# kubectl config set-cluster kubernetes-training \</span><br><span class="line">&gt;   --certificate-authority=ca.pem \</span><br><span class="line">&gt;   --embed-certs=true \</span><br><span class="line">&gt;   --server=https://127.0.0.1:6443 \</span><br><span class="line">&gt;   --kubeconfig=admin.kubeconfig</span><br><span class="line">Cluster &quot;kubernetes-training&quot; set.</span><br><span class="line">[root@worker-master ~]#</span><br><span class="line">[root@worker-master ~]# kubectl config set-credentials admin \</span><br><span class="line">&gt;   --client-certificate=admin.pem \</span><br><span class="line">&gt;   --client-key=admin-key.pem \</span><br><span class="line">&gt;   --embed-certs=true \</span><br><span class="line">&gt;   --kubeconfig=admin.kubeconfig</span><br><span class="line">User &quot;admin&quot; set.</span><br><span class="line">[root@worker-master ~]#</span><br><span class="line">[root@worker-master ~]# kubectl config set-context default \</span><br><span class="line">&gt;   --cluster=kubernetes-training \</span><br><span class="line">&gt;   --user=admin \</span><br><span class="line">&gt;   --kubeconfig=admin.kubeconfig</span><br><span class="line">Context &quot;default&quot; created.</span><br><span class="line">[root@worker-master ~]# kubectl config use-context default --kubeconfig=admin.kubeconfig</span><br><span class="line">Switched to context &quot;default&quot;.</span><br></pre></td></tr></table></figure>
<h3 id="3-6-分发配置文件"><a href="#3-6-分发配置文件" class="headerlink" title="3.6 分发配置文件"></a>3.6 分发配置文件</h3><p>将 kubelet 与 kube-proxy kubeconfig 配置文件复制到每个 worker 节点上：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# scp -i /root/k8s worker-1.kubeconfig kube-proxy.kubeconfig  root@172.26.64.2:~/</span><br><span class="line">worker-1.kubeconfig                                                                                                                                                           100% 6473    14.4MB/s   00:00    </span><br><span class="line">kube-proxy.kubeconfig                                                                                                                                                         100% 6419    14.3MB/s   00:00</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# scp -i /root/k8s  worker-2.kubeconfig kube-proxy.kubeconfig root@172.26.64.10:~/</span><br><span class="line">worker-2.kubeconfig                                                                                                                                                           100% 6473    12.0MB/s   00:00    </span><br><span class="line">kube-proxy.kubeconfig                                                                                                                                                         100% 6419    14.2MB/s   00:00</span><br></pre></td></tr></table></figure>
<p>本来还有一步就是，将 admin、kube-controller-manager 与 kube-scheduler kubeconfig 配置文件复制到每个控制节点上：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp admin.kubeconfig kube-controller-manager.kubeconfig kube-scheduler.kubeconfig master:~/</span><br></pre></td></tr></table></figure></p>
<p>不过这个本来就是在 master 上了，所以不用执行了。</p>
<h2 id="4-配置和生成密钥"><a href="#4-配置和生成密钥" class="headerlink" title="4. 配置和生成密钥"></a>4. 配置和生成密钥</h2><p>Kubernetes 存储了集群状态、应用配置和密钥等很多不同的数据。而 Kubernetes 也支持集群数据的加密存储。</p>
<p>本部分将会创建加密密钥以及一个用于加密 Kubernetes Secrets 的 加密配置文件。</p>
<h3 id="4-1-建立加密密钥"><a href="#4-1-建立加密密钥" class="headerlink" title="4.1 建立加密密钥"></a>4.1 建立加密密钥</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# ENCRYPTION_KEY=$(head -c 32 /dev/urandom | base64)</span><br></pre></td></tr></table></figure>
<h3 id="4-2-加密配置文件"><a href="#4-2-加密配置文件" class="headerlink" title="4.2 加密配置文件"></a>4.2 加密配置文件</h3><p>生成名为 encryption-config.yaml 的加密配置文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# cat &gt; encryption-config.yaml &lt;&lt;EOF</span><br><span class="line">&gt; kind: EncryptionConfig</span><br><span class="line">&gt; apiVersion: v1</span><br><span class="line">&gt; resources:</span><br><span class="line">&gt;   - resources:</span><br><span class="line">&gt;       - secrets</span><br><span class="line">&gt;     providers:</span><br><span class="line">&gt;       - aescbc:</span><br><span class="line">&gt;           keys:</span><br><span class="line">&gt;             - name: key1</span><br><span class="line">&gt;               secret: $&#123;ENCRYPTION_KEY&#125;</span><br><span class="line">&gt;       - identity: &#123;&#125;</span><br><span class="line">&gt; EOF</span><br></pre></td></tr></table></figure></p>
<p>接下来还有一步就是将 encryption-config.yaml 复制到每个控制节点上：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp encryption-config.yaml master:~/</span><br></pre></td></tr></table></figure></p>
<p>不过本来我们就是在 master 上了，所以就不需要了。</p>
<h2 id="5-部署-etcd-群集"><a href="#5-部署-etcd-群集" class="headerlink" title="5. 部署 etcd 群集"></a>5. 部署 etcd 群集</h2><p>Kubernetes 组件都是无状态的，所有的群集状态都储存在 etcd 集群中。</p>
<h3 id="5-1-下载并安装-etcd-二进制文件"><a href="#5-1-下载并安装-etcd-二进制文件" class="headerlink" title="5.1 下载并安装 etcd 二进制文件"></a>5.1 下载并安装 etcd 二进制文件</h3><p>从 <a href="https://github.com/etcd-io/etcd" target="_blank" rel="noopener">coreos/etcd</a> GitHub 中下载 etcd 发布文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# wget --timestamping \</span><br><span class="line">&gt;   &quot;https://github.com/coreos/etcd/releases/download/v3.3.9/etcd-v3.3.9-linux-amd64.tar.gz&quot;</span><br></pre></td></tr></table></figure></p>
<p>解压缩并安装 etcd 服务与 etcdctl 命令行工具：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# tar -xvf etcd-v3.3.9-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# sudo mv etcd-v3.3.9-linux-amd64/etcd* /usr/local/bin/</span><br></pre></td></tr></table></figure>
<h3 id="5-2-配置-etcd-Server"><a href="#5-2-配置-etcd-Server" class="headerlink" title="5.2 配置 etcd Server"></a>5.2 配置 etcd Server</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# sudo mkdir -p /etc/etcd /var/lib/etcd</span><br><span class="line">[root@worker-master ~]# sudo cp ca.pem kubernetes-key.pem kubernetes.pem /etc/etcd/</span><br></pre></td></tr></table></figure>
<p>每个 etcd 成员必须有一个整集群中唯一的名字，使用 hostname 作为 etcd name：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# ETCD_NAME=$(hostname -s)</span><br></pre></td></tr></table></figure></p>
<p>生成 etcd.service 的 systemd 配置文件:</p>
<blockquote>
<p>请注意：对于使用公网主机（如云服务器等）的操作者， etcd 绑定的服务端口（即以下的 ${MASTER_IP} ）应使用内网 IP 地址。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# cat &lt;&lt;EOF | sudo tee /etc/systemd/system/etcd.service</span><br><span class="line">&gt; [Unit]</span><br><span class="line">&gt; Description=etcd</span><br><span class="line">&gt; Documentation=https://github.com/coreos</span><br><span class="line">&gt; [Service]</span><br><span class="line">&gt; ExecStart=/usr/local/bin/etcd \\</span><br><span class="line">&gt;   --name master \\</span><br><span class="line">&gt;   --cert-file=/etc/etcd/kubernetes.pem \\</span><br><span class="line">&gt;   --key-file=/etc/etcd/kubernetes-key.pem \\</span><br><span class="line">&gt;   --peer-cert-file=/etc/etcd/kubernetes.pem \\</span><br><span class="line">&gt;   --peer-key-file=/etc/etcd/kubernetes-key.pem \\</span><br><span class="line">&gt;   --trusted-ca-file=/etc/etcd/ca.pem \\</span><br><span class="line">&gt;   --peer-trusted-ca-file=/etc/etcd/ca.pem \\</span><br><span class="line">&gt;   --peer-client-cert-auth \\</span><br><span class="line">&gt;   --client-cert-auth \\</span><br><span class="line">&gt;   --initial-advertise-peer-urls https://$&#123;MASTER_IP&#125;:2380 \\</span><br><span class="line">&gt;   --listen-peer-urls https://$&#123;MASTER_IP&#125;:2380 \\</span><br><span class="line">&gt;   --listen-client-urls https://$&#123;MASTER_IP&#125;:2379,http://127.0.0.1:2379 \\</span><br><span class="line">&gt;   --advertise-client-urls https://$&#123;MASTER_IP&#125;:2379,http://127.0.0.1:2379 \\</span><br><span class="line">&gt;   --data-dir=/var/lib/etcd</span><br><span class="line">&gt; Restart=on-failure</span><br><span class="line">&gt; RestartSec=5</span><br><span class="line">&gt; [Install]</span><br><span class="line">&gt; WantedBy=multi-user.target</span><br><span class="line">&gt; EOF</span><br></pre></td></tr></table></figure>
<h3 id="5-3-启动-etcd-Server"><a href="#5-3-启动-etcd-Server" class="headerlink" title="5.3 启动 etcd Server"></a>5.3 启动 etcd Server</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# sudo systemctl daemon-reload</span><br><span class="line">[root@worker-master ~]# sudo systemctl enable etcd</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/etcd.service to /etc/systemd/system/etcd.service.</span><br><span class="line">[root@worker-master ~]# sudo systemctl start etcd</span><br></pre></td></tr></table></figure>
<h3 id="5-4-验证是否正常"><a href="#5-4-验证是否正常" class="headerlink" title="5.4 验证是否正常"></a>5.4 验证是否正常</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# ETCDCTL_API=3 etcdctl member list</span><br><span class="line">6911926ad78226a5, started, master, https://172.26.64.9:2380, http://127.0.0.1:2379,https://172.26.64.9:2379</span><br></pre></td></tr></table></figure>
<p>正常。</p>
<h2 id="6-部署-Kubernetes-控制节点"><a href="#6-部署-Kubernetes-控制节点" class="headerlink" title="6. 部署 Kubernetes 控制节点"></a>6. 部署 Kubernetes 控制节点</h2><p>本部分将会在控制节点上部署 Kubernetes 控制服务。每个控制节点上需要部署的服务包括：Kubernetes API Server、Scheduler 以及 Controller Manager 等。</p>
<h3 id="6-1-创建-Kubernetes-配置目录"><a href="#6-1-创建-Kubernetes-配置目录" class="headerlink" title="6.1 创建 Kubernetes 配置目录"></a>6.1 创建 Kubernetes 配置目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# sudo mkdir -p /etc/kubernetes/config</span><br></pre></td></tr></table></figure>
<h3 id="6-2-下载并安装-Kubernetes-Controller-二进制文件"><a href="#6-2-下载并安装-Kubernetes-Controller-二进制文件" class="headerlink" title="6.2 下载并安装 Kubernetes Controller 二进制文件"></a>6.2 下载并安装 Kubernetes Controller 二进制文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# wget --timestamping \</span><br><span class="line">&gt;   &quot;https://storage.googleapis.com/kubernetes-release/release/v1.15.0/bin/linux/amd64/kube-apiserver&quot; \</span><br><span class="line">&gt;   &quot;https://storage.googleapis.com/kubernetes-release/release/v1.15.0/bin/linux/amd64/kube-controller-manager&quot; \</span><br><span class="line">&gt;   &quot;https://storage.googleapis.com/kubernetes-release/release/v1.15.0/bin/linux/amd64/kube-scheduler&quot; \</span><br><span class="line">&gt;   &quot;https://storage.googleapis.com/kubernetes-release/release/v1.15.0/bin/linux/amd64/kubectl&quot;</span><br><span class="line">...</span><br><span class="line">Downloaded: 4 files, 346M in 9.5s (36.2 MB/s)</span><br><span class="line">[root@worker-master ~]# chmod +x kube-apiserver kube-controller-manager kube-scheduler kubectl</span><br><span class="line">[root@worker-master ~]# sudo mv kube-apiserver kube-controller-manager kube-scheduler kubectl /usr/local/bin/</span><br></pre></td></tr></table></figure>
<h3 id="6-3-配置-Kubernetes-API-Server"><a href="#6-3-配置-Kubernetes-API-Server" class="headerlink" title="6.3 配置 Kubernetes API Server"></a>6.3 配置 Kubernetes API Server</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# sudo mkdir -p /var/lib/kubernetes/</span><br><span class="line">[root@worker-master ~]# sudo mv ca.pem ca-key.pem kubernetes-key.pem kubernetes.pem \</span><br><span class="line">&gt;   service-account-key.pem service-account.pem \</span><br><span class="line">&gt;   encryption-config.yaml /var/lib/kubernetes/</span><br></pre></td></tr></table></figure>
<p>生成 kube-apiserver.service systemd 配置文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# cat &lt;&lt;EOF | sudo tee /etc/systemd/system/kube-apiserver.service</span><br><span class="line">&gt; [Unit]</span><br><span class="line">&gt; Description=Kubernetes API Server</span><br><span class="line">&gt; Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">&gt;</span><br><span class="line">&gt; [Service]</span><br><span class="line">&gt; ExecStart=/usr/local/bin/kube-apiserver \\</span><br><span class="line">&gt;   --advertise-address=$&#123;MASTER_IP&#125; \\</span><br><span class="line">&gt;   --allow-privileged=true \\</span><br><span class="line">&gt;   --audit-log-maxage=30 \\</span><br><span class="line">&gt;   --audit-log-maxbackup=3 \\</span><br><span class="line">&gt;   --audit-log-maxsize=100 \\</span><br><span class="line">&gt;   --audit-log-path=/var/log/audit.log \\</span><br><span class="line">&gt;   --authorization-mode=Node,RBAC \\</span><br><span class="line">&gt;   --bind-address=0.0.0.0 \\</span><br><span class="line">&gt;   --client-ca-file=/var/lib/kubernetes/ca.pem \\</span><br><span class="line">&gt;   --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota \\</span><br><span class="line">&gt;   --enable-swagger-ui=true \\</span><br><span class="line">&gt;   --etcd-cafile=/var/lib/kubernetes/ca.pem \\</span><br><span class="line">&gt;   --etcd-certfile=/var/lib/kubernetes/kubernetes.pem \\</span><br><span class="line">&gt;   --etcd-keyfile=/var/lib/kubernetes/kubernetes-key.pem \\</span><br><span class="line">&gt;   --etcd-servers=http://127.0.0.1:2379 \\</span><br><span class="line">&gt;   --event-ttl=1h \\</span><br><span class="line">&gt;   --experimental-encryption-provider-config=/var/lib/kubernetes/encryption-config.yaml \\</span><br><span class="line">&gt;   --insecure-bind-address=127.0.0.1 \\</span><br><span class="line">&gt;   --kubelet-certificate-authority=/var/lib/kubernetes/ca.pem \\</span><br><span class="line">&gt;   --kubelet-client-certificate=/var/lib/kubernetes/kubernetes.pem \\</span><br><span class="line">&gt;   --kubelet-client-key=/var/lib/kubernetes/kubernetes-key.pem \\</span><br><span class="line">&gt;   --kubelet-https=true \\</span><br><span class="line">&gt;   --runtime-config=api/all \\</span><br><span class="line">&gt;   --service-account-key-file=/var/lib/kubernetes/service-account.pem \\</span><br><span class="line">&gt;   --service-cluster-ip-range=10.250.0.0/24 \\</span><br><span class="line">&gt;   --service-node-port-range=30000-32767 \\</span><br><span class="line">&gt;   --tls-cert-file=/var/lib/kubernetes/kubernetes.pem \\</span><br><span class="line">&gt;   --tls-private-key-file=/var/lib/kubernetes/kubernetes-key.pem \\</span><br><span class="line">&gt;   --v=2</span><br><span class="line">&gt; Restart=on-failure</span><br><span class="line">&gt; RestartSec=5</span><br><span class="line">&gt;</span><br><span class="line">&gt; [Install]</span><br><span class="line">&gt; WantedBy=multi-user.target</span><br><span class="line">&gt; EOF</span><br></pre></td></tr></table></figure></p>
<h3 id="6-4-配置-Kubernetes-Controller-Manager"><a href="#6-4-配置-Kubernetes-Controller-Manager" class="headerlink" title="6.4 配置 Kubernetes Controller Manager"></a>6.4 配置 Kubernetes Controller Manager</h3><p>生成 kube-controller-manager.service systemd 配置文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# sudo mv kube-controller-manager.kubeconfig /var/lib/kubernetes/</span><br><span class="line">[root@worker-master ~]# cat &lt;&lt;EOF | sudo tee /etc/systemd/system/kube-controller-manager.service</span><br><span class="line">&gt; [Unit]</span><br><span class="line">&gt; Description=Kubernetes Controller Manager</span><br><span class="line">&gt; Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">&gt;</span><br><span class="line">&gt; [Service]</span><br><span class="line">&gt; ExecStart=/usr/local/bin/kube-controller-manager \\</span><br><span class="line">&gt;   --address=0.0.0.0 \\</span><br><span class="line">&gt;   --allocate-node-cidrs=true \\</span><br><span class="line">&gt;   --cluster-cidr=10.244.0.0/16 \\</span><br><span class="line">&gt;   --cluster-name=kubernetes \\</span><br><span class="line">&gt;   --cluster-signing-cert-file=/var/lib/kubernetes/ca.pem \\</span><br><span class="line">&gt;   --cluster-signing-key-file=/var/lib/kubernetes/ca-key.pem \\</span><br><span class="line">&gt;   --kubeconfig=/var/lib/kubernetes/kube-controller-manager.kubeconfig \\</span><br><span class="line">&gt;   --leader-elect=true \\</span><br><span class="line">&gt;   --root-ca-file=/var/lib/kubernetes/ca.pem \\</span><br><span class="line">&gt;   --service-account-private-key-file=/var/lib/kubernetes/service-account-key.pem \\</span><br><span class="line">&gt;   --service-cluster-ip-range=10.250.0.0/24 \\</span><br><span class="line">&gt;   --use-service-account-credentials=true \\</span><br><span class="line">&gt;   --v=2</span><br><span class="line">&gt; Restart=on-failure</span><br><span class="line">&gt; RestartSec=5</span><br><span class="line">&gt;</span><br><span class="line">&gt; [Install]</span><br><span class="line">&gt; WantedBy=multi-user.target</span><br><span class="line">&gt; EOF</span><br></pre></td></tr></table></figure></p>
<h3 id="6-5-配置-Kubernetes-Scheduler"><a href="#6-5-配置-Kubernetes-Scheduler" class="headerlink" title="6.5 配置 Kubernetes Scheduler"></a>6.5 配置 Kubernetes Scheduler</h3><p>生成 kube-scheduler.service systemd 配置文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# sudo mv kube-scheduler.kubeconfig /var/lib/kubernetes/</span><br><span class="line">[root@worker-master ~]# cat &lt;&lt;EOF | sudo tee /etc/kubernetes/config/kube-scheduler.yaml</span><br><span class="line">&gt; apiVersion: kubescheduler.config.k8s.io/v1alpha1</span><br><span class="line">&gt; kind: KubeSchedulerConfiguration</span><br><span class="line">&gt; clientConnection:</span><br><span class="line">&gt;   kubeconfig: &quot;/var/lib/kubernetes/kube-scheduler.kubeconfig&quot;</span><br><span class="line">&gt; leaderElection:</span><br><span class="line">&gt;   leaderElect: true</span><br><span class="line">&gt; EOF</span><br><span class="line">[root@worker-master ~]# cat &lt;&lt;EOF | sudo tee /etc/systemd/system/kube-scheduler.service</span><br><span class="line">&gt; [Unit]</span><br><span class="line">&gt; Description=Kubernetes Scheduler</span><br><span class="line">&gt; Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">&gt;</span><br><span class="line">&gt; [Service]</span><br><span class="line">&gt; ExecStart=/usr/local/bin/kube-scheduler \\</span><br><span class="line">&gt;   --config=/etc/kubernetes/config/kube-scheduler.yaml \\</span><br><span class="line">&gt;   --v=2</span><br><span class="line">&gt; Restart=on-failure</span><br><span class="line">&gt; RestartSec=5</span><br><span class="line">&gt;</span><br><span class="line">&gt; [Install]</span><br><span class="line">&gt; WantedBy=multi-user.target</span><br><span class="line">&gt; EOF</span><br></pre></td></tr></table></figure></p>
<h3 id="6-6-启动控制器服务"><a href="#6-6-启动控制器服务" class="headerlink" title="6.6 启动控制器服务"></a>6.6 启动控制器服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# sudo systemctl daemon-reload</span><br><span class="line">[root@worker-master ~]# sudo systemctl enable kube-apiserver kube-controller-manager kube-scheduler</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/kube-apiserver.service to /etc/systemd/system/kube-apiserver.service.</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/kube-controller-manager.service to /etc/systemd/system/kube-controller-manager.service.</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/kube-scheduler.service to /etc/systemd/system/kube-scheduler.service.</span><br><span class="line">[root@worker-master ~]# sudo systemctl start kube-apiserver kube-controller-manager kube-scheduler</span><br></pre></td></tr></table></figure>
<p>请等待 10 秒以便 Kubernetes API Server 初始化。 接下来验证一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# kubectl get componentstatuses --kubeconfig admin.kubeconfig</span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">scheduler            Healthy   ok                  </span><br><span class="line">controller-manager   Healthy   ok</span><br></pre></td></tr></table></figure>
<p>说明正常。</p>
<h2 id="7-Kubelet-RBAC-授权"><a href="#7-Kubelet-RBAC-授权" class="headerlink" title="7. Kubelet RBAC 授权"></a>7. Kubelet RBAC 授权</h2><p>本节将会配置 API Server 访问 Kubelet API 的 RBAC 授权。访问 Kubelet API 是获取 metrics、日志以及执行容器命令所必需的。</p>
<blockquote>
<p>这里设置 Kubelet –authorization-mode 为 Webhook 模式。Webhook 模式使用 SubjectAccessReview API 来决定授权。</p>
</blockquote>
<p>创建 system:kube-apiserver-to-kubelet ClusterRole 以允许请求 Kubelet API 和执行大部分来管理 Pods 的任务:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# cat &lt;&lt;EOF | kubectl apply --kubeconfig admin.kubeconfig -f -</span><br><span class="line">&gt; apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">&gt; kind: ClusterRole</span><br><span class="line">&gt; metadata:</span><br><span class="line">&gt;   annotations:</span><br><span class="line">&gt;     rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;</span><br><span class="line">&gt;   labels:</span><br><span class="line">&gt;     kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">&gt;   name: system:kube-apiserver-to-kubelet</span><br><span class="line">&gt; rules:</span><br><span class="line">&gt;   - apiGroups:</span><br><span class="line">&gt;       - &quot;&quot;</span><br><span class="line">&gt;     resources:</span><br><span class="line">&gt;       - nodes/proxy</span><br><span class="line">&gt;       - nodes/stats</span><br><span class="line">&gt;       - nodes/log</span><br><span class="line">&gt;       - nodes/spec</span><br><span class="line">&gt;       - nodes/metrics</span><br><span class="line">&gt;     verbs:</span><br><span class="line">&gt;       - &quot;*&quot;</span><br><span class="line">&gt; EOF</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:kube-apiserver-to-kubelet created</span><br></pre></td></tr></table></figure></p>
<p>Kubernetes API Server 使用客户端凭证授权 Kubelet 为 <code>kubernetes</code> 用户，此凭证用 <code>--kubelet-client-certificate</code> flag 来定义。</p>
<p>绑定 <code>system:kube-apiserver-to-kubelet</code> ClusterRole 到 <code>kubernetes</code> 用户:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# cat &lt;&lt;EOF | kubectl apply --kubeconfig admin.kubeconfig -f -</span><br><span class="line">&gt; apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">&gt; kind: ClusterRoleBinding</span><br><span class="line">&gt; metadata:</span><br><span class="line">&gt;   name: system:kube-apiserver</span><br><span class="line">&gt;   namespace: &quot;&quot;</span><br><span class="line">&gt; roleRef:</span><br><span class="line">&gt;   apiGroup: rbac.authorization.k8s.io</span><br><span class="line">&gt;   kind: ClusterRole</span><br><span class="line">&gt;   name: system:kube-apiserver-to-kubelet</span><br><span class="line">&gt; subjects:</span><br><span class="line">&gt;   - apiGroup: rbac.authorization.k8s.io</span><br><span class="line">&gt;     kind: User</span><br><span class="line">&gt;     name: kubernetes</span><br><span class="line">&gt; EOF</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created</span><br></pre></td></tr></table></figure></p>
<h2 id="8-部署-Kubernetes-Workers-节点"><a href="#8-部署-Kubernetes-Workers-节点" class="headerlink" title="8. 部署 Kubernetes Workers 节点"></a>8. 部署 Kubernetes Workers 节点</h2><p>本部分将会部署 Kubernetes Worker 节点 (上面的 1-7 步骤都是在 master 上操作的)。每个节点上将会安装以下服务：</p>
<ul>
<li><a href="https://www.docker.com/" target="_blank" rel="noopener">Docker</a></li>
<li><a href="https://github.com/containernetworking/cni" target="_blank" rel="noopener">container networking plugins</a></li>
<li><a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/" target="_blank" rel="noopener">kubelet</a></li>
<li><a href="https://kubernetes.io/docs/concepts/cluster-administration/proxies/" target="_blank" rel="noopener">kube-proxy</a></li>
</ul>
<p>因为我们有两个 worker 节点， 接下来先部署 worker-1 节点，等加入集群成功了，并且验证没问题之后， 再部署 worker-2 节点。</p>
<p>所以接下来的操作都是在 worker-1 节点上操作 (通用配置要先配置)的。</p>
<h3 id="8-1-安装依赖"><a href="#8-1-安装依赖" class="headerlink" title="8.1 安装依赖"></a>8.1 安装依赖</h3><p>安装 OS 依赖组件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-1 ~]# sudo yum install -y socat conntrack ipset</span><br></pre></td></tr></table></figure></p>
<p>安装 docker:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-1 ~]# sudo yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">[root@worker-1 ~]# sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">[root@worker-1 ~]# sudo yum install -y docker-ce docker-ce-cli containerd.io</span><br><span class="line">[root@worker-1 ~]# sudo systemctl enable docker</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/docker.service to /usr/lib/systemd/system/docker.service.</span><br><span class="line">[root@worker-1 ~]# sudo systemctl start docker</span><br></pre></td></tr></table></figure></p>
<p>下载 worker 二进制文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-1 ~]# wget --timestamping \</span><br><span class="line">&gt;   https://github.com/containernetworking/plugins/releases/download/v0.6.0/cni-plugins-amd64-v0.6.0.tgz \</span><br><span class="line">&gt;   https://storage.googleapis.com/kubernetes-release/release/v1.15.0/bin/linux/amd64/kubectl \</span><br><span class="line">&gt;   https://storage.googleapis.com/kubernetes-release/release/v1.15.0/bin/linux/amd64/kube-proxy \</span><br><span class="line">&gt;   https://storage.googleapis.com/kubernetes-release/release/v1.15.0/bin/linux/amd64/kubelet</span><br></pre></td></tr></table></figure></p>
<p>创建安装目录：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-1 ~]# sudo mkdir -p \</span><br><span class="line">&gt;   /opt/cni/bin \</span><br><span class="line">&gt;   /var/lib/kubelet \</span><br><span class="line">&gt;   /var/lib/kube-proxy \</span><br><span class="line">&gt;   /var/lib/kubernetes \</span><br><span class="line">&gt;   /var/run/kubernetes</span><br></pre></td></tr></table></figure></p>
<p>安装 worker 二进制文件:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-1 ~]# chmod +x kubectl kube-proxy kubelet</span><br><span class="line">[root@worker-1 ~]# sudo mv kubectl kube-proxy kubelet /usr/local/bin/</span><br></pre></td></tr></table></figure></p>
<h3 id="8-2-配置-Kubelet"><a href="#8-2-配置-Kubelet" class="headerlink" title="8.2 配置 Kubelet"></a>8.2 配置 Kubelet</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-1 ~]# sudo cp worker-1-key.pem worker-1.pem /var/lib/kubelet/</span><br><span class="line">[root@worker-1 ~]# sudo cp worker-1.kubeconfig /var/lib/kubelet/kubeconfig</span><br><span class="line">[root@worker-1 ~]# sudo cp ca.pem /var/lib/kubernetes/</span><br><span class="line">[root@worker-1 ~]# sudo tar -xvf cni-plugins-amd64-v0.6.0.tgz -C /opt/cni/bin/</span><br></pre></td></tr></table></figure>
<p>生成 kubelet.service systemd 配置文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-1 ~]# cat &lt;&lt;EOF | sudo tee /var/lib/kubelet/kubelet-config.yaml</span><br><span class="line">&gt; kind: KubeletConfiguration</span><br><span class="line">&gt; apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">&gt; authentication:</span><br><span class="line">&gt;   anonymous:</span><br><span class="line">&gt;     enabled: false</span><br><span class="line">&gt;   webhook:</span><br><span class="line">&gt;     enabled: true</span><br><span class="line">&gt;   x509:</span><br><span class="line">&gt;     clientCAFile: &quot;/var/lib/kubernetes/ca.pem&quot;</span><br><span class="line">&gt; authorization:</span><br><span class="line">&gt;   mode: Webhook</span><br><span class="line">&gt; clusterDomain: &quot;cluster.local&quot;</span><br><span class="line">&gt; clusterDNS:</span><br><span class="line">&gt;   - &quot;10.250.0.10&quot;</span><br><span class="line">&gt; runtimeRequestTimeout: &quot;15m&quot;</span><br><span class="line">&gt; tlsCertFile: &quot;/var/lib/kubelet/worker-1.pem&quot;</span><br><span class="line">&gt; tlsPrivateKeyFile: &quot;/var/lib/kubelet/worker-1-key.pem&quot;</span><br><span class="line">&gt; EOF</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-1 ~]# cat &lt;&lt;EOF | sudo tee /etc/systemd/system/kubelet.service</span><br><span class="line">&gt; [Unit]</span><br><span class="line">&gt; Description=Kubernetes Kubelet</span><br><span class="line">&gt; Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">&gt; After=docker.service</span><br><span class="line">&gt; Requires=docker.service</span><br><span class="line">&gt;</span><br><span class="line">&gt; [Service]</span><br><span class="line">&gt; ExecStart=/usr/local/bin/kubelet \\</span><br><span class="line">&gt;   --config=/var/lib/kubelet/kubelet-config.yaml \\</span><br><span class="line">&gt;   --image-pull-progress-deadline=2m \\</span><br><span class="line">&gt;   --kubeconfig=/var/lib/kubelet/kubeconfig \\</span><br><span class="line">&gt;   --pod-infra-container-image=cargo.caicloud.io/caicloud/pause-amd64:3.1 \\</span><br><span class="line">&gt;   --network-plugin=cni \\</span><br><span class="line">&gt;   --register-node=true \\</span><br><span class="line">&gt;   --v=2</span><br><span class="line">&gt; Restart=on-failure</span><br><span class="line">&gt; RestartSec=5</span><br><span class="line">&gt;</span><br><span class="line">&gt; [Install]</span><br><span class="line">&gt; WantedBy=multi-user.target</span><br><span class="line">&gt; EOF</span><br></pre></td></tr></table></figure>
<h3 id="8-3-配置-Kube-Proxy"><a href="#8-3-配置-Kube-Proxy" class="headerlink" title="8.3 配置 Kube-Proxy"></a>8.3 配置 Kube-Proxy</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-1 ~]# sudo mv kube-proxy.kubeconfig /var/lib/kube-proxy/kubeconfig</span><br></pre></td></tr></table></figure>
<p>生成 kube-proxy.service systemd 配置文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-1 ~]# cat &lt;&lt;EOF | sudo tee /var/lib/kube-proxy/kube-proxy-config.yaml</span><br><span class="line">&gt; kind: KubeProxyConfiguration</span><br><span class="line">&gt; apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">&gt; clientConnection:</span><br><span class="line">&gt;   kubeconfig: &quot;/var/lib/kube-proxy/kubeconfig&quot;</span><br><span class="line">&gt; mode: &quot;iptables&quot;</span><br><span class="line">&gt; clusterCIDR: &quot;10.244.0.0/16&quot;</span><br><span class="line">&gt; EOF</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-1 ~]# cat &lt;&lt;EOF | sudo tee /etc/systemd/system/kube-proxy.service</span><br><span class="line">&gt; [Unit]</span><br><span class="line">&gt; Description=Kubernetes Kube Proxy</span><br><span class="line">&gt; Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">&gt;</span><br><span class="line">&gt; [Service]</span><br><span class="line">&gt; ExecStart=/usr/local/bin/kube-proxy \\</span><br><span class="line">&gt;   --config=/var/lib/kube-proxy/kube-proxy-config.yaml</span><br><span class="line">&gt; Restart=on-failure</span><br><span class="line">&gt; RestartSec=5</span><br><span class="line">&gt;</span><br><span class="line">&gt; [Install]</span><br><span class="line">&gt; WantedBy=multi-user.target</span><br><span class="line">&gt; EOF</span><br></pre></td></tr></table></figure>
<h3 id="8-4-启动-worker-服务"><a href="#8-4-启动-worker-服务" class="headerlink" title="8.4 启动 worker 服务"></a>8.4 启动 worker 服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-1 ~]# sudo systemctl daemon-reload</span><br><span class="line">[root@worker-1 ~]# sudo systemctl enable kubelet kube-proxy</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/kubelet.service to /etc/systemd/system/kubelet.service.</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/kube-proxy.service to /etc/systemd/system/kube-proxy.service.</span><br><span class="line">[root@worker-1 ~]# sudo systemctl start kubelet kube-proxy</span><br></pre></td></tr></table></figure>
<p>这样子 worker-1 节点的配置就好了</p>
<h2 id="9-配置-Kubectl"><a href="#9-配置-Kubectl" class="headerlink" title="9. 配置 Kubectl"></a>9. 配置 Kubectl</h2><p>本部分将生成一个用于 admin 用户的 kubeconfig 文件。</p>
<blockquote>
<p>注意：在生成 admin 客户端证书的目录来运行本部分的指令。</p>
</blockquote>
<blockquote>
<p>注意，这部分操作实践我还是在 worker-1 当中执行。 (但是文档好像是应该在 master 上执行的，不过我后面操作的时候，放到 worker-1 上执行好像也没啥问题)</p>
</blockquote>
<h2 id="9-1-admin-kubeconfig"><a href="#9-1-admin-kubeconfig" class="headerlink" title="9.1 admin kubeconfig"></a>9.1 admin kubeconfig</h2><p>为 admin 用户生成 kubeconfig 文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-1 ~]# export MASTER_IP=172.26.64.9</span><br><span class="line">[root@worker-1 ~]# kubectl config set-cluster kubernetes-training \</span><br><span class="line">&gt;   --certificate-authority=ca.pem \</span><br><span class="line">&gt;   --embed-certs=true \</span><br><span class="line">&gt;   --server=https://$&#123;MASTER_IP&#125;:6443</span><br><span class="line">Cluster &quot;kubernetes-training&quot; set.</span><br><span class="line">[root@worker-1 ~]# kubectl config set-credentials admin \</span><br><span class="line">&gt;   --client-certificate=admin.pem \</span><br><span class="line">&gt;   --client-key=admin-key.pem</span><br><span class="line">User &quot;admin&quot; set.</span><br><span class="line">[root@worker-1 ~]# kubectl config set-context kubernetes-training \</span><br><span class="line">&gt;   --cluster=kubernetes-training \</span><br><span class="line">&gt;   --user=admin</span><br><span class="line">Context &quot;kubernetes-training&quot; created.</span><br><span class="line">[root@worker-1 ~]# kubectl config use-context kubernetes-training</span><br><span class="line">Switched to context &quot;kubernetes-training&quot;.</span><br></pre></td></tr></table></figure></p>
<p>检查远端 Kubernetes 集群的健康状况:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-1 ~]# kubectl get componentstatuses</span><br><span class="line">Error in configuration:</span><br><span class="line">* unable to read client-cert /root/admin.pem for admin due to open /root/admin.pem: no such file or directory</span><br><span class="line">* unable to read client-key /root/admin-key.pem for admin due to open /root/admin-key.pem: no such file or directory</span><br></pre></td></tr></table></figure></p>
<p>发现报错了，找不到 admin.pem 和 admin-key.pem 这两个文件， 这两个文件只在 master 上才有， worker-1 没有。 所以我当时的做法是将 master 上的这两个文件拷贝到 worker-1 上:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# scp -i /root/k8s admin.pem admin-key.pem  root@172.26.64.2:~/</span><br><span class="line">admin.pem                                                                                                                                                                     100% 1432     3.8MB/s   00:00    </span><br><span class="line">admin-key.pem                                                                                                                                                                 100% 1679     5.1MB/s   00:00</span><br></pre></td></tr></table></figure></p>
<p>然后重新执行一下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-1 ~]# kubectl config set-cluster kubernetes-training   --certificate-authority=ca.pem   --embed-certs=true   --server=https://$&#123;MASTER_IP&#125;:6443</span><br><span class="line">Cluster &quot;kubernetes-training&quot; set.</span><br><span class="line">[root@worker-1 ~]# kubectl config set-credentials admin   --client-certificate=admin.pem   --client-key=admin-key.pem</span><br><span class="line">User &quot;admin&quot; set.</span><br><span class="line">[root@worker-1 ~]# kubectl config set-context kubernetes-training   --cluster=kubernetes-training   --user=admin</span><br><span class="line">Context &quot;kubernetes-training&quot; modified.</span><br><span class="line">[root@worker-1 ~]# kubectl config use-context kubernetes-training</span><br><span class="line">Switched to context &quot;kubernetes-training&quot;.</span><br></pre></td></tr></table></figure></p>
<p>这时候状态就正常了:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-1 ~]# kubectl get componentstatuses</span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">controller-manager   Healthy   ok                  </span><br><span class="line">scheduler            Healthy   ok                  </span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;</span><br></pre></td></tr></table></figure></p>
<p>并且也可以列出远端kubernetes cluster 的节点:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-1 ~]# kubectl get nodes</span><br><span class="line">NAME       STATUS     ROLES    AGE   VERSION</span><br><span class="line">worker-1   NotReady   &lt;none&gt;   20m   v1.15.0</span><br></pre></td></tr></table></figure></p>
<p>此时节点已经注册成功了，但节点的状态仍然是 NotReady，我们需要继续安装集群网络以使其 Ready。</p>
<h2 id="10-配置-Pod-网络路由"><a href="#10-配置-Pod-网络路由" class="headerlink" title="10. 配置 Pod 网络路由"></a>10. 配置 Pod 网络路由</h2><blockquote>
<p>注意，这部分操作实践我还是在 worker-1 当中执行。 (但是文档好像是应该在 master 上执行的，不过我后面操作的时候，放到 worker-1 上执行好像也没啥问题)</p>
</blockquote>
<p>每个 Pod 都会从所在 Node 的 Pod CIDR 中分配一个 IP 地址。由于网络还没有配置，跨节点的 Pod 之间还无法通信。</p>
<p>我们可以选择 <a href="https://kubernetes.io/docs/concepts/cluster-administration/networking/#how-to-achieve-this" target="_blank" rel="noopener">Cluster Networking</a> 来实现 Kubernetes 网络模型。</p>
<p>这里我们选择安装 flannel, 这边要注意一个细节，就是这个 yaml 教程是直接取本地的， 也就是从这个 <a href="https://github.com/caicloud/kube-ladder" target="_blank" rel="noopener">github 项目</a>中的文件，所以我是将这个 github 项目拉到本地，然后解压，然后再引用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-1 ~]# kubectl apply -f ./kube-ladder-master/tutorials/resources/kube-flannel.yaml</span><br><span class="line">podsecuritypolicy.extensions/psp.flannel.unprivileged created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/flannel created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/flannel created</span><br><span class="line">serviceaccount/flannel created</span><br><span class="line">configmap/kube-flannel-cfg created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-amd64 created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-arm64 created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-arm created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-ppc64le created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-s390x created</span><br></pre></td></tr></table></figure>
<p>这样子就创建好了</p>
<h2 id="11-部署-DNS-扩展"><a href="#11-部署-DNS-扩展" class="headerlink" title="11. 部署 DNS 扩展"></a>11. 部署 DNS 扩展</h2><p>部属 kube-dns 群集扩展:</p>
<blockquote>
<p>这边也是用到这个 github 项目的一个 yaml 配置文件</p>
</blockquote>
<blockquote>
<p>注意，这部分操作实践我还是在 worker-1 当中执行。 (但是文档好像是应该在 master 上执行的，不过我后面操作的时候，放到 worker-1 上执行好像也没啥问题)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-1 ~]# kubectl apply -f ./kube-ladder-master/tutorials/resources/coredns.yaml</span><br><span class="line">serviceaccount/coredns created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:coredns created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/system:coredns created</span><br><span class="line">configmap/coredns created</span><br><span class="line">deployment.extensions/coredns created</span><br><span class="line">service/kube-dns created</span><br></pre></td></tr></table></figure>
<p>列出 kube-dns 部署的 Pod 列表 (要等会儿才会变成 running):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-1 ~]# kubectl get pods -l k8s-app=kube-dns -n kube-system</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-797d65b84c-9757q   1/1     Running   0          2m27s</span><br><span class="line">coredns-797d65b84c-x7b5m   1/1     Running   1          2m27s</span><br></pre></td></tr></table></figure></p>
<p>接下来验证一下，建立一个 busybox 部署:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-1 ~]# kubectl run busybox --image=busybox:1.28.3 --command -- sleep 3600</span><br><span class="line">kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed in a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.</span><br><span class="line">deployment.apps/busybox created</span><br></pre></td></tr></table></figure></p>
<p>列出 busybox 部署的 Pod：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-1 ~]# kubectl get pods -l run=busybox</span><br><span class="line">NAME                      READY   STATUS              RESTARTS   AGE</span><br><span class="line">busybox-bc6dbfc6d-s5bgc   0/1     ContainerCreating   0          19s</span><br></pre></td></tr></table></figure></p>
<p>查询 busybox Pod 的全名:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-1 ~]# kubectl get pods -l run=busybox -o jsonpath=&quot;&#123;.items[0].metadata.name&#125;&quot;</span><br><span class="line">busybox-bc6dbfc6d-s5bgc</span><br></pre></td></tr></table></figure></p>
<p>在 busybox Pod 中查询 DNS：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-1 ~]# kubectl exec -ti busybox-bc6dbfc6d-s5bgc -- nslookup kubernetes</span><br><span class="line">Server:    10.250.0.10</span><br><span class="line">Address 1: 10.250.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      kubernetes</span><br><span class="line">Address 1: 10.250.0.1 kubernetes.default.svc.cluster.local</span><br></pre></td></tr></table></figure></p>
<p>这边要注意一个细节，之前我没有在 /etc/hosts 上补上 <code>172.26.64.2 worker-1</code> 这一行的时候，这个会报错:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-1 ~]# kubectl exec -ti busybox-bc6dbfc6d-s5bgc -- nslookup kubernetes</span><br><span class="line">Error from server: error dialing backend: dial tcp: lookup worker-1 on 183.60.83.19:53: no such host</span><br></pre></td></tr></table></figure></p>
<p>所以要 host 才行。</p>
<p>所以 node 节点  worker-1 集群成功了。 不过这有比较疑惑的就是，我的 9,10,11 步骤都是在 worker-1 上执行的，并没有在 master 上执行 (但是运行结果却是正常的), 所以我怀疑是不是 admin 的凭证对就可以了。</p>
<h2 id="12-烟雾测试"><a href="#12-烟雾测试" class="headerlink" title="12. 烟雾测试"></a>12. 烟雾测试</h2><p>虽然现在集群中只有一台 worker-1 (注意，跟之前的 kubeadm 不一样的是，本次的 master 并没有在集群中，只是控制节点而已), 但是也算集群了，本部分将会运行一系列的测试来验证 Kubernetes 集群的功能正常。</p>
<h3 id="12-1-数据加密"><a href="#12-1-数据加密" class="headerlink" title="12.1 数据加密"></a>12.1 数据加密</h3><p>本节将会验证 encrypt secret data at rest 的功能。</p>
<blockquote>
<p>本节是在 master 机器上进行测试的</p>
</blockquote>
<p>创建一个 Secret:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# kubectl create secret generic kubernetes-training \</span><br><span class="line">&gt;   --from-literal=&quot;mykey=mydata&quot;</span><br></pre></td></tr></table></figure></p>
<p>查询存在 etcd 里 16 进位编码的 kubernetes-training secret:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# ETCDCTL_API=3 etcdctl get \</span><br><span class="line">&gt;   --endpoints=http://127.0.0.1:2379 \</span><br><span class="line">&gt;   --cacert=/etc/etcd/ca.pem \</span><br><span class="line">&gt;   --cert=/etc/etcd/kubernetes.pem \</span><br><span class="line">&gt;   --key=/etc/etcd/kubernetes-key.pem\</span><br><span class="line">&gt;   /registry/secrets/default/kubernetes-training | hexdump -C</span><br><span class="line">00000000  2f 72 65 67 69 73 74 72  79 2f 73 65 63 72 65 74  |/registry/secret|</span><br><span class="line">00000010  73 2f 64 65 66 61 75 6c  74 2f 6b 75 62 65 72 6e  |s/default/kubern|</span><br><span class="line">00000020  65 74 65 73 2d 74 72 61  69 6e 69 6e 67 0a 6b 38  |etes-training.k8|</span><br><span class="line">00000030  73 3a 65 6e 63 3a 61 65  73 63 62 63 3a 76 31 3a  |s:enc:aescbc:v1:|</span><br><span class="line">00000040  6b 65 79 31 3a 36 b4 09  2b c5 d7 30 17 85 f3 88  |key1:6..+..0....|</span><br><span class="line">00000050  91 0c 38 5e 06 e2 ce 72  40 f8 c1 be d9 b7 f7 ae  |..8^...r@.......|</span><br><span class="line">00000060  59 da e5 43 04 f4 36 a3  e6 5e 08 17 f5 a9 fb cd  |Y..C..6..^......|</span><br><span class="line">00000070  eb 06 7e 95 67 66 cb 8b  d3 aa 00 cf 89 03 a5 af  |..~.gf..........|</span><br><span class="line">00000080  bd 4d db 22 5d b2 d1 cc  3c 3e 6e 7d 8b cd 8a 1e  |.M.&quot;]...&lt;&gt;n&#125;....|</span><br><span class="line">00000090  b8 3f d1 d3 48 51 34 0f  f9 65 4e ed 89 c7 d0 6d  |.?..HQ4..eN....m|</span><br><span class="line">000000a0  38 3f a2 1c 52 1b bc b8  29 f8 f2 32 15 47 58 e2  |8?..R...)..2.GX.|</span><br><span class="line">000000b0  14 b3 c5 bb ab 4a 9a 34  2a b9 d5 69 b2 f8 ae ba  |.....J.4*..i....|</span><br><span class="line">000000c0  b7 62 50 47 7a 4d 42 02  f4 1a 8b 13 67 70 a4 c8  |.bPGzMB.....gp..|</span><br><span class="line">000000d0  b8 e3 2a 86 0a 44 0a 7d  4c c6 18 e2 ee 0c 4c 5a  |..*..D.&#125;L.....LZ|</span><br><span class="line">000000e0  1d 11 0d ca 16 0a                                 |......|</span><br><span class="line">000000e6</span><br></pre></td></tr></table></figure></p>
<p>Etcd 的密钥以 k8s:enc:aescbc:v1:key1 为前缀, 表示使用密钥为 key1 的 aescbc 加密数据。</p>
<h3 id="12-2-部署"><a href="#12-2-部署" class="headerlink" title="12.2 部署"></a>12.2 部署</h3><p>本节将会验证建立与管理 Deployments 的功能。</p>
<p>创建一个 Deployment 用来搭建 nginx Web 服务：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# kubectl run nginx --image=nginx</span><br><span class="line">kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed in a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.</span><br><span class="line">deployment.apps/nginx created</span><br></pre></td></tr></table></figure></p>
<p>列出 nginx deployment 的 pods:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# kubectl get pods -l run=nginx</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-7bb7cd8db5-dct2j   1/1     Running   0          53s</span><br></pre></td></tr></table></figure></p>
<h3 id="12-3-测试端口转发"><a href="#12-3-测试端口转发" class="headerlink" title="12.3 测试端口转发"></a>12.3 测试端口转发</h3><p>本节将会验证使用 port forwarding 从远端进入容器的功能。</p>
<p>查询 nginx pod 的全名:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# POD_NAME=$(kubectl get pods -l run=nginx -o jsonpath=&quot;&#123;.items[0].metadata.name&#125;&quot;)</span><br></pre></td></tr></table></figure></p>
<p>将本地机器的 8080 端口转发到 nginx pod 的 80 端口：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# kubectl port-forward $POD_NAME 8080:80</span><br><span class="line">Forwarding from [::1]:8080 -&gt; 80</span><br></pre></td></tr></table></figure></p>
<p>开一个新的终端来做 HTTP 请求测试:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# curl --head http://127.0.0.1:8080</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Date: Thu, 29 Oct 2020 11:10:32 GMT</span><br></pre></td></tr></table></figure></p>
<p>是正常的。</p>
<h3 id="12-4-查看容器日志"><a href="#12-4-查看容器日志" class="headerlink" title="12.4 查看容器日志"></a>12.4 查看容器日志</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# kubectl logs $POD_NAME</span><br><span class="line">/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration</span><br><span class="line">/docker-entrypoint.sh: Looking for shell scripts in /docker-entrypoint.d/</span><br><span class="line">/docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh</span><br><span class="line">10-listen-on-ipv6-by-default.sh: Getting the checksum of /etc/nginx/conf.d/default.conf</span><br><span class="line">10-listen-on-ipv6-by-default.sh: Enabled listen on IPv6 in /etc/nginx/conf.d/default.conf</span><br><span class="line">/docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh</span><br><span class="line">/docker-entrypoint.sh: Configuration complete; ready for start up</span><br></pre></td></tr></table></figure>
<h3 id="12-5-执行容器命令"><a href="#12-5-执行容器命令" class="headerlink" title="12.5 执行容器命令"></a>12.5 执行容器命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# kubectl exec -ti $POD_NAME -- nginx -v</span><br><span class="line">nginx version: nginx/1.19.3</span><br></pre></td></tr></table></figure>
<h3 id="12-6-验证服务"><a href="#12-6-验证服务" class="headerlink" title="12.6 验证服务"></a>12.6 验证服务</h3><p>将 nginx 部署导出为 NodePort 类型的 Service：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# kubectl expose deployment nginx --port 80 --type NodePort</span><br><span class="line">service/nginx exposed</span><br></pre></td></tr></table></figure></p>
<p>查询 nginx 服务分配的 Node Port：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# kubectl get services -o wide</span><br><span class="line">NAME         TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)        AGE     SELECTOR</span><br><span class="line">kubernetes   ClusterIP   10.250.0.1    &lt;none&gt;        443/TCP        64m     &lt;none&gt;</span><br><span class="line">nginx        NodePort    10.250.0.64   &lt;none&gt;        80:31091/TCP   2m42s   run=nginx</span><br></pre></td></tr></table></figure></p>
<p>使用 Node IP 地址 + nginx 服务的 Node Port 做 HTTP 请求测试, 因为当前集群只有 worker-1， 所以是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# curl -I http://172.26.64.2:31091</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.19.3</span><br><span class="line">Date: Thu, 29 Oct 2020 11:16:33 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 612</span><br><span class="line">Last-Modified: Tue, 29 Sep 2020 14:12:31 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;5f7340cf-264&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure></p>
<p>所以测试通过。</p>
<p>这边要注意一个细节，虽然  master 节点还没有加入 集群。 但是他是控制节点的， 所以他也可以执行指令， 当然 worker-1 节点也是可以的</p>
<p>master 执行指令:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-master ~]# kubectl get nodes</span><br><span class="line">NAME       STATUS   ROLES    AGE   VERSION</span><br><span class="line">worker-1   Ready    &lt;none&gt;   21h   v1.15.0</span><br></pre></td></tr></table></figure></p>
<p>worker-1 节点，执行指令:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-1 ~]# kubectl get nodes</span><br><span class="line">NAME       STATUS   ROLES    AGE   VERSION</span><br><span class="line">worker-1   Ready    &lt;none&gt;   21h   v1.15.0</span><br></pre></td></tr></table></figure></p>
<h2 id="13-将-worker-2-也加入到集群"><a href="#13-将-worker-2-也加入到集群" class="headerlink" title="13. 将 worker-2 也加入到集群"></a>13. 将 worker-2 也加入到集群</h2><p>将 worker-2 节点加入到集群中，很简单，在 worker-2 节点上，执行 8，9 步骤的操作即可 (10 和 11 步骤不用再处理)</p>
<blockquote>
<p>依然将 master 的 admin 的凭证拷贝过来</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-2 ~]# sudo yum install -y socat conntrack ipset</span><br><span class="line">[root@worker-2 ~]# sudo yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">[root@worker-2 ~]# sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">[root@worker-2 ~]# sudo yum install -y docker-ce docker-ce-cli containerd.io</span><br><span class="line">[root@worker-2 ~]# sudo systemctl enable docker</span><br><span class="line">[root@worker-2 ~]# sudo systemctl start docker</span><br><span class="line">[root@worker-2 ~]# wget --timestamping \</span><br><span class="line">&gt;   https://github.com/containernetworking/plugins/releases/download/v0.6.0/cni-plugins-amd64-v0.6.0.tgz \</span><br><span class="line">&gt;   https://storage.googleapis.com/kubernetes-release/release/v1.15.0/bin/linux/amd64/kubectl \</span><br><span class="line">&gt;   https://storage.googleapis.com/kubernetes-release/release/v1.15.0/bin/linux/amd64/kube-proxy \</span><br><span class="line">&gt;   https://storage.googleapis.com/kubernetes-release/release/v1.15.0/bin/linux/amd64/kubelet</span><br><span class="line">[root@worker-2 ~]# sudo mkdir -p \</span><br><span class="line">&gt;   /opt/cni/bin \</span><br><span class="line">&gt;   /var/lib/kubelet \</span><br><span class="line">&gt;   /var/lib/kube-proxy \</span><br><span class="line">&gt;   /var/lib/kubernetes \</span><br><span class="line">&gt;   /var/run/kubernetes</span><br><span class="line">[root@worker-2 ~]# chmod +x kubectl kube-proxy kubelet</span><br><span class="line">[root@worker-2 ~]# sudo mv kubectl kube-proxy kubelet /usr/local/bin/</span><br><span class="line">[root@worker-2 ~]# sudo cp worker-2-key.pem worker-2.pem /var/lib/kubelet/</span><br><span class="line">[root@worker-2 ~]# sudo cp worker-2.kubeconfig /var/lib/kubelet/kubeconfig</span><br><span class="line">[root@worker-2 ~]# sudo cp ca.pem /var/lib/kubernetes/</span><br><span class="line">[root@worker-2 ~]# sudo tar -xvf cni-plugins-amd64-v0.6.0.tgz -C /opt/cni/bin/</span><br><span class="line">[root@worker-2 ~]# cat &lt;&lt;EOF | sudo tee /var/lib/kubelet/kubelet-config.yaml</span><br><span class="line">&gt; kind: KubeletConfiguration</span><br><span class="line">&gt; apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">&gt; authentication:</span><br><span class="line">&gt;   anonymous:</span><br><span class="line">&gt;     enabled: false</span><br><span class="line">&gt;   webhook:</span><br><span class="line">&gt;     enabled: true</span><br><span class="line">&gt;   x509:</span><br><span class="line">&gt;     clientCAFile: &quot;/var/lib/kubernetes/ca.pem&quot;</span><br><span class="line">&gt; authorization:</span><br><span class="line">&gt;   mode: Webhook</span><br><span class="line">&gt; clusterDomain: &quot;cluster.local&quot;</span><br><span class="line">&gt; clusterDNS:</span><br><span class="line">&gt;   - &quot;10.250.0.10&quot;</span><br><span class="line">&gt; runtimeRequestTimeout: &quot;15m&quot;</span><br><span class="line">&gt; tlsCertFile: &quot;/var/lib/kubelet/worker-2.pem&quot;</span><br><span class="line">&gt; tlsPrivateKeyFile: &quot;/var/lib/kubelet/worker-2-key.pem&quot;</span><br><span class="line">&gt; EOF</span><br><span class="line">[root@worker-2 ~]# cat &lt;&lt;EOF | sudo tee /etc/systemd/system/kubelet.service</span><br><span class="line">&gt; [Unit]</span><br><span class="line">&gt; Description=Kubernetes Kubelet</span><br><span class="line">&gt; Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">&gt; After=docker.service</span><br><span class="line">&gt; Requires=docker.service</span><br><span class="line">&gt;</span><br><span class="line">&gt; [Service]</span><br><span class="line">&gt; ExecStart=/usr/local/bin/kubelet \\</span><br><span class="line">&gt;   --config=/var/lib/kubelet/kubelet-config.yaml \\</span><br><span class="line">&gt;   --image-pull-progress-deadline=2m \\</span><br><span class="line">&gt;   --kubeconfig=/var/lib/kubelet/kubeconfig \\</span><br><span class="line">&gt;   --pod-infra-container-image=cargo.caicloud.io/caicloud/pause-amd64:3.1 \\</span><br><span class="line">&gt;   --network-plugin=cni \\</span><br><span class="line">&gt;   --register-node=true \\</span><br><span class="line">&gt;   --v=2</span><br><span class="line">&gt; Restart=on-failure</span><br><span class="line">&gt; RestartSec=5</span><br><span class="line">&gt;</span><br><span class="line">&gt; [Install]</span><br><span class="line">&gt; WantedBy=multi-user.target</span><br><span class="line">&gt; EOF</span><br><span class="line">[root@worker-2 ~]# sudo mv kube-proxy.kubeconfig /var/lib/kube-proxy/kubeconfig</span><br><span class="line">[root@worker-2 ~]# cat &lt;&lt;EOF | sudo tee /var/lib/kube-proxy/kube-proxy-config.yaml</span><br><span class="line">&gt; kind: KubeProxyConfiguration</span><br><span class="line">&gt; apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">&gt; clientConnection:</span><br><span class="line">&gt;   kubeconfig: &quot;/var/lib/kube-proxy/kubeconfig&quot;</span><br><span class="line">&gt; mode: &quot;iptables&quot;</span><br><span class="line">&gt; clusterCIDR: &quot;10.244.0.0/16&quot;</span><br><span class="line">&gt; EOF</span><br><span class="line">[root@worker-2 ~]# cat &lt;&lt;EOF | sudo tee /etc/systemd/system/kube-proxy.service</span><br><span class="line">&gt; [Unit]</span><br><span class="line">&gt; Description=Kubernetes Kube Proxy</span><br><span class="line">&gt; Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">&gt;</span><br><span class="line">&gt; [Service]</span><br><span class="line">&gt; ExecStart=/usr/local/bin/kube-proxy \\</span><br><span class="line">&gt;   --config=/var/lib/kube-proxy/kube-proxy-config.yaml</span><br><span class="line">&gt; Restart=on-failure</span><br><span class="line">&gt; RestartSec=5</span><br><span class="line">&gt;</span><br><span class="line">&gt; [Install]</span><br><span class="line">&gt; WantedBy=multi-user.target</span><br><span class="line">&gt; EOF</span><br><span class="line">[root@worker-2 ~]# sudo systemctl daemon-reload</span><br><span class="line">[root@worker-2 ~]# sudo systemctl enable kubelet kube-proxy</span><br><span class="line">[root@worker-2 ~]# sudo systemctl start kubelet kube-proxy</span><br><span class="line">[root@worker-2 ~]# export MASTER_IP=172.26.64.9</span><br><span class="line">[root@worker-2 ~]# kubectl config set-cluster kubernetes-training \</span><br><span class="line">&gt;   --certificate-authority=ca.pem \</span><br><span class="line">&gt;   --embed-certs=true \</span><br><span class="line">&gt;   --server=https://$&#123;MASTER_IP&#125;:6443</span><br><span class="line">[root@worker-2 ~]# kubectl config set-credentials admin \</span><br><span class="line">&gt;   --client-certificate=admin.pem \</span><br><span class="line">&gt;   --client-key=admin-key.pem</span><br><span class="line">[root@worker-2 ~]# kubectl config set-context kubernetes-training \</span><br><span class="line">&gt;   --cluster=kubernetes-training \</span><br><span class="line">&gt;   --user=admin</span><br><span class="line">[root@worker-2 ~]# kubectl config use-context kubernetes-training</span><br></pre></td></tr></table></figure>
<p>这样子就好了，接下来检查一下状态:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-2 ~]# kubectl get componentstatuses</span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">controller-manager   Healthy   ok                  </span><br><span class="line">scheduler            Healthy   ok                  </span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;</span><br></pre></td></tr></table></figure></p>
<p>查看状态:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-2 ~]# kubectl get nodes</span><br><span class="line">NAME       STATUS   ROLES    AGE     VERSION</span><br><span class="line">worker-1   Ready    &lt;none&gt;   22h     v1.15.0</span><br><span class="line">worker-2   Ready    &lt;none&gt;   2m25s   v1.15.0</span><br></pre></td></tr></table></figure></p>
<p>到这边，第二个 node 集群就成功了。 我们知道一旦集群加入成功了，那么当前集群的服务，应该也都是能用的， 所以直接用他的 ip 来请求 nginx 的服务，看一下之前部署的服务是否也在 worker-2 生效：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@worker-2 ~]# curl -I http://172.26.64.10:31091</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.19.3</span><br><span class="line">Date: Fri, 30 Oct 2020 08:57:15 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 612</span><br><span class="line">Last-Modified: Tue, 29 Sep 2020 14:12:31 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;5f7340cf-264&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure></p>
<p>可以看到已经成功了， 说明第二个集群节点也是可以的。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这样子 kubernetes 的二进制包的集群环境安装就结束了。 篇幅不短， 事实上，我就算按照教程将其用二进制包的方式来安装集群环境，但是很多细节和操作仍然是一知半解啊， 只能继续学习了， 任重而道远啊，一起加油 XD</p>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    Zach Ke
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://kebingzao.com/2020/11/09/k8s-install-binary/" title="CentOS7 使用二进制包安装 kubernetes 集群环境">http://kebingzao.com/2020/11/09/k8s-install-binary/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/kubernetes/" rel="tag"># kubernetes</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/11/06/k8s-install-kubeadm/" rel="next" title="CentOS7 手动安装 Kubeadm 集群环境">
                <i class="fa fa-chevron-left"></i> CentOS7 手动安装 Kubeadm 集群环境
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/12/07/github-site-17/" rel="prev" title="github建站系列(17) -- 为你的 blog 添加google adsence 广告">
                github建站系列(17) -- 为你的 blog 添加google adsence 广告 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="Zach Ke" />
            
              <p class="site-author-name" itemprop="name">Zach Ke</p>
              <p class="site-description motion-element" itemprop="description">做最咸的那一条</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">313</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">30</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">81</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/kebingzao" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#机器准备"><span class="nav-number">2.</span> <span class="nav-text">机器准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#每一台的环境都要先配置"><span class="nav-number">3.</span> <span class="nav-text">每一台的环境都要先配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-关闭防火墙-开放端口"><span class="nav-number">3.1.</span> <span class="nav-text">1. 关闭防火墙 / 开放端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-禁用SELinux"><span class="nav-number">3.2.</span> <span class="nav-text">2. 禁用SELinux</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-关闭Swap"><span class="nav-number">3.3.</span> <span class="nav-text">3. 关闭Swap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-CentOS-7-用户还需要执行："><span class="nav-number">3.4.</span> <span class="nav-text">4. CentOS 7 用户还需要执行：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-etc-hosts-文件增加"><span class="nav-number">3.5.</span> <span class="nav-text">5. /etc/hosts 文件增加</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-安装必要工具"><span class="nav-number">4.</span> <span class="nav-text">1. 安装必要工具</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-安装-cfssl"><span class="nav-number">4.1.</span> <span class="nav-text">1.1 安装 cfssl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-安装-kubectl"><span class="nav-number">4.2.</span> <span class="nav-text">1.2 安装 kubectl</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-配置-CA-并创建-TLS-证书"><span class="nav-number">5.</span> <span class="nav-text">2. 配置 CA 并创建 TLS 证书</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-Certificate-Authority"><span class="nav-number">5.1.</span> <span class="nav-text">2.1 Certificate Authority</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-1-新建-CA-配置文件"><span class="nav-number">5.1.1.</span> <span class="nav-text">2.1.1 新建 CA 配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-2-新建-CA-凭证签发请求文件"><span class="nav-number">5.1.2.</span> <span class="nav-text">2.1.2 新建 CA 凭证签发请求文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-3-生成-CA-凭证和私钥"><span class="nav-number">5.1.3.</span> <span class="nav-text">2.1.3 生成 CA 凭证和私钥</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-client-与-server-凭证"><span class="nav-number">5.2.</span> <span class="nav-text">2.2 client 与 server 凭证</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-1-Admin-客户端凭证"><span class="nav-number">5.2.1.</span> <span class="nav-text">2.2.1 Admin 客户端凭证</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-2-Kubelet-客户端凭证"><span class="nav-number">5.2.2.</span> <span class="nav-text">2.2.2 Kubelet 客户端凭证</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-2-1-为-worker-1-节点创建凭证和私钥"><span class="nav-number">5.2.2.1.</span> <span class="nav-text">2.2.2.1 为 worker-1 节点创建凭证和私钥</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-2-2-为-worker-2-节点创建凭证和私钥"><span class="nav-number">5.2.2.2.</span> <span class="nav-text">2.2.2.2 为 worker-2 节点创建凭证和私钥</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-3-Kube-controller-manager-客户端凭证"><span class="nav-number">5.2.3.</span> <span class="nav-text">2.2.3 Kube-controller-manager 客户端凭证</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-4-Kube-proxy-客户端凭证"><span class="nav-number">5.2.4.</span> <span class="nav-text">2.2.4 Kube-proxy 客户端凭证</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-5-kube-scheduler-证书"><span class="nav-number">5.2.5.</span> <span class="nav-text">2.2.5 kube-scheduler 证书</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-6-Kubernetes-API-Server-证书"><span class="nav-number">5.2.6.</span> <span class="nav-text">2.2.6 Kubernetes API Server 证书</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-6-1-创建-Kubernetes-API-Server-凭证签发请求文件"><span class="nav-number">5.2.6.1.</span> <span class="nav-text">2.2.6.1 创建 Kubernetes API Server 凭证签发请求文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-6-2-创建-Kubernetes-API-Server-凭证与私钥"><span class="nav-number">5.2.6.2.</span> <span class="nav-text">2.2.6.2 创建 Kubernetes API Server 凭证与私钥</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-7-Service-Account-证书"><span class="nav-number">5.2.7.</span> <span class="nav-text">2.2.7 Service Account 证书</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-分发客户端和服务器证书"><span class="nav-number">5.3.</span> <span class="nav-text">2.3 分发客户端和服务器证书</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-配置和生成-Kubernetes-配置文件"><span class="nav-number">6.</span> <span class="nav-text">3. 配置和生成 Kubernetes 配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-kubelet-配置文件"><span class="nav-number">6.1.</span> <span class="nav-text">3.1 kubelet 配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-1-worker-1"><span class="nav-number">6.1.1.</span> <span class="nav-text">3.1.1 worker-1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-1-worker-2"><span class="nav-number">6.1.2.</span> <span class="nav-text">3.1.1 worker-2</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-kube-proxy-配置文件"><span class="nav-number">6.2.</span> <span class="nav-text">3.2 kube-proxy 配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-kube-controller-manager-配置文件"><span class="nav-number">6.3.</span> <span class="nav-text">3.3 kube-controller-manager 配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-kube-scheduler-配置文件"><span class="nav-number">6.4.</span> <span class="nav-text">3.4 kube-scheduler 配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-Admin-配置文件"><span class="nav-number">6.5.</span> <span class="nav-text">3.5 Admin 配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-分发配置文件"><span class="nav-number">6.6.</span> <span class="nav-text">3.6 分发配置文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-配置和生成密钥"><span class="nav-number">7.</span> <span class="nav-text">4. 配置和生成密钥</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-建立加密密钥"><span class="nav-number">7.1.</span> <span class="nav-text">4.1 建立加密密钥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-加密配置文件"><span class="nav-number">7.2.</span> <span class="nav-text">4.2 加密配置文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-部署-etcd-群集"><span class="nav-number">8.</span> <span class="nav-text">5. 部署 etcd 群集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-下载并安装-etcd-二进制文件"><span class="nav-number">8.1.</span> <span class="nav-text">5.1 下载并安装 etcd 二进制文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-配置-etcd-Server"><span class="nav-number">8.2.</span> <span class="nav-text">5.2 配置 etcd Server</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-启动-etcd-Server"><span class="nav-number">8.3.</span> <span class="nav-text">5.3 启动 etcd Server</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-验证是否正常"><span class="nav-number">8.4.</span> <span class="nav-text">5.4 验证是否正常</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-部署-Kubernetes-控制节点"><span class="nav-number">9.</span> <span class="nav-text">6. 部署 Kubernetes 控制节点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-创建-Kubernetes-配置目录"><span class="nav-number">9.1.</span> <span class="nav-text">6.1 创建 Kubernetes 配置目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-下载并安装-Kubernetes-Controller-二进制文件"><span class="nav-number">9.2.</span> <span class="nav-text">6.2 下载并安装 Kubernetes Controller 二进制文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-配置-Kubernetes-API-Server"><span class="nav-number">9.3.</span> <span class="nav-text">6.3 配置 Kubernetes API Server</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-4-配置-Kubernetes-Controller-Manager"><span class="nav-number">9.4.</span> <span class="nav-text">6.4 配置 Kubernetes Controller Manager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-5-配置-Kubernetes-Scheduler"><span class="nav-number">9.5.</span> <span class="nav-text">6.5 配置 Kubernetes Scheduler</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-6-启动控制器服务"><span class="nav-number">9.6.</span> <span class="nav-text">6.6 启动控制器服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-Kubelet-RBAC-授权"><span class="nav-number">10.</span> <span class="nav-text">7. Kubelet RBAC 授权</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-部署-Kubernetes-Workers-节点"><span class="nav-number">11.</span> <span class="nav-text">8. 部署 Kubernetes Workers 节点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-安装依赖"><span class="nav-number">11.1.</span> <span class="nav-text">8.1 安装依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-配置-Kubelet"><span class="nav-number">11.2.</span> <span class="nav-text">8.2 配置 Kubelet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-配置-Kube-Proxy"><span class="nav-number">11.3.</span> <span class="nav-text">8.3 配置 Kube-Proxy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-4-启动-worker-服务"><span class="nav-number">11.4.</span> <span class="nav-text">8.4 启动 worker 服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-配置-Kubectl"><span class="nav-number">12.</span> <span class="nav-text">9. 配置 Kubectl</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-1-admin-kubeconfig"><span class="nav-number">13.</span> <span class="nav-text">9.1 admin kubeconfig</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-配置-Pod-网络路由"><span class="nav-number">14.</span> <span class="nav-text">10. 配置 Pod 网络路由</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-部署-DNS-扩展"><span class="nav-number">15.</span> <span class="nav-text">11. 部署 DNS 扩展</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-烟雾测试"><span class="nav-number">16.</span> <span class="nav-text">12. 烟雾测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#12-1-数据加密"><span class="nav-number">16.1.</span> <span class="nav-text">12.1 数据加密</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-2-部署"><span class="nav-number">16.2.</span> <span class="nav-text">12.2 部署</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-3-测试端口转发"><span class="nav-number">16.3.</span> <span class="nav-text">12.3 测试端口转发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-4-查看容器日志"><span class="nav-number">16.4.</span> <span class="nav-text">12.4 查看容器日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-5-执行容器命令"><span class="nav-number">16.5.</span> <span class="nav-text">12.5 执行容器命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-6-验证服务"><span class="nav-number">16.6.</span> <span class="nav-text">12.6 验证服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#13-将-worker-2-也加入到集群"><span class="nav-number">17.</span> <span class="nav-text">13. 将 worker-2 也加入到集群</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">18.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zach Ke</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://zach-2.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://kebingzao.com/2020/11/09/k8s-install-binary/';
          this.page.identifier = '2020/11/09/k8s-install-binary/';
          this.page.title = 'CentOS7 使用二进制包安装 kubernetes 集群环境';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://zach-2.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  














  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.4"></script>



  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("HIV4XRdKJXB0eaFgtSjiVNaK-gzGzoHsz", "zN3v8grxW0Q8eXwNlEgXxWrF");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  



</body>
</html>
