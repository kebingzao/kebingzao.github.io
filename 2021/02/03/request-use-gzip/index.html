<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <script src="/live2d-widget/live2d-widget-resource/jquery.min.js"></script>
  <link rel="stylesheet" href="/live2d-widget/live2d-widget-resource/font-awesome.min.css"/>
  <script src="/live2d-widget/autoload.js"></script>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<script data-ad-client="ca-pub-9657591565519636" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="nginx," />










<meta name="description" content="前言我们知道一般无论是 CDN 还是 服务端的接口(nginx 配置gzip以优化站点资源加载速度)，在响应返回的时候，都会配置 gzip 来压缩响应数据，以达到减少体积，加快网络传输的效能。 但是 gzip 压缩只用于 response 的响应数据，一般来说针对 pc 端的站点来说，足够了。 但是有时候针对手机 app 来说，光是 response 用 gzip 压缩还不够， 因为 reques">
<meta name="keywords" content="nginx">
<meta property="og:type" content="article">
<meta property="og:title" content="http 请求的时候使用 gzip 压缩来减少流量消耗">
<meta property="og:url" content="http://kebingzao.com/2021/02/03/request-use-gzip/index.html">
<meta property="og:site_name" content="Zach Ke&#39;s Notes">
<meta property="og:description" content="前言我们知道一般无论是 CDN 还是 服务端的接口(nginx 配置gzip以优化站点资源加载速度)，在响应返回的时候，都会配置 gzip 来压缩响应数据，以达到减少体积，加快网络传输的效能。 但是 gzip 压缩只用于 response 的响应数据，一般来说针对 pc 端的站点来说，足够了。 但是有时候针对手机 app 来说，光是 response 用 gzip 压缩还不够， 因为 reques">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2021-02-03T16:28:47.795Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="http 请求的时候使用 gzip 压缩来减少流量消耗">
<meta name="twitter:description" content="前言我们知道一般无论是 CDN 还是 服务端的接口(nginx 配置gzip以优化站点资源加载速度)，在响应返回的时候，都会配置 gzip 来压缩响应数据，以达到减少体积，加快网络传输的效能。 但是 gzip 压缩只用于 response 的响应数据，一般来说针对 pc 端的站点来说，足够了。 但是有时候针对手机 app 来说，光是 response 用 gzip 压缩还不够， 因为 reques">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'KGVI6VPIBI',
      apiKey: '41c2ccc830ca183768a6bf1e50a03f44',
      indexName: 'test_blog',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://kebingzao.com/2021/02/03/request-use-gzip/"/>





  <title>http 请求的时候使用 gzip 压缩来减少流量消耗 | Zach Ke's Notes</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <a href="https://github.com/kebingzao" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Zach Ke's Notes</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Quick notes</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kebingzao.com/2021/02/03/request-use-gzip/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zach Ke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zach Ke's Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">http 请求的时候使用 gzip 压缩来减少流量消耗</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-02-03T11:57:39+08:00">
                2021-02-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/nginx相关/" itemprop="url" rel="index">
                    <span itemprop="name">nginx相关</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/02/03/request-use-gzip/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2021/02/03/request-use-gzip/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2021/02/03/request-use-gzip/" class="leancloud_visitors" data-flag-title="http 请求的时候使用 gzip 压缩来减少流量消耗">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>我们知道一般无论是 CDN 还是 服务端的接口(<a href="/2018/06/10/nginx-gzip/" title="nginx 配置gzip以优化站点资源加载速度">nginx 配置gzip以优化站点资源加载速度</a>)，在响应返回的时候，都会配置 gzip 来压缩响应数据，以达到减少体积，加快网络传输的效能。 但是 gzip 压缩只用于 response 的响应数据，一般来说针对 pc 端的站点来说，足够了。</p>
<p>但是有时候针对手机 app 来说，光是 response 用 gzip 压缩还不够， 因为 request 请求的时候，如果有时候 body 体带上很多数据的话，还是会导致体积很大，从而消耗流量。 手机的流量可比 pc 的流量贵多了。 因此对于有些比较注重流量消耗的 app 来说，最好也要做到 request 请求的时候，也用上 gzip 来压缩数据，然后服务端在 nginx 或者程序的网关那边，再根据请求头 <code>Content-Encoding</code> 是否为 <code>gzip</code> 来判断是否要对请求的数据进行 gzip 解压缩。</p>
<a id="more"></a>
<h2 id="实操"><a href="#实操" class="headerlink" title="实操"></a>实操</h2><p>接下来我将通过用 golang 语言来模拟客户端的请求和服务端的响应是否要带上 gzip 头部，来模拟这一过程，代码很简单，而且已经极简了，客户端代码就是 <code>client.go</code>, 服务端代码就是 <code>server.go</code>， 不需要用到第三方库。 (我的 golang 环境是 <code>1.13.8</code>)</p>
<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><p><code>client.go</code>:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"bytes"</span></span><br><span class="line">	<span class="string">"compress/gzip"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"io/ioutil"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"flag"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> requestUseGzip = flag.String(<span class="string">"req_use_gzip"</span>, <span class="string">"1"</span>, <span class="string">"has request body use gzip"</span>)</span><br><span class="line">	<span class="keyword">var</span> responseUseGzip = flag.String(<span class="string">"resp_use_gzip"</span>, <span class="string">"1"</span>, <span class="string">"has response body use gzip"</span>)</span><br><span class="line">	flag.Parse()</span><br><span class="line">	<span class="keyword">var</span> requestBodyStr = <span class="string">`&#123;"name":"zach ke","des":"woooooo boy", "response_use_gzip": "%s"&#125;`</span></span><br><span class="line">	data := []<span class="keyword">byte</span>(fmt.Sprintf(requestBodyStr, *responseUseGzip))</span><br><span class="line">	<span class="keyword">var</span> httpRequest *http.Request</span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line">	<span class="keyword">if</span> *requestUseGzip == <span class="string">"1"</span>&#123;</span><br><span class="line">		fmt.Println(<span class="string">"request with gzip"</span>)</span><br><span class="line">		<span class="keyword">var</span> zBuf bytes.Buffer</span><br><span class="line">		zw := gzip.NewWriter(&amp;zBuf)</span><br><span class="line">		<span class="keyword">if</span> _, err := zw.Write(data); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(<span class="string">"gzip is faild,err:"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		zw.Close()</span><br><span class="line">		httpRequest, err = http.NewRequest(<span class="string">"POST"</span>, <span class="string">"http://localhost:9905/request"</span>, &amp;zBuf)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(<span class="string">"http request is failed, err: "</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		httpRequest.Header.Set(<span class="string">"Content-Encoding"</span>, <span class="string">"gzip"</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">"request without gzip"</span>)</span><br><span class="line">		reader := bytes.NewReader(data)</span><br><span class="line">		httpRequest, err = http.NewRequest(<span class="string">"POST"</span>, <span class="string">"http://localhost:9905/request"</span>, reader)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(<span class="string">"http request is failed, err: "</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 通过参数判断是否返回值要用 gzip 压缩</span></span><br><span class="line">	<span class="keyword">if</span> *responseUseGzip == <span class="string">"1"</span> &#123;</span><br><span class="line">		httpRequest.Header.Set(<span class="string">"Accept-Encoding"</span>, <span class="string">"gzip"</span>)</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="comment">// 这个也要指定，不然 response 那边获取 content-length 头部会取不到值</span></span><br><span class="line">		httpRequest.Header.Set(<span class="string">"Accept-Encoding"</span>, <span class="string">"deflate"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	client := &amp;http.Client&#123;&#125;</span><br><span class="line">	httpResponse, err := client.Do(httpRequest)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">"httpResponse is failed, err: "</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> httpResponse.Body.Close()</span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">"respone content length="</span>, httpResponse.ContentLength)</span><br><span class="line">	<span class="keyword">if</span> httpResponse.StatusCode == <span class="number">200</span> &#123;</span><br><span class="line">		<span class="keyword">var</span> respBody <span class="keyword">string</span></span><br><span class="line">		<span class="keyword">switch</span> httpResponse.Header.Get(<span class="string">"Content-Encoding"</span>) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">"gzip"</span>:</span><br><span class="line">			fmt.Println(<span class="string">"response with gzip"</span>)</span><br><span class="line">			reader, err := gzip.NewReader(httpResponse.Body)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				fmt.Println(<span class="string">"gzip get reader err "</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line">			data, err = ioutil.ReadAll(reader)</span><br><span class="line">			respBody = <span class="keyword">string</span>(data)</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			fmt.Println(<span class="string">"response without gzip"</span>)</span><br><span class="line">			bodyByte, _ := ioutil.ReadAll(httpResponse.Body)</span><br><span class="line">			respBody = <span class="keyword">string</span>(bodyByte)</span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Println(<span class="string">"resp data="</span>, respBody)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，我这边通过 flag 来控制本次请求中， request 是否要 gzip 压缩，要求 response 是否也要 gzip 压缩返回。 所以总共有以下四种可能:</p>
<ol>
<li>request gzip 压缩， response gzip 压缩</li>
<li>request gzip 压缩， response 不 压缩</li>
<li>request 不 压缩， response gzip 压缩</li>
<li>request 不 压缩， response 不 压缩</li>
</ol>
<h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><p><code>server.go</code>:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"compress/gzip"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"io/ioutil"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"bytes"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handler</span><span class="params">(resp http.ResponseWriter, req *http.Request)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> bodyDataStr <span class="keyword">string</span></span><br><span class="line">	<span class="comment">// 是否需要解 gzip 压缩</span></span><br><span class="line">	fmt.Println(<span class="string">"resquest content length="</span>, req.ContentLength)</span><br><span class="line">	<span class="keyword">if</span> req.Header.Get(<span class="string">"Content-Encoding"</span>) == <span class="string">"gzip"</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">"request with gzip"</span>)</span><br><span class="line">		body, err := gzip.NewReader(req.Body)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(<span class="string">"unzip is failed, err:"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">defer</span> body.Close()</span><br><span class="line">		data, err := ioutil.ReadAll(body)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(<span class="string">"read all is failed.err:"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		bodyDataStr = <span class="keyword">string</span>(data)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">"request without gzip"</span>)</span><br><span class="line">		data, err := ioutil.ReadAll(req.Body)</span><br><span class="line">		<span class="keyword">defer</span> req.Body.Close()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(<span class="string">"read resp is failed, err: "</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		bodyDataStr = <span class="keyword">string</span>(data)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">"request json string="</span>, bodyDataStr)</span><br><span class="line"></span><br><span class="line">	respJson := []<span class="keyword">byte</span>(<span class="string">`&#123;code: "1",msg: "success"&#125;`</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 通过头部的 Accept-Encoding 判断返回值是否要用 gzip 压缩</span></span><br><span class="line">	<span class="keyword">if</span> req.Header.Get(<span class="string">"Accept-Encoding"</span>) == <span class="string">"gzip"</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">"response with gzip"</span>)</span><br><span class="line">		<span class="comment">// 添加 gzip 头部</span></span><br><span class="line">		resp.Header().Set(<span class="string">"Content-Encoding"</span>, <span class="string">"gzip"</span>)</span><br><span class="line">		<span class="keyword">var</span> zBuf bytes.Buffer</span><br><span class="line">		zw := gzip.NewWriter(&amp;zBuf)</span><br><span class="line">		<span class="keyword">if</span> _, err := zw.Write(respJson); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			zw.Close()</span><br><span class="line">			fmt.Println(<span class="string">"gzip is faild,err:"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		zw.Close()</span><br><span class="line">		<span class="comment">//fmt.Println("gzip content:", string(zBuf.Bytes()))</span></span><br><span class="line">		resp.Write(zBuf.Bytes())</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		fmt.Println(<span class="string">"response without gzip"</span>)</span><br><span class="line">		<span class="comment">// 正常不压缩 返回</span></span><br><span class="line">		resp.Write(respJson)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">"http://localhost:9905/request"</span>)</span><br><span class="line">	http.HandleFunc(<span class="string">"/request"</span>, handler)</span><br><span class="line">	http.ListenAndServe(<span class="string">":9905"</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="运行起来"><a href="#运行起来" class="headerlink" title="运行起来"></a>运行起来</h3><p>首先先运行服务端:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> run server.<span class="keyword">go</span></span><br></pre></td></tr></table></figure></p>
<p>接下来针对以上 4 种情况，分别运行 客户端 程序，然后查看一下服务端的输出</p>
<h4 id="1-都压缩"><a href="#1-都压缩" class="headerlink" title="1. 都压缩"></a>1. 都压缩</h4><p>客户端指令:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~ &gt;go run client.go</span><br><span class="line">request with gzip</span><br><span class="line">respone content length= 50</span><br><span class="line">response with gzip</span><br><span class="line">resp data= &#123;code: &quot;1&quot;,msg: &quot;success&quot;&#125;</span><br></pre></td></tr></table></figure></p>
<p>服务端输出:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">resquest content length= 85</span><br><span class="line">request with gzip</span><br><span class="line">request json string= &#123;&quot;name&quot;:&quot;zach ke&quot;,&quot;des&quot;:&quot;woooooo boy&quot;, &quot;response_use_gzip&quot;: &quot;1&quot;&#125;</span><br><span class="line">response with gzip</span><br></pre></td></tr></table></figure></p>
<h4 id="2-request-压缩，-response-不压缩"><a href="#2-request-压缩，-response-不压缩" class="headerlink" title="2. request 压缩， response 不压缩"></a>2. request 压缩， response 不压缩</h4><p>客户端指令:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~ &gt;go run client.go -resp_use_gzip=0 -req_use_gzip=1</span><br><span class="line">request with gzip</span><br><span class="line">respone content length= 26</span><br><span class="line">response without gzip</span><br><span class="line">resp data= &#123;code: &quot;1&quot;,msg: &quot;success&quot;&#125;</span><br></pre></td></tr></table></figure></p>
<p>服务端输出:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">resquest content length= 85</span><br><span class="line">request with gzip</span><br><span class="line">request json string= &#123;&quot;name&quot;:&quot;zach ke&quot;,&quot;des&quot;:&quot;woooooo boy&quot;, &quot;response_use_gzip&quot;: &quot;0&quot;&#125;</span><br><span class="line">response without gzip</span><br></pre></td></tr></table></figure></p>
<h4 id="3-request-不压缩，-response-压缩"><a href="#3-request-不压缩，-response-压缩" class="headerlink" title="3. request 不压缩， response 压缩"></a>3. request 不压缩， response 压缩</h4><p>客户端指令:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~ &gt;go run client.go -resp_use_gzip=1 -req_use_gzip=0</span><br><span class="line">request without gzip</span><br><span class="line">respone content length= 50</span><br><span class="line">response with gzip</span><br><span class="line">resp data= &#123;code: &quot;1&quot;,msg: &quot;success&quot;&#125;</span><br></pre></td></tr></table></figure></p>
<p>服务端输出:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">resquest content length= 64</span><br><span class="line">request without gzip</span><br><span class="line">request json string= &#123;&quot;name&quot;:&quot;zach ke&quot;,&quot;des&quot;:&quot;woooooo boy&quot;, &quot;response_use_gzip&quot;: &quot;1&quot;&#125;</span><br><span class="line">response with gzip</span><br></pre></td></tr></table></figure></p>
<h4 id="4-都不压缩"><a href="#4-都不压缩" class="headerlink" title="4. 都不压缩"></a>4. 都不压缩</h4><p>客户端指令:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~ &gt;go run client.go -resp_use_gzip=0 -req_use_gzip=0</span><br><span class="line">request without gzip</span><br><span class="line">respone content length= 26</span><br><span class="line">response without gzip</span><br><span class="line">resp data= &#123;code: &quot;1&quot;,msg: &quot;success&quot;&#125;</span><br></pre></td></tr></table></figure></p>
<p>服务端输出:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">resquest content length= 64</span><br><span class="line">request without gzip</span><br><span class="line">request json string= &#123;&quot;name&quot;:&quot;zach ke&quot;,&quot;des&quot;:&quot;woooooo boy&quot;, &quot;response_use_gzip&quot;: &quot;0&quot;&#125;</span><br><span class="line">response without gzip</span><br></pre></td></tr></table></figure></p>
<p>其实判断是否要用 gzip 压缩很简单，通过 request 或者 response 的头部设置即可:</p>
<ol>
<li>如果自身设置 <code>Content-Encoding</code> 为 <code>gzip</code>, 说明你的数据是 gzip 压缩过的， 对方要进行 gzip 解压才行</li>
<li>如果你希望对方给你的数据是 gzip 压缩过的，那么就设置头部 <code>Accept-Encoding</code> 为 <code>gzip</code></li>
</ol>
<h2 id="gzip-压缩后体积更大的情况"><a href="#gzip-压缩后体积更大的情况" class="headerlink" title="gzip 压缩后体积更大的情况"></a>gzip 压缩后体积更大的情况</h2><p>不知道以上有一种情况，你们有没有发现过，就是无论是 request 还是 response 的数据， gzip 压缩过后的字节体积比原先更多了，反而是不压缩的字节体积更小，为了更直观，我列个表格:</p>
<table>
<thead>
<tr>
<th>-</th>
<th>请求 body 字节</th>
<th>响应 body 字节</th>
</tr>
</thead>
<tbody>
<tr>
<td>都压缩</td>
<td>85</td>
<td>50</td>
</tr>
<tr>
<td>只压缩 request</td>
<td>85</td>
<td>26</td>
</tr>
<tr>
<td>只压缩 response</td>
<td>64</td>
<td>50</td>
</tr>
<tr>
<td>都不压缩</td>
<td>64</td>
<td>26</td>
</tr>
</tbody>
</table>
<p>其实这样子是对的，事实上 gzip 压缩的时候，在原数据比较小的时候，反而压缩后的体积会更大， 这也是为啥 nginx 要有一个 <code>gzip_min_length</code> 参数来控制压缩的最小字节数，一般我们是设置为 1k (默认值是 20)， 具体可以看 <a href="/2021/01/26/gzip-min-length/" title="gzip 配置 gzip_min_length 来判断 response 是否要 gzip 压缩">gzip 配置 gzip_min_length 来判断 response 是否要 gzip 压缩</a></p>
<p>接下来我们将 请求的 body 和 响应的 body 都调大一点<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">respJson := []byte(`&#123;code: &quot;1&quot;,msg: &quot;success&quot;, des: &quot;12asdfsafsafsagaegewgsdfsdfsdfsdfgghhhhhhhhhhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrrrrrwgsdfsdfsdfsdfgghhhhhhhhhhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrwgsdfsdfsdfsdfgghhhhhhhhhhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr&quot;&#125;`)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var requestBodyStr = `&#123;&quot;name&quot;:&quot;zach ke&quot;,&quot;des&quot;:&quot;woooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boy&quot;, &quot;response_use_gzip&quot;: &quot;%s&quot;&#125;`</span><br></pre></td></tr></table></figure>
<p>可以看到 都压缩后的体积是:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">request with gzip</span><br><span class="line">respone content length= 111</span><br><span class="line">response with gzip</span><br><span class="line">resp data= &#123;code: &quot;1&quot;,msg: &quot;success&quot;, des: &quot;12asdfsafsafsagaegewgsdfsdfsdfsdfgghhhhhhhhhhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrrrrrwgsdfsdfsdfsdfgghhhhhhhhhhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrwgsdfsdfsdfsdfgghhhhhhhh</span><br><span class="line">hhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr&quot;&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">resquest content length= 89</span><br><span class="line">request with gzip</span><br><span class="line">request json string= &#123;&quot;name&quot;:&quot;zach ke&quot;,&quot;des&quot;:&quot;woooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo</span><br><span class="line"> boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boy&quot;, &quot;response_use_gzip&quot;: &quot;1&quot;&#125;</span><br><span class="line">response with gzip</span><br></pre></td></tr></table></figure>
<p>分别是请求体积是 89， 响应体积 111。 </p>
<p>而如果是没有压缩的，那么就是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">request without gzip</span><br><span class="line">respone content length= 343</span><br><span class="line">response without gzip</span><br><span class="line">resp data= &#123;code: &quot;1&quot;,msg: &quot;success&quot;, des: &quot;12asdfsafsafsagaegewgsdfsdfsdfsdfgghhhhhhhhhhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrrrrrwgsdfsdfsdfsdfgghhhhhhhhhhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrwgsdfsdfsdfsdfgghhhhhhhh</span><br><span class="line">hhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr&quot;&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">resquest content length= 383</span><br><span class="line">request without gzip</span><br><span class="line">request json string= &#123;&quot;name&quot;:&quot;zach ke&quot;,&quot;des&quot;:&quot;woooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo</span><br><span class="line"> boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boy&quot;, &quot;response_use_gzip&quot;: &quot;0&quot;&#125;</span><br><span class="line">response without gzip</span><br></pre></td></tr></table></figure>
<p>分别是请求体积是 383， 响应体积 343。  可以看到这个压缩率就不错了。 </p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>基本上数据量越多的话， 用 gzip 能省的流量越多，而且还能够加快网络传输，何乐而不为。 (事实上，还可以设置压缩比例和压缩算法，我这边为了演示，只使用默认的配置)</p>
<p>不过request 请求的话，如果用 gzip 的话，会影响性能的，数据量越大的话， 压缩和解压所消耗的时间也会越长，所以一般 pc 端的站点也不需要， 只有一些对流量消耗比较敏感的 app 可以考虑用这种方式。</p>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    Zach Ke
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://kebingzao.com/2021/02/03/request-use-gzip/" title="http 请求的时候使用 gzip 压缩来减少流量消耗">http://kebingzao.com/2021/02/03/request-use-gzip/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/nginx/" rel="tag"># nginx</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/01/26/gzip-min-length/" rel="next" title="gzip 配置 gzip_min_length 来判断 response 是否要 gzip 压缩">
                <i class="fa fa-chevron-left"></i> gzip 配置 gzip_min_length 来判断 response 是否要 gzip 压缩
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/02/22/cookie-samesite/" rel="prev" title="chrome 默认 cookie 的 SameSite=Lax，导致 http 模式的站点的第三方 cookie 无法进行跨域传输">
                chrome 默认 cookie 的 SameSite=Lax，导致 http 模式的站点的第三方 cookie 无法进行跨域传输 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="Zach Ke" />
            
              <p class="site-author-name" itemprop="name">Zach Ke</p>
              <p class="site-description motion-element" itemprop="description">做最咸的那一条</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">246</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">27</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">57</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/kebingzao" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实操"><span class="nav-number">2.</span> <span class="nav-text">实操</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#客户端"><span class="nav-number">2.1.</span> <span class="nav-text">客户端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务端"><span class="nav-number">2.2.</span> <span class="nav-text">服务端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#运行起来"><span class="nav-number">2.3.</span> <span class="nav-text">运行起来</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-都压缩"><span class="nav-number">2.3.1.</span> <span class="nav-text">1. 都压缩</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-request-压缩，-response-不压缩"><span class="nav-number">2.3.2.</span> <span class="nav-text">2. request 压缩， response 不压缩</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-request-不压缩，-response-压缩"><span class="nav-number">2.3.3.</span> <span class="nav-text">3. request 不压缩， response 压缩</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-都不压缩"><span class="nav-number">2.3.4.</span> <span class="nav-text">4. 都不压缩</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gzip-压缩后体积更大的情况"><span class="nav-number">3.</span> <span class="nav-text">gzip 压缩后体积更大的情况</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zach Ke</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://zach-2.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://kebingzao.com/2021/02/03/request-use-gzip/';
          this.page.identifier = '2021/02/03/request-use-gzip/';
          this.page.title = 'http 请求的时候使用 gzip 压缩来减少流量消耗';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://zach-2.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  














  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.4"></script>



  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("HIV4XRdKJXB0eaFgtSjiVNaK-gzGzoHsz", "zN3v8grxW0Q8eXwNlEgXxWrF");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  



</body>
</html>
