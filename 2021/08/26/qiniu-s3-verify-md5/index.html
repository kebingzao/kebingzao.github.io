<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <script src="/live2d-widget/live2d-widget-resource/jquery.min.js"></script>
  <link rel="stylesheet" href="/live2d-widget/live2d-widget-resource/font-awesome.min.css"/>
  <script src="/live2d-widget/autoload.js"></script>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />


















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="aws,s3,七牛," />










<meta name="description" content="前言我们的业务有上传服务，不管是我们自己的文件，还是用户生成的文件， 都会传到第三方的存储云服务中。 如果是国内用户，我们用的是七牛云服务， 如果是国外用户，我们用的是 aws 的 s3 存储服务。 如果是存放用户上传文件，一般我们建立的 bucket 就是私有桶。 正常情况下如果上传成功的话，一般文件都是完整的。 但是不排除网络丢包的情况， 那么我们怎么去保证我们上传的文件，一定是完整的呢。 最">
<meta name="keywords" content="aws,s3,七牛">
<meta property="og:type" content="article">
<meta property="og:title" content="在进行七牛或者S3文件上传的时候，怎么保证上传文件的完整性">
<meta property="og:url" content="http://kebingzao.com/2021/08/26/qiniu-s3-verify-md5/index.html">
<meta property="og:site_name" content="Zach Ke&#39;s Notes">
<meta property="og:description" content="前言我们的业务有上传服务，不管是我们自己的文件，还是用户生成的文件， 都会传到第三方的存储云服务中。 如果是国内用户，我们用的是七牛云服务， 如果是国外用户，我们用的是 aws 的 s3 存储服务。 如果是存放用户上传文件，一般我们建立的 bucket 就是私有桶。 正常情况下如果上传成功的话，一般文件都是完整的。 但是不排除网络丢包的情况， 那么我们怎么去保证我们上传的文件，一定是完整的呢。 最">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://kebingzao.com/2021/08/26/qiniu-s3-verify-md5/1.png">
<meta property="og:updated_time" content="2021-08-28T11:11:34.688Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="在进行七牛或者S3文件上传的时候，怎么保证上传文件的完整性">
<meta name="twitter:description" content="前言我们的业务有上传服务，不管是我们自己的文件，还是用户生成的文件， 都会传到第三方的存储云服务中。 如果是国内用户，我们用的是七牛云服务， 如果是国外用户，我们用的是 aws 的 s3 存储服务。 如果是存放用户上传文件，一般我们建立的 bucket 就是私有桶。 正常情况下如果上传成功的话，一般文件都是完整的。 但是不排除网络丢包的情况， 那么我们怎么去保证我们上传的文件，一定是完整的呢。 最">
<meta name="twitter:image" content="http://kebingzao.com/2021/08/26/qiniu-s3-verify-md5/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'KGVI6VPIBI',
      apiKey: '41c2ccc830ca183768a6bf1e50a03f44',
      indexName: 'test_blog',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://kebingzao.com/2021/08/26/qiniu-s3-verify-md5/"/>





  <title>在进行七牛或者S3文件上传的时候，怎么保证上传文件的完整性 | Zach Ke's Notes</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <a href="https://github.com/kebingzao" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Zach Ke's Notes</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Quick notes</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kebingzao.com/2021/08/26/qiniu-s3-verify-md5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zach Ke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zach Ke's Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">在进行七牛或者S3文件上传的时候，怎么保证上传文件的完整性</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-08-26T13:54:19+08:00">
                2021-08-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/golang相关/" itemprop="url" rel="index">
                    <span itemprop="name">golang相关</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/08/26/qiniu-s3-verify-md5/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2021/08/26/qiniu-s3-verify-md5/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2021/08/26/qiniu-s3-verify-md5/" class="leancloud_visitors" data-flag-title="在进行七牛或者S3文件上传的时候，怎么保证上传文件的完整性">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>我们的业务有上传服务，不管是我们自己的文件，还是用户生成的文件， 都会传到第三方的存储云服务中。 如果是国内用户，我们用的是七牛云服务， 如果是国外用户，我们用的是 aws 的 s3 存储服务。</p>
<p>如果是存放用户上传文件，一般我们建立的 bucket 就是私有桶。 正常情况下如果上传成功的话，一般文件都是完整的。 但是不排除网络丢包的情况， 那么我们怎么去保证我们上传的文件，一定是完整的呢。</p>
<p>最简单的方法，就是在上传到云服务之前，先把本地的文件进行 md5 计算，得到一个 md5 的 hash 值。 然后上传到云服务之后， 再去云服务请求这个文件的 md5 的值，两者对比，如果一致的话，那么文件就是完整的。<br><a id="more"></a></p>
<h2 id="获取本地文件的-md5-值"><a href="#获取本地文件的-md5-值" class="headerlink" title="获取本地文件的 md5 值"></a>获取本地文件的 md5 值</h2><p>这个就很简单了，各种语言都可以实现，就以 golang 为例，代码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">func GetPackageFileHash(filePath) (string, error) &#123;</span><br><span class="line">	fileBytes,err := ioutil.ReadFile(filePath)</span><br><span class="line">	if err != nil&#123;</span><br><span class="line">		return &quot;&quot;, err</span><br><span class="line">	&#125;</span><br><span class="line">	h := md5.New()</span><br><span class="line">	h.Write(fileBytes)</span><br><span class="line">	md5s = hex.EncodeToString(h.Sum(nil))</span><br><span class="line">	return md5s, nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样子就可以了。</p>
<h2 id="获取七牛的文件的-md5-值"><a href="#获取七牛的文件的-md5-值" class="headerlink" title="获取七牛的文件的 md5 值"></a>获取七牛的文件的 md5 值</h2><p>七牛也有接口可以获取已上传文件的 md5 值: <a href="https://developer.qiniu.com/dora/1297/file-hash-value-qhash" target="_blank" rel="noopener">文件HASH值（qhash）</a></p>
<blockquote>
<p>他这边有地区限制, 该功能目前支持华东、华南、华北、北美、东南亚区域的存储 bucket</p>
</blockquote>
<p>简单的来说，就是在原来的资源的连接 url 最后再补上 <code>?qhash/md5</code> 字串，这样子就会返回该文件的 md5 值了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http://dn-odum9helk.qbox.me/resource/gogopher.jpg?qhash/md5</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;hash&quot;: &quot;6085d57b5ee06ac7f793fa5f0f052cb5&quot;,</span><br><span class="line">    &quot;fsize&quot;: 214513</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>不过要注意的是，该方式仅适用于公开桶， 不适用于私有桶， 私有桶的文件的 md5 值的请求，就跟我们请求私有桶的下载连接一样，也要对整个请求进行签名才行。 只不过这时候的资源文件的名称就会由 <code>gogopher.jpg</code> 变成 <code>gogopher.jpg?qhash/md5</code>, 而本例就是用的私有桶，用的就是这种方式。</p>
<p><img src="/2021/08/26/qiniu-s3-verify-md5/1.png" alt=""></p>
<p>搞笑的是，关于私有桶怎么请求 md5 值，他的文档竟然都没有提到， 还是我提交工单给他们， 他们工程师才说的。</p>
<p>而且之前在处理这个事情的时候， 他们也有开放一个接口来获取资源的元信息: <a href="https://developer.qiniu.com/kodo/1308/stat" target="_blank" rel="noopener">资源元信息查询</a>, 上面文档返回值有 <code>md5</code>， 但是我用了他们的 golang 的 SDK 里面的方式， 发现响应返回的结构体， 只有一些必须返回的，比如 hash, fsize 等， 并没有 md5 值<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">type Entry struct &#123;</span><br><span class="line">	Hash     string `json:&quot;hash&quot;`</span><br><span class="line">	Fsize    int64  `json:&quot;fsize&quot;`</span><br><span class="line">	PutTime  int64  `json:&quot;putTime&quot;`</span><br><span class="line">	MimeType string `json:&quot;mimeType&quot;`</span><br><span class="line">	Customer string `json:&quot;customer&quot;`</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>也不知道是不是我使用方式不当，反正我请求下来， 是没有看到 md5 值。 所以就用了上面第一种方式来得到 md5 值。</p>
<h2 id="获取-S3-的文件的-md5-值"><a href="#获取-S3-的文件的-md5-值" class="headerlink" title="获取 S3 的文件的 md5 值"></a>获取 S3 的文件的 md5 值</h2><p>关于怎么保证 S3 上传文件的完整性的话，他们是有官方文档的: <a href="https://aws.amazon.com/cn/premiumsupport/knowledge-center/data-integrity-s3/" target="_blank" rel="noopener">如何检查已上载到 Amazon S3 的对象的完整性？</a>, 不过他们的处理方式是在上传的时候， 先计算文件的 md5 值，然后在上传的时候，将 <code>Content-MD5</code> 当做 header 头部带过去， 上传的时候， Amazon S3 根据提供的 Content-MD5 值检查对象。如果值不匹配，则会收到错误消息。</p>
<p>这个是在上传结算的时候， 由 s3 那边来判断是否完整。 其实是可以达到我们的需求的。 但是为了跟七牛的完整性校验保持一致。 还是采用了上传完成之后，再获取 md5 值进行匹配的方式来处理。</p>
<p>如果要获取资源的 md5 的话，S3 也有提供一个接口，可以获取这个资源的 etag: <a href="https://docs.aws.amazon.com/AmazonS3/latest/API/API_HeadObject.html" target="_blank" rel="noopener">HeadObject</a>, 正常情况下，这个 etag 就是这个文件的 md5 值。 但是在某些情况下， 他并不等于文件的 md5 值.</p>
<blockquote><p>实体标签表示对象的特定版本。 ETag 仅反映对象内容的更改，而不反映其元数据。 ETag 可能是也可能不是对象数据的 MD5 摘要。它是否取决于对象是如何创建的以及它是如何加密的，如下所述：</p>
<p>通过 AWS 管理控制台或通过 PUT 对象、POST 对象或复制操作创建的对象：</p>
<ul>
<li>由 SSE-S3 或明文加密的对象具有作为其数据的 MD5 摘要的 ETag。</li>
<li>由 SSE-C 或 SSE-KMS 加密的对象具有不是其对象数据的 MD5 摘要的 ETag。</li>
</ul>
<p>无论加密方法如何，由分段上传或分段复制操作创建的对象都具有不是 MD5 摘要的 ETag。</p>
<footer><strong>Etag</strong><cite><a href="https://docs.aws.amazon.com/AmazonS3/latest/API/RESTCommonResponseHeaders.html" target="_blank" rel="noopener">docs.aws.amazon.com/AmazonS3/latest/API/RESTCommonResponseHeaders.html</a></cite></footer></blockquote>
<p>简单的来说，正常情况下，ETag 应该是跟资源的 md5 一致。 但是不同的加密上传会导致有可能 ETag 会不一致。 尤其是分段上传肯定是不一致的。 而且我也试过了， 直接在 AWS 管理控制台上传的资源算出来的 ETag 也跟资源本身的 md5 也不一致。</p>
<p>不过对于我们的业务来说，不是分段上传， 加密对象也不是 SSE-C 或 SSE-KMS， 所以 ETag 和 md5 是一致 。 所以我们的场景是可以用这个方法来得到 ETag，然后校验的。</p>
<h2 id="举个栗子"><a href="#举个栗子" class="headerlink" title="举个栗子"></a>举个栗子</h2><p>接下来写了完整的 demo 来说明一下， 我这边就直接贴代码了， 尽可能代码简介一点。 整个 demo 的文件有几个 (用 golang 写的)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- main.go   入口文件</span><br><span class="line">- qiniu.go  七牛上传的相关函数</span><br><span class="line">- aws.go    s3 上传的 aws 权限验证</span><br><span class="line">- s3.go     s3 上传的相关函数</span><br><span class="line">- utils.go  工具方法</span><br><span class="line">- text.txt  demo 中用来上传的实例文件</span><br></pre></td></tr></table></figure></p>
<p>结构非常简单清晰，而且用 golang 来写可以让代码巨简洁，没有一行是多余的。 接下来开始介绍各个文件。</p>
<h3 id="工具方法文件-utils-go"><a href="#工具方法文件-utils-go" class="headerlink" title="工具方法文件 utils.go"></a>工具方法文件 utils.go</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">	&quot;io/ioutil&quot;</span><br><span class="line">	&quot;crypto/md5&quot;</span><br><span class="line">	&quot;encoding/hex&quot;</span><br><span class="line">	&quot;time&quot;</span><br><span class="line">	&quot;net&quot;</span><br><span class="line">	&quot;net/http&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">const (</span><br><span class="line">	DefaultResponseTimeout  = 30</span><br><span class="line">	DefaultKeepAliveTimeout = 30</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func log (msg string) &#123;</span><br><span class="line">	fmt.Println(msg + &quot;\n&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 获取文件的 md5</span><br><span class="line">func Md5bytes(bytes []byte) (md5s string) &#123;</span><br><span class="line">	h := md5.New()</span><br><span class="line">	h.Write(bytes)</span><br><span class="line">	md5s = hex.EncodeToString(h.Sum(nil))</span><br><span class="line">	return</span><br><span class="line">&#125;</span><br><span class="line">// http 请求</span><br><span class="line">func HttpGet(url string) ([]byte, error) &#123;</span><br><span class="line">	var body []byte</span><br><span class="line">	timeout := time.Duration(DefaultResponseTimeout) * time.Second</span><br><span class="line">	keepalive := time.Duration(DefaultKeepAliveTimeout) * time.Second</span><br><span class="line"></span><br><span class="line">	transport := &amp;http.Transport&#123;</span><br><span class="line">		ResponseHeaderTimeout: timeout,</span><br><span class="line">		Dial: func(network, addr string) (net.Conn, error) &#123;</span><br><span class="line">			dialer := net.Dialer&#123;</span><br><span class="line">				Timeout:   timeout,</span><br><span class="line">				KeepAlive: keepalive,</span><br><span class="line">			&#125;</span><br><span class="line">			return dialer.Dial(network, addr)</span><br><span class="line">		&#125;,</span><br><span class="line">		DisableKeepAlives: true,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	client := &amp;http.Client&#123;</span><br><span class="line">		Transport: transport,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	resp, err := client.Get(url)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		return body, err</span><br><span class="line">	&#125;</span><br><span class="line">	defer resp.Body.Close()</span><br><span class="line"></span><br><span class="line">	body, err = ioutil.ReadAll(resp.Body)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		return body, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return body, nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 获取文件的 md5 值</span><br><span class="line">func GetFileMd5Hash(fileBytes []byte) (string) &#123;</span><br><span class="line">	hash := Md5bytes(fileBytes)</span><br><span class="line">	log(fmt.Sprintf(&quot;get file hash: %v&quot;, hash))</span><br><span class="line">	return hash</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>封装了几个等下要用到的方法。 不再多说，注释写的也很清楚。</p>
<h3 id="七牛上传文件-qiniu-go"><a href="#七牛上传文件-qiniu-go" class="headerlink" title="七牛上传文件 qiniu.go"></a>七牛上传文件 qiniu.go</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;bytes&quot;</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">	&quot;io/ioutil&quot;</span><br><span class="line">	&quot;github.com/qiniu/api.v6/conf&quot;</span><br><span class="line">	qio &quot;github.com/qiniu/api.v6/io&quot;</span><br><span class="line">	&quot;github.com/qiniu/api.v6/rs&quot;</span><br><span class="line">	&quot;github.com/qiniu/api.v6/url&quot;</span><br><span class="line">	&quot;encoding/json&quot;</span><br><span class="line">	&quot;errors&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">const (</span><br><span class="line">	// 七牛上传的有效期， 设置为一个小时</span><br><span class="line">	QiniuUploadExpireTime = 3600</span><br><span class="line">	// 七牛的 bucket 名称</span><br><span class="line">	QiniuBucket = &quot;test-example&quot;</span><br><span class="line">	// 这个 bucket 的自定义域名，生成下载地址，或者请求 md5 值的时候，会用到</span><br><span class="line">	QiniuDomain = &quot;https://test-example-qn.foo.com/&quot;</span><br><span class="line">	QiniuAccessKey = &quot;_gDUs_24.......................ABw_Uo&quot;</span><br><span class="line">	QiniuSecretKey = &quot;Zs-........................-ar-SQk&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">type QiNiuHandler struct &#123;</span><br><span class="line">	PutPolicy rs.PutPolicy</span><br><span class="line">	Name      string</span><br><span class="line">	rsCli     rs.Client</span><br><span class="line">	DoMain    string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// QiniuInit 七牛初始化</span><br><span class="line">func QiniuInit() *QiNiuHandler &#123;</span><br><span class="line">	return newQiNiu()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func newQiNiu() *QiNiuHandler &#123;</span><br><span class="line">	conf.ACCESS_KEY = QiniuAccessKey</span><br><span class="line">	conf.SECRET_KEY = QiniuSecretKey</span><br><span class="line"></span><br><span class="line">	QiNiuUpload := &amp;QiNiuHandler&#123;&#125;</span><br><span class="line">	name := QiniuBucket</span><br><span class="line">	QiNiuUpload.PutPolicy = rs.PutPolicy&#123;</span><br><span class="line">		Scope: name,</span><br><span class="line">	&#125;</span><br><span class="line">	QiNiuUpload.Name = name</span><br><span class="line">	QiNiuUpload.rsCli = rs.New(nil)</span><br><span class="line">	QiNiuUpload.DoMain = QiniuDomain</span><br><span class="line"></span><br><span class="line">	return QiNiuUpload</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (q *QiNiuHandler) UploadFile(fileName string, file []byte) (url string, err error) &#123;</span><br><span class="line">	log(fmt.Sprintf(&quot;start upload qiniu : %v&quot;, fileName))</span><br><span class="line"></span><br><span class="line">	b := ioutil.NopCloser(bytes.NewReader(file))</span><br><span class="line">	var ret qio.PutRet</span><br><span class="line">	var extra = &amp;qio.PutExtra&#123;&#125;</span><br><span class="line">	// 上传之前先判断是否文件名已经存在，如果已经存在，那么就删掉</span><br><span class="line">	err = q.Delete(fileName)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log(fmt.Sprintf(&quot;q.Delete failed: %v&quot;, err.Error()))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	uptoken := q.PutPolicy.Token(nil)</span><br><span class="line">	log(fmt.Sprintf(&quot;qiniu upload name : %v, token : %v&quot;, fileName, uptoken))</span><br><span class="line">	err = qio.Put(nil, &amp;ret, uptoken, fileName, b, extra)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		//上传产生错误</span><br><span class="line">		log(fmt.Sprintf(&quot;upload qiniu failed: %v&quot;, err.Error()))</span><br><span class="line">		return url, err</span><br><span class="line">	&#125;</span><br><span class="line">	//上传成功，处理返回值</span><br><span class="line">	url = GenDownloadUrl(q.DoMain, fileName, QiniuUploadExpireTime, true)</span><br><span class="line">	log(fmt.Sprintf(&quot;end upload qiniu : %v&quot;, fileName))</span><br><span class="line">	return url, nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//删除文件</span><br><span class="line">func (q *QiNiuHandler) Delete(fileName string) error &#123;</span><br><span class="line">	err := q.rsCli.Delete(nil, q.Name, fileName)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		return err</span><br><span class="line">	&#125;</span><br><span class="line">	return nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//获取文件的元信息，比如 hash 值 (这个方法暂时本项目用不到)</span><br><span class="line">// https://developer.qiniu.com/kodo/1308/stat</span><br><span class="line">func (q *QiNiuHandler) Stat(fileName string) (rs.Entry, error) &#123;</span><br><span class="line">	eInfo, err := q.rsCli.Stat(nil, q.Name, fileName)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		return  eInfo, err</span><br><span class="line">	&#125;</span><br><span class="line">	log(fmt.Sprintf(&quot;get qiniu file stat : %v, info: %v&quot;, fileName, eInfo))</span><br><span class="line">	return eInfo, nil</span><br><span class="line">&#125;</span><br><span class="line">// 获取文件的 md5 值</span><br><span class="line">func (q *QiNiuHandler) GetFileHash(fileName string) (string, error) &#123;</span><br><span class="line">	// https://developer.qiniu.com/dora/1297/file-hash-value-qhash</span><br><span class="line">	// 不过因为是私有空间，所以要访问的话，还得再进行签名</span><br><span class="line">	log(fmt.Sprintf(&quot;start get qiniu hash  %v&quot;, fileName))</span><br><span class="line">	fileName = fmt.Sprintf(&quot;%v?qhash/md5&quot;, fileName)</span><br><span class="line">	// 如果要访问私有空间的 md5 值，那么就要用下载的那个 token 来加密链接，然后请求</span><br><span class="line">	url := GenDownloadUrl(q.DoMain, fileName, QiniuUploadExpireTime, false)</span><br><span class="line">	body, err := HttpGet(url)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log(fmt.Sprintf(&quot;get qiniu md5 fail, request fail: %v:&quot;, url))</span><br><span class="line">		return &quot;&quot;, nil</span><br><span class="line">	&#125;</span><br><span class="line">	result := make(map[string]interface&#123;&#125;)</span><br><span class="line">	err = json.Unmarshal([]byte(body), &amp;result)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log(fmt.Sprintf(&quot;get qiniu md5 fail: %v json %v:&quot;, url, string(body)))</span><br><span class="line">	&#125;</span><br><span class="line">	log(fmt.Sprintf(&quot;url: %v, result: %v&quot;, url, result))</span><br><span class="line">	// 如果文档不存在的话，就会为空</span><br><span class="line">	if result[&quot;hash&quot;] == nil &#123;</span><br><span class="line">		return &quot;&quot;, errors.New(result[&quot;error&quot;].(string))</span><br><span class="line">	&#125;</span><br><span class="line">	if result[&quot;hash&quot;].(string) == &quot;&quot; &#123;</span><br><span class="line">		log(fmt.Sprintf(&quot;get qiniu md5 fail: %v not find hash param %v:&quot;, url, string(body)))</span><br><span class="line">	&#125;</span><br><span class="line">	hash := result[&quot;hash&quot;].(string)</span><br><span class="line">	log(fmt.Sprintf(&quot;get qiniu hash success, %v: %v&quot;, url, hash))</span><br><span class="line">	return hash, nil</span><br><span class="line">&#125;</span><br><span class="line">// 生成下载的链接，主要是生成 token</span><br><span class="line">func GenDownloadUrl(domain string, key string, expire uint32, needEscape bool) string &#123;</span><br><span class="line">	urlStr := domain + url.Escape(key)</span><br><span class="line">	if !needEscape &#123;</span><br><span class="line">		urlStr = domain + key</span><br><span class="line">	&#125;</span><br><span class="line">	policy := rs.GetPolicy&#123;&#125;</span><br><span class="line">	policy.Expires = expire</span><br><span class="line">	return policy.MakeRequest(urlStr, nil)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注释也写的很清楚， 就是上传和获取 md5，直接用他们的 sdk 方法就可以搞定了。 也不多说</p>
<h3 id="s3-上传文件-aws-go-和-s3-go"><a href="#s3-上传文件-aws-go-和-s3-go" class="headerlink" title="s3 上传文件 aws.go 和 s3.go"></a>s3 上传文件 aws.go 和 s3.go</h3><p>因为 s3 是属于 aws 的其中一个服务， 而 aws 的 accessKey 和 secretKey 是适用于所有的 aws 产品的，不仅仅是 s3。 所以这边将权限初始化分开，会显得架构更加的清晰。</p>
<p>首先是 aws.go 就是权限初始化:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;github.com/crowdmob/goamz/aws&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">type Amzs struct &#123;</span><br><span class="line">	Auth aws.Auth</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const (</span><br><span class="line">	AWSAccessKey= &quot;ABBBBBBBUAAAAAAAAA&quot;</span><br><span class="line">	AWSSecretKey= &quot;Ie..................7sux4z+FtH&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">var (</span><br><span class="line">	Amz       *Amzs</span><br><span class="line">	AmzRegoin map[string]aws.Region = map[string]aws.Region&#123;</span><br><span class="line">		&quot;USEast&quot;:  aws.USEast,</span><br><span class="line">		&quot;USWest&quot;:  aws.USWest,</span><br><span class="line">		&quot;USWest2&quot;: aws.USWest2,</span><br><span class="line">	&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func AmzInit() &#123;</span><br><span class="line">	Amz = newAmzs()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func newAmzs() *Amzs &#123;</span><br><span class="line">	amz := &amp;Amzs&#123;</span><br><span class="line">		Auth: aws.Auth&#123;AccessKey: AWSAccessKey, SecretKey: AWSSecretKey&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	return amz</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func getRegion(region string) aws.Region &#123;</span><br><span class="line">	var r aws.Region</span><br><span class="line">	var ok bool</span><br><span class="line"></span><br><span class="line">	if r, ok = AmzRegoin[region]; !ok &#123;</span><br><span class="line">		r = AmzRegoin[&quot;USWest&quot;]</span><br><span class="line">	&#125;</span><br><span class="line">	return r</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>他有很多个区域， 一般我们的bucket， 要么是在美东，要么是在美西， 不需要所有的 region 都列出来。</p>
<p>接下来是 s3.go:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;github.com/crowdmob/goamz/aws&quot;</span><br><span class="line">	&quot;github.com/crowdmob/goamz/s3&quot;</span><br><span class="line">	&quot;time&quot;</span><br><span class="line">	&quot;strings&quot;</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">const (</span><br><span class="line">	S3Bucket = &quot;test-s3&quot;</span><br><span class="line">	S3BucketAcl= &quot;public-read&quot;</span><br><span class="line">	S3ConnectTimeout= 15</span><br><span class="line">	S3ReadTimeout= 240</span><br><span class="line">	// 本次的 bucket 是在美东区域</span><br><span class="line">	S3BucketRegion = &quot;USEast&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">type S3Handler struct &#123;</span><br><span class="line">	Bucket *s3.Bucket</span><br><span class="line">	Name   string</span><br><span class="line">	Region aws.Region</span><br><span class="line">	Acl    s3.ACL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func S3Init() *S3Handler &#123;</span><br><span class="line">	// 先初始化 aws 的权限设置</span><br><span class="line">	AmzInit()</span><br><span class="line">	// 然后再初始化 s3 的配置</span><br><span class="line">	return newS3()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func newS3() *S3Handler &#123;</span><br><span class="line">	region := getRegion(S3BucketRegion)</span><br><span class="line">	sn := s3.New(Amz.Auth, region)</span><br><span class="line">	sn.ConnectTimeout = time.Duration(S3ConnectTimeout) * time.Second</span><br><span class="line">	sn.ReadTimeout = time.Duration(S3ReadTimeout) * time.Second</span><br><span class="line"></span><br><span class="line">	s := &amp;S3Handler&#123;</span><br><span class="line">		Name:   S3Bucket,</span><br><span class="line">		Acl:    s3.ACL(S3BucketAcl),</span><br><span class="line">		Region: region,</span><br><span class="line">		Bucket: sn.Bucket(S3Bucket),</span><br><span class="line">	&#125;</span><br><span class="line">	return s</span><br><span class="line">&#125;</span><br><span class="line">// 上传文件</span><br><span class="line">func (m *S3Handler) UploadFile(fileName string, data []byte) (url string, err error) &#123;</span><br><span class="line">	log(fmt.Sprintf(&quot;start upload s3 : %v&quot;, fileName))</span><br><span class="line">	contType := &quot;application/octet-stream&quot;</span><br><span class="line">	option := &amp;s3.Options&#123;&#125;</span><br><span class="line">	err = m.Bucket.Put(fileName, data, contType, m.Acl, *option)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log(fmt.Sprintf(&quot;upload s3 failed, file: %v, error : %v&quot;, fileName, err.Error()))</span><br><span class="line">		return url, err</span><br><span class="line">	&#125;</span><br><span class="line">	url = m.Bucket.URL(fileName)</span><br><span class="line">	log(fmt.Sprintf(&quot;end upload s3 : %v&quot;, fileName))</span><br><span class="line">	return url, nil</span><br><span class="line">&#125;</span><br><span class="line">// 获取 s3 文件的 meta 资源数据， 直接获取 header 的数据</span><br><span class="line">func (m *S3Handler) GetFileMetaData(fileName string) (map[string]interface&#123;&#125;, error) &#123;</span><br><span class="line">	log(fmt.Sprintf(&quot;get s3 meta : %v&quot;, fileName))</span><br><span class="line">	resp, err := m.Bucket.Head(fileName, nil)</span><br><span class="line">	metaMap := make(map[string]interface&#123;&#125;)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log(fmt.Sprintf(&quot;get s3  meta failed, file: %v, error : %v&quot;, fileName, err.Error()))</span><br><span class="line">		return metaMap, err</span><br><span class="line">	&#125;</span><br><span class="line">	for k, v := range resp.Header &#123;</span><br><span class="line">		metaMap[k] = v</span><br><span class="line">	&#125;</span><br><span class="line">	log(fmt.Sprintf(&quot;meta: %v, e-tag: %v&quot;, metaMap, metaMap[&quot;Etag&quot;]))</span><br><span class="line">	return metaMap, nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 获取文件的 md5 值, 这里其实就是 etag</span><br><span class="line">// 这边要特别注意的是， 通过 s3 上传的文件，并不是所有文件的 md5 值都是跟 etag 一致的。</span><br><span class="line">// 除了多块上传的时候， etag 肯定是跟源文件的 md5 不一致的情况， 在普通单文件上传时候，采取不同的加密方式，也会导致有时候 etag 会跟实际文件的 md5 不一样。</span><br><span class="line">// 比如我就试过直接在 AWS Management Console 直接上传文件的时候， 他的 etag 就不是源文件的 md5 值。</span><br><span class="line">// 不过对于本项目来说， 因为是通过 PUT 的方式来进行单文件上传的，并且也没有设置其他的加密方式，所以刚好 etag 跟源文件的 md5 值一样。</span><br><span class="line">// 具体关于什么时候 etag 会跟 md5 不一致的文档： https://docs.aws.amazon.com/AmazonS3/latest/API/RESTCommonResponseHeaders.html</span><br><span class="line">// 还有一种校验 s3 上传文件完整性的情况，就是在上传的时候， 在头部传入 Content-MD5 的值，这个值是我们自己算的，算法： https://aws.amazon.com/cn/premiumsupport/knowledge-center/data-integrity-s3/ ， 通过这种方式也可以判断上传文件的完整性， 不过为了保证跟七牛的体验一致，还是采用上传后 md5 校验的方式来进行判断。</span><br><span class="line">func (m *S3Handler) GetFileHash(fileName string) (string, error) &#123;</span><br><span class="line">	log(fmt.Sprintf(&quot;start get s3 hash  %v&quot;, fileName))</span><br><span class="line">	metaMap, err := m.GetFileMetaData(fileName)</span><br><span class="line">	hash := &quot;&quot;</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log(fmt.Sprintf(&quot;get s3 hash failed, file: %v, error : %v&quot;, fileName, err.Error()))</span><br><span class="line">		return &quot;&quot;, err</span><br><span class="line">	&#125;</span><br><span class="line">	if metaMap[&quot;Etag&quot;] != nil &#123;</span><br><span class="line">		hash = metaMap[&quot;Etag&quot;].([]string)[0]</span><br><span class="line">		// 替换掉 双引号</span><br><span class="line">		hash = strings.Replace(hash, `&quot;`, ``, -1)</span><br><span class="line">	&#125;</span><br><span class="line">	log(fmt.Sprintf(&quot;get s3 hash success, %v: %v&quot;, fileName, hash))</span><br><span class="line">	return hash, nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注释也很清楚， 不再多说。</p>
<h3 id="最后执行的-main-文件"><a href="#最后执行的-main-文件" class="headerlink" title="最后执行的 main 文件"></a>最后执行的 main 文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;io/ioutil&quot;</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">const (</span><br><span class="line">	UploadFileName = &quot;test.txt&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">type UploadHandler interface &#123;</span><br><span class="line">	UploadFile(FileName string, file []byte) (downloadUrl string, err error)</span><br><span class="line">	GetFileHash(FileName string) (string, error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	fmt.Println(&quot;start===&quot;)</span><br><span class="line">	testQiNiu()</span><br><span class="line">	testS3()</span><br><span class="line">&#125;</span><br><span class="line">// 测试七牛上传</span><br><span class="line">func testQiNiu ()&#123;</span><br><span class="line">	uploadClient := QiniuInit()</span><br><span class="line">	commonHandle(uploadClient)</span><br><span class="line">&#125;</span><br><span class="line">// 测试 s3 上传</span><br><span class="line">func testS3 ()&#123;</span><br><span class="line">	uploadClient := S3Init()</span><br><span class="line">	commonHandle(uploadClient)</span><br><span class="line">&#125;</span><br><span class="line">// 通用方法处理</span><br><span class="line">func commonHandle (uploadClient UploadHandler)&#123;</span><br><span class="line">	// read file</span><br><span class="line">	b, err := ioutil.ReadFile(&quot;./&quot; + UploadFileName)</span><br><span class="line">	newName := &quot;new-test.txt&quot;</span><br><span class="line">	originHash := GetFileMd5Hash(b)</span><br><span class="line">	// 接下来上传, 可以选择直接用原文件名称，也可以重命名</span><br><span class="line">	downloadUrl, err := uploadClient.UploadFile(newName, b)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	log(fmt.Sprintf(&quot;download url: %v&quot;, downloadUrl))</span><br><span class="line">	// 得到 本地文件 的 md5 值</span><br><span class="line">	localHash, err := uploadClient.GetFileHash(newName)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	log(fmt.Sprintf(&quot;local md5: %v, online md5: %v&quot;, originHash, localHash))</span><br><span class="line">	// 接下来比较两者的 md5 值是否一致</span><br><span class="line">	if originHash == localHash &#123;</span><br><span class="line">		log(&quot;file match!!!!&quot;)</span><br><span class="line">	&#125;else&#123;</span><br><span class="line">		log(&quot;file not match!!!!&quot;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>做了一个 interface， 这样子就可以将通用的处理流程都抽出来。 显得代码更加的干净了。</p>
<h3 id="跑起来看下效果"><a href="#跑起来看下效果" class="headerlink" title="跑起来看下效果"></a>跑起来看下效果</h3><p>可以看到，刚开始是跑七牛上传， 然后接下来是跑 s3 上传的。 先看七牛的 log:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">start===</span><br><span class="line">get file hash: e10adc3949ba59abbe56e057f20f883e</span><br><span class="line"></span><br><span class="line">start upload qiniu : new-test.txt</span><br><span class="line"></span><br><span class="line">qiniu upload name : new-test.txt, token : _gDUs_24d-itH7Kk0EFYwU5uxnEpiYSSpdABw_Uo:SSGy00RIKSMhI1ymNPRrSnUA-U0=:eyJzY29wZSI6ImFpci10ZXN0IiwiZGVhZGxpbmUiOjE2MzAwNDgzMTB9</span><br><span class="line"></span><br><span class="line">end upload qiniu : new-test.txt</span><br><span class="line"></span><br><span class="line">download url: https://test-example-qn.foo.com/new-test.txt?e=1630048310&amp;token=_gDUs_24d-itH7Kk0EFYwU5uxnEpiYSSpdABw_Uo:mCz4fbDYN1SzIZa5E3gzeTzpf2U</span><br><span class="line"></span><br><span class="line">start get qiniu hash  new-test.txt</span><br><span class="line"></span><br><span class="line">url: https://test-example-qn.foo.com/new-test.txt?qhash/md5&amp;e=1630048310&amp;token=_gDUs_24d-itH7Kk0EFYwU5uxnEpiYSSpdABw_Uo:ZVL1JRqSn8zPb9DM2HodgwBCldM, result: map[fsize:6 hash:e10adc3949ba59abbe56e057f20f883e]</span><br><span class="line"></span><br><span class="line">get qiniu hash success, https://test-example-qn.foo.com/new-test.txt?qhash/md5&amp;e=1630048310&amp;token=_gDUs_24d-itH7Kk0EFYwU5uxnEpiYSSpdABw_Uo:ZVL1JRqSn8zPb9DM2HodgwBCldM: e10adc3949ba59abbe56e057f20f883e</span><br><span class="line"></span><br><span class="line">local md5: e10adc3949ba59abbe56e057f20f883e, online md5: e10adc3949ba59abbe56e057f20f883e</span><br><span class="line"></span><br><span class="line">file match!!!!</span><br></pre></td></tr></table></figure>
<p>log 也写的很详细了， 反正就是先上传，然后再获取 md5， 最后匹配。</p>
<p>然后接下来看 s3 上传的 log:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">get file hash: e10adc3949ba59abbe56e057f20f883e</span><br><span class="line"></span><br><span class="line">start upload s3 : new-test.txt</span><br><span class="line"></span><br><span class="line">end upload s3 : new-test.txt</span><br><span class="line"></span><br><span class="line">download url: https://s3.amazonaws.com/test-s3/new-test.txt</span><br><span class="line"></span><br><span class="line">start get s3 hash  new-test.txt</span><br><span class="line"></span><br><span class="line">get s3 meta : new-test.txt</span><br><span class="line"></span><br><span class="line">meta: map[Accept-Ranges:[bytes] Content-Length:[6] Content-Type:[application/octet-stream] Date:[Fri, 27 Aug 2021 06:12:01 GMT] Etag:[&quot;e10adc3949ba59abbe56e057f20f883e&quot;] Last-Modified:[Fri, 27 Aug 2021 06:12:00 GMT] Server:[Amazo</span><br><span class="line">nS3] X-Amz-Id-2:[O3OUrzoLr8Z0RbAOaLa0/DI3q+KfBJrCa87mlVg2KCbS3uwozv5nCe9Yf+gtDL9w5A97hurS6rU=] X-Amz-Request-Id:[YX6T7015025YYNZF]], e-tag: [&quot;e10adc3949ba59abbe56e057f20f883e&quot;]</span><br><span class="line"></span><br><span class="line">get s3 hash success, new-test.txt: e10adc3949ba59abbe56e057f20f883e</span><br><span class="line"></span><br><span class="line">local md5: e10adc3949ba59abbe56e057f20f883e, online md5: e10adc3949ba59abbe56e057f20f883e</span><br><span class="line"></span><br><span class="line">file match!!!!</span><br></pre></td></tr></table></figure>
<p>一样测试结果肯定是匹配的。</p>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    Zach Ke
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://kebingzao.com/2021/08/26/qiniu-s3-verify-md5/" title="在进行七牛或者S3文件上传的时候，怎么保证上传文件的完整性">http://kebingzao.com/2021/08/26/qiniu-s3-verify-md5/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/aws/" rel="tag"># aws</a>
          
            <a href="/tags/s3/" rel="tag"># s3</a>
          
            <a href="/tags/七牛/" rel="tag"># 七牛</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/08/19/use-web-logan/" rel="next" title="使用 Logan 来做前端日志系统">
                <i class="fa fa-chevron-left"></i> 使用 Logan 来做前端日志系统
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/09/09/redirect-safe-url/" rel="prev" title="web 安全之 - 登录之后的重定向 url 要有白名单机制">
                web 安全之 - 登录之后的重定向 url 要有白名单机制 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="Zach Ke" />
            
              <p class="site-author-name" itemprop="name">Zach Ke</p>
              <p class="site-description motion-element" itemprop="description">做最咸的那一条</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">284</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">28</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">71</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/kebingzao" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#获取本地文件的-md5-值"><span class="nav-number">2.</span> <span class="nav-text">获取本地文件的 md5 值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#获取七牛的文件的-md5-值"><span class="nav-number">3.</span> <span class="nav-text">获取七牛的文件的 md5 值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#获取-S3-的文件的-md5-值"><span class="nav-number">4.</span> <span class="nav-text">获取 S3 的文件的 md5 值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#举个栗子"><span class="nav-number">5.</span> <span class="nav-text">举个栗子</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#工具方法文件-utils-go"><span class="nav-number">5.1.</span> <span class="nav-text">工具方法文件 utils.go</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#七牛上传文件-qiniu-go"><span class="nav-number">5.2.</span> <span class="nav-text">七牛上传文件 qiniu.go</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#s3-上传文件-aws-go-和-s3-go"><span class="nav-number">5.3.</span> <span class="nav-text">s3 上传文件 aws.go 和 s3.go</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#最后执行的-main-文件"><span class="nav-number">5.4.</span> <span class="nav-text">最后执行的 main 文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#跑起来看下效果"><span class="nav-number">5.5.</span> <span class="nav-text">跑起来看下效果</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zach Ke</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://zach-2.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://kebingzao.com/2021/08/26/qiniu-s3-verify-md5/';
          this.page.identifier = '2021/08/26/qiniu-s3-verify-md5/';
          this.page.title = '在进行七牛或者S3文件上传的时候，怎么保证上传文件的完整性';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://zach-2.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  














  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.4"></script>



  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("HIV4XRdKJXB0eaFgtSjiVNaK-gzGzoHsz", "zN3v8grxW0Q8eXwNlEgXxWrF");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  



</body>
</html>
