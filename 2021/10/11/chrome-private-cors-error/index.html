<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <script src="/live2d-widget/live2d-widget-resource/jquery.min.js"></script>
  <link rel="stylesheet" href="/live2d-widget/live2d-widget-resource/font-awesome.min.css"/>
  <script src="/live2d-widget/autoload.js"></script>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />


















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Chrome," />










<meta name="description" content="前言前段时间，有用户反馈 chrome 最新版本，无法在我们的远程站点连接本地的设备。 后面查了一下， 发现控制台有报了这个错误:1Access to script at &amp;apos;http://192.168.197.81:8888/sdctl/comm/ping/?product=intl&amp;amp;des=1&amp;amp;callback=_jqjsp&amp;amp;_1633681289908=&amp;a">
<meta name="keywords" content="Chrome">
<meta property="og:type" content="article">
<meta property="og:title" content="chrome 94 之后 http 远程站点请求 ip 地址报 CORS 错误">
<meta property="og:url" content="http://kebingzao.com/2021/10/11/chrome-private-cors-error/index.html">
<meta property="og:site_name" content="Zach Ke&#39;s Notes">
<meta property="og:description" content="前言前段时间，有用户反馈 chrome 最新版本，无法在我们的远程站点连接本地的设备。 后面查了一下， 发现控制台有报了这个错误:1Access to script at &amp;apos;http://192.168.197.81:8888/sdctl/comm/ping/?product=intl&amp;amp;des=1&amp;amp;callback=_jqjsp&amp;amp;_1633681289908=&amp;a">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://kebingzao.com/2021/10/11/chrome-private-cors-error/3.png">
<meta property="og:image" content="http://kebingzao.com/2021/10/11/chrome-private-cors-error/6.png">
<meta property="og:image" content="http://kebingzao.com/2021/10/11/chrome-private-cors-error/7.png">
<meta property="og:image" content="http://kebingzao.com/2021/10/11/chrome-private-cors-error/8.png">
<meta property="og:image" content="http://kebingzao.com/2021/10/11/chrome-private-cors-error/9.png">
<meta property="og:image" content="http://kebingzao.com/2021/10/11/chrome-private-cors-error/10.png">
<meta property="og:image" content="http://kebingzao.com/2021/10/11/chrome-private-cors-error/11.png">
<meta property="og:image" content="http://kebingzao.com/2021/10/11/chrome-private-cors-error/12.png">
<meta property="og:image" content="http://kebingzao.com/2021/10/11/chrome-private-cors-error/13.png">
<meta property="og:image" content="http://kebingzao.com/2021/10/11/chrome-private-cors-error/14.png">
<meta property="og:updated_time" content="2021-10-21T14:38:40.245Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="chrome 94 之后 http 远程站点请求 ip 地址报 CORS 错误">
<meta name="twitter:description" content="前言前段时间，有用户反馈 chrome 最新版本，无法在我们的远程站点连接本地的设备。 后面查了一下， 发现控制台有报了这个错误:1Access to script at &amp;apos;http://192.168.197.81:8888/sdctl/comm/ping/?product=intl&amp;amp;des=1&amp;amp;callback=_jqjsp&amp;amp;_1633681289908=&amp;a">
<meta name="twitter:image" content="http://kebingzao.com/2021/10/11/chrome-private-cors-error/3.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'KGVI6VPIBI',
      apiKey: '41c2ccc830ca183768a6bf1e50a03f44',
      indexName: 'test_blog',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://kebingzao.com/2021/10/11/chrome-private-cors-error/"/>





  <title>chrome 94 之后 http 远程站点请求 ip 地址报 CORS 错误 | Zach Ke's Notes</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <a href="https://github.com/kebingzao" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Zach Ke's Notes</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Quick notes</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kebingzao.com/2021/10/11/chrome-private-cors-error/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zach Ke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zach Ke's Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">chrome 94 之后 http 远程站点请求 ip 地址报 CORS 错误</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-10-11T11:55:24+08:00">
                2021-10-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/前端相关/" itemprop="url" rel="index">
                    <span itemprop="name">前端相关</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/10/11/chrome-private-cors-error/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2021/10/11/chrome-private-cors-error/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2021/10/11/chrome-private-cors-error/" class="leancloud_visitors" data-flag-title="chrome 94 之后 http 远程站点请求 ip 地址报 CORS 错误">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>前段时间，有用户反馈 chrome 最新版本，无法在我们的远程站点连接本地的设备。 后面查了一下， 发现控制台有报了这个错误:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Access to script at &apos;http://192.168.197.81:8888/sdctl/comm/ping/?product=intl&amp;des=1&amp;callback=_jqjsp&amp;_1633681289908=&apos; from origin &apos;http://example.com&apos; has been blocked by CORS policy: The request client is not a secure context and the resource is in more-private address space `private`.</span><br></pre></td></tr></table></figure></p>
<p>而且有些用户的 chrome 更奇葩， 请求 google 机器人校验的验证码的 api.js 也报了这个错:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index.html:1 Access to script at &apos;https://www.recaptcha.net/recaptcha/api.js&apos; from origin &apos;http://example.com&apos; has been blocked by CORS policy: The request client is not a secure context and the resource is in more-private address space `local`.</span><br></pre></td></tr></table></figure></p>
<h2 id="排查"><a href="#排查" class="headerlink" title="排查"></a>排查</h2><p>后面查了一下， 是 chrome 新版本 94 的问题， 他不允许线上远端的站点请求 本地local 的地址，比如 ip 地址，所以会报 CORS 错误。 </p>
<p>但是为啥我们的一些 chrome 94 没有问题， 猜测应该是 A/B 测的原因。<br><a id="more"></a></p>
<p><a href="https://developer.chrome.com/blog/private-network-access-update/" target="_blank" rel="noopener">https://developer.chrome.com/blog/private-network-access-update/</a>  这个是他们的更新 log， 他们认为 远程站点请求 local 资源是不安全的， 有过多次被 CSRF 攻击的情况， 所以要禁止这种行为，才会报这个 CORS 的错。</p>
<p><img src="/2021/10/11/chrome-private-cors-error/3.png" alt=""></p>
<p>而且在 2022 年 5 月：Chrome 102 推出稳定版。弃用试验结束。Chrome 会阻止来自公共、非安全上下文的所有私有网络请求。 到时候， http 协议下的远程站点就真的无法访问本地私有专用网络了。</p>
<blockquote>
<p>同时我在我的本地地址试了一下， 发现不会有这个问题。 说明确实是远程站点才会有。 本地 host 不受影响，直接在导航栏请求 ip 地址也正常。</p>
</blockquote>
<h2 id="通过修改-chrome-配置来避免"><a href="#通过修改-chrome-配置来避免" class="headerlink" title="通过修改 chrome 配置来避免"></a>通过修改 chrome 配置来避免</h2><p>后面通过查了一下 <a href="https://stackoverflow.com/questions/66534759/chrome-cors-error-on-request-to-localhost-dev-server-from-remote-site" target="_blank" rel="noopener">Chrome CORS error on request to localhost dev server from remote site</a>, 发现要解决的话， chrome 有个配置可以解决。</p>
<ol>
<li>打开 tab 页面 <code>chrome://flags/#block-insecure-private-network-requests</code></li>
<li>将其 <code>Block insecure private network requests</code> 设置为 <code>Disabled</code>, 然后重启就行了， 这样子就相当于把这个功能禁用掉</li>
</ol>
<p><img src="/2021/10/11/chrome-private-cors-error/6.png" alt=""></p>
<p>这样子就相当于禁用了。 效果是可以的，也就不会再报这个错误了。</p>
<h2 id="使用-deprecation-trial"><a href="#使用-deprecation-trial" class="headerlink" title="使用 deprecation trial"></a>使用 deprecation trial</h2><p>虽然通过修改 chrome 配置项是可以的， 但是这样子毕竟对用户不太友好，而且也不是每个用户遇到问题都会反馈。 所以还是要有一个解决方案的。</p>
<p>这一篇 blog: <a href="https://developer.chrome.com/blog/private-network-access-update/" target="_blank" rel="noopener">Private Network Access update: Introducing a deprecation trial</a> 有给了三种途径解决。</p>
<blockquote><p>Accessing private IP addresses<br>If your website needs to issue requests to a target server on a private IP address, then simply upgrading the initiator website to HTTPS does not work. Mixed Content prevents secure contexts from making requests over plaintext HTTP, so the newly-secured website will still find itself unable to make the requests. There are a few ways to solve this issue:</p>
<ol>
<li>Upgrade both ends to HTTPS.</li>
<li>Use WebTransport to securely connect to the target server.</li>
<li>Reverse the embedding relationship.</li>
</ol>
<footer><strong>Accessing private IP addresses</strong><cite><a href="https://developer.chrome.com/blog/private-network-access-update/" target="_blank" rel="noopener">developer.chrome.com/blog/private-network-access-update</a></cite></footer></blockquote>
<p>不过他给的解决方案其实就是要升级为 https。 但是我们的 local server 是 ip 地址， 如果远程站点升级为 https， 那么将无法访问这个 ip 地址了。 而如果将这个 ip 地址也自定义一个 ssl 证书的话，又需要首次访问的时候， 提醒用户去设置允许， 所以只能保持用 http 协议。</p>
<p>同时有给了我们一种现阶段的兼容方式 <code>deprecation trial</code>， 可以一直用到 <code>2022-05-17</code> 。</p>
<blockquote><p>Register for the deprecation trial<br>First, register for the “Private Network Access from non-secure contexts” trial using the web developers console, and obtain a trial token for each affected origin. Then configure your web servers to attach the origin-specific Origin-Trial: $token header on responses. Note that this header need only be set on main resource and navigation responses, and then only when the resulting document will make use of the deprecated feature. It is useless (though harmless) to attach this header to subresource responses.</p>
<p>Since this trial must be enabled or disabled before a document is allowed to make any requests, it cannot be enabled through a <meta> tag. Such tags are only parsed from the response body after subresource requests might have been issued. This presents a challenge for websites not in control of response headers, such as github.io static websites served by a third party.</p>
<footer><strong>Register for the deprecation trial</strong><cite><a href="https://developer.chrome.com/blog/private-network-access-update/" target="_blank" rel="noopener">developer.chrome.com/blog/private-network-access-update</a></cite></footer></blockquote>
<p>其实就是去 chrome 的 develop 后台，针对这个功能申请一个 token， 然后再这个 web server 的回执中将这个 token 作为 <code>Origin-Trial</code> 头部返回。</p>
<blockquote>
<p>这边要注意，这边的 web server 是你的远程站点的 web server， 而不是你请求的那个 local 资源的 web server。 这个坑我也踩过</p>
</blockquote>
<p>正常有两种方式来用这个 token</p>
<p><img src="/2021/10/11/chrome-private-cors-error/7.png" alt=""></p>
<ol>
<li>当做 web server 的 response <code>Origin-Trial</code> 头部返回</li>
<li>设置成 web server 的 meta 标签</li>
</ol>
<p>不过 blog 文章里面说， meta 标签不适于本次这个例子。 因此只能用 response 头部返回的情况</p>
<blockquote>
<p>刚开始我还不信邪， 还真尝试了用 meta 标签的方式， 最后证明文章说的没错，确实不适用于本例</p>
</blockquote>
<h3 id="申请-token"><a href="#申请-token" class="headerlink" title="申请 token"></a>申请 token</h3><p>所以就去这边申请 <a href="https://developer.chrome.com/origintrials/#/trials/active" target="_blank" rel="noopener">chrome origin trials</a></p>
<p><img src="/2021/10/11/chrome-private-cors-error/8.png" alt=""></p>
<p>找到这个项</p>
<p><img src="/2021/10/11/chrome-private-cors-error/9.png" alt=""></p>
<p>然后点击进去， 点击注册 按钮</p>
<p><img src="/2021/10/11/chrome-private-cors-error/10.png" alt=""></p>
<p>可以看到这种兼容模式， 只能用到 <code>2022-05-17</code>, 也就是这个 chrome 101 版本出来之后，就没有用了。</p>
<p>然后填一下， 这时候就注册好了。</p>
<p><img src="/2021/10/11/chrome-private-cors-error/11.png" alt=""></p>
<p>这边注意几个点</p>
<ol>
<li>这个 token 是有有效期的， 看起来应该是 55 天的有效期， 快到期的时候，要点击 renew 按钮续期</li>
<li>renew 按钮，刚申请的时候，是点击不了的。</li>
</ol>
<p>后面发现 有个 三角形的 感叹号。 我怀疑第一次要生效的话， 得先 feedback 一下才行。 并且 renew 按钮是点不了的。</p>
<p>所以就点击 feedback 按钮， 进行了填写。 果然填写了之后， 感叹号不见了。 renew 按钮也可以点击了。</p>
<p><img src="/2021/10/11/chrome-private-cors-error/12.png" alt=""></p>
<p>接下来我们就可以用这个 token 了。</p>
<h3 id="在远程站点的-response-中返回-Origin-Trial-头部"><a href="#在远程站点的-response-中返回-Origin-Trial-头部" class="headerlink" title="在远程站点的 response 中返回 Origin-Trial 头部"></a>在远程站点的 response 中返回 Origin-Trial 头部</h3><p>因为这个站点， 国内有用 网宿的加速， 国外用的是 s3 的 cloudfront cdn。 所以要配两个地方。 之前添加 <code>x-frame-options</code> 头部的时候，就处理过了。 具体看: <a href="/2020/04/26/cloudfront-add-x-frame-options/" title="web 安全之 - cloudfront 添加 x-frame-options 防止 Clickjacking">web 安全之 - cloudfront 添加 x-frame-options 防止 Clickjacking</a></p>
<h4 id="网宿添加头部"><a href="#网宿添加头部" class="headerlink" title="网宿添加头部"></a>网宿添加头部</h4><p><img src="/2021/10/11/chrome-private-cors-error/13.png" alt=""></p>
<p>在网宿后台这样子配， 然后测试一下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[kbz@centos156 logs]$ curl -I http://example.com/index.html</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Mon, 11 Oct 2021 03:28:08 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 7065</span><br><span class="line">Connection: keep-alive</span><br><span class="line">x-amz-id-2: InmgJo+NreFhy3ipzrvWRxNXTalwg0eRgXVSS35TJbfzkxFQsfb7CBVQJv4klP2Pw+j0b8ZC1Aw=</span><br><span class="line">x-amz-request-id: 5NGX6B1PWYF6HW04</span><br><span class="line">Last-Modified: Tue, 28 Sep 2021 11:34:17 GMT</span><br><span class="line">ETag: &quot;e42f39a00a7eaa61f93ba5b582c72d28&quot;</span><br><span class="line">Server: AmazonS3</span><br><span class="line">X-Via: 1.1 jfzhdx97:4 (Cdn Cache Server V2.0), 1.1 PS-FOC-01iNb26:10 (Cdn Cache Server V2.0)</span><br><span class="line">X-Ws-Request-Id: 6163af48_PS-FOC-01wFw27_14483-32709</span><br><span class="line">X-Frame-Options: SAMEORIGIN</span><br><span class="line">Origin-Trial: AlzXLEBW+....ZCIsImV4cGlyeSI6MTY1Mjc3NDQwMH0=</span><br></pre></td></tr></table></figure>
<h4 id="cloudfront-添加头部"><a href="#cloudfront-添加头部" class="headerlink" title="cloudfront 添加头部"></a>cloudfront 添加头部</h4><p>还是在 添加 <code>x-frame-options</code> 头部的时候， 直接添加一行， 然后重新部署一个新版本，最后应用到对应的 cloudfront 就行了</p>
<p><img src="/2021/10/11/chrome-private-cors-error/14.png" alt=""></p>
<p>然后测试一下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[kbz@gosrv-other ~]$ curl -I http://example.com/index.html</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 7065</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Last-Modified: Tue, 28 Sep 2021 11:34:17 GMT</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line">Server: AmazonS3</span><br><span class="line">X-Frame-Options: SAMEORIGIN</span><br><span class="line">Origin-Trial: AlzXLEBW+...yeSI6MTY1Mjc3NDQwMH0=</span><br><span class="line">X-Edge-Origin-Shield-Skipped: 0</span><br><span class="line">Date: Mon, 11 Oct 2021 03:29:00 GMT</span><br><span class="line">ETag: &quot;e42f39a00a7eaa61f93ba5b582c72d28&quot;</span><br><span class="line">X-Cache: RefreshHit from cloudfront</span><br><span class="line">Via: 1.1 7a21e9c0eca084f9537ebb23906ea9ff.cloudfront.net (CloudFront)</span><br><span class="line">X-Amz-Cf-Pop: SFO20-C1</span><br><span class="line">X-Amz-Cf-Id: OTY0Aq5ejaUsl5-ZdZIfbEltgzwPEu6QM-eizShk-Jvg76RUYzfDVw==</span><br></pre></td></tr></table></figure></p>
<p>说明都正常。</p>
<p>这时候 chrome 访问的时候， 终于正常了， 不会再报错误了。</p>
<h2 id="后续注意续期"><a href="#后续注意续期" class="headerlink" title="后续注意续期"></a>后续注意续期</h2><p>在 <code>2021-12-03</code> 之前，要对这个 token 进行续期。就是点击 renew 按钮。</p>
<h2 id="真正的解决方案"><a href="#真正的解决方案" class="headerlink" title="真正的解决方案"></a>真正的解决方案</h2><p>到明年的 <code>2022-05-17</code> 这个临时方案也不行了。 那么有没有可以解决的方式??</p>
<p>从 chrome 的策略来看， http 下访问私有专用网络， 大方向应该还是不行的。 因为这个东西确实不安全， 所以报了多个 CSRF 的安全漏洞。 所以能升 https， 还是要升级到 https。</p>
<p>如果到那时候，还想要在 http 协议下访问私有专用网络，那么就只能启用他的 policies， 具体可以看 <a href="https://developer.chrome.com/blog/private-network-access-update/#policies" target="_blank" rel="noopener">Enable policies</a>:</p>
<ol>
<li><a href="https://chromeenterprise.google/policies/#InsecurePrivateNetworkRequestsAllowed" target="_blank" rel="noopener">InsecurePrivateNetworkRequestsAllowed</a></li>
<li><a href="https://chromeenterprise.google/policies/#InsecurePrivateNetworkRequestsAllowedForUrls" target="_blank" rel="noopener">InsecurePrivateNetworkRequestsAllowedForUrls</a></li>
</ol>
<p>其实就是要将这个私有网络设置为 chrome 这个用户的访问白名单， 以 windows 为例，就是要这样子设置:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Software\Policies\Google\Chrome\InsecurePrivateNetworkRequestsAllowedForUrls\1 = http://www.example.com:8080</span><br><span class="line">Software\Policies\Google\Chrome\InsecurePrivateNetworkRequestsAllowedForUrls\2 = [*.]example.edu</span><br></pre></td></tr></table></figure></p>
<p>但是这样子不现实。 所以可能在 <code>2022-05-17</code> 之后， http 协议的远程站点，就不能再请求本地的专用网络了。包括 ip 形式的， localhost 形式的。</p>
<hr>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://github.com/GoogleChrome/OriginTrials/blob/gh-pages/developer-guide.md" target="_blank" rel="noopener">Origin Trials Guide for Web Developers</a></li>
<li><a href="https://developer.chrome.com/blog/private-network-access-update/" target="_blank" rel="noopener">Private Network Access update: Introducing a deprecation trial</a></li>
<li><a href="https://developer.chrome.com/blog/origin-trials/" target="_blank" rel="noopener">How to register for an origin trial</a></li>
<li><a href="https://wicg.github.io/private-network-access/" target="_blank" rel="noopener">Private Network Access</a></li>
<li><a href="https://stackoverflow.com/questions/66534759/chrome-cors-error-on-request-to-localhost-dev-server-from-remote-site" target="_blank" rel="noopener">Chrome CORS error on request to localhost dev server from remote site</a></li>
</ul>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    Zach Ke
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://kebingzao.com/2021/10/11/chrome-private-cors-error/" title="chrome 94 之后 http 远程站点请求 ip 地址报 CORS 错误">http://kebingzao.com/2021/10/11/chrome-private-cors-error/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Chrome/" rel="tag"># Chrome</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/09/09/redirect-safe-url/" rel="next" title="web 安全之 - 登录之后的重定向 url 要有白名单机制">
                <i class="fa fa-chevron-left"></i> web 安全之 - 登录之后的重定向 url 要有白名单机制
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/10/21/nginx-proxy-wss-https/" rel="prev" title="nginx 转发代理 wss 和 https (目标程序是 ws 和 http)">
                nginx 转发代理 wss 和 https (目标程序是 ws 和 http) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="Zach Ke" />
            
              <p class="site-author-name" itemprop="name">Zach Ke</p>
              <p class="site-description motion-element" itemprop="description">做最咸的那一条</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">304</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">29</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">77</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/kebingzao" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#排查"><span class="nav-number">2.</span> <span class="nav-text">排查</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#通过修改-chrome-配置来避免"><span class="nav-number">3.</span> <span class="nav-text">通过修改 chrome 配置来避免</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用-deprecation-trial"><span class="nav-number">4.</span> <span class="nav-text">使用 deprecation trial</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#申请-token"><span class="nav-number">4.1.</span> <span class="nav-text">申请 token</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在远程站点的-response-中返回-Origin-Trial-头部"><span class="nav-number">4.2.</span> <span class="nav-text">在远程站点的 response 中返回 Origin-Trial 头部</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#网宿添加头部"><span class="nav-number">4.2.1.</span> <span class="nav-text">网宿添加头部</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#cloudfront-添加头部"><span class="nav-number">4.2.2.</span> <span class="nav-text">cloudfront 添加头部</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#后续注意续期"><span class="nav-number">5.</span> <span class="nav-text">后续注意续期</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#真正的解决方案"><span class="nav-number">6.</span> <span class="nav-text">真正的解决方案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-number">7.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zach Ke</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://zach-2.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://kebingzao.com/2021/10/11/chrome-private-cors-error/';
          this.page.identifier = '2021/10/11/chrome-private-cors-error/';
          this.page.title = 'chrome 94 之后 http 远程站点请求 ip 地址报 CORS 错误';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://zach-2.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  














  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.4"></script>



  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("HIV4XRdKJXB0eaFgtSjiVNaK-gzGzoHsz", "zN3v8grxW0Q8eXwNlEgXxWrF");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  



</body>
</html>
