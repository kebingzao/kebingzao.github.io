<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <script src="/live2d-widget/live2d-widget-resource/jquery.min.js"></script>
  <link rel="stylesheet" href="/live2d-widget/live2d-widget-resource/font-awesome.min.css"/>
  <script src="/live2d-widget/autoload.js"></script>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />


















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="prometheus,alertmanager," />










<meta name="description" content="前言通过 基于 prometheus 打造监控报警后台 (3) - 使用 grafana 创建仪表盘 我们已经能够在 grafana 上面创建漂亮的数据监控仪表盘了。 本节我们讲一下怎么在 prometheus 上设置预警并且发送警报。  简单的架构图如下  在 prometheus 监控系统中，采集与警报是分离的，所以是分为两个步骤的:  在 prometheus 中创建警报规则，并监控警报和触">
<meta name="keywords" content="prometheus,alertmanager">
<meta property="og:type" content="article">
<meta property="og:title" content="基于 prometheus 打造监控报警后台 (4) - 使用 alertmanager 发送警报">
<meta property="og:url" content="http://kebingzao.com/2022/11/29/prometheus-4-alertmanager/index.html">
<meta property="og:site_name" content="Zach Ke&#39;s Notes">
<meta property="og:description" content="前言通过 基于 prometheus 打造监控报警后台 (3) - 使用 grafana 创建仪表盘 我们已经能够在 grafana 上面创建漂亮的数据监控仪表盘了。 本节我们讲一下怎么在 prometheus 上设置预警并且发送警报。  简单的架构图如下  在 prometheus 监控系统中，采集与警报是分离的，所以是分为两个步骤的:  在 prometheus 中创建警报规则，并监控警报和触">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://kebingzao.com/2022/11/29/prometheus-4-alertmanager/1.png">
<meta property="og:image" content="http://kebingzao.com/2022/11/29/prometheus-4-alertmanager/2.png">
<meta property="og:image" content="http://kebingzao.com/2022/11/29/prometheus-4-alertmanager/3.png">
<meta property="og:image" content="http://kebingzao.com/2022/11/29/prometheus-4-alertmanager/4.png">
<meta property="og:image" content="http://kebingzao.com/2022/11/29/prometheus-4-alertmanager/5.png">
<meta property="og:image" content="http://kebingzao.com/2022/11/29/prometheus-4-alertmanager/6.png">
<meta property="og:image" content="http://kebingzao.com/2022/11/29/prometheus-4-alertmanager/7.png">
<meta property="og:image" content="http://kebingzao.com/2022/11/29/prometheus-4-alertmanager/8.png">
<meta property="og:image" content="http://kebingzao.com/2022/11/29/prometheus-4-alertmanager/9.png">
<meta property="og:image" content="http://kebingzao.com/2022/11/29/prometheus-4-alertmanager/10.png">
<meta property="og:image" content="http://kebingzao.com/2022/11/29/prometheus-4-alertmanager/11.png">
<meta property="og:image" content="http://kebingzao.com/2022/11/29/prometheus-4-alertmanager/12.png">
<meta property="og:image" content="http://kebingzao.com/2022/11/29/prometheus-4-alertmanager/13.png">
<meta property="og:image" content="http://kebingzao.com/2022/11/29/prometheus-4-alertmanager/14.png">
<meta property="og:image" content="http://kebingzao.com/2022/11/29/prometheus-4-alertmanager/15.png">
<meta property="og:image" content="http://kebingzao.com/2022/11/29/prometheus-4-alertmanager/16.png">
<meta property="og:image" content="http://kebingzao.com/2022/11/29/prometheus-4-alertmanager/17.png">
<meta property="og:image" content="http://kebingzao.com/2022/11/29/prometheus-4-alertmanager/18.png">
<meta property="og:image" content="http://kebingzao.com/2022/11/29/prometheus-4-alertmanager/19.png">
<meta property="og:image" content="http://kebingzao.com/2022/11/29/prometheus-4-alertmanager/20.png">
<meta property="og:image" content="http://kebingzao.com/2022/11/29/prometheus-4-alertmanager/21.png">
<meta property="og:updated_time" content="2023-12-01T17:07:56.501Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="基于 prometheus 打造监控报警后台 (4) - 使用 alertmanager 发送警报">
<meta name="twitter:description" content="前言通过 基于 prometheus 打造监控报警后台 (3) - 使用 grafana 创建仪表盘 我们已经能够在 grafana 上面创建漂亮的数据监控仪表盘了。 本节我们讲一下怎么在 prometheus 上设置预警并且发送警报。  简单的架构图如下  在 prometheus 监控系统中，采集与警报是分离的，所以是分为两个步骤的:  在 prometheus 中创建警报规则，并监控警报和触">
<meta name="twitter:image" content="http://kebingzao.com/2022/11/29/prometheus-4-alertmanager/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'KGVI6VPIBI',
      apiKey: '41c2ccc830ca183768a6bf1e50a03f44',
      indexName: 'test_blog',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://kebingzao.com/2022/11/29/prometheus-4-alertmanager/"/>





  <title>基于 prometheus 打造监控报警后台 (4) - 使用 alertmanager 发送警报 | Zach Ke's Notes</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <a href="https://github.com/kebingzao" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Zach Ke's Notes</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Quick notes</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kebingzao.com/2022/11/29/prometheus-4-alertmanager/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zach Ke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zach Ke's Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">基于 prometheus 打造监控报警后台 (4) - 使用 alertmanager 发送警报</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-11-29T18:11:11+08:00">
                2022-11-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/prometheus-相关/" itemprop="url" rel="index">
                    <span itemprop="name">prometheus 相关</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2022/11/29/prometheus-4-alertmanager/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2022/11/29/prometheus-4-alertmanager/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2022/11/29/prometheus-4-alertmanager/" class="leancloud_visitors" data-flag-title="基于 prometheus 打造监控报警后台 (4) - 使用 alertmanager 发送警报">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>通过 <a href="/2022/11/29/prometheus-3-grafana/" title="基于 prometheus 打造监控报警后台 (3) - 使用 grafana 创建仪表盘">基于 prometheus 打造监控报警后台 (3) - 使用 grafana 创建仪表盘</a> 我们已经能够在 grafana 上面创建漂亮的数据监控仪表盘了。</p>
<p>本节我们讲一下怎么在 prometheus 上设置预警并且发送警报。 </p>
<p>简单的架构图如下</p>
<p><img src="/2022/11/29/prometheus-4-alertmanager/1.png" alt=""></p>
<p>在 prometheus 监控系统中，采集与警报是分离的，所以是分为两个步骤的:</p>
<ol>
<li>在 prometheus 中创建警报规则，并监控警报和触发警报</li>
<li>触发警报之后(firing)，prometheus 将报警信息转发给独立组件 alertmanager，然后经过 alertmanager 对报警信息处理之后，最后通过接收器发送给指定用户</li>
</ol>
<p>同时 alertmanager 支持多种接收器(<code>receiver</code>), 比如 <code>Email</code>, <code>Slack</code> , <code>钉钉</code>, <code>企业微信</code> , <code>Webhook</code><br><a id="more"></a></p>
<h2 id="再添加一台-node-节点监控"><a href="#再添加一台-node-节点监控" class="headerlink" title="再添加一台 node 节点监控"></a>再添加一台 node 节点监控</h2><p>为了便于后面更好的测试警报， 我这边又在另外的云服务器上添加另一个 node_exporter 监控，对应配置改成:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &quot;vmware-host&quot;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets:</span><br><span class="line">        - localhost:9100</span><br><span class="line">        - 43.153.11.234:9100</span><br></pre></td></tr></table></figure></p>
<p>这时候 job <code>vmware-host</code> 就有两台实例主机监控了</p>
<p><img src="/2022/11/29/prometheus-4-alertmanager/2.png" alt=""></p>
<h2 id="创建警报规则"><a href="#创建警报规则" class="headerlink" title="创建警报规则"></a>创建警报规则</h2><p>prometheus 可以创建两种规则:</p>
<ol>
<li><a href="https://prometheus.io/docs/prometheus/latest/configuration/recording_rules/" target="_blank" rel="noopener">记录规则(<code>recording rules</code>)</a></li>
<li><a href="https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/" target="_blank" rel="noopener">警报规则(<code>alerting rules</code>)</a></li>
</ol>
<p>其中 <code>记录规则</code> 不在本次警报章节中，后面会单独开篇章讲述。 本章主要讲的是如何用 <code>警报规则</code> 创建一条警报</p>
<p>默认情况下，可以在 prometheus 的后台看到，其实并不会有 <code>警报规则</code>，以及对应的 alert 警报</p>
<p><img src="/2022/11/29/prometheus-4-alertmanager/3.png" alt=""></p>
<p><img src="/2022/11/29/prometheus-4-alertmanager/4.png" alt=""></p>
<h3 id="1-创建一条警报文件"><a href="#1-创建一条警报文件" class="headerlink" title="1. 创建一条警报文件"></a>1. 创建一条警报文件</h3><p>首先就要创建一个<code>警报规则</code>:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># 先在 prometheus 目录下创建一个 rules 目录，专门用来存放 rules 的 yml 文件</span><br><span class="line">[root@VM-64-9-centos prometheus]# mkdir rules</span><br><span class="line">[root@VM-64-9-centos prometheus]# cd rules</span><br><span class="line"></span><br><span class="line"># 接下来创建一个 test-1.yml 的 rule 文件， 使用 YAML 文件格式</span><br><span class="line"># 里面包含一条警报规则，就是监控 node 的节点存活</span><br><span class="line">[root@VM-64-9-centos rules]# cat test-1.yml </span><br><span class="line"># rules/test-1.yml</span><br><span class="line">groups:</span><br><span class="line">  - name: test-1</span><br><span class="line">    rules:</span><br><span class="line">      - alert: 节点存活</span><br><span class="line">        expr: up&#123;job=&quot;vmware-host&quot;&#125; == 0</span><br><span class="line">        for: 1m</span><br><span class="line">        labels:</span><br><span class="line">          level: critical</span><br><span class="line">        annotations:</span><br><span class="line">          summary: &quot;机器 &#123;&#123; $labels.instance &#125;&#125; 挂了&quot;</span><br><span class="line">          description: &quot;&#123;&#123;$labels.instance&#125;&#125; 宕机(当前值: &#123;&#123; $value &#125;&#125;)</span><br><span class="line"></span><br><span class="line"># 接下来使用工具检查 test-1.yml 的格式是否正常，一样用 promtool 检查</span><br><span class="line">[root@VM-64-9-centos prometheus]# ./promtool check rules rules/test-1.yml </span><br><span class="line">Checking rules/test-1.yml</span><br><span class="line">  SUCCESS: 1 rules found</span><br></pre></td></tr></table></figure></p>
<p>这样子就创建了一个警报规则文件叫做 <code>test-1.yml</code>, 里面包含了一条警报规则，名称叫做 <code>节点存活</code>, 并且有使用 promtool 工具有校验 rule 文件格式是正确的(如果格式不正确，将无法应用)。</p>
<blockquote>
<p>关于检查格式，如果 rules 目录下有多个规则文件，那么可以这样子一次性检查 <code>./promtool check rules rules/*.yml</code> 所有文件</p>
</blockquote>
<blockquote>
<p>一个规则文件里面可以包含多个警报规则，可以写在同一组 group 里面的 rules 下面，也可以单独写在另一个 group 中。</p>
</blockquote>
<p>为了使告警信息具有更好的可读性，prometheus 支持使用变量来获取指定标签中的值。比如 <code>$labels.&lt;labelname&gt;</code> 变量可以访问当前告警实例中指定标签的值。<code>$value</code> 可以获取当前 PromQL 表达式计算的样本值。</p>
<h3 id="2-将警报规则添加到-prometheus-配置文件中"><a href="#2-将警报规则添加到-prometheus-配置文件中" class="headerlink" title="2. 将警报规则添加到 prometheus 配置文件中"></a>2. 将警报规则添加到 prometheus 配置文件中</h3><p>在 prometheus 文件中，添加 <code>rule_files</code> 这个节点，其他不变<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># 编辑 prometheus.yml 添加 rule_files 节点，指定对应位置的警报规则文件</span><br><span class="line">[root@VM-64-9-centos prometheus]# cat prometheus.yml </span><br><span class="line">global:</span><br><span class="line">  scrape_interval: 15s</span><br><span class="line">  evaluation_interval: 15s</span><br><span class="line"></span><br><span class="line">rule_files:</span><br><span class="line">  - &quot;rules/test-1.yml&quot;</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &quot;prometheus&quot;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&quot;localhost:9090&quot;]</span><br><span class="line"></span><br><span class="line">  - job_name: &quot;vmware-host&quot;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets:</span><br><span class="line">        - localhost:9100</span><br><span class="line">        - 43.153.11.234:9100</span><br><span class="line"></span><br><span class="line"># 验证配置文件是否格式正确 (连同 rules 文件一起验证)</span><br><span class="line">[root@VM-64-9-centos prometheus]# ./promtool check config prometheus.yml </span><br><span class="line">Checking prometheus.yml</span><br><span class="line">  SUCCESS: 1 rule files found</span><br><span class="line"> SUCCESS: prometheus.yml is valid prometheus config file syntax</span><br><span class="line"></span><br><span class="line">Checking rules/test-1.yml</span><br><span class="line">  SUCCESS: 1 rules found</span><br><span class="line"></span><br><span class="line"># 重新加载配置文件，让 rules 文件生效</span><br><span class="line">[root@VM-64-9-centos prometheus]# curl -X POST localhost:9090/-/reload</span><br></pre></td></tr></table></figure></p>
<p>这边如果有多个 rules 文件要应用的话，可以这样子写<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rule_files:</span><br><span class="line">  - &quot;rules/*.yml&quot;</span><br></pre></td></tr></table></figure></p>
<p>或者这样子写:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rule_files:</span><br><span class="line">  - &quot;rules/test-1.yml&quot;</span><br><span class="line">  - &quot;rules/test-2.yml&quot;</span><br></pre></td></tr></table></figure></p>
<p>接下来就可以看到在 prometheus 的后台上， rules 和 alerts 都有值了</p>
<p><img src="/2022/11/29/prometheus-4-alertmanager/5.png" alt=""></p>
<p>可以看到出现了一个 group 为 <code>test-1</code> 的警报规则组， 里面有一条警报，名称为 <code>节点存活</code></p>
<p>alerts 那边也可以看到确实存在一个警告了， 但是处于 未激活的 <code>inactive</code> 状态， 这个说明当前状态是正常的</p>
<p><img src="/2022/11/29/prometheus-4-alertmanager/6.png" alt=""></p>
<h3 id="3-警报规则参数"><a href="#3-警报规则参数" class="headerlink" title="3. 警报规则参数"></a>3. 警报规则参数</h3><p>关于 rules 文件的参数配置，可以参照官方的文档: <a href="https://prometheus.io/docs/prometheus/latest/configuration/recording_rules/" target="_blank" rel="noopener">rules configuration</a></p>
<blockquote>
<p>记录规则 和 警报规则 的配置差别仅仅在于 <code>rules</code> 小节下的第一个配置的 key 是 record 还是 alert。 其他都一样</p>
</blockquote>
<p>整个 rule 文件是以一个 groups 规则组开头的:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">groups:</span><br><span class="line">  [ - &lt;rule_group&gt; ]</span><br></pre></td></tr></table></figure></p>
<p>里面可以包含各个规则组，记录规则 和 警报规则都可以写一起。 然后每一个组 <code>rule_group</code> 的参数如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 组名</span><br><span class="line">name: &lt;string&gt;</span><br><span class="line"></span><br><span class="line"># 规则评估间隔，没有设置就默认吃 prometheus 配置文件的这个 global.evaluation_interval 值</span><br><span class="line">[ interval: &lt;duration&gt; | default = global.evaluation_interval ]</span><br><span class="line"></span><br><span class="line"># 限制可触发警报数量，默认 0 表示不限制</span><br><span class="line"># 如果有设置的话，一旦由该组规则触发的警报大于这个值，之后将不会触发这个规则引起的警报</span><br><span class="line">[ limit: &lt;int&gt; | default = 0 ]</span><br><span class="line"></span><br><span class="line">rules:</span><br><span class="line">  [ - &lt;rule&gt; ... ]</span><br></pre></td></tr></table></figure></p>
<p>接下来就是单个 rule 的配置, 分两种语法，一种是记录规则，一种是警报，我们本次只讲警报规则配置。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 警报规则的名称</span><br><span class="line">alert: &lt;string&gt;</span><br><span class="line"></span><br><span class="line"># 评估执行的 PromQL 语法表达式，结果应该是 true 或者 false</span><br><span class="line"># 如果为 true，那么就会触发警报，警报的状态就会从 inactive 的未激活，转换为 pending 或者 firing</span><br><span class="line">expr: &lt;string&gt;</span><br><span class="line"></span><br><span class="line"># 等待期，一旦规则警报被触发之后，会变成 pending 中间态，这时候就会进入等待期</span><br><span class="line"># 如果等待期内，该规则警报没有重新变成正常（也就是在这期间的评估结果有一次 expr 的执行结果为 false, 状态就会变成 inactive 的正常态), 状态就会变成结束态的 firing。 然后 prometheus 就会将这个警报发送给 alertmanager</span><br><span class="line"># 如果为 0 的话，将直接跳过 pending 状态，一旦评估的 expr 为 true，那么马上变成 firing 状态</span><br><span class="line">[ for: &lt;duration&gt; | default = 0s ]</span><br><span class="line"></span><br><span class="line"># 警报标签,可自己定制，这个添加的标签，可以被模板提取出来</span><br><span class="line">labels:</span><br><span class="line">  [ &lt;labelname&gt;: &lt;tmpl_string&gt; ]</span><br><span class="line"></span><br><span class="line"># 警报的注释，用于描述，比如后面发送邮件 或者 钉钉通知的话，用得着，也可以被模板提取出来</span><br><span class="line">annotations:</span><br><span class="line">  [ &lt;labelname&gt;: &lt;tmpl_string&gt; ]</span><br></pre></td></tr></table></figure></p>
<p>这边需要注意的是， for 这个参数，一般我们不希望偶尔的网络波动导致 prometheus 抓取数据失败，就会马上触发警报(firing 状态)，从而就收到警报邮件了，因此我们就会设置一个比较合理的等待值。 在等待周期之内，如果触发评估规则了，并且 expr 表达式为 false，那么就会将状态变成 inactive，这时候就不会触发警报了</p>
<p>这个值要大于评估周期 <code>evaluation_interval</code> 才有价值，比如评估周期是 15s， 然后 for 设置的是 20s，然后触发顺序是这样子:</p>
<ol>
<li>触发评估周期，然后执行 expr 表达式，为 true， 警报状态从 <code>inactive</code> 变成 <code>pending</code>, 进入等待期(执行 for 子句)</li>
<li>过了 15s，又触发评估周期，执行 expr 表达式，这时候就有两种情况:<br>2.1 执行结果为 true，但是还没有到 for 的 20s，继续保持 pending 状态，然后又过了 5s，for 的等待期结束，状态从 <code>pending</code> 变成 <code>firing</code>, 触发警报， prometheus 将这个警报扔给 alertmanager 处理<br>2.2 执行结果为 false，警报状态从 <code>pending</code> 变成 <code>inactive</code>， 警报恢复正常，重新等待下一轮评估</li>
</ol>
<p>所以我们刚才的那个配置，其实就是我们有一个叫做 <code>test-1</code> 的规则警报组，里面有一条警报叫 <code>节点存活</code>, 评估周期是 15s， 抓取周期是 15s，等待周期是 1 分钟，然后判断的表达式是 <code>up{job=&quot;vmware-host&quot;} == 0</code></p>
<h3 id="4-警报的状态"><a href="#4-警报的状态" class="headerlink" title="4. 警报的状态"></a>4. 警报的状态</h3><p>prometheus 警报有 4 种状态:</p>
<ul>
<li><strong>inactive</strong> -&gt; 非活动状态，表示正在监控，但是还未有任何警报触发</li>
<li><strong>pending</strong> -&gt; 警报被触发，但是在等待期内，如果等待期内没有恢复正常，就会转化为 firing</li>
<li><strong>firing</strong> -&gt; 结束态，警报已经触发，prometheus 将按照配置将报警信息发送给 alertmanager</li>
<li><strong>resolve</strong> -&gt; 恢复态，如果是 firing 状态，后面又恢复正常，警报又会重新变成 inactive。 这时候 prometheus 就会发送一个 resolve 的恢复态给 alertmanager，让 alertmanager 发送报警恢复邮件 (假设有配置的话)</li>
</ul>
<p>虽然以上有 4 种，但是对于 prometheus 的警报来说， 只有前三种，因为对于状态显示来说， 第四种的恢复态，其实就是第一种的 inactive。 也就是只有 alertmanager 才需要恢复态</p>
<p>所以对于 alertmanager 的警报来说，只有两种状态: firing 和 resolve， 因为 prometheus server 传递给 alertmanager 的状态就只有这两个状态</p>
<h3 id="5-抓取周期-scrape-interval-和-评估周期-evaluation-interval"><a href="#5-抓取周期-scrape-interval-和-评估周期-evaluation-interval" class="headerlink" title="5. 抓取周期(scrape_interval) 和 评估周期 (evaluation_interval)"></a>5. 抓取周期(scrape_interval) 和 评估周期 (evaluation_interval)</h3><p>在 prometheus server 中， 抓取周期 和 评估周期是分开的，可以各自设置。 但是最好评估周期要 大于等于 抓取周期。 不能小于， 不然就会出现评估的时候，取的是旧值，导致误报。</p>
<p>举个例子，假设抓取周期是 2 分钟， 然后评估周期是 15s， 等待周期是 1m，这时候就会出现这种情况:</p>
<ol>
<li>第一次抓取的时候，节点挂了， up 为 0</li>
<li>15s 后触发评估周期，发现节点挂了，状态变成 pending， 启动等待周期 1m</li>
<li>又过了 10s，节点启动正常</li>
<li>又过了 5s，触发第二次评估，但是因为还没有触发抓取周期，评估的数据还是旧的，所以判断还是 pending</li>
<li>又过了 45s，期间触发了 3 轮的评估，因为都是旧值，同时因为过了等待周期，状态变为 firing，触发报警</li>
<li>又过了一分钟， 触发抓取周期，节点正常，同时时间周期也触发了评估周期，表达式返回 false， 状态从 firing 变成 inactive，警报恢复正常</li>
</ol>
<p>以上就会有误报的情况。</p>
<p>所以再有等待期(for 不为 0)的情况下，其实就是 <code>for 等待周期</code> &gt;= <code>评估周期</code> &gt;= <code>抓取周期</code></p>
<h3 id="6-操作触发警报"><a href="#6-操作触发警报" class="headerlink" title="6. 操作触发警报"></a>6. 操作触发警报</h3><p>我们将 prometheus 这一台的 node_exporter 节点服务停止<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-64-9-centos prometheus]# systemctl stop node_exporter.service</span><br></pre></td></tr></table></figure></p>
<p>因为抓取周期和评估周期是 15s，所以这时候就可以看到 alert 状态变成 pending 了</p>
<p><img src="/2022/11/29/prometheus-4-alertmanager/7.png" alt=""></p>
<p>然后过了一分钟之后，过了等待期，彻底变成 firing 了</p>
<p><img src="/2022/11/29/prometheus-4-alertmanager/8.png" alt=""></p>
<p>同时实例监控这边，会有显示有一个节点 down  了</p>
<p><img src="/2022/11/29/prometheus-4-alertmanager/9.png" alt=""></p>
<p>接下来我们将这个 node_exporter 重新启动，可以看到一旦到新一轮的评估周期，就会变成正常的 inactive</p>
<p>接下来也试过先关掉服务，然后再过了等待期之前，再开启服务，这时候只要新一轮的评估周期在等待期内，一样会从 pending 变成 inactive，不会触发 firing</p>
<h3 id="7-警报规则的单元测试"><a href="#7-警报规则的单元测试" class="headerlink" title="7. 警报规则的单元测试"></a>7. 警报规则的单元测试</h3><p>我们可以用 <code>promtool</code> 来对警报规则进行单元测试: 具体可以看官方文档: <a href="https://prometheus.io/docs/prometheus/latest/configuration/unit_testing_rules/" target="_blank" rel="noopener">规则的单元测试</a></p>
<h2 id="alertmanager"><a href="#alertmanager" class="headerlink" title="alertmanager"></a>alertmanager</h2><p>我们已经能够从 prometheus server 中创建警报规则，并成功触发警报了， 但是我们还缺少触发之后的报警手段，比如发送 mail 到运维人员之类的手段</p>
<h3 id="1-安装"><a href="#1-安装" class="headerlink" title="1. 安装"></a>1. 安装</h3><p>而这个就是 alertmanager 所要做的功能。 alertmanager 是一个独立的服务，因为我们要单独安装, 下载地址: <a href="https://prometheus.io/download/" target="_blank" rel="noopener">download</a>, 一样采用二进制包的方式安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># 下载解压，重命名</span><br><span class="line">[root@VM-64-9-centos ~]# cd /usr/local/</span><br><span class="line">[root@VM-64-9-centos local]# wget https://github.com/prometheus/alertmanager/releases/download/v0.24.0/alertmanager-0.24.0.linux-amd64.tar.gz</span><br><span class="line">[root@VM-64-9-centos local]# tar zxf alertmanager-0.24.0.linux-amd64.tar.gz</span><br><span class="line">[root@VM-64-9-centos local]# mv alertmanager-0.24.0.linux-amd64  alertmanager</span><br><span class="line"></span><br><span class="line"># 指定 owner</span><br><span class="line">[root@VM-64-9-centos local]# chown root.root alertmanager -R</span><br><span class="line"></span><br><span class="line"># 创建 system 启动脚本</span><br><span class="line">[root@VM-64-9-centos local]# cat  /usr/lib/systemd/system/alertmanager.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Alertmanager</span><br><span class="line">Documentation=https://prometheus.io/</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/usr/local/alertmanager/alertmanager --config.file=/usr/local/alertmanager/alertmanager.yml</span><br><span class="line">ExecStop=/bin/kill -s QUIT $MAINPID</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"># 设置开机自启动，并启动服务</span><br><span class="line">[root@VM-64-9-centos local]# systemctl daemon-reload</span><br><span class="line">[root@VM-64-9-centos local]# systemctl enable alertmanager</span><br><span class="line">[root@VM-64-9-centos local]# systemctl start alertmanager</span><br><span class="line"></span><br><span class="line"># 查看服务</span><br><span class="line">[root@VM-64-9-centos local]# netstat -anlp  | grep  alert</span><br><span class="line">tcp6       0      0 :::9093                 :::*                    LISTEN      601/alertmanager</span><br></pre></td></tr></table></figure></p>
<p>这样子就安装好了，alertmanager 有自己的查看后台， <code>http://ip:9093</code></p>
<p><img src="/2022/11/29/prometheus-4-alertmanager/10.png" alt=""></p>
<p>可以看到，因为刚安装，也没有关联 prometheus， 所以没有警报信息</p>
<h3 id="2-设置配置文件"><a href="#2-设置配置文件" class="headerlink" title="2. 设置配置文件"></a>2. 设置配置文件</h3><p>接下来我们配置一下配置文件，默认的配置文件是这样子的，在<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-64-9-centos alertmanager]# cat /usr/local/alertmanager/alertmanager.yml</span><br><span class="line">route:</span><br><span class="line">  group_by: [&apos;alertname&apos;]</span><br><span class="line">  group_wait: 30s</span><br><span class="line">  group_interval: 5m</span><br><span class="line">  repeat_interval: 1h</span><br><span class="line">  receiver: &apos;web.hook&apos;</span><br><span class="line">receivers:</span><br><span class="line">  - name: &apos;web.hook&apos;</span><br><span class="line">    webhook_configs:</span><br><span class="line">      - url: &apos;http://127.0.0.1:5001/&apos;</span><br><span class="line">inhibit_rules:</span><br><span class="line">  - source_match:</span><br><span class="line">      severity: &apos;critical&apos;</span><br><span class="line">    target_match:</span><br><span class="line">      severity: &apos;warning&apos;</span><br><span class="line">    equal: [&apos;alertname&apos;, &apos;dev&apos;, &apos;instance&apos;]</span><br></pre></td></tr></table></figure></p>
<p>配置了以下规则:</p>
<ol>
<li>配置了几个时间设置间隔</li>
<li>配置了分组方式(根据标签名 <code>alertname</code> 来分组)</li>
<li>配置了 webhook 的接收者，方式是发送 webhook endpoint api</li>
<li>配置抑制(<code>inhibit_rules</code>)规则</li>
</ol>
<p>我们稍微改造一下，改成用 mail 来做接收者。 具体改为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># 编辑调整</span><br><span class="line">[root@VM-64-9-centos alertmanager]# cat alertmanager.yml </span><br><span class="line">global:</span><br><span class="line">  smtp_smarthost: &apos;smtp.qq.com:25&apos;</span><br><span class="line">  smtp_from: &apos;z***e@foxmail.com&apos;</span><br><span class="line">  smtp_auth_username: &apos;z***e@foxmail.com&apos;</span><br><span class="line">  smtp_auth_password: &apos;ypgtxxxxxxxxxxxxx&apos; </span><br><span class="line">  smtp_require_tls: false</span><br><span class="line">route:</span><br><span class="line">  group_by: [&apos;alertname&apos;]</span><br><span class="line">  group_wait: 30s</span><br><span class="line">  group_interval: 5m</span><br><span class="line">  repeat_interval: 10m</span><br><span class="line">  receiver: default-receiver</span><br><span class="line">receivers:</span><br><span class="line">  - name: &apos;default-receiver&apos;</span><br><span class="line">    email_configs:</span><br><span class="line">    - to: &apos;k****o@gmail.com&apos;</span><br><span class="line"></span><br><span class="line"># 使用工具检查 yml 格式</span><br><span class="line">[root@VM-64-9-centos alertmanager]# ./amtool check-config alertmanager.yml</span><br><span class="line">Checking &apos;alertmanager.yml&apos;  SUCCESS</span><br><span class="line">Found:</span><br><span class="line"> - global config</span><br><span class="line"> - route</span><br><span class="line"> - 0 inhibit rules</span><br><span class="line"> - 1 receivers</span><br><span class="line"> - 0 templates</span><br><span class="line"></span><br><span class="line"># 重启服务使得配置生效</span><br><span class="line">[root@VM-64-9-centos alertmanager]# systemctl restart alertmanager.service</span><br></pre></td></tr></table></figure>
<p>其实就是去掉了抑制配置，将接收者改成 mail 邮箱，同时增加了 mail 配置，其他都不变。</p>
<blockquote>
<p>关于怎么用 qq 邮箱配置 smtp 邮箱服务，可以看我之前的文章: <a href="/2022/10/31/sentry-2/" title="bug 追踪系统 Sentry (2) -- 账号初始化和邮件发送配置">bug 追踪系统 Sentry (2) -- 账号初始化和邮件发送配置</a></p>
</blockquote>
<p>二进制包安装的目标目录下有自带一个 yml 文件校验工具 <code>amtool</code>, 可以用它来校验 alertmanager 的配置文件是否格式正确</p>
<blockquote>
<p>事实上， amtool 不仅仅是校验工具怎么简单，他还是一个可以配置 alertmanager 的 cli 命令工具， 感兴趣的可以看官方文档: <a href="https://github.com/prometheus/alertmanager#amtool" target="_blank" rel="noopener">amtool</a></p>
</blockquote>
<p>上面的 yml 文件配置其实是有一些缺省默认值的，具体看完整的配置，我们可以在 alertmanager 后台的 status 查看: <code>http://ip:9093/#/status</code></p>
<blockquote>
<p>后面会讲到这些配置项的含义</p>
</blockquote>
<p><img src="/2022/11/29/prometheus-4-alertmanager/11.png" alt=""></p>
<h3 id="3-prometheus-关联-alertmanager"><a href="#3-prometheus-关联-alertmanager" class="headerlink" title="3. prometheus 关联 alertmanager"></a>3. prometheus 关联 alertmanager</h3><p>接下来就要在 prometheus 管理 alertmanager 服务了，加 <code>alerting</code> 这个节点就行了，其他不变<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># 添加 alerting 小节，将 alertmanager 服务加上去</span><br><span class="line">[root@VM-64-9-centos prometheus]# cat prometheus.yml </span><br><span class="line">global:</span><br><span class="line">  scrape_interval: 15s</span><br><span class="line">  evaluation_interval: 15s</span><br><span class="line"></span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">    - static_configs:</span><br><span class="line">        - targets:</span><br><span class="line">          - &quot;localhost:9093&quot;</span><br><span class="line"></span><br><span class="line">rule_files:</span><br><span class="line">  - &quot;rules/test-1.yml&quot;</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &quot;prometheus&quot;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&quot;localhost:9090&quot;]</span><br><span class="line"></span><br><span class="line">  - job_name: &quot;vmware-host&quot;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets:</span><br><span class="line">        - localhost:9100</span><br><span class="line">        - 43.153.11.234:9100</span><br><span class="line"></span><br><span class="line"># 检查语法</span><br><span class="line">[root@VM-64-9-centos prometheus]# ./promtool check config prometheus.yml </span><br><span class="line">Checking prometheus.yml</span><br><span class="line">  SUCCESS: 1 rule files found</span><br><span class="line"> SUCCESS: prometheus.yml is valid prometheus config file syntax</span><br><span class="line"></span><br><span class="line">Checking rules/test-1.yml</span><br><span class="line">  SUCCESS: 1 rules found</span><br><span class="line"></span><br><span class="line"># 更新配置文件</span><br><span class="line">[root@VM-64-9-centos prometheus]# curl -X POST localhost:9090/-/reload</span><br></pre></td></tr></table></figure></p>
<h3 id="4-测试警报发送"><a href="#4-测试警报发送" class="headerlink" title="4. 测试警报发送"></a>4. 测试警报发送</h3><p>接下来我们测试警报发送， 将 prometheus server 这一台的 node_exporter 服务关闭:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop node_exporter.service</span><br></pre></td></tr></table></figure></p>
<p>接下来可以看到，警报名称为 <code>节点存活</code> 的状态变化 <code>inactive</code> -&gt; <code>pending</code> -&gt; <code>firing</code></p>
<p>当变成 firing 的时候，这时候 alertmanager 就会接收到这一台报警消息，这时候就可以收到这一封报警邮件了</p>
<p><img src="/2022/11/29/prometheus-4-alertmanager/12.png" alt=""></p>
<p>同时在 alertmanager 后台，我们也可以看到有触发这个警报了</p>
<p><img src="/2022/11/29/prometheus-4-alertmanager/13.png" alt=""></p>
<p>因为没有设置邮件模板，所以他用的是 alertmanager 的默认的模板， 所以没有明确在 yml 文件配置，但是补上这些默认的缺省值的话，  receivers 这一块邮箱的配置应该是:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">receivers:</span><br><span class="line">- name: default-receiver</span><br><span class="line">  email_configs:</span><br><span class="line">  - send_resolved: false</span><br><span class="line">    to: k****o@gmail.com</span><br><span class="line">    from: z***e@foxmail.com</span><br><span class="line">    hello: localhost</span><br><span class="line">    smarthost: smtp.qq.com:25</span><br><span class="line">    auth_username: z***e@foxmail.com</span><br><span class="line">    auth_password: &lt;secret&gt;</span><br><span class="line">    headers:</span><br><span class="line">      From: z***e@foxmail.com</span><br><span class="line">      Subject: &apos;&#123;&#123; template &quot;email.default.subject&quot; . &#125;&#125;&apos;</span><br><span class="line">      To: k****o@gmail.com</span><br><span class="line">    html: &apos;&#123;&#123; template &quot;email.default.html&quot; . &#125;&#125;&apos;</span><br><span class="line">    require_tls: false</span><br><span class="line">templates: []</span><br></pre></td></tr></table></figure></p>
<h3 id="5-配置文件参数解析"><a href="#5-配置文件参数解析" class="headerlink" title="5. 配置文件参数解析"></a>5. 配置文件参数解析</h3><p>接下来我们详细讲一下 alertmanager 的 yml 配置文件的相关配置参数，一样直接参照官方配置文档: <a href="https://prometheus.io/docs/alerting/latest/configuration/" target="_blank" rel="noopener">alertmanager 配置文档</a></p>
<blockquote>
<p>这边参照的是当前最新的 <code>0.24</code> 版本，后面如果版本有继续迭代，可能会出现有些参数不一样</p>
</blockquote>
<p>关于 alertmanager 的配置文件的配置，官方也有提供了 example 参考: <a href="https://github.com/prometheus/alertmanager/blob/main/doc/examples/simple.yml" target="_blank" rel="noopener">alertmanager simple.yml</a></p>
<h4 id="5-1-global"><a href="#5-1-global" class="headerlink" title="5.1. global"></a>5.1. <a href="https://prometheus.io/docs/alerting/latest/configuration/#configuration-file" target="_blank" rel="noopener">global</a></h4><p>配置文件，一样分为 7 个小节:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"># 全局配置，有些可被下面的具体配置替换</span><br><span class="line">global:</span><br><span class="line">  # smtp 相关的邮箱发送配置</span><br><span class="line">  # 邮件发送来源，很多时候要跟 username 的发送邮箱同一个</span><br><span class="line">  [ smtp_from: &lt;tmpl_string&gt; ]</span><br><span class="line">  # smtp 协议的发送端点</span><br><span class="line">  [ smtp_smarthost: &lt;string&gt; ]</span><br><span class="line">  # 定义的主机名称 (hostname)</span><br><span class="line">  [ smtp_hello: &lt;string&gt; | default = &quot;localhost&quot; ]</span><br><span class="line">  # 登录的用户名和密码，以及对应的一些加密协议</span><br><span class="line">  [ smtp_auth_username: &lt;string&gt; ]</span><br><span class="line">  [ smtp_auth_password: &lt;secret&gt; ]</span><br><span class="line">  [ smtp_auth_identity: &lt;string&gt; ]</span><br><span class="line">  [ smtp_auth_secret: &lt;secret&gt; ]</span><br><span class="line">  # 是否启用 tls 加密，默认启用</span><br><span class="line">  [ smtp_require_tls: &lt;bool&gt; | default = true ]</span><br><span class="line"></span><br><span class="line">  # 一些第三方的 receivers 配置</span><br><span class="line">  [ slack_api_url: &lt;secret&gt; ]</span><br><span class="line">  [ slack_api_url_file: &lt;filepath&gt; ]</span><br><span class="line">  [ victorops_api_key: &lt;secret&gt; ]</span><br><span class="line">  [ victorops_api_url: &lt;string&gt; | default = &quot;https://alert.victorops.com/integrations/generic/20131114/alert/&quot; ]</span><br><span class="line">  [ pagerduty_url: &lt;string&gt; | default = &quot;https://events.pagerduty.com/v2/enqueue&quot; ]</span><br><span class="line">  [ opsgenie_api_key: &lt;secret&gt; ]</span><br><span class="line">  [ opsgenie_api_key_file: &lt;filepath&gt; ]</span><br><span class="line">  [ opsgenie_api_url: &lt;string&gt; | default = &quot;https://api.opsgenie.com/&quot; ]</span><br><span class="line">  [ wechat_api_url: &lt;string&gt; | default = &quot;https://qyapi.weixin.qq.com/cgi-bin/&quot; ]</span><br><span class="line">  [ wechat_api_secret: &lt;secret&gt; ]</span><br><span class="line">  [ wechat_api_corp_id: &lt;string&gt; ]</span><br><span class="line">  [ telegram_api_url: &lt;string&gt; | default = &quot;https://api.telegram.org&quot; ]</span><br><span class="line">  # http 客户端配置，允许配置接收方用来与基于 HTTP 的 API 服务通信的 HTTP 客户端</span><br><span class="line">  [ http_config: &lt;http_config&gt; ]</span><br><span class="line"></span><br><span class="line">  # 如果超过这个时间段，prometheus 那边没有给出警报的状态更新，alertmanager 就默认这个警报已经解决</span><br><span class="line">  # 对于 alertmanager 来说，哪怕 prometheus 一直给 firing 状态，那也是警报有新的状态更新</span><br><span class="line">  # 一定是要那种没有任何状态值给过来的，比如 prometheus server 挂了，或者 rules 警报规则被删除了这种</span><br><span class="line">  [ resolve_timeout: &lt;duration&gt; | default = 5m ]</span><br><span class="line"></span><br><span class="line"># 模板文件目录</span><br><span class="line"># 警报模板可以自定义通知的信息格式，以及其包含的对应警报指标数据，可以自定义Email、企业微信的模板，配置指定的存放位置</span><br><span class="line">templates:</span><br><span class="line">  [ - &lt;filepath&gt; ... ]</span><br><span class="line"></span><br><span class="line"># 警报的路由树</span><br><span class="line">route: &lt;route&gt;</span><br><span class="line"></span><br><span class="line"># 警报通知接收者配置</span><br><span class="line">receivers:</span><br><span class="line">  - &lt;receiver&gt; ...</span><br><span class="line"></span><br><span class="line"># 抑制规则配置</span><br><span class="line">inhibit_rules:</span><br><span class="line">  [ - &lt;inhibit_rule&gt; ... ]</span><br><span class="line"></span><br><span class="line"># 静音/激活 的时间间隔的一组数据</span><br><span class="line"># 他配置的时间点和名称，要匹配 route 节点下的 mute_time_intervals 或者 active_time_intervals</span><br><span class="line">time_intervals:</span><br><span class="line">  [ - &lt;time_interval&gt; ... ]</span><br></pre></td></tr></table></figure></p>
<p>具体的描述，官方文档写的很清楚了， 接下来主要看这个 <code>route</code> 节点的配置</p>
<h4 id="5-2-route"><a href="#5-2-route" class="headerlink" title="5.2. route"></a>5.2. <a href="https://prometheus.io/docs/alerting/latest/configuration/#route" target="_blank" rel="noopener">route</a></h4><p>警报路由节点(<code>route</code>) 描述了在收到 prometheus 生成的警报后，将警报信息发送给接收器 receiver 指定的目标地址规则。 alertmanager 对传入的警报信息进行处理，根据所定义的规则与配置进行匹配。</p>
<p>对于路由可以理解为树状结构，设置的第一个 route 是 root route，往下的就是包含的子节点(子节点的可配置参数跟根节点一样)，每个警报传进来以后，会从配置的跟节点路由进入路由树，按照深度优先从左向右遍历匹配，当匹配的节点后停止，进行警报处理。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"># 接收器名称，如果下面的子 route 节点没有匹配到，就采用这个默认的接收器</span><br><span class="line"># 如果没有设置子节点，也是用这个</span><br><span class="line">[ receiver: &lt;string&gt; ]</span><br><span class="line"></span><br><span class="line"># 根据 prometheus 的 lables 进行报警分组，这些警报会合并为一个通知发送给接收器，也就是警报分组。</span><br><span class="line"># 后面关于 alertmanager 的分组特性，会单独挑一个小篇幅来实践</span><br><span class="line">[ group_by: &apos;[&apos; &lt;labelname&gt;, ... &apos;]&apos; ]</span><br><span class="line"></span><br><span class="line"># 警报是否应继续匹配后续的兄弟节点，默认为 false， 即一旦匹配上，就采用当前这个，不再继续匹配</span><br><span class="line">[ continue: &lt;boolean&gt; | default = false ]</span><br><span class="line"></span><br><span class="line"># 一组匹配规则，通过正则表达式来匹配</span><br><span class="line">matchers:</span><br><span class="line">  [ - &lt;matcher&gt; ... ]</span><br><span class="line"></span><br><span class="line"># 设置从接受警报到发送的等待时间，若在等待时间中group接收到新的警报信息，这些警报会合并为一条发送</span><br><span class="line">[ group_wait: &lt;duration&gt; | default = 30s ]</span><br><span class="line"></span><br><span class="line"># 此设置控制的是 group 之间发送警报通知的间隔时间</span><br><span class="line">[ group_interval: &lt;duration&gt; | default = 5m ]</span><br><span class="line"></span><br><span class="line"># 此设置控制的是警报发送成功以后，没有对警报做解决操作的话，状态 Firing 没有变成 Inactive 或者 Pending ，会再次发送警报的的间隔时间。</span><br><span class="line">[ repeat_interval: &lt;duration&gt; | default = 4h ]</span><br><span class="line"></span><br><span class="line"># 路由应该静音的时间段</span><br><span class="line"># root route 不设置这个，一般在 routes 树下面的子 route 节点设置</span><br><span class="line"># 如果有配置的话，那么在静音期间，哪怕 prometheus 发送警报过来， alertmanager 也不会发送警报通知</span><br><span class="line"># 他的值是一个 string，也就是上述 time_intervals 所配置的时间段所设置的 name</span><br><span class="line">mute_time_intervals:</span><br><span class="line">  [ - &lt;string&gt; ...]</span><br><span class="line"></span><br><span class="line"># 路由应该处于活动状态的时间段，默认的空值代表始终处于活动状态，</span><br><span class="line"># root route 不设置这个，一般在 routes 树下面的子 route 节点设置</span><br><span class="line"># 只有处于活动状态的时候，alertmanager 才会发送警报通知</span><br><span class="line"># 他的值是一个 string，也就是上述 time_intervals 所配置的时间段所设置的 name</span><br><span class="line"># 比如我如果只想在 周一到周五 才想收到邮件， 那么就可以配置这个， 后面会有例子</span><br><span class="line">active_time_intervals:</span><br><span class="line">  [ - &lt;string&gt; ...]</span><br><span class="line"></span><br><span class="line"># 匹配路由树，上面的每一个 route 配置就跟 root route 配置一样</span><br><span class="line">routes:</span><br><span class="line">  [ - &lt;route&gt; ... ]</span><br></pre></td></tr></table></figure></p>
<p>上面的配置有点抽象，我们可以用一个例子说一下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"># root route 节点</span><br><span class="line">route:</span><br><span class="line">  # 默认接收器</span><br><span class="line">  receiver: &apos;default-receiver&apos;</span><br><span class="line">  # 收到警报后，如果在 30s 内还有其他同组的报警，那么就合并成一条报警通知</span><br><span class="line">  group_wait: 30s</span><br><span class="line">  # 收到警报后，判断上一条同一组的警报是否是 5 分钟之前，如果是之前，那么等待上述的 30s 过后，就立马发送</span><br><span class="line">  # 如果上一条同组的发送间隔还不足 5 分钟，这时候就等间隔达到了 5 分钟，再发送</span><br><span class="line">  group_interval: 5m</span><br><span class="line">  # 发送警报间隔，如果 4h 之后，该警报还是没有修复，哪怕警报内容重复，也要再次发送报警通知</span><br><span class="line">  repeat_interval: 4h</span><br><span class="line">  # 分组依据，根据 prometheus 的 labels 进行报警分组</span><br><span class="line">  # 以下标签中，根据 cluster 和 alertname 这两个的值来分组</span><br><span class="line">  group_by: [cluster, alertname]</span><br><span class="line">  # 子路由节点</span><br><span class="line">  routes:</span><br><span class="line">  # 组内等待时间 10s，并且警报的 service 标签是 mysql 或者 cassandra 的警报，那么他的接收者是 database-pager</span><br><span class="line">  - receiver: &apos;database-pager&apos;</span><br><span class="line">    group_wait: 10s</span><br><span class="line">    matchers:</span><br><span class="line">    - service=~&quot;mysql|cassandra&quot;</span><br><span class="line">    </span><br><span class="line">  # 匹配 team=&quot;frontend&quot;, 那么就按照 product 和 environment 这两个标签的值来分组，并且设置接收者是 frontend-pager</span><br><span class="line">  - receiver: &apos;frontend-pager&apos;</span><br><span class="line">    group_by: [product, environment]</span><br><span class="line">    matchers:</span><br><span class="line">    - team=&quot;frontend&quot;</span><br><span class="line"></span><br><span class="line">  # 匹配 service=&quot;inhouse-service&quot; 标签，并且在下班时间和节假日时间是静音，不发送通知给接收者 dev-pager</span><br><span class="line">  # 同时继续往下匹配</span><br><span class="line">  - receiver: &apos;dev-pager&apos;</span><br><span class="line">    matchers:</span><br><span class="line">      - service=&quot;inhouse-service&quot;</span><br><span class="line">    mute_time_intervals:</span><br><span class="line">      - offhours</span><br><span class="line">      - holidays</span><br><span class="line">    continue: true</span><br><span class="line"></span><br><span class="line">    # 匹配 service=&quot;inhouse-service&quot; 标签, 并且只有在下班时间和节假日才会生效，如果生效，就发送给 on-call-pager 接收者</span><br><span class="line">    # 简单的来说，如果是下班时间和节假日的警报，那么普通预警比如发邮件之类的不够， 采用打电话之类的预警</span><br><span class="line">  - receiver: &apos;on-call-pager&apos;</span><br><span class="line">    matchers:</span><br><span class="line">      - service=&quot;inhouse-service&quot;</span><br><span class="line">    active_time_intervals:</span><br><span class="line">      - offhours</span><br><span class="line">      - holidays</span><br></pre></td></tr></table></figure></p>
<p>简单的来说，路由匹配的执行步骤如下：</p>
<ol>
<li>先判断警报的 service 标签是 mysql 或者 cassandra，如果是就给接收者 database-pager，然后结束, 同时继承 root route 的 group by，按照 cluster 和 alertname 这两个标签的值来分组</li>
<li>如果不是，匹配 team=”frontend”, 同时按照 product 和 environment 这两个标签的值来分组 (重写了 root route 的 group by)，抛给接收者 frontend-pager，然后结束</li>
<li>如果还不是，匹配 service=”inhouse-service” 标签，然后分为两种<br>3.1 如果当前不是下班时间和节假日时间，那么就通知给接收者 dev-pager，然后继续匹配到下一条规则，有匹配到但是因为不满足 下班时间和节假日 的激活时间，不发送给接收者 on-call-pager<br>3.2 如果当前是下班时间和节假日时间，那么当前是静音状态，不发送接收者 dev-pager，然后继续匹配到下一条规则，有匹配到，同时满足激活条件，发送给接收者 on-call-pager</li>
<li>如果都不匹配，发送给默认的接收者 default-receiver</li>
</ol>
<h4 id="5-3-time-intervals"><a href="#5-3-time-intervals" class="headerlink" title="5.3. time_intervals"></a>5.3. <a href="https://prometheus.io/docs/alerting/latest/configuration/#time_interval" target="_blank" rel="noopener">time_intervals</a></h4><p>其中 <code>offhours</code> 和 <code>holidays</code> 这两个 <code>time_intervals</code> 是要在上述的子节点 <code>time_intervals</code> 配置的，比如这样子:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">time_intervals:</span><br><span class="line">  - name: holidays</span><br><span class="line">    time_intervals:</span><br><span class="line">      - weekdays: [&apos;saturday&apos;, &apos;sunday&apos;]</span><br><span class="line">  - name: offhours</span><br><span class="line">    time_intervals:</span><br><span class="line">      - times:</span><br><span class="line">        - start_time: 18:00</span><br><span class="line">          end_time: 24:00</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>以上的时区都是 UTC 时区，目前不支持其他时区</p>
</blockquote>
<h4 id="5-4-receiver"><a href="#5-4-receiver" class="headerlink" title="5.4. receiver"></a>5.4. <a href="https://prometheus.io/docs/alerting/latest/configuration/#receiver" target="_blank" rel="noopener">receiver</a></h4><p>接受器是一个统称，每个 receiver 都有需要设置一个全局唯一的名称，并且对应一个或者多个通知方式，包括 email 、微信、 Slack 、钉钉等。</p>
<p>接下来我们看一下接收者 (<code>receiver</code>) 的配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># The unique name of the receiver.</span><br><span class="line">name: &lt;string&gt;</span><br><span class="line"></span><br><span class="line"># Configurations for several notification integrations.</span><br><span class="line">email_configs:</span><br><span class="line">  [ - &lt;email_config&gt;, ... ]</span><br><span class="line">opsgenie_configs:</span><br><span class="line">  [ - &lt;opsgenie_config&gt;, ... ]</span><br><span class="line">pagerduty_configs:</span><br><span class="line">  [ - &lt;pagerduty_config&gt;, ... ]</span><br><span class="line">pushover_configs:</span><br><span class="line">  [ - &lt;pushover_config&gt;, ... ]</span><br><span class="line">slack_configs:</span><br><span class="line">  [ - &lt;slack_config&gt;, ... ]</span><br><span class="line">sns_configs:</span><br><span class="line">  [ - &lt;sns_config&gt;, ... ]</span><br><span class="line">victorops_configs:</span><br><span class="line">  [ - &lt;victorops_config&gt;, ... ]</span><br><span class="line">webhook_configs:</span><br><span class="line">  [ - &lt;webhook_config&gt;, ... ]</span><br><span class="line">wechat_configs:</span><br><span class="line">  [ - &lt;wechat_config&gt;, ... ]</span><br><span class="line">telegram_configs:</span><br><span class="line">  [ - &lt;telegram_config&gt;, ... ]</span><br></pre></td></tr></table></figure></p>
<p>上面配置很多个， 我们一般只用这几个: <strong>email</strong>， <strong>钉钉</strong>， <strong>webhook</strong></p>
<blockquote>
<p>其中 钉钉 是又是基于 webhook 的</p>
</blockquote>
<h5 id="5-4-1-email-config"><a href="#5-4-1-email-config" class="headerlink" title="5.4.1 email_config"></a>5.4.1 <a href="https://prometheus.io/docs/alerting/latest/configuration/#email_config" target="_blank" rel="noopener">email_config</a></h5><p>邮件的配置如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># 警报状态恢复是否要发送恢复邮件</span><br><span class="line">[ send_resolved: &lt;boolean&gt; | default = false ]</span><br><span class="line"></span><br><span class="line"># 发送对象邮箱</span><br><span class="line">to: &lt;tmpl_string&gt;</span><br><span class="line"></span><br><span class="line"># 发送者邮箱</span><br><span class="line">[ from: &lt;tmpl_string&gt; | default = global.smtp_from ]</span><br><span class="line"></span><br><span class="line"># The SMTP host</span><br><span class="line">[ smarthost: &lt;string&gt; | default = global.smtp_smarthost ]</span><br><span class="line"></span><br><span class="line"># 主机名称</span><br><span class="line">[ hello: &lt;string&gt; | default = global.smtp_hello ]</span><br><span class="line"></span><br><span class="line"># SMTP 校验信息</span><br><span class="line">[ auth_username: &lt;string&gt; | default = global.smtp_auth_username ]</span><br><span class="line">[ auth_password: &lt;secret&gt; | default = global.smtp_auth_password ]</span><br><span class="line">[ auth_secret: &lt;secret&gt; | default = global.smtp_auth_secret ]</span><br><span class="line">[ auth_identity: &lt;string&gt; | default = global.smtp_auth_identity ]</span><br><span class="line"></span><br><span class="line"># 是否开启 SMTP TLS </span><br><span class="line">[ require_tls: &lt;bool&gt; | default = global.smtp_require_tls ]</span><br><span class="line"></span><br><span class="line"># TLS 配置</span><br><span class="line">tls_config:</span><br><span class="line">  [ &lt;tls_config&gt; ]</span><br><span class="line"></span><br><span class="line"># 邮件 HTML body</span><br><span class="line">[ html: &lt;tmpl_string&gt; | default = &apos;&#123;&#123; template &quot;email.default.html&quot; . &#125;&#125;&apos; ]</span><br><span class="line"># 邮件 text body</span><br><span class="line">[ text: &lt;tmpl_string&gt; ]</span><br><span class="line"></span><br><span class="line"># 邮件头部键值对</span><br><span class="line">[ headers: &#123; &lt;string&gt;: &lt;tmpl_string&gt;, ... &#125; ]</span><br></pre></td></tr></table></figure></p>
<h5 id="5-4-2-webhook-config"><a href="#5-4-2-webhook-config" class="headerlink" title="5.4.2 webhook_config"></a>5.4.2 <a href="https://prometheus.io/docs/alerting/latest/configuration/#webhook_config" target="_blank" rel="noopener">webhook_config</a></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 警报状态恢复是否要发送恢复邮件</span><br><span class="line">[ send_resolved: &lt;boolean&gt; | default = true ]</span><br><span class="line"></span><br><span class="line"># HTTP POST url</span><br><span class="line">url: &lt;string&gt;</span><br><span class="line"></span><br><span class="line"># The HTTP client 配置</span><br><span class="line">[ http_config: &lt;http_config&gt; | default = global.http_config ]</span><br><span class="line"></span><br><span class="line"># 配置最大通知数， 0 表示不限制</span><br><span class="line">[ max_alerts: &lt;int&gt; | default = 0 ]</span><br></pre></td></tr></table></figure>
<h4 id="5-5-inhibit-rules"><a href="#5-5-inhibit-rules" class="headerlink" title="5.5. inhibit_rules"></a>5.5. <a href="https://prometheus.io/docs/alerting/latest/configuration/#inhibit_rule" target="_blank" rel="noopener">inhibit_rules</a></h4><p>inhibit_rules 模块中设置警报抑制功能，可以指定在特定条件下需要忽略的警报条件。可以使用此选项设置首选，比如优先处理某些警报，如果同一组中的警报同时发生，则忽略其他警报。</p>
<p>合理使用 inhibit_rules ，可以减少频发发送没有意义的警报的产生。</p>
<p>alertmanager 有 3个特性:</p>
<ul>
<li>分组(<code>Grouping</code>)</li>
<li>抑制(<code>Inhibition</code>)</li>
<li>静默(<code>Silences</code>)</li>
</ul>
<p>本节不详细讨论这三个特性，后面会单独开篇章来分析。</p>
<h3 id="6-group-interval-和-repeat-interval"><a href="#6-group-interval-和-repeat-interval" class="headerlink" title="6. group_interval 和 repeat_interval"></a>6. group_interval 和 repeat_interval</h3><p>我们例子中其实很简单，除了 global 配置全局邮件发送之外，其他就是:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">route:</span><br><span class="line">  group_by: [&apos;alertname&apos;]</span><br><span class="line">  group_wait: 30s</span><br><span class="line">  group_interval: 5m</span><br><span class="line">  repeat_interval: 10m</span><br><span class="line">  receiver: default-receiver</span><br><span class="line">receivers:</span><br><span class="line">  - name: &apos;default-receiver&apos;</span><br><span class="line">    email_configs:</span><br><span class="line">    - to: &apos;k****o@gmail.com&apos;</span><br></pre></td></tr></table></figure>
<p>所以其实就很简单， 一旦收到警报，处理步骤如下:</p>
<ol>
<li>根据标签 alertname 的值进行分组，如果是首次的话，等待 30s 让相同组的警报过来， 30s 之内，如果有其他组内的警报进来的话， 就合并成一组，然后发送给接收器 default-receiver， 然后这个接收器发送邮件，用的是默认模板</li>
<li>然后接下来又过了一分钟，又来了一条相同的警报信息，这时候除了等待 30s 归类之外，就要读 group_interval 配置，如果与上一条同组的警报通知间隔不到 5 分钟，那么就要等到 5 分钟，才会发送下一条警报</li>
<li>然后发送之前，判断本次的警报是否有恢复(状态是否有改变)，这时候就要读 repeat_interval 的配置，也就是说，要发送重复警报的话，还要再等 10 分钟才行</li>
</ol>
<p>综上就可以看到，假设一条警报一直没有修复， 就会出现，除了第一次是马上发送警报，接下来要发重复警报的话，就要再过 group_interval + repeat_interval = 15 分钟</p>
<p><img src="/2022/11/29/prometheus-4-alertmanager/14.png" alt=""></p>
<h4 id="6-1-两台-node-相继挂掉的情况"><a href="#6-1-两台-node-相继挂掉的情况" class="headerlink" title="6.1 两台 node 相继挂掉的情况"></a>6.1 两台 node 相继挂掉的情况</h4><p>接下来我们还是基于上述的配置，测试一下两台 node_exporter (localhost 和 234 这两台) 相继停掉的情况，时间线如下</p>
<ol>
<li>15 分的时候， localhost 这一台的 node_exporter 关闭，警报变成 pending</li>
<li>16 分的时候， 过了 rule 的 for 等待时间(1 分钟)，prometheus 将警报发送给 alertmanager</li>
<li>alertmanager 收到警报，继续等待 30s (<code>group_wait</code>), 发现没有同组的警报，并且上一次这个组的警报发送间隔超过了 5 分钟， 所以马上发送邮件</li>
<li>17 分的时候， 收到了邮件，因为警报内容跟之前测试的一样，所以在 gmail 那边，会归档到之前的那一封</li>
</ol>
<p><img src="/2022/11/29/prometheus-4-alertmanager/15.png" alt=""></p>
<ol start="5">
<li>18 分的时候，234 这一台的 node_exporter 关闭，然后警报变成 pending</li>
<li>19 分的时候，234 的警报也变成 firing</li>
</ol>
<p><img src="/2022/11/29/prometheus-4-alertmanager/16.png" alt=""></p>
<ol start="7">
<li>alertmanager 收到警报，继续等待 30s (<code>group_wait</code>), 如果有相同的警报，就合并成一条，然后判断间隔时间是否超过了 5 分钟，发现没有(上一次发是 17 分钟)，继续等待，并且合并警报</li>
<li>22 分的时候，终于达到了 group 的间隔时间了，这时候触发 repeat_interval 判断，对比了，一下本次的报警信息跟上一次不一样 (本次两条报警)，所以不满足再次等待条件， 发送邮件</li>
<li>22 分的时候，收到邮件，内容不一样，单独一封</li>
</ol>
<p><img src="/2022/11/29/prometheus-4-alertmanager/17.png" alt=""></p>
<p>打开之后，发现内容就是两台的报警信息</p>
<p><img src="/2022/11/29/prometheus-4-alertmanager/18.png" alt=""></p>
<h3 id="7-发送钉钉通知"><a href="#7-发送钉钉通知" class="headerlink" title="7. 发送钉钉通知"></a>7. 发送钉钉通知</h3><p>正常工作中，现在大家都有用钉钉在协同办公，所以对于业务预警来说，发送钉钉通知预警是非常有用的事情。 所以接下来我们添加一下钉钉预警的</p>
<h4 id="7-1-安装-Prometheus-webhook-Dingtalk"><a href="#7-1-安装-Prometheus-webhook-Dingtalk" class="headerlink" title="7.1 安装 Prometheus-webhook-Dingtalk"></a>7.1 安装 Prometheus-webhook-Dingtalk</h4><p>首先我们安装钉钉组件: <a href="https://github.com/timonwong/prometheus-webhook-dingtalk" target="_blank" rel="noopener">下载地址</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"># 下载解压</span><br><span class="line">[root@VM-64-9-centos ~]# cd /usr/local/</span><br><span class="line">[root@VM-64-9-centos local]# wget https://github.com/timonwong/prometheus-webhook-dingtalk/releases/download/v2.1.0/prometheus-webhook-dingtalk-2.1.0.linux-amd64.tar.gz</span><br><span class="line">[root@VM-64-9-centos local]# tar xf prometheus-webhook-dingtalk-2.1.0.linux-amd64.tar.gz </span><br><span class="line">[root@VM-64-9-centos local]# mv prometheus-webhook-dingtalk-2.1.0.linux-amd64 prometheus-webhook-dingtalk</span><br><span class="line"></span><br><span class="line"># 创建 config.yml 配置文件，之前只有一个 example 文件，直接拷贝一份命名 config.yml</span><br><span class="line">[root@VM-64-9-centos local]# cd prometheus-webhook-dingtalk/</span><br><span class="line">[root@VM-64-9-centos prometheus-webhook-dingtalk]# cp config.example.yml config.yml</span><br><span class="line"></span><br><span class="line"># 配置 config.yml</span><br><span class="line">[root@VM-64-9-centos local]# cat prometheus-webhook-dingtalk/config.yml </span><br><span class="line">## 这个参数要设置为 true, 才会去读自定义的模板，不然就会读程序的默认模板</span><br><span class="line">no_builtin_template: true</span><br><span class="line"></span><br><span class="line">## 模板文件路径， 这边一定要用绝对路径</span><br><span class="line">templates:</span><br><span class="line">  - /usr/local/prometheus/templates/dingding-default.tmpl</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 设定监听的端点，可以设置多个</span><br><span class="line">targets:</span><br><span class="line">  webhook_1:</span><br><span class="line">    url: https://oapi.dingtalk.com/robot/send?access_token=3aff7c1ac0122xxxxxxxxxxxxxxxxxxxxxxx85ac45f2cc942296</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 添加到 system 服务，这边的启动参数不要加双引号包裹，不然会启动失败</span><br><span class="line">[root@VM-64-9-centos local]# cat /usr/lib/systemd/system/prometheus-webhook-dingtalk.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=prometheus webhook dingtalk</span><br><span class="line">Documentation=https://github.com/timonwong/prometheus-webhook-dingtalk</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/usr/local/prometheus-webhook-dingtalk/prometheus-webhook-dingtalk --web.listen-address=:8070 --web.enable-ui --config.file=/usr/local/prometheus-webhook-dingtalk/config.yml</span><br><span class="line">ExecStop=/bin/kill -s QUIT $MAINPID</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"># 启动服务</span><br><span class="line">[root@VM-64-9-centos local]# systemctl daemon-reload</span><br><span class="line">[root@VM-64-9-centos local]# systemctl enable prometheus-webhook-dingtalk</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/prometheus-webhook-dingtalk.service to /usr/lib/systemd/system/prometheus-webhook-dingtalk.service.</span><br><span class="line">[root@VM-64-9-centos local]# systemctl start prometheus-webhook-dingtalk</span><br><span class="line"></span><br><span class="line"># 查看服务启动状态，可以看到有在监听 8070 端口了</span><br><span class="line">[root@VM-64-9-centos local]# systemctl status prometheus-webhook-dingtalk -l</span><br><span class="line">● prometheus-webhook-dingtalk.service - prometheus webhook dingtalk</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/prometheus-webhook-dingtalk.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Fri 2022-12-02 11:25:59 CST; 1min 55s ago</span><br><span class="line">     Docs: https://github.com/timonwong/prometheus-webhook-dingtalk</span><br><span class="line"> Main PID: 4942 (prometheus-webh)</span><br><span class="line">   CGroup: /system.slice/prometheus-webhook-dingtalk.service</span><br><span class="line">           └─4942 /usr/local/prometheus-webhook-dingtalk/prometheus-webhook-dingtalk --web.listen-address=:8070 --web.enable-ui --config.file=/usr/local/prometheus-webhook-dingtalk/config.yml</span><br><span class="line"></span><br><span class="line">Dec 02 11:25:59 VM-64-9-centos systemd[1]: Started prometheus webhook dingtalk.</span><br><span class="line">Dec 02 11:25:59 VM-64-9-centos prometheus-webhook-dingtalk[4942]: ts=2022-12-02T03:25:59.452Z caller=main.go:59 level=info msg=&quot;Starting prometheus-webhook-dingtalk&quot; version=&quot;(version=2.1.0, branch=HEAD, revision=8580d1395f59490682fb2798136266bdb3005ab4)&quot;</span><br><span class="line">Dec 02 11:25:59 VM-64-9-centos prometheus-webhook-dingtalk[4942]: ts=2022-12-02T03:25:59.452Z caller=main.go:60 level=info msg=&quot;Build context&quot; (gogo1.18.1,userroot@177bd003ba4d,date20220421-08:19:05)=(MISSING)</span><br><span class="line">Dec 02 11:25:59 VM-64-9-centos prometheus-webhook-dingtalk[4942]: ts=2022-12-02T03:25:59.452Z caller=coordinator.go:83 level=info component=configuration file=/usr/local/prometheus-webhook-dingtalk/config.yml msg=&quot;Loading configuration file&quot;</span><br><span class="line">Dec 02 11:25:59 VM-64-9-centos prometheus-webhook-dingtalk[4942]: ts=2022-12-02T03:25:59.452Z caller=coordinator.go:91 level=info component=configuration file=/usr/local/prometheus-webhook-dingtalk/config.yml msg=&quot;Completed loading of configuration file&quot;</span><br><span class="line">Dec 02 11:25:59 VM-64-9-centos prometheus-webhook-dingtalk[4942]: ts=2022-12-02T03:25:59.452Z caller=main.go:97 level=info component=configuration msg=&quot;Loading templates&quot; templates=contrib/templates/default.tmpl</span><br><span class="line">Dec 02 11:25:59 VM-64-9-centos prometheus-webhook-dingtalk[4942]: ts=2022-12-02T03:25:59.453Z caller=main.go:113 component=configuration msg=&quot;Webhook urls for prometheus alertmanager&quot; urls=http://localhost:8070/dingtalk/webhook_1/send</span><br><span class="line">Dec 02 11:25:59 VM-64-9-centos prometheus-webhook-dingtalk[4942]: ts=2022-12-02T03:25:59.453Z caller=web.go:208 level=info component=web msg=&quot;Start listening for connections&quot; address=:8070</span><br></pre></td></tr></table></figure></p>
<p>从上面的配置文件可以看到，我们只设置了一个 webhook 的端口，也就是这个:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8070/dingtalk/webhook_1/send</span><br></pre></td></tr></table></figure></p>
<p>后面在填 alertmanager 的 webhook 的 url 的时候，就是填这个， <code>webhook_1</code> 就是上面所配置的 target， 可以配置多个， 然后程序就会生成多个监听 url， 然后在 alertmanager 那边灵活分配到发送 webhook 到哪一个端点</p>
<p>上面有两个细节要注意:</p>
<ol>
<li><strong>一个是这个配置要设置为 true，程序才会去读取自定义的模板</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">no_builtin_template: true</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>刚开始这个没有设置，默认为 false，不管怎么设置，发现 钉钉通知都是发送默认的模板，因为项目文档太少，到后面我直接看源代码去了，结果才发现要读自定义模板，跟这个配置有关，以下是源代码:<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">FromGlobs</span><span class="params">(loadBuiltinTemplate <span class="keyword">bool</span>, paths ...<span class="keyword">string</span>)</span> <span class="params">(*Template, error)</span></span> &#123;</span><br><span class="line">	tmpl := template.New(<span class="string">""</span>).</span><br><span class="line">		Option(<span class="string">"missingkey=zero"</span>).</span><br><span class="line">		Funcs(defaultFuncs).</span><br><span class="line">		Funcs(sprig.TxtFuncMap())</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> loadBuiltinTemplate &#123;</span><br><span class="line">		f, err := Assets.Open(<span class="string">"/templates/default.tmpl"</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">defer</span> f.Close()</span><br><span class="line">		b, err := io.ReadAll(f)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> _, err := tmpl.Parse(<span class="keyword">string</span>(b)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, tp := <span class="keyword">range</span> paths &#123;</span><br><span class="line">		<span class="comment">// ParseGlob in the template packages errors if not at least one file is</span></span><br><span class="line">		<span class="comment">// matched. We want to allow empty matches that may be populated later on.</span></span><br><span class="line">		p, err := filepath.Glob(tp)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(p) &gt; <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> _, err := tmpl.ParseGlob(tp); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;Template&#123;tmpl: tmpl&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后他的调用方式是反着来的:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tmpl, err := template.FromGlobs(!conf.NoBuiltinTemplate, conf.Templates...)</span><br></pre></td></tr></table></figure></p>
<p>也就是要 <code>NoBuiltinTemplate</code> 为 true，里面才会变成 false， 才会读自定义模板路径</p>
<ol start="2">
<li><strong>还有就是模板路径要绝对路径</strong><br>这个也是很坑， 因为实例里面是相对路径的 <code>contrib/templates/legacy/template.tmpl</code>, 导致我配置自定义的时候，刚开始也是放在这个 contrib 目录下的，结果一直报这个错误<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-64-9-centos templates]# journalctl -f -u prometheus-webhook-dingtalk.service</span><br><span class="line">-- Logs begin at Mon 2022-11-14 09:42:41 CST. --</span><br><span class="line">Dec 02 16:06:04 VM-64-9-centos systemd[1]: Unit prometheus-webhook-dingtalk.service entered failed state.</span><br><span class="line">Dec 02 16:06:04 VM-64-9-centos systemd[1]: prometheus-webhook-dingtalk.service failed.</span><br><span class="line">...</span><br><span class="line">Dec 02 16:07:28 VM-64-9-centos prometheus-webhook-dingtalk[12891]: ts=2022-12-02T08:07:28.953Z caller=dingtalk.go:90 level=error component=web target=webhook_1 msg=&quot;Failed to build notification&quot; err=&quot;template: :1:12: executing \&quot;\&quot; at &lt;&#123;&#123;template \&quot;ding.link.title\&quot; .&#125;&#125;&gt;: template \&quot;ding.link.title\&quot; not defined&quot;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>一直报这个 <code>ding.link.title</code> 参数没有定义， 但是明明模板有定义，为啥找不到，后面改成绝对路径，就可以找到了</p>
<blockquote>
<p>可以使用 journalctl -f -u service 来跟进某一个 system server 的日志</p>
</blockquote>
<h4 id="7-2-模板配置"><a href="#7-2-模板配置" class="headerlink" title="7.2 模板配置"></a>7.2 模板配置</h4><p>从上面的配置文件来看，除了配置端点之外，我们还自己创建了一个模板文件:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/prometheus/templates/dingding-default.tmpl</span><br></pre></td></tr></table></figure></p>
<p>内容如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-64-9-centos prometheus-webhook-dingtalk]# cat /usr/local/prometheus/templates/dingding-default.tmpl</span><br><span class="line">&#123;&#123;/* 定义子标题 */&#125;&#125;</span><br><span class="line">&#123;&#123; define &quot;__subject&quot; &#125;&#125;[&#123;&#123; .Status | toUpper &#125;&#125;&#123;&#123; if eq .Status &quot;firing&quot; &#125;&#125;:&#123;&#123; .Alerts.Firing | len &#125;&#125;&#123;&#123; end &#125;&#125;] &#123;&#123; .GroupLabels.SortedPairs.Values | join &quot; &quot; &#125;&#125; &#123;&#123; if gt (len .CommonLabels) (len .GroupLabels) &#125;&#125;(&#123;&#123; with .CommonLabels.Remove .GroupLabels.Names &#125;&#125;&#123;&#123; .Values | join &quot; &quot; &#125;&#125;&#123;&#123; end &#125;&#125;)&#123;&#123; end &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class="line">&#123;&#123; define &quot;__alertmanagerURL&quot; &#125;&#125;&#123;&#123; .ExternalURL &#125;&#125;/#/alerts?receiver=&#123;&#123; .Receiver &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;&#123;/* 定义警报内容*/&#125;&#125;</span><br><span class="line">&#123;&#123; define &quot;default.__text_alert_list&quot; &#125;&#125;&#123;&#123; range . &#125;&#125;</span><br><span class="line">**Trigger Time:** &#123;&#123; dateInZone &quot;2006.01.02 15:04:05&quot; (.StartsAt) &quot;Asia/Shanghai&quot; &#125;&#125;</span><br><span class="line"></span><br><span class="line">**Summary:** &#123;&#123; .Annotations.summary &#125;&#125;</span><br><span class="line"></span><br><span class="line">**Description:** &#123;&#123; .Annotations.description &#125;&#125;</span><br><span class="line"></span><br><span class="line">**Details:**</span><br><span class="line">&#123;&#123; range .Labels.SortedPairs &#125;&#125;&#123;&#123; if and (ne (.Name) &quot;severity&quot;) (ne (.Name) &quot;summary&quot;) &#125;&#125;&gt; - &#123;&#123; .Name &#125;&#125;: &#123;&#123; .Value | markdown | html &#125;&#125;</span><br><span class="line">&#123;&#123; end &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class="line">&#123;&#123; end &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;&#123;/* 定义警报恢复内容 */&#125;&#125;</span><br><span class="line">&#123;&#123; define &quot;default.__text_resolved_list&quot; &#125;&#125;&#123;&#123; range . &#125;&#125;</span><br><span class="line"></span><br><span class="line">**Trigger Time:** &#123;&#123; dateInZone &quot;2006.01.02 15:04:05&quot; (.StartsAt) &quot;Asia/Shanghai&quot; &#125;&#125;</span><br><span class="line"></span><br><span class="line">**Resolved Time:** &#123;&#123; dateInZone &quot;2006.01.02 15:04:05&quot; (.EndsAt) &quot;Asia/Shanghai&quot; &#125;&#125;</span><br><span class="line"></span><br><span class="line">**Summary:** &#123;&#123; .Annotations.summary &#125;&#125;</span><br><span class="line"></span><br><span class="line">**Details:**</span><br><span class="line">&#123;&#123; range .Labels.SortedPairs &#125;&#125;&#123;&#123; if and (ne (.Name) &quot;severity&quot;) (ne (.Name) &quot;summary&quot;) &#125;&#125;&gt; - &#123;&#123; .Name &#125;&#125;: &#123;&#123; .Value | markdown | html &#125;&#125;</span><br><span class="line">&#123;&#123; end &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class="line">&#123;&#123; end &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;&#123;/* 定义标题和内容 */&#125;&#125;</span><br><span class="line">&#123;&#123; define &quot;default.title&quot; &#125;&#125;&#123;&#123; template &quot;__subject&quot; . &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class="line">&#123;&#123; define &quot;default.content&quot; &#125;&#125;#### \[&#123;&#123; .Status | toUpper &#125;&#125;&#123;&#123; if eq .Status &quot;firing&quot; &#125;&#125;:&#123;&#123; .Alerts.Firing | len &#125;&#125;&#123;&#123; end &#125;&#125;\] **[&#123;&#123; index .GroupLabels &quot;alertname&quot; &#125;&#125;](&#123;&#123; template &quot;__alertmanagerURL&quot; . &#125;&#125;)**</span><br><span class="line"></span><br><span class="line">&#123;&#123;/* 判断是警报还是恢复 */&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;/* 如果是警报 */&#125;&#125;</span><br><span class="line">&#123;&#123; if gt (len .Alerts.Firing) 0 -&#125;&#125;</span><br><span class="line">**Alerts Firing**</span><br><span class="line">&#123;&#123; template &quot;default.__text_alert_list&quot; .Alerts.Firing &#125;&#125;</span><br><span class="line">&#123;&#123; range .AtMobiles &#125;&#125;@&#123;&#123; . &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;/* 如果是恢复警报 */&#125;&#125;</span><br><span class="line">&#123;&#123; if gt (len .Alerts.Resolved) 0 -&#125;&#125;</span><br><span class="line">**Alerts Resolved**</span><br><span class="line">&#123;&#123; template &quot;default.__text_resolved_list&quot; .Alerts.Resolved &#125;&#125;</span><br><span class="line">&#123;&#123; range .AtMobiles &#125;&#125;@&#123;&#123; . &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;&#123;/* 下面这两个钉钉的字段定义是一定要有的，因为程序会执行 */&#125;&#125;</span><br><span class="line">&#123;&#123; define &quot;ding.link.title&quot; &#125;&#125;&#123;&#123; template &quot;default.title&quot; . &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class="line">&#123;&#123; define &quot;ding.link.content&quot; &#125;&#125;&#123;&#123; template &quot;default.content&quot; . &#125;&#125;&#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个模板语法用的 golang 的语法模板: </p>
<ul>
<li><a href="https://prometheus.io/docs/visualization/consoles/" target="_blank" rel="noopener">console template</a></li>
<li><a href="https://pkg.go.dev/text/template" target="_blank" rel="noopener">golang template</a></li>
</ul>
<p>而且对于这个钉钉模板来说， 他发送钉钉通知的代码是这样子的:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DefaultTargetMessage = TargetMessage&#123;</span><br><span class="line">	Title: `&#123;&#123; template &quot;ding.link.title&quot; . &#125;&#125;`,</span><br><span class="line">	Text:  `&#123;&#123; template &quot;ding.link.content&quot; . &#125;&#125;`,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>也就是我们必须要在模板文件里面至少要定义这两个值，哪怕只是以下这种极简单的硬编码也是可以 work 的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; define &quot;ding.link.title&quot; &#125;&#125; hello title &#123;&#123; end &#125;&#125;</span><br><span class="line">&#123;&#123; define &quot;ding.link.content&quot; &#125;&#125; hello content &#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p>至于参数匹配的规则大概是这样子</p>
<ol>
<li><p>首先 alertmanager 那边的 webhook 请求的 post body 体是这样子的(<a href="https://prometheus.io/docs/alerting/latest/configuration/#webhook_config" target="_blank" rel="noopener">相关文档地址</a>):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;version&quot;: &quot;4&quot;,</span><br><span class="line">  &quot;groupKey&quot;: &lt;string&gt;,              // key identifying the group of alerts (e.g. to deduplicate)</span><br><span class="line">  &quot;truncatedAlerts&quot;: &lt;int&gt;,          // how many alerts have been truncated due to &quot;max_alerts&quot;</span><br><span class="line">  &quot;status&quot;: &quot;&lt;resolved|firing&gt;&quot;,</span><br><span class="line">  &quot;receiver&quot;: &lt;string&gt;,</span><br><span class="line">  &quot;groupLabels&quot;: &lt;object&gt;,</span><br><span class="line">  &quot;commonLabels&quot;: &lt;object&gt;,</span><br><span class="line">  &quot;commonAnnotations&quot;: &lt;object&gt;,</span><br><span class="line">  &quot;externalURL&quot;: &lt;string&gt;,           // backlink to the Alertmanager.</span><br><span class="line">  &quot;alerts&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;status&quot;: &quot;&lt;resolved|firing&gt;&quot;,</span><br><span class="line">      &quot;labels&quot;: &lt;object&gt;,</span><br><span class="line">      &quot;annotations&quot;: &lt;object&gt;,</span><br><span class="line">      &quot;startsAt&quot;: &quot;&lt;rfc3339&gt;&quot;,</span><br><span class="line">      &quot;endsAt&quot;: &quot;&lt;rfc3339&gt;&quot;,</span><br><span class="line">      &quot;generatorURL&quot;: &lt;string&gt;,      // identifies the entity that caused the alert</span><br><span class="line">      &quot;fingerprint&quot;: &lt;string&gt;        // fingerprint to identify the alert</span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后将这边 body 体转换对 struct 对象:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">type Data struct &#123;</span><br><span class="line">	Receiver string `json:&quot;receiver&quot;`</span><br><span class="line">	Status   string `json:&quot;status&quot;`</span><br><span class="line">	Alerts   Alerts `json:&quot;alerts&quot;`</span><br><span class="line"></span><br><span class="line">	GroupLabels       KV `json:&quot;groupLabels&quot;`</span><br><span class="line">	CommonLabels      KV `json:&quot;commonLabels&quot;`</span><br><span class="line">	CommonAnnotations KV `json:&quot;commonAnnotations&quot;`</span><br><span class="line"></span><br><span class="line">	ExternalURL string `json:&quot;externalURL&quot;`</span><br><span class="line">	AtMobiles   []string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Alert holds one alert for notification templates.</span><br><span class="line">type Alert struct &#123;</span><br><span class="line">	Status       string    `json:&quot;status&quot;`</span><br><span class="line">	Labels       KV        `json:&quot;labels&quot;`</span><br><span class="line">	Annotations  KV        `json:&quot;annotations&quot;`</span><br><span class="line">	StartsAt     time.Time `json:&quot;startsAt&quot;`</span><br><span class="line">	EndsAt       time.Time `json:&quot;endsAt&quot;`</span><br><span class="line">	GeneratorURL string    `json:&quot;generatorURL&quot;`</span><br><span class="line">	Fingerprint  string    `json:&quot;fingerprint&quot;`</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Alerts is a list of Alert objects.</span><br><span class="line">type Alerts []Alert</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后接下来就是模板插值了</p>
</li>
</ol>
<h4 id="7-3-配置到-alertmanager"><a href="#7-3-配置到-alertmanager" class="headerlink" title="7.3 配置到 alertmanager"></a>7.3 配置到 alertmanager</h4><p>同时可以配置: alertmanager ,将其加进去, 多了一个恢复状态的回执 <code>send_resolved</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-64-9-centos ~]# cat /usr/local/alertmanager/alertmanager.yml </span><br><span class="line">global:</span><br><span class="line">  smtp_smarthost: &apos;smtp.qq.com:25&apos;</span><br><span class="line">  smtp_from: &apos;z***e@foxmail.com&apos;</span><br><span class="line">  smtp_auth_username: &apos;z***e@foxmail.com&apos;</span><br><span class="line">  smtp_auth_password: &apos;ypgtxxxxxxxxxxxx&apos; </span><br><span class="line">  smtp_require_tls: false</span><br><span class="line">route:</span><br><span class="line">  group_by: [&apos;alertname&apos;]</span><br><span class="line">  group_wait: 30s</span><br><span class="line">  group_interval: 5m</span><br><span class="line">  repeat_interval: 10m</span><br><span class="line">  receiver: default-receiver</span><br><span class="line">receivers:</span><br><span class="line">  - name: &apos;default-receiver&apos;</span><br><span class="line">    email_configs:</span><br><span class="line">    - to: &apos;k****o@gmail.com&apos;</span><br><span class="line">    webhook_configs:</span><br><span class="line">    - url: http://localhost:8070/dingtalk/webhook_1/send</span><br><span class="line">      send_resolved: true</span><br><span class="line"></span><br><span class="line"># 检查格式是否正确</span><br><span class="line">[root@VM-64-9-centos alertmanager]# ./amtool check-config alertmanager.yml </span><br><span class="line">Checking &apos;alertmanager.yml&apos;  SUCCESS</span><br><span class="line">Found:</span><br><span class="line"> - global config</span><br><span class="line"> - route</span><br><span class="line"> - 0 inhibit rules</span><br><span class="line"> - 1 receivers</span><br><span class="line"> - 0 templates</span><br><span class="line"> </span><br><span class="line"># 最后重启</span><br><span class="line">[root@VM-64-9-centos ~]# systemctl restart alertmanager</span><br></pre></td></tr></table></figure></p>
<h4 id="7-4-接下来测试"><a href="#7-4-接下来测试" class="headerlink" title="7.4 接下来测试"></a>7.4 接下来测试</h4><p>先把 node_exporter 关掉一台，然后过段时间再开启，这时候就可以收到报警和恢复的钉钉通知了</p>
<p><img src="/2022/11/29/prometheus-4-alertmanager/19.png" alt=""></p>
<h3 id="8-邮件配置自定义模板"><a href="#8-邮件配置自定义模板" class="headerlink" title="8. 邮件配置自定义模板"></a>8. 邮件配置自定义模板</h3><p>通过上面我们可以看到 钉钉通知可以发送自定义模板，也可以设置恢复警报， 那么对于邮件通知来说，也是可以的</p>
<p>Prometheus 支持在警报的注释和标签以及服务的控制台页面中进行模板化。模板能够对本地数据库运行查询、迭代数据、使用条件、格式化数据等。Prometheus 模板语言基于<a href="https://pkg.go.dev/text/template" target="_blank" rel="noopener">Go 模板系统</a>。</p>
<p>发送给接收者的通知是通过模板构建的。 alertmanager 带有默认模板，但也可以自定义。其中默认模板就是这个: </p>
<ul>
<li><a href="https://github.com/prometheus/alertmanager/blob/main/template/default.tmpl" target="_blank" rel="noopener">alertmanager default.tmpl</a></li>
<li>还有一个就是邮件的 html 模板: <a href="https://github.com/prometheus/alertmanager/blob/main/template/email.html" target="_blank" rel="noopener">alertmanager template email.html</a></li>
</ul>
<p>很多语法都跟我们刚才创建钉钉通知的模板的语法一样，因为都是从相同的地方取值的，所以我们简单改造一下，新建一个:<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-64-9-centos alertmanager]# cat  /usr/local/prometheus/templates/mail.tmpl </span><br><span class="line">&#123;&#123; define "custom_mail_subject" &#125;&#125; &#123;&#123; template "__subject" . &#125;&#125; &#123;&#123; end &#125;&#125;</span><br><span class="line">&#123;&#123; define "custom_mail_html" &#125;&#125;</span><br><span class="line"><span class="meta">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/1999/xhtml"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=UTF-8"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>&#123;&#123; template "__subject" . &#125;&#125;<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">/* -------------------------------------</span></span><br><span class="line"><span class="undefined">    GLOBAL</span></span><br><span class="line"><span class="undefined">    A very basic CSS reset</span></span><br><span class="line"><span class="undefined">------------------------------------- */</span></span><br><span class="line"><span class="undefined">* &#123;</span></span><br><span class="line"><span class="undefined">  margin: 0;</span></span><br><span class="line"><span class="undefined">  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;</span></span><br><span class="line"><span class="undefined">  box-sizing: border-box;</span></span><br><span class="line"><span class="undefined">  font-size: 14px;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">img &#123;</span></span><br><span class="line"><span class="undefined">  max-width: 100%;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">body &#123;</span></span><br><span class="line"><span class="undefined">  -webkit-font-smoothing: antialiased;</span></span><br><span class="line"><span class="undefined">  -webkit-text-size-adjust: none;</span></span><br><span class="line"><span class="undefined">  width: 100% !important;</span></span><br><span class="line"><span class="undefined">  height: 100%;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">line-height</span>: 1<span class="selector-class">.6em</span>;</span></span><br><span class="line"><span class="css">  <span class="comment">/* 1.6em * 14px = 22.4px, use px to get airier line-height also in Thunderbird, and Yahoo!, Outlook.com, AOL webmail clients */</span></span></span><br><span class="line"><span class="css">  <span class="comment">/*line-height: 22px;*/</span></span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css"><span class="comment">/* Let's make sure all tables have defaults */</span></span></span><br><span class="line"><span class="undefined">table td &#123;</span></span><br><span class="line"><span class="undefined">  vertical-align: top;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">/* -------------------------------------</span></span><br><span class="line"><span class="undefined">    BODY &amp; CONTAINER</span></span><br><span class="line"><span class="undefined">------------------------------------- */</span></span><br><span class="line"><span class="undefined">body &#123;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">background-color</span>: <span class="selector-id">#f6f6f6</span>;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css"><span class="selector-class">.body-wrap</span> &#123;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">background-color</span>: <span class="selector-id">#f6f6f6</span>;</span></span><br><span class="line"><span class="undefined">  width: 100%;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css"><span class="selector-class">.container</span> &#123;</span></span><br><span class="line"><span class="undefined">  display: block !important;</span></span><br><span class="line"><span class="undefined">  max-width: 600px !important;</span></span><br><span class="line"><span class="undefined">  margin: 0 auto !important;</span></span><br><span class="line"><span class="css">  <span class="comment">/* makes it centered */</span></span></span><br><span class="line"><span class="undefined">  clear: both !important;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css"><span class="selector-class">.content</span> &#123;</span></span><br><span class="line"><span class="undefined">  max-width: 600px;</span></span><br><span class="line"><span class="undefined">  margin: 0 auto;</span></span><br><span class="line"><span class="undefined">  display: block;</span></span><br><span class="line"><span class="undefined">  padding: 20px;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">/* -------------------------------------</span></span><br><span class="line"><span class="undefined">    HEADER, FOOTER, MAIN</span></span><br><span class="line"><span class="undefined">------------------------------------- */</span></span><br><span class="line"><span class="css"><span class="selector-class">.main</span> &#123;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">background-color</span>: <span class="selector-id">#fff</span>;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">border</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#e9e9e9</span>;</span></span><br><span class="line"><span class="undefined">  border-radius: 3px;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css"><span class="selector-class">.content-wrap</span> &#123;</span></span><br><span class="line"><span class="undefined">  padding: 30px;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css"><span class="selector-class">.content-block</span> &#123;</span></span><br><span class="line"><span class="undefined">  padding: 0 0 20px;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css"><span class="selector-class">.header</span> &#123;</span></span><br><span class="line"><span class="undefined">  width: 100%;</span></span><br><span class="line"><span class="undefined">  margin-bottom: 20px;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css"><span class="selector-class">.footer</span> &#123;</span></span><br><span class="line"><span class="undefined">  width: 100%;</span></span><br><span class="line"><span class="undefined">  clear: both;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">color</span>: <span class="selector-id">#999</span>;</span></span><br><span class="line"><span class="undefined">  padding: 20px;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="css"><span class="selector-class">.footer</span> <span class="selector-tag">p</span>, <span class="selector-class">.footer</span> <span class="selector-tag">a</span>, <span class="selector-class">.footer</span> <span class="selector-tag">td</span> &#123;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">color</span>: <span class="selector-id">#999</span>;</span></span><br><span class="line"><span class="undefined">  font-size: 12px;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">/* -------------------------------------</span></span><br><span class="line"><span class="undefined">    TYPOGRAPHY</span></span><br><span class="line"><span class="undefined">------------------------------------- */</span></span><br><span class="line"><span class="undefined">h1, h2, h3 &#123;</span></span><br><span class="line"><span class="undefined">  font-family: "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">color</span>: <span class="selector-id">#000</span>;</span></span><br><span class="line"><span class="undefined">  margin: 40px 0 0;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">line-height</span>: 1<span class="selector-class">.2em</span>;</span></span><br><span class="line"><span class="undefined">  font-weight: 400;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">h1 &#123;</span></span><br><span class="line"><span class="undefined">  font-size: 32px;</span></span><br><span class="line"><span class="undefined">  font-weight: 500;</span></span><br><span class="line"><span class="css">  <span class="comment">/* 1.2em * 32px = 38.4px, use px to get airier line-height also in Thunderbird, and Yahoo!, Outlook.com, AOL webmail clients */</span></span></span><br><span class="line"><span class="css">  <span class="comment">/*line-height: 38px;*/</span></span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">h2 &#123;</span></span><br><span class="line"><span class="undefined">  font-size: 24px;</span></span><br><span class="line"><span class="css">  <span class="comment">/* 1.2em * 24px = 28.8px, use px to get airier line-height also in Thunderbird, and Yahoo!, Outlook.com, AOL webmail clients */</span></span></span><br><span class="line"><span class="css">  <span class="comment">/*line-height: 29px;*/</span></span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">h3 &#123;</span></span><br><span class="line"><span class="undefined">  font-size: 18px;</span></span><br><span class="line"><span class="css">  <span class="comment">/* 1.2em * 18px = 21.6px, use px to get airier line-height also in Thunderbird, and Yahoo!, Outlook.com, AOL webmail clients */</span></span></span><br><span class="line"><span class="css">  <span class="comment">/*line-height: 22px;*/</span></span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">h4 &#123;</span></span><br><span class="line"><span class="undefined">  font-size: 14px;</span></span><br><span class="line"><span class="undefined">  font-weight: 600;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">p, ul, ol &#123;</span></span><br><span class="line"><span class="undefined">  margin-bottom: 10px;</span></span><br><span class="line"><span class="undefined">  font-weight: normal;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">p li, ul li, ol li &#123;</span></span><br><span class="line"><span class="undefined">  margin-left: 5px;</span></span><br><span class="line"><span class="undefined">  list-style-position: inside;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">/* -------------------------------------</span></span><br><span class="line"><span class="undefined">    LINKS &amp; BUTTONS</span></span><br><span class="line"><span class="undefined">------------------------------------- */</span></span><br><span class="line"><span class="undefined">a &#123;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">color</span>: <span class="selector-id">#348eda</span>;</span></span><br><span class="line"><span class="undefined">  text-decoration: underline;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css"><span class="selector-class">.btn-primary</span> &#123;</span></span><br><span class="line"><span class="undefined">  text-decoration: none;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">color</span>: <span class="selector-id">#FFF</span>;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">background-color</span>: <span class="selector-id">#348eda</span>;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">border</span>: <span class="selector-tag">solid</span> <span class="selector-id">#348eda</span>;</span></span><br><span class="line"><span class="undefined">  border-width: 10px 20px;</span></span><br><span class="line"><span class="undefined">  line-height: 2em;</span></span><br><span class="line"><span class="css">  <span class="comment">/* 2em * 14px = 28px, use px to get airier line-height also in Thunderbird, and Yahoo!, Outlook.com, AOL webmail clients */</span></span></span><br><span class="line"><span class="css">  <span class="comment">/*line-height: 28px;*/</span></span></span><br><span class="line"><span class="undefined">  font-weight: bold;</span></span><br><span class="line"><span class="undefined">  text-align: center;</span></span><br><span class="line"><span class="undefined">  cursor: pointer;</span></span><br><span class="line"><span class="undefined">  display: inline-block;</span></span><br><span class="line"><span class="undefined">  border-radius: 5px;</span></span><br><span class="line"><span class="undefined">  text-transform: capitalize;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">/* -------------------------------------</span></span><br><span class="line"><span class="undefined">    OTHER STYLES THAT MIGHT BE USEFUL</span></span><br><span class="line"><span class="undefined">------------------------------------- */</span></span><br><span class="line"><span class="css"><span class="selector-class">.last</span> &#123;</span></span><br><span class="line"><span class="undefined">  margin-bottom: 0;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css"><span class="selector-class">.first</span> &#123;</span></span><br><span class="line"><span class="undefined">  margin-top: 0;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css"><span class="selector-class">.aligncenter</span> &#123;</span></span><br><span class="line"><span class="undefined">  text-align: center;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css"><span class="selector-class">.alignright</span> &#123;</span></span><br><span class="line"><span class="undefined">  text-align: right;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css"><span class="selector-class">.alignleft</span> &#123;</span></span><br><span class="line"><span class="undefined">  text-align: left;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css"><span class="selector-class">.clear</span> &#123;</span></span><br><span class="line"><span class="undefined">  clear: both;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">/* -------------------------------------</span></span><br><span class="line"><span class="undefined">    ALERTS</span></span><br><span class="line"><span class="undefined">    Change the class depending on warning email, good email or bad email</span></span><br><span class="line"><span class="undefined">------------------------------------- */</span></span><br><span class="line"><span class="css"><span class="selector-class">.alert</span> &#123;</span></span><br><span class="line"><span class="undefined">  font-size: 16px;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">color</span>: <span class="selector-id">#fff</span>;</span></span><br><span class="line"><span class="undefined">  font-weight: 500;</span></span><br><span class="line"><span class="undefined">  padding: 20px;</span></span><br><span class="line"><span class="undefined">  text-align: center;</span></span><br><span class="line"><span class="undefined">  border-radius: 3px 3px 0 0;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="css"><span class="selector-class">.alert</span> <span class="selector-tag">a</span> &#123;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">color</span>: <span class="selector-id">#fff</span>;</span></span><br><span class="line"><span class="undefined">  text-decoration: none;</span></span><br><span class="line"><span class="undefined">  font-weight: 500;</span></span><br><span class="line"><span class="undefined">  font-size: 16px;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="css"><span class="selector-class">.alert</span><span class="selector-class">.alert-warning</span> &#123;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">background-color</span>: <span class="selector-id">#E6522C</span>;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="css"><span class="selector-class">.alert</span><span class="selector-class">.alert-bad</span> &#123;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">background-color</span>: <span class="selector-id">#D0021B</span>;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="css"><span class="selector-class">.alert</span><span class="selector-class">.alert-good</span> &#123;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">background-color</span>: <span class="selector-id">#68B90F</span>;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">/* -------------------------------------</span></span><br><span class="line"><span class="undefined">    INVOICE</span></span><br><span class="line"><span class="undefined">    Styles for the billing table</span></span><br><span class="line"><span class="undefined">------------------------------------- */</span></span><br><span class="line"><span class="css"><span class="selector-class">.invoice</span> &#123;</span></span><br><span class="line"><span class="undefined">  margin: 40px auto;</span></span><br><span class="line"><span class="undefined">  text-align: left;</span></span><br><span class="line"><span class="undefined">  width: 80%;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="css"><span class="selector-class">.invoice</span> <span class="selector-tag">td</span> &#123;</span></span><br><span class="line"><span class="undefined">  padding: 5px 0;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="css"><span class="selector-class">.invoice</span> <span class="selector-class">.invoice-items</span> &#123;</span></span><br><span class="line"><span class="undefined">  width: 100%;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="css"><span class="selector-class">.invoice</span> <span class="selector-class">.invoice-items</span> <span class="selector-tag">td</span> &#123;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">border-top</span>: <span class="selector-id">#eee</span> 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span>;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="css"><span class="selector-class">.invoice</span> <span class="selector-class">.invoice-items</span> <span class="selector-class">.total</span> <span class="selector-tag">td</span> &#123;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">border-top</span>: 2<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#333</span>;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">border-bottom</span>: 2<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#333</span>;</span></span><br><span class="line"><span class="undefined">  font-weight: 700;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">/* -------------------------------------</span></span><br><span class="line"><span class="undefined">    RESPONSIVE AND MOBILE FRIENDLY STYLES</span></span><br><span class="line"><span class="undefined">------------------------------------- */</span></span><br><span class="line"><span class="css">@<span class="keyword">media</span> only screen and (max-width: <span class="number">640px</span>) &#123;</span></span><br><span class="line"><span class="undefined">  body &#123;</span></span><br><span class="line"><span class="undefined">    padding: 0 !important;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  h1, h2, h3, h4 &#123;</span></span><br><span class="line"><span class="undefined">    font-weight: 800 !important;</span></span><br><span class="line"><span class="undefined">    margin: 20px 0 5px !important;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  h1 &#123;</span></span><br><span class="line"><span class="undefined">    font-size: 22px !important;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  h2 &#123;</span></span><br><span class="line"><span class="undefined">    font-size: 18px !important;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  h3 &#123;</span></span><br><span class="line"><span class="undefined">    font-size: 16px !important;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css">  <span class="selector-class">.container</span> &#123;</span></span><br><span class="line"><span class="undefined">    padding: 0 !important;</span></span><br><span class="line"><span class="undefined">    width: 100% !important;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css">  <span class="selector-class">.content</span> &#123;</span></span><br><span class="line"><span class="undefined">    padding: 0 !important;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css">  <span class="selector-class">.content-wrap</span> &#123;</span></span><br><span class="line"><span class="undefined">    padding: 10px !important;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css">  <span class="selector-class">.invoice</span> &#123;</span></span><br><span class="line"><span class="undefined">    width: 100% !important;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">itemscope</span> <span class="attr">itemtype</span>=<span class="string">"http://schema.org/EmailMessage"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">"body-wrap"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"container"</span> <span class="attr">width</span>=<span class="string">"600"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"content"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">"main"</span> <span class="attr">width</span>=<span class="string">"100%"</span> <span class="attr">cellpadding</span>=<span class="string">"0"</span> <span class="attr">cellspacing</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            &#123;&#123; if gt (len .Alerts.Firing) 0 &#125;&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"alert alert-warning"</span>&gt;</span></span><br><span class="line">            &#123;&#123; else &#125;&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"alert alert-good"</span>&gt;</span></span><br><span class="line">            &#123;&#123; end &#125;&#125;</span><br><span class="line">              &#123;&#123; .Alerts | len &#125;&#125; alert&#123;&#123; if gt (len .Alerts) 1 &#125;&#125;s&#123;&#123; end &#125;&#125; for &#123;&#123; range .GroupLabels.SortedPairs &#125;&#125;</span><br><span class="line">                &#123;&#123; .Name &#125;&#125;=&#123;&#123; .Value &#125;&#125; </span><br><span class="line">              &#123;&#123; end &#125;&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"content-wrap"</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">table</span> <span class="attr">width</span>=<span class="string">"100%"</span> <span class="attr">cellpadding</span>=<span class="string">"0"</span> <span class="attr">cellspacing</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"content-block"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">'&#123;&#123; template "__alertmanagerURL" . &#125;&#125;'</span> <span class="attr">class</span>=<span class="string">"btn-primary"</span>&gt;</span>View in &#123;&#123; template "__alertmanager" . &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                &#123;&#123; if gt (len .Alerts.Firing) 0 &#125;&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"content-block"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">strong</span>&gt;</span>[&#123;&#123; .Alerts.Firing | len &#125;&#125;] Firing<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                &#123;&#123; end &#125;&#125;</span><br><span class="line">                &#123;&#123; range .Alerts.Firing &#125;&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"content-block"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">strong</span>&gt;</span>标签组:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">                    &#123;&#123; range .Labels.SortedPairs &#125;&#125;&#123;&#123; .Name &#125;&#125; = &#123;&#123; .Value &#125;&#125;<span class="tag">&lt;<span class="name">br</span> /&gt;</span>&#123;&#123; end &#125;&#125;</span><br><span class="line">                    &#123;&#123; if gt (len .Annotations) 0 &#125;&#125;<span class="tag">&lt;<span class="name">strong</span>&gt;</span>描述:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span>&#123;&#123; end &#125;&#125;</span><br><span class="line">                    &#123;&#123; range .Annotations.SortedPairs &#125;&#125;&#123;&#123; .Name &#125;&#125; = &#123;&#123; .Value &#125;&#125;<span class="tag">&lt;<span class="name">br</span> /&gt;</span>&#123;&#123; end &#125;&#125;</span><br><span class="line">					<span class="tag">&lt;<span class="name">strong</span>&gt;</span>触发时间(UTC):<span class="tag">&lt;/<span class="name">strong</span>&gt;</span>** &#123;&#123; .StartsAt &#125;&#125; <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;&#123; .GeneratorURL &#125;&#125;"</span>&gt;</span>查看详情<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                &#123;&#123; end &#125;&#125;</span><br><span class="line"></span><br><span class="line">                &#123;&#123; if gt (len .Alerts.Resolved) 0 &#125;&#125;</span><br><span class="line">                  &#123;&#123; if gt (len .Alerts.Firing) 0 &#125;&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"content-block"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">hr</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                  &#123;&#123; end &#125;&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"content-block"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">strong</span>&gt;</span>[&#123;&#123; .Alerts.Resolved | len &#125;&#125;] Resolved<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                &#123;&#123; end &#125;&#125;</span><br><span class="line">                &#123;&#123; range .Alerts.Resolved &#125;&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"content-block"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">strong</span>&gt;</span>标签:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">                    &#123;&#123; range .Labels.SortedPairs &#125;&#125;&#123;&#123; .Name &#125;&#125; = &#123;&#123; .Value &#125;&#125;<span class="tag">&lt;<span class="name">br</span> /&gt;</span>&#123;&#123; end &#125;&#125;</span><br><span class="line">                    &#123;&#123; if gt (len .Annotations) 0 &#125;&#125;<span class="tag">&lt;<span class="name">strong</span>&gt;</span>详情:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span>&#123;&#123; end &#125;&#125;</span><br><span class="line">                    &#123;&#123; range .Annotations.SortedPairs &#125;&#125;&#123;&#123; .Name &#125;&#125; = &#123;&#123; .Value &#125;&#125;<span class="tag">&lt;<span class="name">br</span> /&gt;</span>&#123;&#123; end &#125;&#125;</span><br><span class="line">					<span class="tag">&lt;<span class="name">strong</span>&gt;</span>触发时间(UTC):<span class="tag">&lt;/<span class="name">strong</span>&gt;</span>** &#123;&#123; .StartsAt &#125;&#125; <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">strong</span>&gt;</span>恢复时间(UTC):<span class="tag">&lt;/<span class="name">strong</span>&gt;</span>** &#123;&#123; .EndsAt &#125;&#125; <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;&#123; .GeneratorURL &#125;&#125;"</span>&gt;</span>点击详情<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                &#123;&#123; end &#125;&#125;</span><br><span class="line">              <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"footer"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">table</span> <span class="attr">width</span>=<span class="string">"100%"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"aligncenter content-block"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">'&#123;&#123; .ExternalURL &#125;&#125;'</span>&gt;</span>Sent by &#123;&#123; template "__alertmanager" . &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p>看似很长，其实是直接将原先的 html 模板拿来进行改造的，添加了两个自定义模板对象</p>
<ul>
<li><code>custom_mail_subject</code> -&gt; 对应标题</li>
<li><code>custom_mail_html</code> -&gt; 对应 html 内容体</li>
</ul>
<p>这两个模板对象都会在下面的配置文件中指定</p>
<blockquote>
<p>而这个模板一旦被定义好，是可以一直被使用的，不仅仅是用于 mail 的模板，其他的通知手段如果想用的话，一样可以用。</p>
</blockquote>
<p>接下来配置 alertmanager.yml， 增加了 <code>templates</code> 的配置和 <code>email_configs</code> 这两个小节，主要是用来定制 mail 的 subject 和 html content， 所对应的模板就是上述创建的模板文件所定义的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-64-9-centos alertmanager]# cat alertmanager.yml </span><br><span class="line">global:</span><br><span class="line">  smtp_smarthost: &apos;smtp.qq.com:25&apos;</span><br><span class="line">  smtp_from: &apos;z***e@foxmail.com&apos;</span><br><span class="line">  smtp_auth_username: &apos;z***e@foxmail.com&apos;</span><br><span class="line">  smtp_auth_password: &apos;ypgtxxxxxxxxxxxx&apos; </span><br><span class="line">  smtp_require_tls: false</span><br><span class="line">templates:</span><br><span class="line">  - &apos;/usr/local/prometheus/templates/mail.tmpl&apos;</span><br><span class="line">route:</span><br><span class="line">  group_by: [&apos;alertname&apos;]</span><br><span class="line">  group_wait: 30s</span><br><span class="line">  group_interval: 5m</span><br><span class="line">  repeat_interval: 10m</span><br><span class="line">  receiver: default-receiver</span><br><span class="line">receivers:</span><br><span class="line">  - name: &apos;default-receiver&apos;</span><br><span class="line">    email_configs:</span><br><span class="line">    - to: &apos;k****o@gmail.com&apos;</span><br><span class="line">      send_resolved: true</span><br><span class="line">      headers:</span><br><span class="line">        subject: &apos;&#123;&#123; template &quot;custom_mail_subject&quot; .  &#125;&#125;&apos;</span><br><span class="line">      html: &apos;&#123;&#123; template &quot;custom_mail_html&quot; . &#125;&#125;&apos;</span><br><span class="line">    webhook_configs:</span><br><span class="line">    - url: http://localhost:8070/dingtalk/webhook_1/send</span><br><span class="line">      send_resolved: true</span><br><span class="line"></span><br><span class="line"># 验证</span><br><span class="line">[root@VM-64-9-centos alertmanager]# ./amtool check-config alertmanager.yml </span><br><span class="line">Checking &apos;alertmanager.yml&apos;  SUCCESS</span><br><span class="line">Found:</span><br><span class="line"> - global config</span><br><span class="line"> - route</span><br><span class="line"> - 0 inhibit rules</span><br><span class="line"> - 1 receivers</span><br><span class="line"> - 1 templates</span><br><span class="line">  SUCCESS</span><br><span class="line"></span><br><span class="line"># 重启配置生效</span><br><span class="line">[root@VM-64-9-centos alertmanager]# systemctl restart alertmanager.service</span><br></pre></td></tr></table></figure></p>
<p>后面就可以看到发送的结果，一个是警报，一个是警报恢复的 (可以看到跟原先相比，之前的英文改成中文了，并且添加了时间)</p>
<p><img src="/2022/11/29/prometheus-4-alertmanager/20.png" alt=""></p>
<p>下面这个是恢复的</p>
<p><img src="/2022/11/29/prometheus-4-alertmanager/21.png" alt=""></p>
<p>这样子我们就可以自己定制我们的邮件通知的模板了</p>
<h3 id="9-alertmanager-也可以热更新配置文件"><a href="#9-alertmanager-也可以热更新配置文件" class="headerlink" title="9. alertmanager 也可以热更新配置文件"></a>9. alertmanager 也可以热更新配置文件</h3><p>alertmanager 除了上述的用 system 来重启让配置生效之外，也可以用热更新来生效配置文件: <a href="https://prometheus.io/docs/alerting/latest/management_api/#reload" target="_blank" rel="noopener">重新加载</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST localhost:9093/-/reload</span><br></pre></td></tr></table></figure></p>
<h2 id="通知模板的数据结构"><a href="#通知模板的数据结构" class="headerlink" title="通知模板的数据结构"></a><a href="https://prometheus.io/docs/alerting/latest/notifications/#alert" target="_blank" rel="noopener">通知模板的数据结构</a></h2><p>上述无论是 钉钉通知的模板还是邮件的模板，他所读取的数据都是 prometheus 发送给 alertmanager 的，这些数据结构包含的 键值对 的含义如下</p>
<blockquote>
<p>alertmanager 的通知模板基于Go 模板系统。请注意，某些字段被评估为文本，而其他字段被评估为 HTML，这将影响转义。</p>
</blockquote>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Receiver</td>
<td>string</td>
<td>接受警报通知的接收器名称</td>
</tr>
<tr>
<td>Status</td>
<td>string</td>
<td>警报状态，例如：Firing或Resolved的通知</td>
</tr>
<tr>
<td>Alerts</td>
<td>alert</td>
<td>警报通知的真实内容，警报中的所有列表</td>
</tr>
<tr>
<td>GroupLabels</td>
<td>KV</td>
<td>包含警报通知的组标签</td>
</tr>
<tr>
<td>CommonLabels</td>
<td>KV</td>
<td>所有警报的公共标签，包含GroupLabels的所有标签</td>
</tr>
<tr>
<td>CommonAnnotations</td>
<td>KV</td>
<td>注释，比如自定义的一些字符串</td>
</tr>
<tr>
<td>ExternalURL</td>
<td>string</td>
<td>警报信息中的Alertmanager地址</td>
</tr>
</tbody>
</table>
<p>其中 alert 包含:</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Status</td>
<td>string</td>
<td>定义警报是已解决还是正在触发。</td>
</tr>
<tr>
<td>Labels</td>
<td>KV</td>
<td>要附加到警报的一组标签。</td>
</tr>
<tr>
<td>Annotations</td>
<td>KV</td>
<td>警报的一组注释。rule 规则定义的</td>
</tr>
<tr>
<td>StartsAt</td>
<td>time.Time</td>
<td>警报开始触发的时间</td>
</tr>
<tr>
<td>EndsAt</td>
<td>time.Time</td>
<td>警报恢复时间，仅当警报的结束时间已知时才设置</td>
</tr>
<tr>
<td>GeneratorURL</td>
<td>string</td>
<td>标识此警报的引起实体的反向链接</td>
</tr>
<tr>
<td>Fingerprint</td>
<td>string</td>
<td>可用于识别警报的指纹。</td>
</tr>
</tbody>
</table>
<h2 id="其他-webhook-集成接收器"><a href="#其他-webhook-集成接收器" class="headerlink" title="其他 webhook 集成接收器"></a>其他 webhook 集成接收器</h2><p>除了上述 钉钉是 通过 webhook 接收器来处理的之外，alertmanager 的 webhook 接收器也集成了很多第三方的通知，比如 gitlab，jira，telegram，zoom 等等， 具体可以看到: <a href="https://prometheus.io/docs/operating/integrations/#alertmanager-webhook-receiver" target="_blank" rel="noopener">Alertmanager Webhook Receiver</a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过本节，我们已经在 prometheus server 配置警报规则并触发，然后通过 alertmanager 进行警报通知发送， 而且可以做到使用钉钉发送和邮件发送了，并且模板都可以自定义。</p>
<p>下一节，我们再详细分析一下 alertmanager 的三个特性, 理解这 3 个特性，能够更好的帮助我们去设置警报:</p>
<ul>
<li>分组(<code>Grouping</code>)</li>
<li>抑制(<code>Inhibition</code>)</li>
<li>静默(<code>Silences</code>)</li>
</ul>
<hr>
<p>参考资料:</p>
<ul>
<li><a href="https://prometheus.io/docs/alerting/latest/alertmanager/" target="_blank" rel="noopener">alertmanager</a></li>
<li><a href="https://prometheus.io/docs/alerting/latest/configuration/" target="_blank" rel="noopener">alertmanager configuration</a></li>
<li><a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#alertmanager_config" target="_blank" rel="noopener">prometheus alertmanager config</a></li>
<li><a href="https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/" target="_blank" rel="noopener">prometheus alerting rules</a></li>
<li><a href="https://prometheus.io/docs/alerting/latest/notifications/" target="_blank" rel="noopener">通知模板参考</a></li>
<li><a href="https://awesome-prometheus-alerts.grep.to/" target="_blank" rel="noopener">Awesome Prometheus alerts</a></li>
<li><a href="https://prometheus.io/docs/prometheus/latest/configuration/template_examples/" target="_blank" rel="noopener">TEMPLATE EXAMPLES</a></li>
<li><a href="https://prometheus.io/docs/alerting/latest/notifications/#alert" target="_blank" rel="noopener">通知模板参考</a></li>
<li><a href="https://velenux.wordpress.com/2021/04/23/how-to-change-prometheus-alertmanager-e-mail-template/" target="_blank" rel="noopener">How to change Prometheus Alertmanager E-Mail template</a></li>
<li><a href="https://blog.csdn.net/wang7531838/article/details/107856842" target="_blank" rel="noopener">Prometheus监控神器-Rules篇</a></li>
<li><a href="https://blog.csdn.net/wang7531838/article/details/107809870" target="_blank" rel="noopener">Prometheus监控神器-Alertmanager篇(1)</a></li>
<li><a href="https://blog.csdn.net/wang7531838/article/details/107837250" target="_blank" rel="noopener">Prometheus监控神器-Alertmanager篇(2)</a></li>
<li><a href="https://blog.csdn.net/qq_42883074/article/details/115354277" target="_blank" rel="noopener">prometheus使用 (十四) 告警模板配置</a></li>
<li><a href="https://www.jianshu.com/p/cfd1361ffcc6" target="_blank" rel="noopener">Prometheus学习系列（十七）之模板参考</a></li>
</ul>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    Zach Ke
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://kebingzao.com/2022/11/29/prometheus-4-alertmanager/" title="基于 prometheus 打造监控报警后台 (4) - 使用 alertmanager 发送警报">http://kebingzao.com/2022/11/29/prometheus-4-alertmanager/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/prometheus/" rel="tag"># prometheus</a>
          
            <a href="/tags/alertmanager/" rel="tag"># alertmanager</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2022/11/29/prometheus-3-grafana/" rel="next" title="基于 prometheus 打造监控报警后台 (3) - 使用 grafana 创建仪表盘">
                <i class="fa fa-chevron-left"></i> 基于 prometheus 打造监控报警后台 (3) - 使用 grafana 创建仪表盘
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2022/12/05/prometheus-5-alertmanager-pro/" rel="prev" title="基于 prometheus 打造监控报警后台 (5) - alertmanager 的三个概念(Grouping, Inhibition, Silences)">
                基于 prometheus 打造监控报警后台 (5) - alertmanager 的三个概念(Grouping, Inhibition, Silences) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="Zach Ke" />
            
              <p class="site-author-name" itemprop="name">Zach Ke</p>
              <p class="site-description motion-element" itemprop="description">做最咸的那一条</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">313</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">30</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">81</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/kebingzao" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#再添加一台-node-节点监控"><span class="nav-number">2.</span> <span class="nav-text">再添加一台 node 节点监控</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建警报规则"><span class="nav-number">3.</span> <span class="nav-text">创建警报规则</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-创建一条警报文件"><span class="nav-number">3.1.</span> <span class="nav-text">1. 创建一条警报文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-将警报规则添加到-prometheus-配置文件中"><span class="nav-number">3.2.</span> <span class="nav-text">2. 将警报规则添加到 prometheus 配置文件中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-警报规则参数"><span class="nav-number">3.3.</span> <span class="nav-text">3. 警报规则参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-警报的状态"><span class="nav-number">3.4.</span> <span class="nav-text">4. 警报的状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-抓取周期-scrape-interval-和-评估周期-evaluation-interval"><span class="nav-number">3.5.</span> <span class="nav-text">5. 抓取周期(scrape_interval) 和 评估周期 (evaluation_interval)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-操作触发警报"><span class="nav-number">3.6.</span> <span class="nav-text">6. 操作触发警报</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-警报规则的单元测试"><span class="nav-number">3.7.</span> <span class="nav-text">7. 警报规则的单元测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#alertmanager"><span class="nav-number">4.</span> <span class="nav-text">alertmanager</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-安装"><span class="nav-number">4.1.</span> <span class="nav-text">1. 安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-设置配置文件"><span class="nav-number">4.2.</span> <span class="nav-text">2. 设置配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-prometheus-关联-alertmanager"><span class="nav-number">4.3.</span> <span class="nav-text">3. prometheus 关联 alertmanager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-测试警报发送"><span class="nav-number">4.4.</span> <span class="nav-text">4. 测试警报发送</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-配置文件参数解析"><span class="nav-number">4.5.</span> <span class="nav-text">5. 配置文件参数解析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-global"><span class="nav-number">4.5.1.</span> <span class="nav-text">5.1. global</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-route"><span class="nav-number">4.5.2.</span> <span class="nav-text">5.2. route</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-time-intervals"><span class="nav-number">4.5.3.</span> <span class="nav-text">5.3. time_intervals</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-4-receiver"><span class="nav-number">4.5.4.</span> <span class="nav-text">5.4. receiver</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#5-4-1-email-config"><span class="nav-number">4.5.4.1.</span> <span class="nav-text">5.4.1 email_config</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-4-2-webhook-config"><span class="nav-number">4.5.4.2.</span> <span class="nav-text">5.4.2 webhook_config</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-5-inhibit-rules"><span class="nav-number">4.5.5.</span> <span class="nav-text">5.5. inhibit_rules</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-group-interval-和-repeat-interval"><span class="nav-number">4.6.</span> <span class="nav-text">6. group_interval 和 repeat_interval</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-两台-node-相继挂掉的情况"><span class="nav-number">4.6.1.</span> <span class="nav-text">6.1 两台 node 相继挂掉的情况</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-发送钉钉通知"><span class="nav-number">4.7.</span> <span class="nav-text">7. 发送钉钉通知</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-安装-Prometheus-webhook-Dingtalk"><span class="nav-number">4.7.1.</span> <span class="nav-text">7.1 安装 Prometheus-webhook-Dingtalk</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-模板配置"><span class="nav-number">4.7.2.</span> <span class="nav-text">7.2 模板配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-3-配置到-alertmanager"><span class="nav-number">4.7.3.</span> <span class="nav-text">7.3 配置到 alertmanager</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-接下来测试"><span class="nav-number">4.7.4.</span> <span class="nav-text">7.4 接下来测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-邮件配置自定义模板"><span class="nav-number">4.8.</span> <span class="nav-text">8. 邮件配置自定义模板</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-alertmanager-也可以热更新配置文件"><span class="nav-number">4.9.</span> <span class="nav-text">9. alertmanager 也可以热更新配置文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#通知模板的数据结构"><span class="nav-number">5.</span> <span class="nav-text">通知模板的数据结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#其他-webhook-集成接收器"><span class="nav-number">6.</span> <span class="nav-text">其他 webhook 集成接收器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">7.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zach Ke</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://zach-2.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://kebingzao.com/2022/11/29/prometheus-4-alertmanager/';
          this.page.identifier = '2022/11/29/prometheus-4-alertmanager/';
          this.page.title = '基于 prometheus 打造监控报警后台 (4) - 使用 alertmanager 发送警报';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://zach-2.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  














  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.4"></script>



  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("HIV4XRdKJXB0eaFgtSjiVNaK-gzGzoHsz", "zN3v8grxW0Q8eXwNlEgXxWrF");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  



</body>
</html>
